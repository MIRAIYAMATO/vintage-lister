<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VintageLister - Desktop Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            /* Primary Colors */
            --color-primary: #3b82f6; 
            --color-primary-dark: #2563eb; 
            --color-primary-light: #dbeafe;
            --color-primary-lighter: #eff6ff;
            
            /* Status Colors */
            --color-success: #22c55e;
            --color-success-dark: #16a34a;
            --color-warning: #f59e0b;
            --color-warning-dark: #d97706;
            --color-warning-light: #fef3c7;
            --color-warning-lighter: #fffbeb;
            --color-warning-text: #92400e;
            --color-error: #ef4444;
            --color-error-dark: #dc2626;
            --color-error-light: #fef2f2;
            
            /* Neutral Colors */
            --color-surface: #ffffff; 
            --color-background: #f1f5f9; 
            --color-text: #1e293b; 
            --color-text-muted: #64748b; 
            --color-text-light: #94a3b8;
            --color-border: #e2e8f0;
            --color-border-dark: #cbd5e1;
            
            /* Dark UI Colors */
            --color-dark: #1e293b;
            --color-dark-lighter: #334155;
            --color-dark-border: #475569;
            
            /* Spacing */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 10px;
            --radius-xl: 12px;
            
            /* Transitions */
            --transition-fast: 0.1s ease;
            --transition-normal: 0.2s ease;
        }
        
        /* Utility Classes */
        .text-success { color: var(--color-success) !important; }
        .text-success-dark { color: var(--color-success-dark) !important; }
        .text-error { color: var(--color-error) !important; }
        .text-warning { color: var(--color-warning) !important; }
        .text-warning-text { color: var(--color-warning-text) !important; }
        .text-primary { color: var(--color-primary) !important; }
        .text-muted { color: var(--color-text-muted) !important; }
        .bg-success { background: var(--color-success) !important; }
        .bg-error { background: var(--color-error) !important; }
        .bg-warning { background: var(--color-warning-light) !important; }
        * { box-sizing: border-box; }
        html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        
        /* TOAST NOTIFICATIONS */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 14px 20px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; min-width: 280px; max-width: 400px; animation: slideIn 0.3s ease; pointer-events: auto; }
        .toast.success { background: linear-gradient(135deg, #059669, #047857); }
        .toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .toast.warning { background: linear-gradient(135deg, #d97706, #b45309); }
        .toast.info { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .toast-icon { font-size: 20px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
        .toast-message { font-size: 12px; opacity: 0.9; line-height: 1.4; }
        .toast-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .toast-close:hover { background: rgba(255,255,255,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast.hiding { animation: slideOut 0.3s ease forwards; }
        
        /* PIN LOCK SCREEN */
        .pin-screen { position: fixed; inset: 0; z-index: 1000; background: linear-gradient(135deg, #1e293b, #0f172a); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-screen.hidden { display: none; }
        .pin-box { background: white; border-radius: 20px; padding: 32px; width: 340px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .pin-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .pin-subtitle { color: var(--color-text-muted); font-size: 14px; margin-bottom: 20px; }
        .pin-input { width: 100%; padding: 16px; font-size: 32px; text-align: center; letter-spacing: 12px; border: 2px solid var(--color-border); border-radius: var(--radius-xl); font-family: monospace; margin-bottom: 16px; transition: var(--transition-fast); }
        .pin-input:focus { outline: none; border-color: var(--color-primary); }
        .pin-input.shake { animation: shake 0.3s; border-color: var(--color-error); }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        .photographer-select { width: 100%; padding: 12px; border: 2px solid var(--color-border); border-radius: var(--radius-lg); font-size: 14px; margin-bottom: 20px; transition: var(--transition-fast); }
        .photographer-select:focus { outline: none; border-color: var(--color-primary); }
        .pin-btn { width: 100%; padding: 16px; background: var(--color-primary); color: white; border: none; border-radius: var(--radius-xl); font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition-fast); }
        .pin-btn:hover { background: var(--color-primary-dark); }
        .pin-btn:active { transform: scale(0.98); }
        .pin-version { color: #475569; font-size: 12px; margin-top: 16px; }
        
        .desktop-layout { display: grid; grid-template-columns: 420px 1fr 280px; height: 100vh; overflow: hidden; }
        .form-panel { background: var(--color-surface); display: flex; flex-direction: column; overflow: hidden; }
        .camera-panel { background: #000; display: flex; flex-direction: column; overflow: hidden; height: 100%; max-height: 100vh; }
        .photos-panel { background: var(--color-background); overflow-y: auto; padding: 16px; border-left: 1px solid var(--color-border); }
        
        /* FLOATING TIMER */
        .floating-timer { position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        .timer-main { font-size: 28px; font-weight: 800; font-family: monospace; }
        .timer-stats { text-align: right; font-size: 11px; opacity: 0.9; }
        .timer-label { font-size: 10px; opacity: 0.7; }
        .photographer-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .version-badge { background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; font-family: monospace; }
        .folder-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .folder-btn:hover { background: rgba(255,255,255,0.25); }
        .folder-btn.active { background: rgba(34,197,94,0.3); border-color: #22c55e; }
        
        /* PROGRESS BAR */
        .progress-bar { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 12px 16px; background: var(--color-background); border-bottom: 1px solid var(--color-border); flex-wrap: wrap; }
        .progress-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--color-border); cursor: pointer; transition: all 0.2s; }
        .progress-dot.active { background: var(--color-primary); transform: scale(1.3); }
        .progress-dot.complete { background: var(--color-success); }
        .progress-label { font-size: 11px; color: var(--color-text-muted); font-weight: 600; margin-left: 8px; }
        .category-badge { font-size: 11px; color: var(--color-primary); font-weight: 700; text-transform: uppercase; margin-left: 4px; }
        .sku-badge { font-size: 10px; background: var(--color-success); color: white; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-family: monospace; display: none; }
        .sku-badge.visible { display: inline-block; }
        
        /* STEP CONTAINER */
        .step-area { flex: 1; overflow-y: auto; padding: 16px; }
        .step-container { display: none; }
        .step-container.active { display: block; }
        
        .section-card { background: var(--color-background); border: 1px solid var(--color-border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .section-label { font-size: 12px; font-weight: 700; color: var(--color-text); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .check-circle { width: 20px; height: 20px; border-radius: 50%; background: var(--color-border); color: #999; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .check-circle.complete { background: var(--color-success); color: white; }
        
        .btn { padding: 10px 12px; border-radius: var(--radius-md); font-size: 12px; font-weight: 600; cursor: pointer; border: 2px solid transparent; transition: var(--transition-fast); text-align: center; }
        .btn:active { transform: scale(0.97); }
        .btn-tertiary { background: white; color: var(--color-text-muted); border: 1px solid var(--color-border); }
        .btn-tertiary:hover { background: var(--color-background); }
        .btn-tertiary.selected { border: 2px solid var(--color-primary) !important; background: var(--color-primary) !important; color: white !important; }
        /* btn-default = light blue with dashed border (suggested/default option) */
        .btn-default { background: #e0f2fe !important; color: #0369a1 !important; border: 2px dashed #7dd3fc !important; }
        .btn-default:hover { background: #bae6fd !important; }
        .btn-default.selected { border: 2px solid var(--color-primary) !important; background: var(--color-primary) !important; color: white !important; }
        /* btn-hero = solid blue (confirmed selection) */
        .btn-hero { background: var(--color-primary); color: white !important; border: 2px solid var(--color-primary-dark) !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-hero:hover { background: var(--color-primary-dark); }
        .btn-hero:active { transform: scale(0.98); }
        .btn-hero.selected { background: var(--color-primary-dark); box-shadow: 0 0 0 3px rgba(59,130,246,0.3); }
        /* btn-secondary = white with gray border (other options) */
        .btn-secondary { background: white; color: var(--color-text); border: 2px solid var(--color-border); }
        .btn-secondary:hover { background: var(--color-background); border-color: var(--color-border-dark); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-secondary.selected { border-color: var(--color-primary); background: var(--color-primary-light); }
        .btn-grid { display: grid; gap: 8px; }
        .btn-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .btn-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .btn-grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        .form-input, .form-select { width: 100%; padding: 10px 12px; border: 2px solid var(--color-border); border-radius: var(--radius-md); font-size: 14px; transition: var(--transition-fast); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); }
        
        .sub-label { font-size: 11px; color: var(--color-text-muted); font-weight: 600; margin: 10px 0 8px 0; }
        .nested-section { background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 12px; margin-top: 10px; }
        .nested-amber { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); }
        
        /* Super Category */
        .super-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 16px 12px; font-size: 11px; font-weight: 700; }
        .super-btn .emoji { font-size: 24px; }
        .super-btn.selected { background: var(--color-primary) !important; color: white !important; border-color: var(--color-primary) !important; }
        
        /* Category buttons */
        .cat-hero { padding: 16px; font-size: 15px; font-weight: 700; border-radius: 8px; border: 2px solid var(--color-border); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 8px; background: white; color: var(--color-text); transition: all 0.15s; }
        .cat-hero:hover { background: var(--color-background); border-color: var(--color-primary); }
        .cat-hero.cat-default { background: #e0f2fe; color: #0369a1; border: 2px dashed #7dd3fc; }
        .cat-hero.cat-default:hover { background: #bae6fd; }
        .cat-hero.selected { background: var(--color-primary) !important; color: white !important; border: 2px solid var(--color-primary) !important; box-shadow: 0 0 0 4px rgba(59,130,246,0.3); }
        .cat-secondary { background: white; color: var(--color-text); border: 2px solid var(--color-border); padding: 12px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.15s; }
        .cat-secondary:hover { background: var(--color-background); border-color: var(--color-primary); }
        .cat-secondary.selected { border-color: var(--color-primary) !important; background: var(--color-primary) !important; color: white !important; box-shadow: 0 0 0 3px rgba(59,130,246,0.3); }
        .cat-other { background: white; color: var(--color-text-muted); border: 1px solid var(--color-border); padding: 8px; font-size: 11px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.15s; }
        .cat-other:hover { border-color: var(--color-primary); color: var(--color-text); }
        .cat-other.selected { border-color: var(--color-primary); background: var(--color-primary); color: white; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
        
        /* Color grid */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        /* V97 style: color-item with label below */
        .color-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 4px; border-radius: 10px; transition: all 0.15s ease; border: 3px solid transparent; }
        .color-item:hover { transform: scale(1.02); }
        .color-item:active { transform: scale(0.95); }
        .color-item span { font-size: 9px; color: #64748b; margin-top: 4px; text-align: center; line-height: 1.1; }
        .color-item.selected { border-color: var(--color-primary); background: #dbeafe; }
        .color-item.selected span { color: var(--color-primary); font-weight: 700; }
        .color-swatch { width: 100%; aspect-ratio: 1; min-height: 40px; border-radius: 8px; border: 2px solid transparent; transition: all 0.15s ease; }
        
        /* Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
        .card { background: white; border: 2px solid var(--color-border); border-radius: 8px; padding: 12px; cursor: pointer; position: relative; }
        .card:hover { background: var(--color-background); }
        .card.selected { border-color: var(--color-primary); background: var(--color-primary); }
        .card.selected .card-name { color: white !important; }
        .card.selected .card-desc { color: rgba(255,255,255,0.9) !important; }
        .card.priority-1 { grid-column: span 2; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px dashed var(--color-primary); }
        .card.priority-1.selected { border-style: solid; background: var(--color-primary); }
        .card.dimmed { opacity: 0.3; pointer-events: none; }
        .card-name { font-size: 13px; font-weight: 700; color: var(--color-text); }
        .card-desc { font-size: 10px; color: var(--color-text-muted); margin-top: 2px; }
        .card-help { position: absolute; top: 6px; right: 6px; width: 18px; height: 18px; border-radius: 50%; background: rgba(59,130,246,0.1); color: var(--color-primary); font-size: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .card.selected .card-help { background: rgba(255,255,255,0.2); color: white; }
        /* Reference Modal (Visual Search) */
        .ref-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
        .ref-modal-overlay.visible { opacity: 1; visibility: visible; }
        .ref-modal { background: white; border-radius: 16px; padding: 24px; max-width: 340px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); transform: scale(0.9); transition: transform 0.2s ease; text-align: center; }
        .ref-modal-overlay.visible .ref-modal { transform: scale(1); }
        .ref-modal-title { font-size: 20px; font-weight: 700; color: var(--color-text); margin-bottom: 8px; }
        .ref-modal-desc { font-size: 14px; color: var(--color-text-muted); line-height: 1.5; margin-bottom: 20px; }
        .ref-modal-link { display: block; width: 100%; padding: 14px; background: var(--color-primary); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; text-decoration: none; margin-bottom: 12px; }
        .ref-modal-link:hover { background: var(--color-primary-dark); }
        .ref-modal-close { width: 100%; padding: 12px; background: #f1f5f9; color: var(--color-text-muted); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        
        /* Help panel */
        .help-btn { width: 100%; padding: 10px; background: var(--color-warning-light); border: 2px dashed var(--color-warning); border-radius: var(--radius-md); font-size: 12px; font-weight: 600; color: var(--color-warning-text); cursor: pointer; transition: var(--transition-fast); }
        .help-btn:hover { background: var(--color-warning-lighter); border-color: var(--color-warning-dark); }
        .help-btn:active { transform: scale(0.98); }
        .help-panel { background: #fffbeb; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 10px; }
        .help-panel.hidden { display: none; }
        .filter-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .filter-btn { padding: 8px 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: white; border: 1px solid var(--color-border); border-radius: var(--radius-sm); color: var(--color-text-muted); cursor: pointer; transition: var(--transition-fast); min-width: fit-content; }
        .filter-btn:hover { background: var(--color-background); border-color: var(--color-border-dark); }
        .filter-btn:active { transform: scale(0.97); }
        .filter-btn.active { background: var(--color-primary); border-color: var(--color-primary); color: white; }
        .help-text { background: #fef3c7; border-radius: 6px; padding: 8px 10px; font-size: 11px; color: #92400e; margin-top: 8px; }
        .help-text.hidden { display: none; }
        
        .tag-warning { background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px; padding: 10px; font-size: 11px; font-weight: 600; color: #b91c1c; text-align: center; margin-bottom: 10px; }
        .tag-warning.hidden { display: none; }
        
        /* Defect buttons with emoji */
        .defect-card { display: flex; flex-direction: column; align-items: center; padding: 12px 8px; gap: 4px; }
        .defect-card .emoji { font-size: 24px; }
        .defect-card .label { font-size: 10px; font-weight: 700; }
        
        /* Navigation */
        .nav-buttons { display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-border); }
        .nav-btn { flex: 1; padding: 14px; border-radius: var(--radius-lg); font-size: 14px; font-weight: 700; cursor: pointer; border: none; transition: var(--transition-fast); }
        .nav-btn:active { transform: scale(0.98); }
        .nav-btn-back { background: white; color: var(--color-text); border: 2px solid var(--color-border); }
        .nav-btn-back:hover { background: var(--color-background); border-color: var(--color-border-dark); }
        .nav-btn-next { background: var(--color-primary); color: white; flex: 2; }
        .nav-btn-next:hover { background: var(--color-primary-dark); }
        
        /* Camera */
        .camera-header { background: #111; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; border-bottom: 1px solid #333; flex-shrink: 0; }
        .camera-select { background: var(--color-dark); border: 1px solid var(--color-dark-border); color: white; padding: 8px 12px; border-radius: var(--radius-sm); font-size: 12px; flex: 1; max-width: 220px; transition: var(--transition-fast); }
        .camera-select:focus { outline: none; border-color: var(--color-primary); }
        .camera-status { font-size: 11px; font-weight: 700; color: #555; }
        .camera-status.live { color: #22c55e; }
        .camera-status.live::before { content: '‚óè'; margin-right: 6px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .camera-view { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; background: #000; min-height: 0; }
        .camera-view-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: visible; }
        .camera-view video { 
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            transition: opacity 0.15s ease, transform 0.3s ease;
        }
        /* Portrait mode: rotate video 90 degrees for MAIN photos */
        .camera-view video.portrait-mode {
            transform-origin: center center;
            /* Transform is set dynamically by JS to include proper scaling */
        }
        .camera-view video.switching { opacity: 0.3; }
        .camera-placeholder { color: #444; text-align: center; position: absolute; z-index: 1; }
        .camera-placeholder-icon { font-size: 48px; margin-bottom: 12px; }
        .camera-overlay { position: absolute; inset: 0; pointer-events: none; display: none; }
        /* Stabilizer indicator */
        .stabilizer-indicator { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.7); padding: 6px 14px; border-radius: 20px; z-index: 10; }
        .stabilizer-dot { width: 14px; height: 14px; border-radius: 50%; background: #ef4444; transition: background 0.2s ease; }
        .stabilizer-dot.stable { background: #22c55e; animation: pulse-green 1s ease-in-out infinite; }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6); } 50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); } }
        .stabilizer-text { color: white; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; }
        .camera-footer { background: #111; padding: 16px; display: flex; justify-content: center; align-items: center; gap: 16px; border-top: 1px solid #333; flex-shrink: 0; }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid var(--color-dark-border); cursor: pointer; transition: var(--transition-fast); }
        .shutter-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .shutter-btn:active { transform: scale(0.95); background: var(--color-background); }
        .shutter-btn.flash { animation: btnflash 0.15s; }
        @keyframes btnflash { 0%{background:white} 50%{background:var(--color-primary)} 100%{background:white} }
        .shutter-hint { color: #555; font-size: 11px; text-align: center; }
        .shutter-hint kbd { background: #333; padding: 3px 6px; border-radius: 4px; font-family: monospace; color: #aaa; }
        .mode-btn { padding: 10px 16px; background: var(--color-dark); border: 2px solid var(--color-dark-border); color: var(--color-text-light); border-radius: var(--radius-md); font-size: 12px; font-weight: 600; cursor: pointer; line-height: 1.3; min-width: 80px; transition: var(--transition-fast); }
        .mode-btn:hover { border-color: var(--color-primary); }
        .mode-btn:active { transform: scale(0.97); }
        .mode-btn.active { background: var(--color-primary); border-color: var(--color-primary); color: white; }
        
        
        
        .mode-btn small { display: block; }
        
        /* Defect Markers on Camera Preview */
        .defect-markers-layer { position: absolute; pointer-events: none; z-index: 5; inset: 0; }
        .defect-markers-layer.active { pointer-events: auto; cursor: crosshair; }
        .defect-markers-layer:not(.active) .defect-marker { display: none; } /* Hide markers when not in main mode */
        .defect-marker { position: absolute; width: 36px; height: 36px; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.5); transition: transform 0.15s ease; }
        .defect-marker:hover { transform: translate(-50%, -50%) scale(1.2); }
        .defect-marker.stain { background: #eab308; }
        .defect-marker.hole { background: #3b82f6; }
        .defect-marker.repair { background: #f97316; }
        .defect-marker-delete { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; background: #ef4444; border-radius: 50%; border: 2px solid white; font-size: 12px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.15s; }
        .defect-marker:hover .defect-marker-delete { opacity: 1; }
        
        /* Defect Type Popup */
        .defect-popup { position: fixed; z-index: 10000; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); padding: 12px; display: none; }
        .defect-popup.visible { display: block; }
        .defect-popup-title { font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 8px; text-align: center; }
        .defect-popup-btns { display: flex; gap: 8px; }
        .defect-popup-btn { padding: 12px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 70px; transition: transform 0.1s; }
        .defect-popup-btn:hover { transform: scale(1.05); }
        .defect-popup-btn:active { transform: scale(0.95); }
        .defect-popup-btn.stain { background: #fef9c3; color: #a16207; border: 2px solid #eab308; }
        .defect-popup-btn.hole { background: #dbeafe; color: #1d4ed8; border: 2px solid #3b82f6; }
        .defect-popup-btn.repair { background: #ffedd5; color: #c2410c; border: 2px solid #f97316; }
        .defect-popup-btn span:first-child { font-size: 20px; }
        .defect-popup-cancel { width: 100%; margin-top: 8px; padding: 8px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 11px; color: #64748b; cursor: pointer; }
        .defect-popup-cancel:hover { background: #e2e8f0; }
        
        /* Defect Mode Indicator */
        .defect-mode-banner { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 10; display: none; }
        .defect-mode-banner.visible { display: flex; align-items: center; gap: 8px; }
        .defect-mode-banner .marker-count { background: #3b82f6; padding: 2px 8px; border-radius: 10px; }
        
        /* Defect Close-up Link Panel & Feature Type Panel */
        .closeup-link-panel { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(220,38,38,0.95); color: white; padding: 10px 16px; border-radius: 12px; font-size: 11px; z-index: 10; display: none; flex-direction: column; gap: 8px; min-width: 200px; }
        .closeup-link-panel.visible { display: flex; }
        .closeup-link-panel .link-buttons { display: flex; flex-wrap: wrap; gap: 4px; }
        .closeup-link-panel .link-btn { padding: 4px 10px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .closeup-link-panel .link-btn:hover { background: rgba(255,255,255,0.3); }
        .closeup-link-panel .link-btn.active { background: white; color: #dc2626; }
        .closeup-link-panel .link-btn-none { padding: 4px 10px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.4); border-radius: 6px; color: rgba(255,255,255,0.7); font-size: 10px; cursor: pointer; margin-top: 4px; }
        .closeup-link-panel .link-btn-none:hover { background: rgba(255,255,255,0.2); }
        .feature-type-btn { padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: white; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .feature-type-btn:hover { background: rgba(255,255,255,0.3); }
        .feature-type-btn.active { background: white; color: #7c3aed; }
        
        /* Photos panel */
        .photos-header { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .photo-count { background: var(--color-primary-light); color: var(--color-primary-dark); padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .photo-section { margin-bottom: 16px; }
        .photo-section-title { font-size: 10px; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .photo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .photo-thumb { aspect-ratio: 3/4; border-radius: 6px; overflow: hidden; background: white; border: 2px solid var(--color-border); position: relative; cursor: pointer; transition: transform 0.1s, border-color 0.1s; }
        .photo-thumb.square { aspect-ratio: 1/1; } /* Square for tag/defect photos */
        .photo-thumb:hover { transform: scale(1.02); border-color: var(--color-primary); }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb-delete { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; opacity: 0; }
        .photo-thumb:hover .photo-thumb-delete { opacity: 1; }
        .photo-thumb-empty { display: flex; align-items: center; justify-content: center; color: var(--color-border); font-size: 18px; cursor: pointer; }
        .stats-section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--color-border); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: 800; }
        .stat-label { font-size: 9px; color: var(--color-text-muted); text-transform: uppercase; }
        
        .reset-btn { padding: 6px 12px; background: var(--color-error); color: white; border: none; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; cursor: pointer; transition: var(--transition-fast); }
        .reset-btn:hover { background: var(--color-error-dark); }
        .reset-btn:active { transform: scale(0.97); }
        
        /* Reset Dropdown Menu */
        .reset-dropdown { position: relative; display: inline-block; }
        .reset-menu { position: absolute; top: 100%; right: 0; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); min-width: 180px; z-index: 1000; display: none; overflow: hidden; }
        .reset-menu.visible { display: block; }
        .reset-menu button { display: block; width: 100%; padding: 12px 16px; background: white; border: none; text-align: left; font-size: 13px; font-weight: 500; cursor: pointer; color: var(--color-text); }
        .reset-menu button:hover { background: #f1f5f9; }
        .reset-menu button:first-child { color: var(--color-primary); }
        .reset-menu button:last-child { color: var(--color-error); }
        .fullres-btn { background: var(--color-success); color: white; padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: 700; border: none; cursor: pointer; transition: var(--transition-fast); }
        .fullres-btn:hover { background: var(--color-success-dark); }
        .fullres-btn:active { transform: scale(0.97); }
        
        /* SKU Gate Overlay */
        .sku-gate { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); z-index: 950; display: flex; align-items: center; justify-content: center; }
        .sku-gate.hidden { display: none; }
        .sku-gate-card { background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 440px; text-align: center; box-shadow: 0 25px 80px rgba(0,0,0,0.4); overflow: hidden; box-sizing: border-box; position: relative; }
        .sku-gate-version { position: absolute; top: 12px; right: 12px; background: var(--color-primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .sku-gate-icon { font-size: 48px; margin-bottom: 16px; }
        .sku-gate-title { font-size: 24px; font-weight: 800; color: var(--color-text); margin-bottom: 8px; }
        .sku-gate-subtitle { font-size: 14px; color: var(--color-text-muted); margin-bottom: 24px; }
        .sku-gate-input-row { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; width: 100%; box-sizing: border-box; }
        .sku-gate-input { flex: 1; padding: 14px 16px; font-size: 22px; font-family: monospace; font-weight: 700; text-align: center; border: 3px solid var(--color-border); border-radius: 12px; outline: none; transition: var(--transition-fast); min-width: 0; box-sizing: border-box; }
        .sku-gate-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 4px rgba(59,130,246,0.2); }
        .sku-gate-input.valid { border-color: var(--color-success); background: #f0fdf4; }
        .sku-gate-scan-btn { padding: 14px 16px; background: var(--color-dark); color: white; border: none; border-radius: 12px; font-size: 20px; cursor: pointer; transition: var(--transition-fast); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .sku-gate-scan-btn:hover { background: var(--color-dark-lighter); }
        .sku-gate-hint { font-size: 12px; color: var(--color-text-muted); }
        .sku-gate-hint kbd { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .sku-gate-status { margin-top: 16px; font-size: 13px; color: var(--color-success); font-weight: 600; min-height: 20px; }
        
        /* SKU Gate Camera Preview */
        .sku-gate-camera-container { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 12px; }
        #sku-gate-video { width: 100%; height: 100%; object-fit: cover; }
        .sku-gate-scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .scan-target { width: 70%; height: 40%; border: 3px dashed rgba(255,255,255,0.7); border-radius: 8px; position: relative; }
        .scan-target::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: #22c55e; border-radius: 2px; animation: scan-line 1.5s ease-in-out infinite; }
        @keyframes scan-line { 0%, 100% { top: -8px; } 50% { top: calc(100% + 4px); } }
        .sku-gate-camera-hint { font-size: 13px; color: var(--color-text-muted); margin-bottom: 12px; }
        .sku-gate-cancel-btn { padding: 10px 24px; background: #f1f5f9; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--color-text-muted); cursor: pointer; transition: var(--transition-fast); }
        .sku-gate-cancel-btn:hover { background: #e2e8f0; color: var(--color-text); }
        
        /* SKU Gate Stabilizer */
        .sku-gate-stabilizer { position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.7); padding: 6px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; color: white; }
        .sku-gate-stabilizer-dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; transition: background 0.3s; }
        .sku-gate-stabilizer-dot.stable { background: #22c55e; }
        .sku-gate-stabilizer.stable { background: rgba(34,197,94,0.9); }
        .sku-gate-stabilizer.stable .sku-gate-stabilizer-dot { background: white; }
        
        /* Locked SKU Badge in Header */
        .sku-locked { display: inline-flex; align-items: center; gap: 6px; background: var(--color-success); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; font-family: monospace; }
        .sku-locked .lock-icon { font-size: 10px; }
        
        .submit-btn { width: 100%; padding: 16px; background: var(--color-success); color: white; border: none; border-radius: var(--radius-lg); font-size: 15px; font-weight: 700; cursor: pointer; transition: var(--transition-fast); }
        .submit-btn:hover { background: var(--color-success-dark); }
        .submit-btn:active { transform: scale(0.98); }
        .submit-btn:disabled { background: var(--color-border); cursor: not-allowed; }
        
        .flash-overlay { position: fixed; inset: 0; background: white; z-index: 500; opacity: 0; pointer-events: none; }
        .flash-overlay.flash { opacity: 1; }
        .hidden { display: none !important; }
        .recording { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.7} }
        
        /* Photo Preview Modal */
        .preview-modal { position: fixed; inset: 0; z-index: 600; background: rgba(0,0,0,0.98); display: none; flex-direction: column; }
        .preview-modal.active { display: flex; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #000; flex-shrink: 0; }
        .preview-title { color: white; font-size: 14px; font-weight: 700; }
        .preview-badge { background: var(--color-primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .preview-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 8px; }
        .preview-close:hover { color: #f87171; }
        .preview-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0; position: relative; overflow: hidden; min-height: 0; }
        .preview-image { width: auto; height: 100%; max-width: 100vw; max-height: calc(100vh - 100px); object-fit: contain; }
        .preview-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: white; font-size: 32px; padding: 16px 12px; cursor: pointer; border-radius: 8px; z-index: 10; }
        .preview-nav:hover { background: rgba(255,255,255,0.2); }
        .preview-nav.prev { left: 20px; }
        .preview-nav.next { right: 20px; }
        .preview-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .preview-footer { display: flex; justify-content: center; gap: 12px; padding: 12px; background: #000; flex-shrink: 0; }
        .preview-btn { padding: 12px 24px; border-radius: var(--radius-md); font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: var(--transition-fast); }
        .preview-btn:active { transform: scale(0.97); }
        .preview-btn-delete { background: var(--color-error); color: white; }
        .preview-btn-delete:hover { background: var(--color-error-dark); }
        .preview-btn-close { background: var(--color-dark-border); color: white; }
        .preview-btn-close:hover { background: var(--color-text-muted); }
        .preview-counter { color: #9ca3af; font-size: 12px; position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); }
        
        /* SKU with scan button */
        .sku-row { display: flex; gap: 8px; }
        .sku-row input { flex: 1; }
        .scan-btn { background: var(--color-dark); color: white; border: none; padding: 10px 16px; border-radius: var(--radius-md); font-size: 18px; cursor: pointer; transition: var(--transition-fast); }
        .scan-btn:hover { background: var(--color-dark-lighter); }
        .scan-btn:active { transform: scale(0.97); }
        
        /* Review cards */
        .review-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
        .review-card { border-radius: 10px; padding: 14px; cursor: pointer; transition: transform 0.1s; }
        .review-card:hover { transform: scale(0.98); }
        .review-card:active { transform: scale(0.96); }
        .card-green { border-left: 4px solid var(--color-success); background: #f0fdf4; }
        .card-yellow { border-left: 4px solid var(--color-warning); background: #fffbeb; }
        .review-card-header { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
        .review-card-header .icon { font-size: 16px; }
        .review-card-header .title { font-size: 12px; font-weight: 700; color: var(--color-text); }
        .review-card-summary { font-size: 11px; color: var(--color-text-muted); line-height: 1.4; }
        .review-banner { background: var(--color-success); color: white; padding: 14px; border-radius: 10px; text-align: center; font-weight: 700; margin-bottom: 12px; }
        .flag-banner { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 10px; text-align: center; font-weight: 700; margin-bottom: 12px; }
        .flag-unusual-btn { width:100%; padding:14px; background:linear-gradient(135deg, var(--color-warning-lighter), var(--color-warning-light)); border:2px dashed var(--color-warning); border-radius: var(--radius-lg); font-weight:700; color: var(--color-warning-text); cursor:pointer; margin-bottom:12px; text-align:center; transition: var(--transition-normal); }
        .flag-unusual-btn:hover { background:linear-gradient(135deg, var(--color-warning-light), #fde68a); }
        .flag-unusual-btn:active { transform: scale(0.98); }
        .flag-unusual-btn.flagged { background:linear-gradient(135deg,#fde68a,#fbbf24); border-style:solid; border-color: var(--color-warning-dark); }
        .elastic-section { background:#f0fdf4; border:1px solid #86efac; border-radius:10px; padding:12px; margin-top:10px; }
    </style>
    <!-- QuaggaJS Barcode Scanner Library - works in all browsers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Reference Modal (Visual Search) -->
    <div id="ref-modal-overlay" class="ref-modal-overlay" onclick="closeRefModal()">
        <div class="ref-modal" onclick="event.stopPropagation()">
            <div class="ref-modal-title" id="ref-modal-title">Fabric Name</div>
            <div class="ref-modal-desc" id="ref-modal-desc">Description</div>
            <a id="ref-modal-link" class="ref-modal-link" href="#" target="_blank">üîç See Examples on Google</a>
            <button class="ref-modal-close" onclick="closeRefModal()">Close</button>
        </div>
    </div>
    
    <!-- Defect Type Popup -->
    <div id="defect-popup" class="defect-popup" onclick="event.stopPropagation()">
        <div class="defect-popup-title">WHAT TYPE OF DEFECT?</div>
        <div class="defect-popup-btns">
            <button class="defect-popup-btn stain" onclick="event.stopPropagation(); confirmDefectMarker('stain')">
                <span>üíß</span>
                <span>Stain</span>
            </button>
            <button class="defect-popup-btn hole" onclick="event.stopPropagation(); confirmDefectMarker('hole')">
                <span>üï≥Ô∏è</span>
                <span>Hole</span>
            </button>
            <button class="defect-popup-btn repair" onclick="event.stopPropagation(); confirmDefectMarker('repair')">
                <span>üßµ</span>
                <span>Repair</span>
            </button>
        </div>
        <button class="defect-popup-cancel" onclick="event.stopPropagation(); cancelDefectMarker()">Cancel</button>
    </div>
    
    <!-- PIN LOCK SCREEN -->
    <div id="pin-screen" class="pin-screen">
        <div class="pin-box">
            <div class="pin-title">VintageLister</div>
            <div class="pin-subtitle">Enter Warehouse PIN</div>
            <input type="tel" id="pin-input" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="off">
            <div class="sub-label">Photographer</div>
            <select id="photographer-select" class="photographer-select">
                <option value="P01">P01 ‚Äì Jeff Koga</option>
                <option value="P02" selected>P02 ‚Äì Elaine Donato</option>
                <option value="P03">P03 ‚Äì Kobe Gaza</option>
            </select>
            <button onclick="checkPin()" class="pin-btn">START LISTING ‚Üí</button>
        </div>
        <div class="pin-version" id="pin-version">Loading...</div>
    </div>
    
    <!-- SKU GATE: Must scan SKU before starting -->
    <div class="sku-gate" id="sku-gate">
        <div class="sku-gate-card">
            <!-- Version Badge -->
            <div class="sku-gate-version" id="sku-gate-version"></div>
            
            <!-- Default Entry View -->
            <div id="sku-gate-entry">
                <div class="sku-gate-icon">üè∑Ô∏è</div>
                <div class="sku-gate-title">Scan SKU to Start</div>
                <div class="sku-gate-subtitle">Every item begins with a SKU scan</div>
                <div class="sku-gate-input-row">
                    <input type="text" id="sku-gate-input" class="sku-gate-input" placeholder="SKU" 
                        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                        oninput="onSkuGateInput()" onkeydown="handleSkuGateKeydown(event)">
                    <button class="sku-gate-scan-btn" onclick="activateSkuGateScan()" title="Scan with camera">üì∑</button>
                </div>
                <div class="sku-gate-hint">Type manually or scan barcode with <kbd>üì∑</kbd> camera</div>
                <div class="sku-gate-status" id="sku-gate-status"></div>
            </div>
            
            <!-- Camera Preview View (shown when scanning) -->
            <div id="sku-gate-camera" class="hidden">
                <div class="sku-gate-title" style="margin-bottom:12px;">üì∑ Scanning...</div>
                <div class="sku-gate-camera-container">
                    <video id="sku-gate-video" autoplay playsinline muted></video>
                    <div class="sku-gate-scan-overlay">
                        <div class="scan-target"></div>
                    </div>
                    <!-- Stabilizer Indicator -->
                    <div class="sku-gate-stabilizer" id="sku-gate-stabilizer">
                        <div class="sku-gate-stabilizer-dot" id="sku-gate-stabilizer-dot"></div>
                        <span id="sku-gate-stabilizer-text">HOLD STEADY</span>
                    </div>
                    <!-- Error Overlay -->
                    <div id="sku-gate-error" class="hidden" style="position:absolute;inset:0;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:12px;">
                        <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
                        <div style="font-size:16px;font-weight:600;color:#ef4444;margin-bottom:8px;">No Camera Detected</div>
                        <div style="font-size:13px;color:#64748b;">Please type the SKU manually</div>
                    </div>
                </div>
                <div class="sku-gate-camera-hint">Center barcode in the frame</div>
                <div id="scanner-status" style="font-size:10px;color:#22c55e;margin-bottom:8px;"></div>
                <input type="text" id="sku-gate-scan-input" class="sku-gate-input" placeholder="Waiting for scan..." 
                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                    oninput="onSkuGateScanInput()" onkeydown="handleSkuGateScanKeydown(event)"
                    style="margin-bottom:12px; font-size:18px; height:50px;">
                <button onclick="cancelSkuGateScan()" class="sku-gate-cancel-btn">‚úï Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="flash-overlay" id="flash-overlay"></div>
    
    <!-- PHOTO PREVIEW MODAL -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-header">
            <span class="preview-title">Photo Preview</span>
            <span class="preview-badge" id="preview-type">MAIN</span>
            <button class="preview-close" onclick="closePreview()">√ó</button>
        </div>
        <div class="preview-body">
            <button class="preview-nav prev" id="preview-prev" onclick="navigatePreview(-1)">‚Äπ</button>
            <img id="preview-image" class="preview-image" src="" alt="Preview">
            <button class="preview-nav next" id="preview-next" onclick="navigatePreview(1)">‚Ä∫</button>
            <div class="preview-counter" id="preview-counter">1 / 1</div>
        </div>
        <div class="preview-footer">
            <button class="preview-btn preview-btn-delete" onclick="deleteFromPreview()">üóëÔ∏è Delete Photo</button>
            <button class="preview-btn preview-btn-close" onclick="closePreview()">Close</button>
        </div>
    </div>
    
    <div class="desktop-layout">
        <!-- LEFT: Form Panel -->
        <div class="form-panel">
            <div class="floating-timer">
                <div>
                    <div class="timer-label">CURRENT ITEM</div>
                    <div class="timer-main" id="timer-current">0:00</div>
                </div>
                <div class="timer-stats">
                    <div>Avg: <strong id="timer-avg">--</strong></div>
                    <div>Last: <strong id="timer-last">--</strong></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button id="folder-btn" class="folder-btn" onclick="selectSaveFolder()" title="Select folder to auto-save photos">üìÅ No Folder</button>
                    <span id="photographer-badge" class="photographer-badge" onclick="showPinScreen()">P02</span>
                    <span class="version-badge" id="header-version">...</span>
                    <div class="reset-dropdown" id="reset-dropdown">
                        <button class="reset-btn" onclick="toggleResetMenu()" title="Reset options" style="margin-left:4px;">‚Üª</button>
                        <div class="reset-menu" id="reset-menu">
                            <button onclick="resetForm(true); hideResetMenu();">üîÑ Reset (Keep SKU)</button>
                            <button onclick="resetForm(false); hideResetMenu();" style="border-top:1px solid #e2e8f0;">üóëÔ∏è Full Reset (New SKU)</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-dot active" id="dot-1" onclick="goToStep(1)"></div>
                <div class="progress-dot" id="dot-2" onclick="goToStep(2)"></div>
                <div class="progress-dot" id="dot-3" onclick="goToStep(3)"></div>
                <div class="progress-dot" id="dot-4" onclick="goToStep(4)"></div>
                <span class="progress-label" id="step-label">Step 1: Tag</span>
                <span class="category-badge" id="category-label"></span>
                <span class="sku-locked hidden" id="sku-locked-badge"><span class="lock-icon">üîí</span> <span id="sku-locked-value"></span></span>
            </div>
            
            <div class="step-area">
                <!-- STEP 1: TAG -->
                <div id="step-1" class="step-container active">
                    <div class="section-card">
                        <div class="section-label"><span id="check-category" class="check-circle">‚óã</span> What is it?</div>
                        <div class="btn-grid btn-grid-3" style="margin-bottom:12px;">
                            <button onclick="setSuperCategory('tops', this)" class="btn btn-hero super-btn selected"><span class="emoji">üëï</span>TOPS</button>
                            <button onclick="setSuperCategory('bottoms', this)" class="btn btn-secondary super-btn"><span class="emoji">üëñ</span>BOTTOMS</button>
                            <button onclick="setSuperCategory('outer', this)" class="btn btn-secondary super-btn"><span class="emoji">üß•</span>OUTER</button>
                        </div>
                        <div id="sub-categories"></div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-tag" class="check-circle">‚óã</span> Tag Info</div>
                        <button onclick="setTagStatus('has', this)" class="btn btn-default tag-btn" style="width:100%;margin-bottom:8px;">‚úì TAG READABLE</button>
                        <div class="btn-grid btn-grid-2">
                            <button onclick="setTagStatus('worn', this)" class="btn btn-secondary tag-btn">üëÄ Worn/Faded</button>
                            <button onclick="setTagStatus('none', this)" class="btn btn-secondary tag-btn">‚úÇÔ∏è Missing/Cut</button>
                        </div>
                        
                        <!-- Tag Location Help -->
                        <button id="tag-help-btn" onclick="toggleTagLocationHelp()" class="help-btn" style="margin-top:8px;">üîç Need help finding the tag?</button>
                        <div id="tag-location-panel" class="help-panel hidden" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#f59e0b;">
                            <div id="tag-location-content"></div>
                        </div>
                        
                        <div id="tag-details" class="hidden nested-section">
                            <div class="sub-label">Tag Size (What Tag Reads)</div>
                            <div class="btn-grid" style="grid-template-columns: repeat(6, 1fr); margin-bottom:8px;">
                                <button onclick="setSize('XS', this)" class="btn btn-secondary size-btn">XS</button>
                                <button onclick="setSize('S', this)" class="btn btn-secondary size-btn">S</button>
                                <button onclick="setSize('M', this)" class="btn btn-secondary size-btn">M</button>
                                <button onclick="setSize('L', this)" class="btn btn-secondary size-btn">L</button>
                                <button onclick="setSize('XL', this)" class="btn btn-secondary size-btn">XL</button>
                                <button onclick="setSize('XXL', this)" class="btn btn-secondary size-btn">XXL</button>
                            </div>
                            <input type="text" id="tag-size-input" placeholder="Or Type (e.g. 42R, OS, 32x30)" onfocus="clearSizeBtns()" oninput="onSizeInput(this)" class="form-input text-sm text-center" style="margin-bottom:8px;">
                            <div class="sub-label">Origin</div>
                            <div class="btn-grid btn-grid-2" style="margin-bottom:8px;">
                                <button onclick="setOrigin('usa', this)" class="btn btn-default origin-btn"><img src="https://flagcdn.com/w20/us.png" width="20" height="15" alt="US" style="vertical-align:middle;margin-right:4px;">USA MADE</button>
                                <button onclick="setOrigin('import', this)" class="btn btn-secondary origin-btn">üåç Import</button>
                            </div>
                            <div id="country-section" class="hidden">
                                <div class="btn-grid btn-grid-3" style="margin-bottom:6px;">
                                    <button onclick="setCountry('Mexico', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/mx.png" width="20" height="15" alt="MX" style="vertical-align:middle;margin-right:4px;">Mexico</button>
                                    <button onclick="setCountry('Honduras', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/hn.png" width="20" height="15" alt="HN" style="vertical-align:middle;margin-right:4px;">Honduras</button>
                                    <button onclick="setCountry('China', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/cn.png" width="20" height="15" alt="CN" style="vertical-align:middle;margin-right:4px;">China</button>
                                </div>
                                <div class="btn-grid btn-grid-3" style="margin-bottom:6px;">
                                    <button onclick="setCountry('Korea', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/kr.png" width="20" height="15" alt="KR" style="vertical-align:middle;margin-right:4px;">Korea</button>
                                    <button onclick="setCountry('Taiwan', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/tw.png" width="20" height="15" alt="TW" style="vertical-align:middle;margin-right:4px;">Taiwan</button>
                                    <button onclick="setCountry('Philippines', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/ph.png" width="20" height="15" alt="PH" style="vertical-align:middle;margin-right:4px;">Philippines</button>
                                </div>
                                <div class="btn-grid btn-grid-3" style="margin-bottom:6px;">
                                    <button onclick="setCountry('Vietnam', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/vn.png" width="20" height="15" alt="VN" style="vertical-align:middle;margin-right:4px;">Vietnam</button>
                                    <button onclick="setCountry('Bangladesh', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/bd.png" width="20" height="15" alt="BD" style="vertical-align:middle;margin-right:4px;">Bangladesh</button>
                                    <button onclick="setCountry('Other', this)" class="btn btn-secondary country-btn">Other...</button>
                                </div>
                                <input type="text" id="country-other-input" placeholder="Type country name..." class="form-input hidden" style="font-size:12px;" oninput="onCountryOtherInput()">
                            </div>
                            <div class="sub-label">Gender on Tag</div>
                            <div class="btn-grid btn-grid-4" style="margin-bottom:6px;">
                                <button onclick="setGender('Men', this)" class="btn btn-secondary gender-btn">Men's</button>
                                <button onclick="setGender('Women', this)" class="btn btn-secondary gender-btn">Women's</button>
                                <button onclick="setGender('Unisex', this)" class="btn btn-secondary gender-btn">Unisex</button>
                                <button onclick="setGender('None', this)" class="btn btn-secondary gender-btn">None</button>
                            </div>
                            <div class="btn-grid btn-grid-3">
                                <button onclick="setGender('Boys', this)" class="btn btn-secondary gender-btn">Boys</button>
                                <button onclick="setGender('Girls', this)" class="btn btn-secondary gender-btn">Girls</button>
                                <button onclick="setGender('Kids Unisex', this)" class="btn btn-secondary gender-btn">Kids Unisex</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button onclick="goToStep(2)" class="nav-btn nav-btn-next">Next: Check ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 2: CHECK -->
                <div id="step-2" class="step-container">
                    <div class="section-card">
                        <div class="section-label"><span id="check-color" class="check-circle">‚óã</span> Color(s)</div>
                        <div class="sub-label" style="margin-bottom:8px;">Tap all that apply</div>
                        <div class="color-grid">
                            <div class="color-item" onclick="toggleColor('White', this)"><div class="color-swatch" style="background:#ffffff;border:1px solid #ddd;"></div><span>White</span></div>
                            <div class="color-item" onclick="toggleColor('Cream', this)"><div class="color-swatch" style="background:#fffdd0;border:1px solid #ddd;"></div><span>Cream</span></div>
                            <div class="color-item" onclick="toggleColor('Tan', this)"><div class="color-swatch" style="background:#d2b48c;"></div><span>Tan</span></div>
                            <div class="color-item" onclick="toggleColor('Gray', this)"><div class="color-swatch" style="background:#6b7280;"></div><span>Gray</span></div>
                            <div class="color-item" onclick="toggleColor('Black', this)"><div class="color-swatch" style="background:#1a1a1a;"></div><span>Black</span></div>
                            
                            <div class="color-item" onclick="toggleColor('Red', this)"><div class="color-swatch" style="background:#dc2626;"></div><span>Red</span></div>
                            <div class="color-item" onclick="toggleColor('Orange', this)"><div class="color-swatch" style="background:#ea580c;"></div><span>Orange</span></div>
                            <div class="color-item" onclick="toggleColor('Yellow', this)"><div class="color-swatch" style="background:#facc15;"></div><span>Yellow</span></div>
                            <div class="color-item" onclick="toggleColor('Green', this)"><div class="color-swatch" style="background:#16a34a;"></div><span>Green</span></div>
                            <div class="color-item" onclick="toggleColor('Blue', this)"><div class="color-swatch" style="background:#2563eb;"></div><span>Blue</span></div>
                            
                            <div class="color-item" onclick="toggleColor('Navy', this)"><div class="color-swatch" style="background:#1e3a5f;"></div><span>Navy</span></div>
                            <div class="color-item" onclick="toggleColor('Purple', this)"><div class="color-swatch" style="background:#7c3aed;"></div><span>Purple</span></div>
                            <div class="color-item" onclick="toggleColor('Pink', this)"><div class="color-swatch" style="background:#ec4899;"></div><span>Pink</span></div>
                            <div class="color-item" onclick="toggleColor('Brown', this)"><div class="color-swatch" style="background:#78350f;"></div><span>Brown</span></div>
                            <div class="color-item" onclick="toggleColor('Multi', this)"><div class="color-swatch" style="background:linear-gradient(135deg,#ef4444,#f97316,#facc15,#22c55e,#3b82f6,#8b5cf6);"></div><span>Multi</span></div>
                        </div>
                    </div>
                    
                    <!-- FADE -->
                    <div class="section-card">
                        <div class="section-label"><span id="check-fade" class="check-circle">‚óã</span> Fade Level</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="setFade('None', this)" class="btn btn-default fade-btn">None</button>
                            <button onclick="setFade('Light', this)" class="btn btn-secondary fade-btn">Light</button>
                            <button onclick="setFade('Heavy', this)" class="btn btn-secondary fade-btn">Heavy</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-pattern" class="check-circle">‚óã</span> Pattern</div>
                        <!-- Pattern cards grid (rendered dynamically) -->
                        <div id="pattern-cards-grid" class="cards-grid"></div>
                        
                        <!-- Other patterns toggle -->
                        <button onclick="toggleOtherPatterns()" id="other-patterns-toggle" class="sub-label" style="cursor:pointer; color:var(--color-primary);">+ More patterns</button>
                        <div id="pattern-others" class="hidden">
                            <div id="pattern-cards-others" class="cards-grid" style="margin-top:8px;"></div>
                        </div>
                        
                        <!-- Pattern Help Button -->
                        <button id="pattern-help-btn" onclick="togglePatternHelp()" class="help-btn" style="margin-top:8px;">ü§î Still not sure? Answer questions</button>
                        <div id="pattern-help-panel" class="help-panel hidden">
                            <div class="sub-label" style="color:#92400e;">Look at the lines:</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="togglePatternFilter('lines','none',this)" class="filter-btn pattern-filter">No lines</button>
                                <button onclick="togglePatternFilter('lines','stripes',this)" class="filter-btn pattern-filter">Stripes (parallel)</button>
                                <button onclick="togglePatternFilter('lines','grid',this)" class="filter-btn pattern-filter">Grid (crossing)</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">What shapes do you see?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="togglePatternFilter('shapes','none',this)" class="filter-btn pattern-filter">None/Solid</button>
                                <button onclick="togglePatternFilter('shapes','dots',this)" class="filter-btn pattern-filter">Dots</button>
                                <button onclick="togglePatternFilter('shapes','curved',this)" class="filter-btn pattern-filter">Curved</button>
                                <button onclick="togglePatternFilter('shapes','geometric',this)" class="filter-btn pattern-filter">Geometric</button>
                                <button onclick="togglePatternFilter('shapes','blobs',this)" class="filter-btn pattern-filter">Irregular</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">How is it made?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="togglePatternFilter('method','woven',this)" class="filter-btn pattern-filter">Part of fabric</button>
                                <button onclick="togglePatternFilter('method','printed',this)" class="filter-btn pattern-filter">Printed on top</button>
                                <button onclick="togglePatternFilter('method','stitched',this)" class="filter-btn pattern-filter">Stitched/Sewn on</button>
                            </div>
                            <div id="pattern-helper" class="help-text hidden"></div>
                        </div>
                        
                        <!-- Print Type (shows when Graphic selected) -->
                        <div id="print-type-section" class="hidden nested-section" style="margin-top:10px; background:rgba(99,102,241,0.1); border-color:rgba(99,102,241,0.3);">
                            <div class="sub-label" style="color:#4338ca; margin-top:0;">Print Type</div>
                            <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); gap:4px; margin-bottom:4px;">
                                <button onclick="setPrintType('Screen', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Screen</button>
                                <button onclick="setPrintType('Heat', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Heat</button>
                                <button onclick="setPrintType('Puff', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Puff</button>
                                <button onclick="setPrintType('DTG', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">DTG</button>
                                <button onclick="setPrintType('AOP', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">AOP</button>
                            </div>
                            <div class="btn-grid btn-grid-4" style="gap:4px;">
                                <button onclick="setPrintType('Patch', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Patch</button>
                                <button onclick="setPrintType('Painted', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Painted</button>
                                <button onclick="setPrintType('Emb', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Emb</button>
                                <button onclick="setPrintType('Other', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Other</button>
                            </div>
                        </div>
                        
                        <!-- Graphic Category (shows when Graphic selected) -->
                        <div id="graphic-category-section" class="hidden nested-section" style="margin-top:8px; background:rgba(99,102,241,0.05); border-color:rgba(99,102,241,0.2);">
                            <div class="sub-label" style="color:#4338ca; margin-top:0;">Graphic Category</div>
                            <div class="btn-grid btn-grid-4" style="gap:4px; margin-bottom:4px;">
                                <button onclick="setGraphicCategory('Band', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üé∏ Band</button>
                                <button onclick="setGraphicCategory('Movie/TV', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üé¨ Movie/TV</button>
                                <button onclick="setGraphicCategory('Sports', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üèà Sports</button>
                                <button onclick="setGraphicCategory('Brand', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">‚Ñ¢Ô∏è Brand</button>
                            </div>
                            <div class="btn-grid btn-grid-4" style="gap:4px;">
                                <button onclick="setGraphicCategory('Art', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üé® Art</button>
                                <button onclick="setGraphicCategory('Tourist', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üó∫Ô∏è Tourist</button>
                                <button onclick="setGraphicCategory('Humor', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üòÇ Humor</button>
                                <button onclick="setGraphicCategory('Other', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">Other</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-fabric-type" class="check-circle">‚óã</span> Fabric Type</div>
                        <div id="fabric-cards-grid" class="cards-grid"></div>
                        <!-- Other Fabric Types dropdown (eBay fabric types from PDF) -->
                        <select id="fabric-other-select" onchange="onFabricOtherChange()" class="form-select" style="margin-top:8px; font-size:12px;">
                            <option value="" selected>Other fabric types...</option>
                            <option value="Wool">Wool (warm, textured)</option>
                            <option value="Canvas">Canvas (heavy cotton)</option>
                            <option value="Quilted">Quilted (puffy sections)</option>
                            <option value="Velvet">Velvet (plush, soft)</option>
                            <option value="Shearling">Shearling (wool/fur lined)</option>
                            <option value="Felt">Felt (pressed wool)</option>
                            <option value="Taffeta">Taffeta (crisp, shiny)</option>
                            <option value="Moleskin">Moleskin (soft brushed)</option>
                            <option value="Ponte">Ponte (stretchy dress)</option>
                            <option value="Lace">Lace (openwork)</option>
                            <option value="Georgette">Georgette (sheer crepe)</option>
                            <option value="Crepe">Crepe (textured, crinkly)</option>
                            <option value="Chiffon">Chiffon (sheer, flowy)</option>
                            <option value="Satin">Satin (shiny, smooth)</option>
                            <option value="Gauze">Gauze (lightweight, airy)</option>
                            <option value="Corduroy">Corduroy (vertical ridges)</option>
                            <option value="Softshell">Softshell (tech outdoor)</option>
                            <option value="Cannot Determine">Cannot Determine</option>
                            <option value="Custom">Custom (type below)...</option>
                        </select>
                        <input type="text" id="fabric-custom-input" placeholder="Type custom fabric type..." class="form-input hidden" style="margin-top:6px; font-size:12px;" oninput="onFabricCustomInput()">
                        <!-- Denim Wash (shows when denim selected) -->
                        <div id="wash-section" class="hidden nested-section" style="margin-top:10px;">
                            <div class="sub-label" style="color:#0369a1;">Denim Wash</div>
                            <div class="btn-grid btn-grid-4">
                                <button onclick="setWash('Light', this)" class="btn btn-secondary wash-btn">Light</button>
                                <button onclick="setWash('Medium', this)" class="btn btn-secondary wash-btn">Medium</button>
                                <button onclick="setWash('Dark', this)" class="btn btn-default wash-btn">Dark</button>
                                <button onclick="setWash('Raw', this)" class="btn btn-secondary wash-btn">Raw</button>
                                <button onclick="setWash('Acid', this)" class="btn btn-secondary wash-btn">Acid</button>
                                <button onclick="setWash('Stone', this)" class="btn btn-secondary wash-btn">Stone</button>
                                <button onclick="setWash('Rinse', this)" class="btn btn-secondary wash-btn">Rinse</button>
                                <button onclick="setWash('Black', this)" class="btn btn-secondary wash-btn">Black</button>
                            </div>
                        </div>
                        <button id="fabric-help-btn" onclick="toggleFabricHelp()" class="help-btn" style="margin-top:8px;">ü§î Not Sure?</button>
                        <div id="fabric-help-panel" class="help-panel hidden">
                            <div class="sub-label" style="color:#92400e;">How does it feel?</div>
                            <div class="filter-row">
                                <button onclick="toggleFabricFilter('stretch','none',this)" class="filter-btn fabric-filter">Rigid</button>
                                <button onclick="toggleFabricFilter('stretch','high',this)" class="filter-btn fabric-filter">Stretchy</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">Surface look/feel?</div>
                            <div class="filter-row">
                                <button onclick="toggleFabricFilter('surface','smooth',this)" class="filter-btn fabric-filter">Smooth</button>
                                <button onclick="toggleFabricFilter('surface','diagonal',this)" class="filter-btn fabric-filter">Diagonal lines</button>
                                <button onclick="toggleFabricFilter('surface','ridged',this)" class="filter-btn fabric-filter">Ridges</button>
                                <button onclick="toggleFabricFilter('surface','rough',this)" class="filter-btn fabric-filter">Rough/Textured</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">Inside texture?</div>
                            <div class="filter-row">
                                <button onclick="toggleFabricFilter('interior','smooth',this)" class="filter-btn fabric-filter">Smooth</button>
                                <button onclick="toggleFabricFilter('interior','fuzzy',this)" class="filter-btn fabric-filter">Fuzzy/Soft</button>
                                <button onclick="toggleFabricFilter('interior','loops',this)" class="filter-btn fabric-filter">Tiny Loops</button>
                            </div>
                            <div id="fabric-helper" class="help-text hidden"></div>
                        </div>
                        <!-- TAG CUT MODE: Expanded trait section (shows when tag missing/cut) -->
                        <div id="fabric-tag-cut-section" class="hidden" style="background:#fef2f2; border:2px solid #fca5a5; border-radius:10px; padding:12px; margin-top:10px;">
                            <div style="font-size:12px; font-weight:700; color:#b91c1c; margin-bottom:8px;">‚ö†Ô∏è NO TAG - Answer these questions (mandatory)</div>
                            <div class="sub-label" style="color:#991b1b;">How does it feel?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleFabricFilter('stretch','none',this)" class="filter-btn fabric-filter tagcut-btn">Rigid</button>
                                <button onclick="toggleFabricFilter('stretch','high',this)" class="filter-btn fabric-filter tagcut-btn">Stretchy</button>
                            </div>
                            <div class="sub-label" style="color:#991b1b;">Surface look/feel?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleFabricFilter('surface','smooth',this)" class="filter-btn fabric-filter tagcut-btn">Smooth</button>
                                <button onclick="toggleFabricFilter('surface','diagonal',this)" class="filter-btn fabric-filter tagcut-btn">Diagonal</button>
                                <button onclick="toggleFabricFilter('surface','ridged',this)" class="filter-btn fabric-filter tagcut-btn">Ridges</button>
                                <button onclick="toggleFabricFilter('surface','rough',this)" class="filter-btn fabric-filter tagcut-btn">Rough</button>
                            </div>
                            <div class="sub-label" style="color:#991b1b;">Inside texture?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleFabricFilter('interior','smooth',this)" class="filter-btn fabric-filter tagcut-btn">Smooth</button>
                                <button onclick="toggleFabricFilter('interior','fuzzy',this)" class="filter-btn fabric-filter tagcut-btn">Fuzzy</button>
                                <button onclick="toggleFabricFilter('interior','loops',this)" class="filter-btn fabric-filter tagcut-btn">Loops</button>
                            </div>
                            <div id="fabric-helper-tagcut" class="help-text"></div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-material" class="check-circle">‚óã</span> Material <span style="font-weight:400;color:var(--color-text-muted);font-size:11px;">(select all that apply)</span></div>
                        <div id="material-tag-warning" class="tag-warning hidden">‚ö†Ô∏è No readable tag ‚Äî use touch tests</div>
                        <div id="material-cards-grid" class="cards-grid"></div>
                        <!-- Other Materials dropdown -->
                        <select id="material-other-select" onchange="onMaterialOtherChange()" class="form-select" style="margin-top:8px; font-size:12px;">
                            <option value="" selected>Other materials...</option>
                            <option value="Mohair">Mohair (fuzzy, luxe)</option>
                            <option value="Alpaca">Alpaca (soft, warm)</option>
                            <option value="Cashmere">Cashmere (luxury)</option>
                            <option value="Linen">Linen (breathable)</option>
                            <option value="Silk">Silk (shiny, luxe)</option>
                            <option value="Fur">Fur (real or faux)</option>
                            <option value="Canvas">Canvas (heavy cotton)</option>
                            <option value="Leather">Leather (real)</option>
                            <option value="Cannot Determine">Cannot Determine</option>
                            <option value="Custom">Custom (type below)...</option>
                        </select>
                        <input type="text" id="material-custom-input" placeholder="Type custom material..." class="form-input hidden" style="margin-top:6px; font-size:12px;" oninput="onMaterialCustomInput()">
                        <button id="material-help-btn" onclick="toggleMaterialHelp()" class="help-btn">ü§î Not Sure?</button>
                        <div id="material-help-panel" class="help-panel hidden">
                            <div class="sub-label" style="color:#92400e;">Temperature?</div>
                            <div class="filter-row">
                                <button onclick="toggleMaterialFilter('temp','cool',this)" class="filter-btn material-filter">Cool</button>
                                <button onclick="toggleMaterialFilter('temp','warm',this)" class="filter-btn material-filter">Warm</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">Shine?</div>
                            <div class="filter-row">
                                <button onclick="toggleMaterialFilter('shine','matte',this)" class="filter-btn material-filter">Matte</button>
                                <button onclick="toggleMaterialFilter('shine','sheen',this)" class="filter-btn material-filter">Sheen</button>
                            </div>
                            <div id="material-helper" class="help-text hidden"></div>
                        </div>
                        <!-- TAG CUT MODE: Expanded material trait section (shows when tag missing/cut) -->
                        <div id="material-tag-cut-section" class="hidden" style="background:#fef2f2; border:2px solid #fca5a5; border-radius:10px; padding:12px; margin-top:10px;">
                            <div style="font-size:12px; font-weight:700; color:#b91c1c; margin-bottom:8px;">‚ö†Ô∏è NO TAG - Answer these questions (mandatory)</div>
                            <div class="sub-label" style="color:#991b1b;">Touch it - Temperature?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleMaterialFilter('temp','cool',this)" class="filter-btn material-filter tagcut-btn">Cool (natural fibers)</button>
                                <button onclick="toggleMaterialFilter('temp','warm',this)" class="filter-btn material-filter tagcut-btn">Warm (synthetics)</button>
                            </div>
                            <div class="sub-label" style="color:#991b1b;">Look at it - Shine?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleMaterialFilter('shine','matte',this)" class="filter-btn material-filter tagcut-btn">Matte (no shine)</button>
                                <button onclick="toggleMaterialFilter('shine','sheen',this)" class="filter-btn material-filter tagcut-btn">Sheen (some shine)</button>
                            </div>
                            <div id="material-helper-tagcut" class="help-text"></div>
                        </div>
                    </div>
                    
                    <div class="section-card" id="construction-section">
                        <div class="section-label"><span id="check-construction" class="check-circle">‚óã</span> Construction</div>
                        
                        <!-- TOPS/OUTER Construction: Sleeves -->
                        <div id="tops-construction">
                            <div class="sub-label">Sleeve Length</div>
                            <div class="btn-grid btn-grid-4" style="margin-bottom:10px;">
                                <button onclick="setSleeve('Short', this)" class="btn btn-default sleeve-btn">Short</button>
                                <button onclick="setSleeve('Long', this)" class="btn btn-secondary sleeve-btn">Long</button>
                                <button onclick="setSleeve('3/4', this)" class="btn btn-secondary sleeve-btn">3/4</button>
                                <button onclick="setSleeve('None', this)" class="btn btn-secondary sleeve-btn">None</button>
                            </div>
                            <div id="sleeve-style-section">
                                <div class="sub-label">Sleeve Style</div>
                                <div class="btn-grid btn-grid-3" style="margin-bottom:10px;">
                                    <button onclick="setSleeveStyle('Standard', this)" class="btn btn-default style-btn">Standard</button>
                                    <button onclick="setSleeveStyle('Raglan', this)" class="btn btn-secondary style-btn">Raglan</button>
                                    <button onclick="setSleeveStyle('Dolman', this)" class="btn btn-secondary style-btn">Dolman</button>
                                </div>
                                <!-- Raglan/Dolman Measurement Notice -->
                                <div id="sleeve-measurement-notice" class="hidden" style="background:#fef3c7; border:1px solid #f59e0b; border-radius:10px; padding:10px; margin-bottom:10px;">
                                    <div style="display:flex; align-items:flex-start; gap:8px;">
                                        <span style="font-size:18px;">üìè</span>
                                        <div>
                                            <div style="font-size:11px; font-weight:700; color:#92400e;">Special Sleeve Measurement</div>
                                            <div style="font-size:10px; color:#b45309; margin-top:4px;">
                                                <strong>No shoulder seam exists!</strong><br>
                                                Measure: <strong>Center of neck ‚Üí Cuff</strong><br>
                                                (Not shoulder to cuff)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Cutoff Section (shows when Sleeve = None on T-Shirts) -->
                            <div id="cutoff-section" class="hidden nested-section nested-amber" style="margin-bottom:10px;">
                                <div class="sub-label" style="color:#92400e; margin-top:0;">üî™ Cut-off / Muscle Tee?</div>
                                <div class="btn-grid btn-grid-2" style="margin-bottom:8px;">
                                    <button onclick="setCutoff('diy', this)" class="btn btn-secondary cutoff-btn" style="display:flex; flex-direction:column; align-items:center; padding:12px 8px;">
                                        <span style="font-size:20px;">‚úÇÔ∏è</span>
                                        <span style="font-size:11px; font-weight:700;">DIY Cut-off</span>
                                        <span style="font-size:9px; color:#666;">Sleeves removed</span>
                                    </button>
                                    <button onclick="setCutoff('manufactured', this)" class="btn btn-secondary cutoff-btn" style="display:flex; flex-direction:column; align-items:center; padding:12px 8px;">
                                        <span style="font-size:20px;">üè≠</span>
                                        <span style="font-size:11px; font-weight:700;">Manufactured</span>
                                        <span style="font-size:9px; color:#666;">Made sleeveless</span>
                                    </button>
                                </div>
                                <div style="font-size:10px; color:#92400e;">üí° This stays categorized as T-Shirt for searchability</div>
                            </div>
                            <div id="stitch-section">
                                <div class="sub-label">Stitch Type</div>
                                <div class="btn-grid btn-grid-2">
                                    <button onclick="setStitch('Single', this)" class="btn btn-secondary stitch-btn">Single Stitch</button>
                                    <button onclick="setStitch('Double', this)" class="btn btn-default stitch-btn">Double Stitch</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BOTTOMS Construction: Leg Style -->
                        <div id="bottoms-construction" class="hidden">
                            <div class="sub-label">Leg Style / Cut</div>
                            <div class="btn-grid btn-grid-4" style="margin-bottom:8px;">
                                <button onclick="setLegStyle('Straight', this)" class="btn btn-default leg-btn">Straight</button>
                                <button onclick="setLegStyle('Bootcut', this)" class="btn btn-secondary leg-btn">Bootcut</button>
                                <button onclick="setLegStyle('Relaxed', this)" class="btn btn-secondary leg-btn">Relaxed</button>
                                <button onclick="setLegStyle('Tapered', this)" class="btn btn-secondary leg-btn">Tapered</button>
                            </div>
                            <div class="btn-grid btn-grid-4" style="margin-bottom:8px;">
                                <button onclick="setLegStyle('Skinny', this)" class="btn btn-secondary leg-btn">Skinny</button>
                                <button onclick="setLegStyle('Wide Leg', this)" class="btn btn-secondary leg-btn">Wide Leg</button>
                                <button onclick="setLegStyle('Flare', this)" class="btn btn-secondary leg-btn">Flare</button>
                                <button onclick="setLegStyle('Baggy', this)" class="btn btn-secondary leg-btn">Baggy</button>
                            </div>
                            <div class="btn-grid btn-grid-3" style="margin-bottom:10px;">
                                <button onclick="setLegStyle('Capri', this)" class="btn btn-secondary leg-btn">Capri</button>
                                <button onclick="setLegStyle('Jogger', this)" class="btn btn-secondary leg-btn">Jogger</button>
                                <button onclick="setLegStyle('Cargo', this)" class="btn btn-secondary leg-btn">Cargo</button>
                            </div>
                            
                            <!-- Leg Style Help -->
                            <button id="leg-help-btn" onclick="toggleLegStyleHelp()" class="help-btn">ü§î Not sure? See examples</button>
                            <div id="leg-style-help" class="help-panel hidden" style="background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-color:#3b82f6;">
                                <div style="font-weight:700;color:#1e40af;margin-bottom:8px;font-size:12px;">üëñ Leg Style Guide</div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:10px;">
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Straight</strong><br>Same width hip to ankle
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Bootcut</strong><br>Slight flare below knee for boots
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Relaxed</strong><br>Loose through thigh, straight leg
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Tapered</strong><br>Wider at thigh, narrow at ankle
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Skinny</strong><br>Tight from hip to ankle
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Wide Leg</strong><br>Wide from hip to ankle
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Flare</strong><br>Dramatic flare from knee down (70s)
                                    </div>
                                    <div style="background:white;padding:6px;border-radius:6px;">
                                        <strong>Baggy</strong><br>Very loose/oversized throughout
                                    </div>
                                </div>
                                <div style="margin-top:8px;font-size:10px;color:#1e40af;">
                                    üí° <strong>Quick test:</strong> Lay flat, measure thigh width vs ankle opening. If ankle is smaller = tapered, same = straight, wider = bootcut/flare
                                </div>
                            </div>
                            
                            <!-- Rise (for jeans/pants) -->
                            <div class="sub-label" style="margin-top:10px;">Rise</div>
                            <div class="btn-grid btn-grid-3">
                                <button onclick="setRise('Low', this)" class="btn btn-secondary rise-btn">Low Rise</button>
                                <button onclick="setRise('Mid', this)" class="btn btn-default rise-btn">Mid Rise</button>
                                <button onclick="setRise('High', this)" class="btn btn-secondary rise-btn">High Rise</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-feel" class="check-circle">‚óã</span> Feel</div>
                        <div class="sub-label">Thickness</div>
                        <div class="btn-grid btn-grid-4" style="margin-bottom:10px;">
                            <button onclick="setThickness('Paper', this)" class="btn btn-secondary thickness-btn">Paper</button>
                            <button onclick="setThickness('Light', this)" class="btn btn-secondary thickness-btn">Light</button>
                            <button onclick="setThickness('Standard', this)" class="btn btn-default thickness-btn">Standard</button>
                            <button onclick="setThickness('Heavy', this)" class="btn btn-secondary thickness-btn">Heavy</button>
                        </div>
                        <div class="sub-label">Layers</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="setLayers('Single', this)" class="btn btn-default layers-btn">Single</button>
                            <button onclick="setLayers('Reversible', this)" class="btn btn-secondary layers-btn">Reversible</button>
                            <button onclick="setLayers('Lined', this)" class="btn btn-secondary layers-btn">Lined</button>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button onclick="goToStep(1)" class="nav-btn nav-btn-back">‚Üê Back</button>
                        <button onclick="goToStep(3)" class="nav-btn nav-btn-next">Next: Snap ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 3: SNAP & SEND -->
                <div id="step-3" class="step-container">
                    <div class="section-card">
                        <div class="section-label"><span id="check-condition" class="check-circle">‚óã</span> Any Issues?</div>
                        <button onclick="setClean(this)" id="btn-clean" class="btn btn-default" style="width:100%;margin-bottom:10px;padding:14px;">‚úì No Defects</button>
                        <div class="sub-label">Or tap defect type:</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="toggleDefect('Stain', this)" class="btn btn-secondary defect-type-btn defect-card"><span class="emoji">üíß</span><span class="label">Stain</span></button>
                            <button onclick="toggleDefect('Hole', this)" class="btn btn-secondary defect-type-btn defect-card"><span class="emoji">üï≥Ô∏è</span><span class="label">Hole</span></button>
                            <button onclick="toggleDefect('Repair', this)" class="btn btn-secondary defect-type-btn defect-card"><span class="emoji">üßµ</span><span class="label">Repair</span></button>
                        </div>
                    </div>
                    
                    <!-- ELASTIC CHECK (shows for Sweatpants) -->
                    <div id="elastic-section" class="section-card hidden">
                        <div class="section-label">ü©≤ Elastic Check</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="setElastic('Solid', this)" class="btn btn-secondary elastic-btn" style="display:flex;flex-direction:column;align-items:center;padding:12px;">
                                <span style="font-size:18px;">üü¢</span>
                                <span style="font-size:11px;font-weight:700;">SOLID</span>
                                <span style="font-size:9px;color:#666;">(springy)</span>
                            </button>
                            <button onclick="setElastic('Crunchy', this)" class="btn btn-secondary elastic-btn" style="display:flex;flex-direction:column;align-items:center;padding:12px;">
                                <span style="font-size:18px;">üü°</span>
                                <span style="font-size:11px;font-weight:700;">CRUNCHY</span>
                                <span style="font-size:9px;color:#666;">(worn)</span>
                            </button>
                            <button onclick="setElastic('None', this)" class="btn btn-secondary elastic-btn" style="display:flex;flex-direction:column;align-items:center;padding:12px;">
                                <span style="font-size:18px;">‚¨ú</span>
                                <span style="font-size:11px;font-weight:700;">NO ELASTIC</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-weight" class="check-circle">‚óã</span> ‚öñÔ∏è Weight</div>
                        <div class="btn-grid btn-grid-2">
                            <select id="weight-lb" onchange="updateWeight()" class="form-select" style="font-size:16px;font-weight:700;">
                                <option value="0" selected>0 lb</option>
                                <option value="1">1 lb</option>
                                <option value="2">2 lb</option>
                                <option value="3">3 lb</option>
                                <option value="4">4 lb</option>
                                <option value="5">5 lb</option>
                            </select>
                            <select id="weight-oz" onchange="updateWeight()" class="form-select" style="font-size:16px;font-weight:700;">
                                <option value="0" selected>0 oz</option>
                                <option value="3">3 oz</option>
                                <option value="4">4 oz</option>
                                <option value="5">5 oz</option>
                                <option value="6">6 oz</option>
                                <option value="7">7 oz</option>
                                <option value="8">8 oz</option>
                                <option value="9">9 oz</option>
                                <option value="10">10 oz</option>
                                <option value="11">11 oz</option>
                                <option value="12">12 oz</option>
                                <option value="13">13 oz</option>
                                <option value="14">14 oz</option>
                                <option value="15">15 oz</option>
                            </select>
                        </div>
                        <div style="margin-top:8px;font-size:11px;color:var(--color-text-muted);">‚¨ÜÔ∏è <strong>Always round up</strong></div>
                    </div>
                    
                    <!-- AUDIO MEASUREMENTS -->
                    <div class="section-card">
                        <div class="section-label"><span id="check-audio" class="check-circle">‚óã</span> üé§ Measurements</div>
                        <!-- Category-specific measurement hints -->
                        <div id="measure-hint-tops" class="nested-section" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div id="measure-tops-standard" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Shoulder to shoulder<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br>6. Sleeve (shoulder to cuff)</div>
                            <div id="measure-tops-raglan" class="hidden" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. <strong style="color:#7c3aed;">Center neck to cuff</strong> ‚≠ê<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br>6. <strong style="color:#7c3aed;">Sleeve (pit to cuff)</strong> ‚≠ê</div>
                            <div id="measure-tops-sleeveless" class="hidden" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Shoulder to shoulder<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br><span style="color:#64748b;font-style:italic;">(No sleeve - sleeveless)</span></div>
                        </div>
                        <div id="measure-hint-button-shirt" class="nested-section hidden" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div id="measure-button-standard" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. <strong>Neck circumference</strong> (collar button to button)<br>2. Shoulder to shoulder<br>3. Pit to pit chest<br>4. Waist<br>5. Bottom hem<br>6. Length (back of collar to hem)<br>7. Sleeve (shoulder to cuff)</div>
                            <div id="measure-button-raglan" class="hidden" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. <strong>Neck circumference</strong> (collar button to button)<br>2. <strong style="color:#7c3aed;">Center neck to cuff</strong> ‚≠ê<br>3. Pit to pit chest<br>4. Waist<br>5. Bottom hem<br>6. Length (back of collar to hem)<br>7. <strong style="color:#7c3aed;">Sleeve (pit to cuff)</strong> ‚≠ê</div>
                            <div id="measure-button-sleeveless" class="hidden" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. <strong>Neck circumference</strong> (collar button to button)<br>2. Shoulder to shoulder<br>3. Pit to pit chest<br>4. Waist<br>5. Bottom hem<br>6. Length (back of collar to hem)<br><span style="color:#64748b;font-style:italic;">(No sleeve - sleeveless)</span></div>
                        </div>
                        <div id="measure-hint-bottoms" class="nested-section hidden" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Waist (flat across)<br>2. Rise (crotch to top)<br>3. Inseam (crotch to hem)<br>4. Thigh (at crotch)<br>5. Leg opening<br>6. Total length (waist to hem)</div>
                        </div>
                        <div id="measure-hint-outer" class="nested-section hidden" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div id="measure-outer-standard" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Shoulder to shoulder<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br>6. Sleeve (shoulder to cuff)</div>
                            <div id="measure-outer-raglan" class="hidden" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. <strong style="color:#7c3aed;">Center neck to cuff</strong> ‚≠ê<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br>6. <strong style="color:#7c3aed;">Sleeve (pit to cuff)</strong> ‚≠ê</div>
                            <div id="measure-outer-sleeveless" class="hidden" style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Shoulder to shoulder<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br><span style="color:#64748b;font-style:italic;">(No sleeve - vest)</span></div>
                        </div>
                        <div id="record-section">
                            <button id="record-btn" onclick="toggleRecording()" class="btn btn-hero" style="width:100%;background:#ef4444;padding:16px;display:flex;flex-direction:column;align-items:center;gap:4px;">
                                <span style="font-size:24px;">üé§</span>
                                <span>TAP TO RECORD</span>
                            </button>
                        </div>
                        <div id="post-record-section" class="hidden">
                            <div class="nested-section" style="background:#f0fdf4;border-color:#86efac;text-align:center;margin-bottom:8px;">
                                <div style="color:#16a34a;font-weight:700;font-size:14px;">‚úì RECORDED</div>
                                <div style="color:#22c55e;font-family:monospace;font-size:18px;" id="recording-duration">0:00</div>
                            </div>
                            <button onclick="reRecord()" style="width:100%;padding:8px;background:none;border:none;color:var(--color-text-muted);font-size:12px;text-decoration:underline;cursor:pointer;">Re-record</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-sku" class="check-circle">‚óã</span> SKU</div>
                        <!-- Locked SKU Display (shown after SKU gate) -->
                        <div id="sku-locked-display" class="hidden" style="display:flex;align-items:center;gap:12px;">
                            <div style="flex:1;padding:14px;background:#f0fdf4;border:2px solid #22c55e;border-radius:10px;font-family:monospace;font-size:20px;font-weight:700;color:#16a34a;text-align:center;" id="sku-display-value"></div>
                            <button onclick="unlockSku()" style="padding:10px 14px;background:#f1f5f9;border:none;border-radius:8px;font-size:11px;color:#64748b;cursor:pointer;" title="Edit SKU">‚úèÔ∏è Edit</button>
                        </div>
                        <!-- Manual SKU Input (hidden after SKU gate, shown if editing) -->
                        <div id="sku-manual-input" class="hidden">
                            <div class="sku-row">
                                <input type="text" id="sku-input" class="form-input" placeholder="Scan or type SKU..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" oninput="onSkuInput()" onkeydown="handleSkuKeydown(event)" style="font-size:18px;font-family:monospace;">
                                <button onclick="activateSkuScan()" class="scan-btn" title="Scan with C922X camera">üì∑</button>
                            </div>
                            <div id="sku-status" style="font-size:10px;color:var(--color-text-muted);margin-top:4px;"></div>
                            <div id="sku-camera-status" style="font-size:10px;color:#16a34a;margin-top:4px;display:none;">üì∑ C922X active - scan barcode now</div>
                        </div>
                    </div>
                    
                    <!-- FLAG AS UNUSUAL -->
                    <button id="flag-btn" onclick="toggleFlagUnusual()" class="flag-unusual-btn">
                        <div style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;">
                            <span>ü§î</span>
                            <span>FLAG AS UNUSUAL</span>
                        </div>
                        <div style="font-size:10px;font-weight:normal;margin-top:4px;opacity:0.8;">
                            Brand you don't recognize ‚Ä¢ Special construction ‚Ä¢ Gut feeling
                        </div>
                    </button>
                    
                    <div class="nav-buttons">
                        <button onclick="goToStep(2)" class="nav-btn nav-btn-back">‚Üê Back</button>
                        <button onclick="goToStep(4)" class="nav-btn nav-btn-next" style="flex:2;">Next: Review ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 4: REVIEW -->
                <div id="step-4" class="step-container">
                    <div class="review-banner">‚ú® Almost done! Quick review</div>
                    
                    <div class="review-grid">
                        <div id="card-tag" onclick="goToStep(1)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-tag">‚ö†Ô∏è</span>
                                <span class="title">TAG</span>
                            </div>
                            <div class="review-card-summary" id="summary-tag">--</div>
                        </div>
                        <div id="card-check" onclick="goToStep(2)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-check">‚ö†Ô∏è</span>
                                <span class="title">CHECK</span>
                            </div>
                            <div class="review-card-summary" id="summary-check">--</div>
                        </div>
                        <div id="card-snap" onclick="goToStep(3)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-snap">‚ö†Ô∏è</span>
                                <span class="title">SNAP</span>
                            </div>
                            <div class="review-card-summary" id="summary-snap">--</div>
                        </div>
                        <div id="card-weight" onclick="goToStep(3)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-weight">‚ö†Ô∏è</span>
                                <span class="title">WEIGHT</span>
                            </div>
                            <div class="review-card-summary" id="summary-weight">--</div>
                        </div>
                    </div>
                    
                    <div id="flag-status" class="flag-banner hidden">üö© FLAGGED FOR REVIEW</div>
                    
                    <button id="submit-btn" class="submit-btn" onclick="submitItem()" disabled>SUBMIT ‚úì</button>
                    
                    <div class="nav-buttons" style="border-top:none;padding-top:8px;">
                        <button onclick="goToStep(3)" class="nav-btn nav-btn-back" style="flex:1;">‚Üê Back</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CENTER: Camera -->
        <div class="camera-panel">
            <div class="camera-header">
                <select id="camera-select" class="camera-select" onchange="switchCamera(this.value)"><option value="">Select Camera...</option></select>
                <span id="camera-indicator" style="background:#3b82f6;color:white;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;">üì¶ BRIO 4K</span>
                <span id="camera-resolution" style="color:#6b7280;font-size:10px;font-family:monospace;">--</span>
                <button class="fullres-btn" onclick="forceMaxResolution()" title="Click to force maximum resolution">FULL RES</button>
                <div id="camera-status" class="camera-status">No camera</div>
            </div>
            <div class="camera-view">
                <div class="camera-view-container">
                    <div class="camera-placeholder" id="camera-placeholder">
                        <div class="camera-placeholder-icon">üì∑</div>
                        <div>Select a camera to begin</div>
                        <div style="font-size:11px;margin-top:6px;color:#555;">Logitech Brio 4K DCI (4096√ó2160)</div>
                    </div>
                    <video id="camera-video" autoplay playsinline style="display:none;"></video>
                    <div class="camera-overlay" id="camera-overlay">
                        <!-- Stabilizer Indicator -->
                        <div class="stabilizer-indicator" id="stabilizer-indicator">
                            <div class="stabilizer-dot" id="stabilizer-dot"></div>
                            <span class="stabilizer-text" id="stabilizer-text">HOLD STEADY</span>
                        </div>
                    </div>
                    <!-- Defect Markers Layer -->
                    <div class="defect-markers-layer" id="defect-markers-layer" onclick="handleDefectClick(event)"></div>
                    <!-- Defect Mode Banner -->
                    <div class="defect-mode-banner" id="defect-mode-banner">
                        <span>üéØ Click to mark defects</span>
                        <span class="marker-count" id="marker-count">0</span>
                    </div>
                    
                    <!-- Defect Close-up Link Panel -->
                    <div class="closeup-link-panel" id="defect-link-panel">
                        <span style="font-weight:600;">Link to defect:</span>
                        <div class="link-buttons" id="defect-link-buttons"></div>
                        <button onclick="selectedDefectLink=null;updateDefectLinkPanel()" class="link-btn-none">None</button>
                    </div>
                    
                    <!-- Feature Type Panel -->
                    <div class="closeup-link-panel" id="feature-type-panel" style="background:rgba(124,58,237,0.95);">
                        <span style="font-weight:600;">Feature type:</span>
                        <div class="link-buttons" id="feature-type-buttons">
                            <button onclick="selectFeatureType('Zipper')" class="feature-type-btn">Zipper</button>
                            <button onclick="selectFeatureType('Button')" class="feature-type-btn">Button</button>
                            <button onclick="selectFeatureType('Label')" class="feature-type-btn">Label</button>
                            <button onclick="selectFeatureType('Stitch')" class="feature-type-btn">Stitch</button>
                            <button onclick="selectFeatureType('Hardware')" class="feature-type-btn">Hardware</button>
                            <button onclick="selectFeatureType('Print')" class="feature-type-btn">Print</button>
                            <button onclick="selectFeatureType('Other')" class="feature-type-btn">Other</button>
                        </div>
                        <button onclick="selectedFeatureType=null;updateFeatureTypePanel()" class="link-btn-none">None</button>
                    </div>
                </div>
            </div>
            <div class="camera-footer">
                <button class="mode-btn active" id="mode-main" onclick="setPhotoMode('main')">üì¶ Main<br><small style="font-size:9px;opacity:0.7;">Brio 4K</small></button>
                <div style="text-align:center;">
                    <button class="shutter-btn" id="shutter-btn" onclick="capturePhoto()"></button>
                    <div class="shutter-hint">Press <kbd>SPACE</kbd> or foot pedal</div>
                </div>
                <button class="mode-btn" id="mode-tag" onclick="setPhotoMode('tag')">üè∑Ô∏è Tag<br><small style="font-size:9px;opacity:0.7;">C922X</small></button>
                <button class="mode-btn" id="mode-defect-closeup" onclick="setPhotoMode('defect-closeup')" style="background:#dc2626;border-color:#dc2626;">üî¥ Defect<br><small style="font-size:9px;opacity:0.7;">C922X</small></button>
                <button class="mode-btn" id="mode-features" onclick="setPhotoMode('features')" style="background:#7c3aed;border-color:#7c3aed;">‚ú® Features<br><small style="font-size:9px;opacity:0.7;">C922X</small></button>
            </div>
        </div>
        
        <!-- RIGHT: Photos -->
        <div class="photos-panel">
            <div class="photos-header"><span>Photos</span><span class="photo-count" id="photo-count">0</span></div>
            <div style="font-size:9px;color:var(--color-text-muted);margin-bottom:12px;">Double-click to preview</div>
            <div class="photo-section">
                <div class="photo-section-title"><span>Main Photos</span><span id="main-count">0</span></div>
                <div class="photo-grid" id="main-photos-grid"><div class="photo-thumb photo-thumb-empty" onclick="setPhotoMode('main')">+</div></div>
            </div>
            <div class="photo-section">
                <div class="photo-section-title"><span>Tag Photos</span><span id="tag-count">0</span></div>
                <div class="photo-grid" id="tag-photos-grid"><div class="photo-thumb square photo-thumb-empty" onclick="setPhotoMode('tag')">+</div></div>
            </div>
            <div class="photo-section">
                <div class="photo-section-title"><span>Defects (Main)</span><span id="defect-count">0</span></div>
                <div class="photo-grid" id="defect-photos-grid"><div class="photo-thumb square photo-thumb-empty" onclick="setPhotoMode('main')" title="Defects marked on main photos">+</div></div>
            </div>
            <div class="photo-section">
                <div class="photo-section-title" style="color:#dc2626;"><span>üî¥ Defect Close-ups</span><span id="defect-closeup-count" style="background:#dc2626;color:white;">0</span></div>
                <div class="photo-grid" id="defect-closeup-photos-grid"><div class="photo-thumb square photo-thumb-empty" onclick="setPhotoMode('defect-closeup')" title="Close-up photos of defects with C922X" style="border-color:#dc2626;">+</div></div>
            </div>
            <div class="photo-section">
                <div class="photo-section-title" style="color:#7c3aed;"><span>‚ú® Feature Close-ups</span><span id="features-count" style="background:#7c3aed;color:white;">0</span></div>
                <div class="photo-grid" id="features-photos-grid"><div class="photo-thumb square photo-thumb-empty" onclick="setPhotoMode('features')" title="Special features: zippers, buttons, codes, copyright" style="border-color:#7c3aed;">+</div></div>
            </div>
            <div class="stats-section">
                <div style="font-size:10px;color:var(--color-text-muted);font-weight:700;margin-bottom:8px;">Today's Stats</div>
                <div class="stats-grid">
                    <div><div class="stat-value" style="color:var(--color-primary)" id="stat-today">0</div><div class="stat-label">Today</div></div>
                    <div><div class="stat-value" style="color:var(--color-success)" id="stat-week">0</div><div class="stat-label">Week</div></div>
                    <div><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total</div></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Barcode Scanning Library -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        // ============ VERSION - UPDATE THIS ONE PLACE ONLY ============
        const VERSION = "v99.70";
        // ===============================================================
        
        const APP_PIN = "1234";
        const N8N_WEBHOOK_URL = "https://jeffkoga.app.n8n.cloud/webhook/0845a6d3-be69-4b68-aba7-28f55112678c";
        let data = { superCategory:'tops', category:'', tagStatus:'', tagSize:'', origin:'', country:'', gender:'', colors:[], fade:'', pattern:'', patternTraits:{lines:'',shapes:'',method:''}, printType:'', graphicCategory:'', fabricType:'', fabricTraits:{stretch:'',surface:'',interior:''}, wash:'', materials:[], materialTraits:{temp:'',shine:''}, sleeveLength:'', sleeveStyle:'', cutoffType:'', stitch:'', legStyle:'', rise:'', thickness:'', layers:'', hasDefects:null, defectTypes:[], weightLb:0, weightOz:0, sku:'', photographer:'P02', audioMeasure:null, audioDuration:0, mainPhotos:[], tagPhotos:[], defectPhotos:[], defectCloseupPhotos:[], featuresPhotos:[], flagged:false, elasticCheck:'' };
        let stats = { today:0, week:0, total:0 }, currentStep = 1, photoMode = 'main', currentStream = null;
        let selectedDefectLink = null; // Index of defect marker to link close-up to
        let selectedFeatureType = null; // Type of feature being photographed
        let fabricFilters = { stretch:null, surface:null, interior:null }, materialFilters = { temp:null, shine:null }, patternFilters = { lines:null, shapes:null, method:null };
        let tagCutMode = false; // When true, fabric selection disabled, traits mandatory
        
        // ============ LOCAL FOLDER SAVE (File System Access API) ============
        let saveDirectoryHandle = null;
        
        async function selectSaveFolder() {
            try {
                // Check if File System Access API is supported
                if(!('showDirectoryPicker' in window)) {
                    showToast('error', 'Not Supported', 'Use Chrome or Edge for folder saving');
                    return;
                }
                
                saveDirectoryHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    startIn: 'desktop'
                });
                
                // Update header button to show selected folder
                const btn = document.getElementById('folder-btn');
                btn.textContent = `üìÅ ${saveDirectoryHandle.name}`;
                btn.style.background = '#166534';
                btn.style.borderColor = '#22c55e';
                
                showToast('success', 'Folder Selected', `Photos will auto-save to "${saveDirectoryHandle.name}"`);
                console.log('üìÅ Save folder selected:', saveDirectoryHandle.name);
                
            } catch(err) {
                if(err.name !== 'AbortError') {
                    console.error('Folder selection error:', err);
                    showToast('error', 'Folder Error', err.message);
                }
            }
        }
        
        async function savePhotoToFolder(blob, filename) {
            if(!saveDirectoryHandle) return false;
            
            try {
                // Create SKU subfolder if SKU exists
                let targetDir = saveDirectoryHandle;
                if(data.sku) {
                    try {
                        targetDir = await saveDirectoryHandle.getDirectoryHandle(data.sku, { create: true });
                    } catch(e) {
                        console.warn('Could not create SKU folder, saving to root');
                    }
                }
                
                // Create file
                const fileHandle = await targetDir.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                console.log(`üíæ Saved: ${data.sku ? data.sku + '/' : ''}${filename}`);
                return true;
                
            } catch(err) {
                console.error('Save error:', err);
                // Don't show toast for every save error, just log it
                return false;
            }
        }
        
        function generatePhotoFilename(type, index) {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const sku = data.sku || 'NOSKU';
            return `${sku}_${type}_${index}_${timestamp}.jpg`;
        }
        let timerStart = null, timerInterval = null, itemTimes = [];
        let mediaRecorder = null, audioChunks = [], recordingStart = null, recordingInterval = null;
        let mainCameraId = null, secondaryCameraId = null, activeCameraId = null;
        let barcodeScanInterval = null;
        // Stabilizer variables
        let stabilizerInterval = null, stabilizerCanvas = null, stabilizerCtx = null;
        let previousFrame = null, stableFrameCount = 0, isStable = false;
        const STABILITY_THRESHOLD = 8; // Lower = more sensitive
        const FRAMES_NEEDED = 3; // Frames needed to be "stable"
        let previewMode = null, previewIndex = 0;
        
        // ============ DEFECT MARKER SYSTEM ============
        let defectMarkers = []; // [{id, x, y, type}]
        let pendingMarker = null; // Temporary marker waiting for type selection
        let defectMarkingEnabled = false;
        const DEFECT_CROP_SIZE = 0.50; // 50% of max dimension (~1920px from 3840 rotated)
        const DEFECT_COLORS = { stain: '#eab308', hole: '#3b82f6', repair: '#f97316' };
        const DEFECT_ICONS = { stain: 'üíß', hole: 'üï≥Ô∏è', repair: 'üßµ' };
        
        
        // ============ TOAST NOTIFICATION SYSTEM ============
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            return toast;
        }
        
        // ============ DEFECT MARKER FUNCTIONS ============
        function handleDefectClick(event) {
            console.log('üéØ handleDefectClick triggered');
            console.log('üéØ defectMarkingEnabled:', defectMarkingEnabled);
            console.log('üéØ photoMode:', photoMode);
            
            if(!defectMarkingEnabled) {
                console.log('üéØ Marking disabled - ignoring click');
                return;
            }
            
            // Check if clicked on existing marker (to delete)
            if(event.target.closest('.defect-marker')) {
                console.log('üéØ Clicked on existing marker - ignoring');
                return; // Let the marker's own click handler deal with it
            }
            
            // Get the video element to check actual image bounds
            const video = document.getElementById('camera-video');
            const videoRect = video.getBoundingClientRect();
            
            // For portrait mode, the video is rotated 90¬∞
            // We need to check if click is within the VISIBLE video area
            const layer = document.getElementById('defect-markers-layer');
            const layerRect = layer.getBoundingClientRect();
            
            // Calculate the actual displayed image area (accounting for letterboxing/black bars)
            let imageLeft, imageTop, imageWidth, imageHeight;
            
            if(photoMode === 'main' && video.classList.contains('portrait-mode')) {
                // Portrait mode - video is rotated, so width/height are swapped visually
                const videoAspect = video.videoWidth / video.videoHeight; // e.g., 4096/2160 ‚âà 1.9
                const containerAspect = layerRect.width / layerRect.height;
                
                // After 90¬∞ rotation, the aspect becomes height/width
                const rotatedAspect = video.videoHeight / video.videoWidth; // e.g., 2160/4096 ‚âà 0.53
                
                if(rotatedAspect < containerAspect) {
                    // Image is taller than container - fit to height, black bars on sides
                    imageHeight = layerRect.height;
                    imageWidth = imageHeight * rotatedAspect;
                    imageLeft = (layerRect.width - imageWidth) / 2;
                    imageTop = 0;
                } else {
                    // Image is wider than container - fit to width
                    imageWidth = layerRect.width;
                    imageHeight = imageWidth / rotatedAspect;
                    imageLeft = 0;
                    imageTop = (layerRect.height - imageHeight) / 2;
                }
            } else {
                // Landscape mode - simpler calculation
                const videoAspect = video.videoWidth / video.videoHeight;
                const containerAspect = layerRect.width / layerRect.height;
                
                if(videoAspect > containerAspect) {
                    // Video is wider - fit to width
                    imageWidth = layerRect.width;
                    imageHeight = imageWidth / videoAspect;
                    imageLeft = 0;
                    imageTop = (layerRect.height - imageHeight) / 2;
                } else {
                    // Video is taller - fit to height
                    imageHeight = layerRect.height;
                    imageWidth = imageHeight * videoAspect;
                    imageLeft = (layerRect.width - imageWidth) / 2;
                    imageTop = 0;
                }
            }
            
            // Get click position relative to layer
            const clickX = event.clientX - layerRect.left;
            const clickY = event.clientY - layerRect.top;
            
            // Check if click is within the actual image bounds
            if(clickX < imageLeft || clickX > imageLeft + imageWidth ||
               clickY < imageTop || clickY > imageTop + imageHeight) {
                console.log('üéØ Click outside image bounds - ignoring');
                showToast('warning', 'Click on the image to mark defects');
                return;
            }
            
            // Calculate percentage position WITHIN the image area (not the full layer)
            const x = ((clickX - imageLeft) / imageWidth) * 100;
            const y = ((clickY - imageTop) / imageHeight) * 100;
            
            console.log(`üéØ Click at ${x.toFixed(1)}%, ${y.toFixed(1)}% (within image)`);
            
            // Store pending marker position
            pendingMarker = { x, y };
            
            // Show defect type popup near click
            const popup = document.getElementById('defect-popup');
            popup.style.left = Math.min(event.clientX, window.innerWidth - 250) + 'px';
            popup.style.top = Math.min(event.clientY - 80, window.innerHeight - 200) + 'px';
            popup.classList.add('visible');
            console.log('üéØ Popup shown');
        }
        
        function confirmDefectMarker(type) {
            console.log('üéØ confirmDefectMarker called with type:', type);
            console.log('üéØ pendingMarker:', pendingMarker);
            
            if(!pendingMarker) {
                console.warn('üéØ No pending marker - aborting');
                return;
            }
            
            const marker = {
                id: Date.now(),
                x: pendingMarker.x,
                y: pendingMarker.y,
                type: type
            };
            
            defectMarkers.push(marker);
            console.log('üéØ Added marker:', marker);
            console.log('üéØ Total markers:', defectMarkers.length);
            
            pendingMarker = null;
            
            // Hide popup
            document.getElementById('defect-popup').classList.remove('visible');
            
            // Render markers
            renderDefectMarkers();
            updateMarkerCount();
            
            // Auto-set hasDefects if markers exist
            if(defectMarkers.length > 0 && data.hasDefects !== true) {
                data.hasDefects = true;
            }
        }
        
        function cancelDefectMarker() {
            pendingMarker = null;
            document.getElementById('defect-popup').classList.remove('visible');
        }
        
        function removeDefectMarker(id) {
            defectMarkers = defectMarkers.filter(m => m.id !== id);
            renderDefectMarkers();
            updateMarkerCount();
            
            // If no markers left, reset hasDefects
            if(defectMarkers.length === 0) {
                data.hasDefects = null;
            }
        }
        
        // Calculate the actual displayed image bounds within the layer
        function getImageBounds() {
            const video = document.getElementById('camera-video');
            const layer = document.getElementById('defect-markers-layer');
            if(!video || !layer) return null;
            
            const layerRect = layer.getBoundingClientRect();
            let imageLeft, imageTop, imageWidth, imageHeight;
            
            if(photoMode === 'main' && video.classList.contains('portrait-mode')) {
                // Portrait mode - video is rotated, aspect is inverted
                const rotatedAspect = video.videoHeight / video.videoWidth;
                
                if(rotatedAspect < layerRect.width / layerRect.height) {
                    // Fit to height
                    imageHeight = layerRect.height;
                    imageWidth = imageHeight * rotatedAspect;
                    imageLeft = (layerRect.width - imageWidth) / 2;
                    imageTop = 0;
                } else {
                    // Fit to width
                    imageWidth = layerRect.width;
                    imageHeight = imageWidth / rotatedAspect;
                    imageLeft = 0;
                    imageTop = (layerRect.height - imageHeight) / 2;
                }
            } else {
                // Landscape mode
                const videoAspect = video.videoWidth / video.videoHeight;
                
                if(videoAspect > layerRect.width / layerRect.height) {
                    imageWidth = layerRect.width;
                    imageHeight = imageWidth / videoAspect;
                    imageLeft = 0;
                    imageTop = (layerRect.height - imageHeight) / 2;
                } else {
                    imageHeight = layerRect.height;
                    imageWidth = imageHeight * videoAspect;
                    imageLeft = (layerRect.width - imageWidth) / 2;
                    imageTop = 0;
                }
            }
            
            return {
                left: imageLeft,
                top: imageTop,
                width: imageWidth,
                height: imageHeight,
                layerWidth: layerRect.width,
                layerHeight: layerRect.height
            };
        }
        
        function renderDefectMarkers() {
            console.log('üéØ renderDefectMarkers called, count:', defectMarkers.length, 'mode:', photoMode);
            
            const layer = document.getElementById('defect-markers-layer');
            if(!layer) return;
            
            // Remove existing markers
            layer.querySelectorAll('.defect-marker').forEach(m => m.remove());
            
            // Get image bounds for proper positioning
            const bounds = getImageBounds();
            
            // Add markers
            defectMarkers.forEach((marker, idx) => {
                const el = document.createElement('div');
                el.className = `defect-marker ${marker.type}`;
                
                if(bounds) {
                    // Position within image area, not full layer
                    const pixelX = bounds.left + (marker.x / 100) * bounds.width;
                    const pixelY = bounds.top + (marker.y / 100) * bounds.height;
                    // Convert to percentage of layer
                    const layerX = (pixelX / bounds.layerWidth) * 100;
                    const layerY = (pixelY / bounds.layerHeight) * 100;
                    el.style.left = layerX + '%';
                    el.style.top = layerY + '%';
                } else {
                    // Fallback to direct percentage
                    el.style.left = marker.x + '%';
                    el.style.top = marker.y + '%';
                }
                
                el.innerHTML = `
                    ${idx + 1}
                    <div class="defect-marker-delete" onclick="event.stopPropagation(); removeDefectMarker(${marker.id})">‚úï</div>
                `;
                el.onclick = (e) => e.stopPropagation();
                el.style.pointerEvents = 'auto';
                layer.appendChild(el);
                console.log(`üéØ Rendered marker ${idx + 1} at ${marker.x.toFixed(1)}%, ${marker.y.toFixed(1)}%`);
            });
        }
        
        function updateMarkerCount() {
            document.getElementById('marker-count').textContent = defectMarkers.length;
        }
        
        function enableDefectMarking() {
            console.log('üéØ enableDefectMarking called');
            defectMarkingEnabled = true;
            const layer = document.getElementById('defect-markers-layer');
            if(layer) {
                layer.classList.add('active');
                console.log('üéØ Layer active class added');
            } else {
                console.error('üéØ defect-markers-layer not found!');
            }
            const banner = document.getElementById('defect-mode-banner');
            if(banner) {
                banner.classList.add('visible');
                console.log('üéØ Banner visible');
            }
        }
        
        function disableDefectMarking() {
            console.log('üéØ disableDefectMarking called');
            defectMarkingEnabled = false;
            document.getElementById('defect-markers-layer')?.classList.remove('active');
            document.getElementById('defect-mode-banner')?.classList.remove('visible');
        }
        
        // Defect Close-up Link Panel
        function updateDefectLinkPanel() {
            const panel = document.getElementById('defect-link-panel');
            const buttonsContainer = document.getElementById('defect-link-buttons');
            
            if(photoMode === 'defect-closeup') {
                panel.classList.add('visible');
                
                // Create buttons for each defect marker
                if(defectMarkers.length === 0) {
                    buttonsContainer.innerHTML = '<span style="opacity:0.7;font-size:10px;">No defects marked yet</span>';
                } else {
                    buttonsContainer.innerHTML = defectMarkers.map((m, i) => 
                        `<button onclick="selectDefectLink(${i})" class="link-btn ${selectedDefectLink === i ? 'active' : ''}">#${i+1}</button>`
                    ).join('');
                }
            } else {
                panel.classList.remove('visible');
            }
        }
        
        function selectDefectLink(index) {
            selectedDefectLink = index;
            updateDefectLinkPanel();
            showToast('info', `Linked to Defect #${index + 1}`, 'Next photo will be linked', 1500);
        }
        
        // Feature Type Panel
        function updateFeatureTypePanel() {
            const panel = document.getElementById('feature-type-panel');
            
            if(photoMode === 'features') {
                panel.classList.add('visible');
                
                // Update active state on buttons
                document.querySelectorAll('.feature-type-btn').forEach(btn => {
                    if(btn.textContent === selectedFeatureType) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } else {
                panel.classList.remove('visible');
            }
        }
        
        function selectFeatureType(type) {
            selectedFeatureType = type;
            updateFeatureTypePanel();
            showToast('info', `Feature: ${type}`, 'Next photo will be tagged', 1500);
        }
        
        function clearDefectMarkers() {
            defectMarkers = [];
            renderDefectMarkers();
            updateMarkerCount();
        }

        const categoryConfig = {
            tops: { heroes: ['T-Shirt', 'Sweatshirt', 'Hoodie'], others: ['Sweater', 'Button Shirt', 'Polo', 'Jersey', 'Tank Top', 'Cardigan', 'Blouse', 'Tunic'] },
            bottoms: { heroes: ['Jeans', 'Pants'], others: ['Shorts', 'Sweatpants'] },
            outer: { heroes: ['Jacket', 'Coat'], others: ['Vest'] }
        };
        const catEmojis = { 'T-Shirt':'üëï', 'Sweatshirt':'üèãÔ∏è', 'Hoodie':'üß•', 'Sweater':'üß∂', 'Button Shirt':'üëî', 'Polo':'üèåÔ∏è', 'Jersey':'üèÄ', 'Tank Top':'ü©±', 'Cardigan':'üß•', 'Jeans':'üëñ', 'Pants':'üëñ', 'Shorts':'ü©≥', 'Sweatpants':'üèÉ', 'Jacket':'üß•', 'Coat':'üß•', 'Vest':'ü¶∫', 'Blouse':'üëö', 'Tunic':'üëó' };
        
        // V99.45: fabricDB with full traits (stretch, surface, interior)
        // surface: smooth, ridged, diagonal, rough/textured
        const fabricDB = {
            // TOPS - Per eBay PDF fabric types
            "T-Shirt": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Standard tee fabric. Stretchy, smooth both sides." },
                { name:"Jersey", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Athletic tee. Soccer, Nike Dri-Fit style." },
                { name:"Rayon", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Silky, drapey. 80s/90s soft tees." },
                { name:"Woven", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Rigid like dress shirt. Rare for tees." },
                { name:"Mesh", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"See-through with tiny holes. Athletic." }
            ],
            "Sweatshirt": [
                { name:"Fleece", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside, smooth outside. 90% of sweats." },
                { name:"French Terry", priority:2, traits:{stretch:"high",surface:"smooth",interior:"loops"}, desc:"Tiny loops inside. Lighter, summer weight." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Sweater-like. Smooth both sides." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin like a thick t-shirt." }
            ],
            "Hoodie": [
                { name:"Fleece", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside, smooth outside. Most common." },
                { name:"French Terry", priority:2, traits:{stretch:"high",surface:"smooth",interior:"loops"}, desc:"Tiny loops inside. Lighter weight." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Sweater-like hoodie." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin, lightweight hoodie." }
            ],
            "Sweater": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Standard sweater. Stretchy yarn loops visible." },
                { name:"Crochet", priority:2, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Open holes, handmade look." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin, lightweight sweater." }
            ],
            "Cardigan": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Standard cardigan with buttons/open front." },
                { name:"Crochet", priority:2, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Open holes, handmade look." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin, lightweight." }
            ],
            "Button Shirt": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Dress shirt fabric. Rigid, no stretch." },
                { name:"Poplin", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Crisp dress shirt. Fine weave." },
                { name:"Chambray", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Looks like light denim but softer." },
                { name:"Denim", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean material. Western/work shirt." },
                { name:"Flannel", priority:2, traits:{stretch:"none",surface:"smooth",interior:"fuzzy"}, desc:"Soft, fuzzy inside. Often plaid." },
                { name:"Corduroy", priority:3, traits:{stretch:"none",surface:"ridged",interior:"smooth"}, desc:"Vertical ridges you can feel & see." }
            ],
            "Polo": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Standard polo. Stretchy with textured surface." },
                { name:"Jersey", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"T-shirt-like polo. Smoother." },
                { name:"Woven", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Dress polo. Rigid like button shirt." }
            ],
            "Tank Top": [
                { name:"Jersey", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Standard tank. Soft & stretchy." },
                { name:"Knit", priority:1, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Same as Jersey." },
                { name:"Rayon", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Silky, drapey feel." },
                { name:"Mesh", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"See-through athletic. Tiny holes." }
            ],
            "Blouse": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Standard blouse. Rigid fabric." },
                { name:"Chiffon", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Sheer, flowy. You can see through it." },
                { name:"Satin", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Shiny, silky smooth." },
                { name:"Crepe", priority:2, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Slightly bumpy/crinkly texture." },
                { name:"Lace", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Decorative with pattern holes." },
                { name:"Georgette", priority:3, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Sheer crepe. Slightly rough feel." }
            ],
            "Tunic": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Standard tunic fabric." },
                { name:"Rayon", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Drapey, soft, silky feel." },
                { name:"Knit", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy tunic." },
                { name:"Crepe", priority:3, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Slightly bumpy texture." },
                { name:"Gauze", priority:3, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Very lightweight, airy, breathable." }
            ],
            "Jersey": [
                { name:"Mesh", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Tiny holes. Most sports jerseys." },
                { name:"Jersey", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Smooth. Baseball/hockey style." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Heavier, vintage style." }
            ],
            // BOTTOMS
            "Jeans": [
                { name:"Denim", priority:1, default:true, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Standard jean material. Diagonal weave." },
                { name:"Selvage", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Premium. Red/white line on inside cuff edge." }
            ],
            "Pants": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Dress pants. Smooth, rigid." },
                { name:"Twill", priority:1, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Chinos, khakis. Diagonal weave pattern." },
                { name:"Corduroy", priority:2, traits:{stretch:"none",surface:"ridged",interior:"smooth"}, desc:"Vertical ridges you can feel & see." },
                { name:"Canvas", priority:2, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Heavy, thick. Carhartt/workwear." },
                { name:"Moleskin", priority:3, traits:{stretch:"none",surface:"smooth",interior:"fuzzy"}, desc:"Soft, brushed cotton. Fuzzy feel." },
                { name:"Ponte", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy dress pant. Thick legging-like." }
            ],
            "Shorts": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Standard shorts. No stretch." },
                { name:"Twill", priority:1, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Cotton shorts. Diagonal weave." },
                { name:"Canvas", priority:2, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Heavy, thick cotton." },
                { name:"Denim", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean shorts, cutoffs." },
                { name:"Mesh", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Athletic shorts. See-through holes." }
            ],
            "Sweatpants": [
                { name:"Fleece", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside. Standard sweats." },
                { name:"French Terry", priority:2, traits:{stretch:"high",surface:"smooth",interior:"loops"}, desc:"Tiny loops inside. Lighter." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Smooth both sides. Jogger style." }
            ],
            // OUTER - Per eBay PDF fabric types (NO materials like Nylon)
            "Jacket": [
                { name:"Denim", priority:1, default:true, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean jacket material. Trucker style." },
                { name:"Canvas", priority:1, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Heavy cotton. Work jacket, Carhartt, chore coat." },
                { name:"Leather", priority:1, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Animal hide. Motorcycle, A-2/G-1 flight, cafe racer." },
                { name:"Satin", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Shiny, silky. Starter jackets, varsity sleeves, bomber." },
                { name:"Twill", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Harrington, Dickies style. Diagonal weave." },
                { name:"Corduroy", priority:2, traits:{stretch:"none",surface:"ridged",interior:"smooth"}, desc:"Vertical ridges. 70s style." },
                { name:"Fleece", priority:3, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Soft, fuzzy. Patagonia, North Face style." },
                { name:"Softshell", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy outdoor tech jacket." }
            ],
            "Coat": [
                { name:"Tweed", priority:1, default:true, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Rough, speckled wool blend. Professor/country style." },
                { name:"Woven", priority:1, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Classic overcoat, peacoat. Dress coat." },
                { name:"Velvet", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Soft, plush. Luxe vintage look." },
                { name:"Shearling", priority:2, traits:{stretch:"none",surface:"smooth",interior:"fuzzy"}, desc:"Wool/fur lined inside. Rancher style." },
                { name:"Felt", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Pressed wool. Stiff, structured." },
                { name:"Taffeta", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Crisp, shiny. Formal evening coat." }
            ],
            "Vest": [
                { name:"Quilted", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Puffer vest. Puffy, insulated sections." },
                { name:"Fleece", priority:1, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Soft, fuzzy. Patagonia style." },
                { name:"Denim", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean vest, cut-off sleeves." },
                { name:"Leather", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Motorcycle vest, biker style." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Sweater vest." }
            ],
            "default": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy, like t-shirt material." },
                { name:"Woven", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Rigid, no stretch. Like dress shirt." },
                { name:"Fleece", priority:2, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside." },
                { name:"Denim", priority:3, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean material." }
            ]
        };
        // V99.9: materialDB from eBay official materials (per PDF)
        const materialDB = {
            // TOPS
            "T-Shirt": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Cool, soft." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic. Slight sheen." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Silky, drapey." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic, athletic." },
                { name:"Acrylic", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic wool-like." }
            ],
            "Sweatshirt": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Most common." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Acrylic", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Rare, warm." }
            ],
            "Hoodie": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Most common." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Tech fleece." },
                { name:"Acrylic", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." }
            ],
            "Sweater": [
                { name:"Wool", priority:1, default:true, traits:{temp:"warm",shine:"matte"}, desc:"Classic. Warm." },
                { name:"Acrylic", priority:1, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic wool." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Lightweight." },
                { name:"Cashmere", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Luxury. Ultra soft." },
                { name:"Mohair", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Fuzzy, luxe." },
                { name:"Alpaca", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Soft, warm." }
            ],
            "Cardigan": [
                { name:"Wool", priority:1, default:true, traits:{temp:"warm",shine:"matte"}, desc:"Classic cardigan." },
                { name:"Acrylic", priority:1, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic wool." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Lightweight." },
                { name:"Cashmere", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Luxury." },
                { name:"Mohair", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Fuzzy." },
                { name:"Alpaca", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Soft, warm." }
            ],
            "Button Shirt": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Crisp." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Wrinkle-free." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Silky, drapey." },
                { name:"Linen", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Cool, wrinkles." },
                { name:"Silk", priority:3, traits:{temp:"cool",shine:"sheen"}, desc:"Luxury. Shiny." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Disco era." }
            ],
            "Polo": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Classic polo." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Acrylic", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." }
            ],
            "Tank Top": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Classic tank." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Silky." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." }
            ],
            "Blouse": [
                { name:"Polyester", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Most common vintage." },
                { name:"Rayon", priority:1, traits:{temp:"cool",shine:"sheen"}, desc:"Silky, drapey." },
                { name:"Silk", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Luxury." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Natural." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"70s-80s." }
            ],
            "Tunic": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Drapey." },
                { name:"Linen", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Breathable." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Warm." }
            ],
            "Jersey": [
                { name:"Polyester", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Most athletic." },
                { name:"Nylon", priority:1, traits:{temp:"warm",shine:"sheen"}, desc:"Mesh jerseys." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Vintage baseball." },
                { name:"Rayon", priority:3, traits:{temp:"cool",shine:"sheen"}, desc:"Old school." }
            ],
            // BOTTOMS
            "Jeans": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"100% denim." },
                { name:"Polyester", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Rare blend." }
            ],
            "Pants": [
                { name:"Polyester", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Dress pants." },
                { name:"Cotton", priority:1, traits:{temp:"cool",shine:"matte"}, desc:"Chinos." },
                { name:"Wool", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Dress wool." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Drapey." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Canvas", priority:3, traits:{temp:"cool",shine:"matte"}, desc:"Workwear." }
            ],
            "Shorts": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Cotton shorts." },
                { name:"Nylon", priority:1, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic/swim." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Canvas", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Heavy duty." },
                { name:"Rayon", priority:3, traits:{temp:"cool",shine:"sheen"}, desc:"Drapey." }
            ],
            "Sweatpants": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Classic sweats." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Acrylic", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." }
            ],
            // OUTER
            "Jacket": [
                { name:"Nylon", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Windbreaker." },
                { name:"Polyester", priority:1, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Canvas", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Work jacket." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Denim/canvas." },
                { name:"Leather", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Moto, bomber." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Varsity." }
            ],
            "Coat": [
                { name:"Wool", priority:1, default:true, traits:{temp:"warm",shine:"matte"}, desc:"Dress coat." },
                { name:"Leather", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Trench, long." },
                { name:"Nylon", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Puffer." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Down fill." },
                { name:"Cashmere", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Luxury." },
                { name:"Fur", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Real/faux fur." }
            ],
            "Vest": [
                { name:"Nylon", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Puffer." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Fleece." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Denim." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Sweater vest." }
            ],
            "default": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural fiber." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic." },
                { name:"Wool", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Warm, natural." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic." }
            ]
        };

        // V99.45: patternDB with traits for dynamic pattern identification
        // lines: none, stripes, grid (crossing lines)
        // shapes: none, dots, curved (flowers/paisley), geometric, blobs (irregular)
        // method: woven (part of fabric), printed (on surface), stitched (embroidered)
        const patternDB = [
            { name:"Solid", priority:1, default:true, traits:{lines:"none",shapes:"none",method:"woven"}, desc:"One color only. No pattern.", examples:"Plain tee, blank shirt" },
            { name:"Graphic", priority:1, traits:{lines:"none",shapes:"any",method:"printed"}, desc:"Image/text printed on fabric.", examples:"Band tee, logo shirt, artwork" },
            { name:"Striped", priority:2, traits:{lines:"stripes",shapes:"none",method:"woven"}, desc:"Parallel lines in one direction.", examples:"Sailor stripe, pinstripe, rugby stripe" },
            { name:"Color Block", priority:2, traits:{lines:"none",shapes:"geometric",method:"woven"}, desc:"Large solid color sections sewn together.", examples:"90s windbreaker, panel tee" },
            { name:"Plaid", priority:2, traits:{lines:"grid",shapes:"none",method:"woven"}, desc:"Crossing horizontal + vertical lines.", examples:"Flannel, tartan, buffalo check, gingham" },
            { name:"Tie Dye", priority:2, traits:{lines:"none",shapes:"curved",method:"printed"}, desc:"Swirly, spiral, or burst patterns.", examples:"Spiral tie dye, crinkle, bull's eye" },
            { name:"Camo", priority:3, traits:{lines:"none",shapes:"blobs",method:"printed"}, desc:"Irregular organic blob shapes.", examples:"Military camo, woodland, digital camo" },
            { name:"Embroidered", priority:3, traits:{lines:"none",shapes:"any",method:"stitched"}, desc:"Design stitched onto fabric.", examples:"Logo embroidery, patches, monogram" },
            { name:"Polka Dot", priority:3, traits:{lines:"none",shapes:"dots",method:"printed"}, desc:"Repeated circles/dots pattern.", examples:"Small dots, large dots, scattered dots" },
            { name:"Paisley", priority:3, traits:{lines:"none",shapes:"curved",method:"printed"}, desc:"Curved teardrop/kidney shapes.", examples:"Bandana pattern, western shirts" },
            { name:"Floral", priority:3, traits:{lines:"none",shapes:"curved",method:"printed"}, desc:"Flower and plant designs.", examples:"Hawaiian shirt, rose pattern, vintage blouse" },
            { name:"Animal", priority:3, traits:{lines:"none",shapes:"blobs",method:"printed"}, desc:"Animal print or animal images.", examples:"Leopard, zebra, snake, tiger print" },
            { name:"Geometric", priority:3, traits:{lines:"none",shapes:"geometric",method:"printed"}, desc:"Triangles, squares, abstract shapes.", examples:"80s geometric, aztec, chevron, argyle" },
            { name:"Checkered", priority:3, traits:{lines:"grid",shapes:"none",method:"woven"}, desc:"Simple two-color grid pattern.", examples:"Checkerboard, racing flag pattern" },
            { name:"Houndstooth", priority:3, traits:{lines:"grid",shapes:"geometric",method:"woven"}, desc:"Broken checks with pointed corners.", examples:"Classic houndstooth, oversized tooth" },
            { name:"Herringbone", priority:3, traits:{lines:"stripes",shapes:"geometric",method:"woven"}, desc:"V-shaped zigzag weave pattern.", examples:"Suit fabric, tweed pattern" },
            { name:"Abstract", priority:3, traits:{lines:"none",shapes:"blobs",method:"printed"}, desc:"Random artistic shapes/splashes.", examples:"Paint splatter, 80s abstract, modern art" },
            { name:"Other", priority:4, traits:{lines:"any",shapes:"any",method:"any"}, desc:"Pattern doesn't fit above options.", examples:"Unique, custom, rare patterns" }
        ];

        // V99.45: Tag Location Database - Where to find tags by category
        const tagLocationDB = {
            // TOPS
            "T-Shirt": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Bottom hem (inside)", desc: "70s/80s VINTAGE: Champion, Russell Athletic often have tags sewn inside the bottom hem!", icon: "‚≠ê" },
                    { location: "Left side seam", desc: "Hip/waist area on the left side - common on Y2K and modern tees", icon: "üìç" }
                ],
                tips: "70s/80s vintage (Champion, Russell): Check INSIDE the bottom hem! Modern/Y2K: Check side seams. Pre-90s vintage usually ONLY have neck tags."
            },
            "Polo": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left or right side seam", desc: "Hip/waist area - very common on polos!", icon: "‚≠ê" },
                    { location: "Bottom hem placket", desc: "Inside where the side slit is", icon: "üìç" }
                ],
                tips: "ALWAYS check both side seams on polos! Many brands put size/style tags there instead of the neck."
            },
            "Button Shirt": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Inside yoke", desc: "Below the collar seam, inside the back", icon: "üìç" },
                    { location: "Bottom front placket", desc: "Inside bottom of the button strip", icon: "üìç" },
                    { location: "Side seam", desc: "Hip area, left or right side", icon: "üìç" }
                ],
                tips: "Western shirts often have multiple small tags. Dress shirts may have tags at the bottom placket."
            },
            "Sweatshirt": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Inside bottom hem/ribbing", desc: "70s/80s VINTAGE: Champion, Russell Athletic often have tags sewn inside the bottom ribbing!", icon: "‚≠ê" },
                    { location: "Left side seam", desc: "Hip/waist area - Champion reverse weave often here", icon: "üìç" }
                ],
                tips: "70s/80s vintage: Check INSIDE the bottom ribbing! Champion reverse weave: side seam. Modern Champion: usually neck tag."
            },
            "Hoodie": {
                primary: { location: "Back of neck", desc: "Inside below the hood attachment", icon: "üëî" },
                secondary: [
                    { location: "Inside kangaroo pocket", desc: "Check inside the front pouch pocket!", icon: "‚≠ê" },
                    { location: "Inside bottom hem/ribbing", desc: "70s/80s vintage Champion/Russell: inside the bottom ribbing", icon: "‚≠ê" },
                    { location: "Left side seam", desc: "Hip/waist area", icon: "üìç" }
                ],
                tips: "70s/80s vintage: Check bottom ribbing! Some brands hide tags inside the kangaroo pocket."
            },
            "Sweater": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Near the bottom hem", icon: "üìç" },
                    { location: "Inside bottom hem", desc: "Folded into the ribbing", icon: "üìç" }
                ],
                tips: "High-end sweaters may have very small woven tags. Check carefully at the neck seam."
            },
            "Cardigan": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Inside front facing", desc: "Behind the button placket", icon: "üìç" },
                    { location: "Side seam", desc: "Near bottom hem", icon: "üìç" }
                ],
                tips: "Button-front cardigans sometimes have tags inside the front facing."
            },
            "Tank Top": {
                primary: { location: "Back of neck", desc: "Inside center back, below the strap", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Under the arm area", icon: "üìç" }
                ],
                tips: "Tank tops often have smaller tags. May be printed directly on the fabric (tagless)."
            },
            "Long Sleeve": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Hip/waist area", icon: "üìç" },
                    { location: "Cuff area", desc: "Inside the sleeve cuff (rare)", icon: "üìç" }
                ],
                tips: "Thermal/waffle knits may have tags at the side seam instead of neck."
            },
            // BOTTOMS
            "Jeans": {
                primary: { location: "Back waistband", desc: "Inside center back, below the leather patch", icon: "üëñ" },
                secondary: [
                    { location: "Inner thigh/inseam", desc: "LEVI'S style - check where legs meet!", icon: "‚≠ê" },
                    { location: "Front waistband", desc: "WRANGLER style - opposite side of zipper fly", icon: "‚≠ê" },
                    { location: "Inside front pocket", desc: "Hidden in the right front pocket", icon: "üìç" },
                    { location: "Coin pocket", desc: "Inside the small watch pocket", icon: "üìç" }
                ],
                tips: "LEVI'S: Check inner thigh! WRANGLER: Check front waistband! Lee/others: Usually back waistband."
            },
            "Pants": {
                primary: { location: "Back waistband", desc: "Inside center back", icon: "üëñ" },
                secondary: [
                    { location: "Inside back pocket", desc: "DISCO/POLYESTER pants often here!", icon: "‚≠ê" },
                    { location: "Front waistband", desc: "Near the button/clasp", icon: "üìç" },
                    { location: "Inside front pocket", desc: "Hidden in the pocket bag", icon: "üìç" }
                ],
                tips: "Vintage polyester/disco pants often have tags in back pockets. Dress pants check all pockets!"
            },
            "Shorts": {
                primary: { location: "Back waistband", desc: "Inside center back", icon: "üëñ" },
                secondary: [
                    { location: "Inside pocket", desc: "Front or back pocket", icon: "üìç" },
                    { location: "Inner thigh", desc: "Side seam near crotch", icon: "üìç" }
                ],
                tips: "Athletic shorts may have tags on the inner liner. Swim trunks check the mesh liner."
            },
            "Sweatpants": {
                primary: { location: "Back waistband", desc: "Inside center back", icon: "üëñ" },
                secondary: [
                    { location: "Inside pocket", desc: "Hidden in the pocket", icon: "üìç" },
                    { location: "Left side seam", desc: "Near the hip", icon: "üìç" }
                ],
                tips: "Champion and Nike often have side seam tags. Check inside any pockets too."
            },
            // OUTER
            "Jacket": {
                primary: { location: "Inside left chest", desc: "Interior left breast area, sewn to lining", icon: "üß•" },
                secondary: [
                    { location: "Inside front pocket", desc: "Hidden inside a front pocket!", icon: "‚≠ê" },
                    { location: "Inside chest pocket", desc: "Interior breast pocket", icon: "‚≠ê" },
                    { location: "Back of neck", desc: "Inside collar area", icon: "üìç" },
                    { location: "Inside hem", desc: "Bottom interior edge", icon: "üìç" }
                ],
                tips: "Windbreakers/track jackets: check inside pockets! Denim jackets: usually inside left chest or neck."
            },
            "Coat": {
                primary: { location: "Inside left chest", desc: "Interior left breast area", icon: "üß•" },
                secondary: [
                    { location: "Inside pocket", desc: "Interior breast pocket or side pocket", icon: "‚≠ê" },
                    { location: "Back of neck", desc: "Inside the collar", icon: "üìç" },
                    { location: "Inside hem", desc: "Bottom interior, sometimes near vent", icon: "üìç" }
                ],
                tips: "Luxury coats may have multiple tags in different locations. Check ALL interior pockets."
            },
            "Vest": {
                primary: { location: "Inside left chest", desc: "Interior left breast area", icon: "üß•" },
                secondary: [
                    { location: "Inside pocket", desc: "Interior pocket", icon: "üìç" },
                    { location: "Back of neck", desc: "Inside at the back neckline", icon: "üìç" }
                ],
                tips: "Puffer vests often have tags inside pockets. Suit vests check interior left chest."
            },
            "default": {
                primary: { location: "Back of neck OR back waistband", desc: "Standard tag locations", icon: "üè∑Ô∏è" },
                secondary: [
                    { location: "Side seam", desc: "Left or right side at hip level", icon: "üìç" },
                    { location: "Inside pocket", desc: "Check all pockets!", icon: "üìç" }
                ],
                tips: "When in doubt: neck area for tops, waistband for bottoms, interior chest for outerwear."
            }
        };

        // Debug: Check camera capabilities (call from browser console)
        window.checkCameraCapabilities = async function() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            
            for(const device of videoDevices) {
                console.log(`\nüì∑ ${device.label}`);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: device.deviceId } }
                    });
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    console.log('  Width range:', capabilities.width?.min, '-', capabilities.width?.max);
                    console.log('  Height range:', capabilities.height?.min, '-', capabilities.height?.max);
                    if(capabilities.width?.max >= 3840) console.log('    ‚úÖ 4K (3840x2160)');
                    if(capabilities.width?.max >= 1920) console.log('    ‚úÖ 1080p (1920x1080)');
                    if(capabilities.width?.max >= 1280) console.log('    ‚úÖ 720p (1280x720)');
                    stream.getTracks().forEach(t => t.stop());
                } catch(e) {
                    console.log('  Error:', e.message);
                }
            }
            console.log('\nüí° If 4K is not showing, try: Camera settings app ‚Üí set to 4K');
        };
        
        // Set version displays everywhere
        function setVersionDisplays() {
            document.title = `VintageLister ${VERSION} - Desktop Station`;
            
            // Pin screen version
            const pinVersion = document.getElementById('pin-version');
            if(pinVersion) pinVersion.textContent = `${VERSION} Desktop Station`;
            
            // Header version badge
            const headerVersion = document.getElementById('header-version');
            if(headerVersion) headerVersion.textContent = VERSION;
            
            // SKU gate version
            const skuGateVersion = document.getElementById('sku-gate-version');
            if(skuGateVersion) skuGateVersion.textContent = VERSION;
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            setVersionDisplays();
            checkAuth(); loadStats(); enumerateCameras(); renderSubCategories('tops'); clearDefectMarkers(); renderFabricCards(); renderMaterialCards(); renderPatternCards(); updateValidation(); 
            document.addEventListener('keydown', (e) => { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && !document.getElementById('preview-modal').classList.contains('active')) { e.preventDefault(); capturePhoto(); } }); 
            document.getElementById('pin-input').addEventListener('keydown', (e) => { if(e.key==='Enter') checkPin(); });
        });
        
        function checkAuth() { try { if(localStorage.getItem('vl_auth')===APP_PIN){ document.getElementById('pin-screen').classList.add('hidden'); data.photographer=localStorage.getItem('vl_photographer')||'P02'; document.getElementById('photographer-badge').textContent=data.photographer; startTimer(); } } catch(e){} }
        function checkPin() { if(document.getElementById('pin-input').value===APP_PIN){ try{ localStorage.setItem('vl_auth',APP_PIN); data.photographer=document.getElementById('photographer-select').value; localStorage.setItem('vl_photographer',data.photographer); document.getElementById('photographer-badge').textContent=data.photographer; }catch(e){} document.getElementById('pin-screen').classList.add('hidden'); startTimer(); } else { document.getElementById('pin-input').value=''; document.getElementById('pin-input').classList.add('shake'); setTimeout(()=>document.getElementById('pin-input').classList.remove('shake'),300); } }
        function showPinScreen() { document.getElementById('pin-screen').classList.remove('hidden'); document.getElementById('pin-input').value=''; document.getElementById('pin-input').focus(); }
        
        // Reset Menu Functions
        function toggleResetMenu() {
            const menu = document.getElementById('reset-menu');
            menu.classList.toggle('visible');
            
            // Close menu when clicking outside
            if(menu.classList.contains('visible')) {
                setTimeout(() => {
                    document.addEventListener('click', closeResetMenuOnClickOutside);
                }, 10);
            }
        }
        
        function hideResetMenu() {
            document.getElementById('reset-menu').classList.remove('visible');
            document.removeEventListener('click', closeResetMenuOnClickOutside);
        }
        
        function closeResetMenuOnClickOutside(e) {
            const dropdown = document.getElementById('reset-dropdown');
            if(!dropdown.contains(e.target)) {
                hideResetMenu();
            }
        }
        
        // === SKU GATE FUNCTIONS ===
        let skuLocked = false;
        
        function showSkuGate() {
            document.getElementById('sku-gate').classList.remove('hidden');
            document.getElementById('sku-gate-input').value = '';
            document.getElementById('sku-gate-input').classList.remove('valid');
            document.getElementById('sku-gate-status').textContent = '';
            skuLocked = false;
            
            // Reset to entry view (hide camera view)
            document.getElementById('sku-gate-entry').classList.remove('hidden');
            document.getElementById('sku-gate-camera').classList.add('hidden');
            
            // Stop barcode scanning, stabilizer and camera stream
            stopSkuGateBarcodeScanning();
            stopSkuGateStabilizer();
            if(skuGateStream) {
                skuGateStream.getTracks().forEach(t => t.stop());
                skuGateStream = null;
            }
            
            // Focus input after a brief delay
            setTimeout(() => document.getElementById('sku-gate-input').focus(), 100);
        }
        
        function hideSkuGate() {
            document.getElementById('sku-gate').classList.add('hidden');
            
            // Stop barcode scanning, stabilizer and camera stream
            stopSkuGateBarcodeScanning();
            stopSkuGateStabilizer();
            if(skuGateStream) {
                skuGateStream.getTracks().forEach(t => t.stop());
                skuGateStream = null;
            }
        }
        
        function onSkuGateInput() {
            const input = document.getElementById('sku-gate-input');
            const value = input.value.trim();
            
            // Visual feedback
            if(value.length >= 3) {
                input.classList.add('valid');
                document.getElementById('sku-gate-status').textContent = 'Press ENTER to confirm';
            } else {
                input.classList.remove('valid');
                document.getElementById('sku-gate-status').textContent = '';
            }
        }
        
        function handleSkuGateKeydown(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const value = document.getElementById('sku-gate-input').value.trim();
                if(value.length >= 1) {
                    lockSku(value);
                }
            }
        }
        
        let skuGateStream = null;
        let skuGateStabilizer = null;
        let skuGateIsStable = false;
        let skuGateBarcodeReader = null;
        let skuGateScanInterval = null;
        
        async function activateSkuGateScan() {
            // Show camera preview, hide entry form
            document.getElementById('sku-gate-entry').classList.add('hidden');
            document.getElementById('sku-gate-camera').classList.remove('hidden');
            
            // Clear and focus scan input
            document.getElementById('sku-gate-scan-input').value = '';
            document.getElementById('sku-gate-scan-input').classList.remove('valid');
            document.getElementById('sku-gate-scan-input').placeholder = 'Scanning...';
            
            // Reset stabilizer
            updateSkuGateStabilizer(false);
            
            // If cameras haven't been enumerated yet, do it now
            if(!mainCameraId && !secondaryCameraId) {
                console.log('üì∑ SKU Gate: Cameras not enumerated yet, requesting permission...');
                try {
                    // First request permission with a temporary stream
                    const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    tempStream.getTracks().forEach(t => t.stop()); // Stop immediately
                    
                    // Now enumerate - we should have labels
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(d => d.kind === 'videoinput');
                    console.log('üì∑ SKU Gate: Found', videoDevices.length, 'cameras');
                    
                    for(const device of videoDevices) {
                        const label = device.label.toLowerCase();
                        console.log('üì∑ SKU Gate: Camera:', device.label, device.deviceId.slice(0,8));
                        if(label.includes('brio')) {
                            mainCameraId = device.deviceId;
                            console.log('üì∑ SKU Gate: Found BRIO:', device.deviceId.slice(0,8));
                        } else if(label.includes('c922') || label.includes('922')) {
                            secondaryCameraId = device.deviceId;
                            console.log('üì∑ SKU Gate: Found C922X:', device.deviceId.slice(0,8));
                        }
                    }
                    
                    // Fallback: use first available camera
                    if(!mainCameraId && !secondaryCameraId && videoDevices.length > 0) {
                        mainCameraId = videoDevices[0].deviceId;
                        console.log('üì∑ SKU Gate: Using first camera:', mainCameraId.slice(0,8));
                    }
                } catch(e) {
                    console.error('üì∑ SKU Gate: Camera access failed:', e);
                }
            }
            
            // Use C922X (secondary camera) for barcode scanning, fallback to BRIO
            const cameraId = secondaryCameraId || mainCameraId;
            console.log('üì∑ SKU Gate: Using camera:', cameraId ? cameraId.slice(0,8) : 'NONE');
            
            // Hide error overlay by default
            document.getElementById('sku-gate-error').classList.add('hidden');
            
            if(!cameraId) {
                // Show error overlay
                document.getElementById('sku-gate-error').classList.remove('hidden');
                document.getElementById('sku-gate-scan-input').placeholder = 'Type SKU manually...';
                document.getElementById('sku-gate-scan-input').focus();
                return;
            }
            
            const video = document.getElementById('sku-gate-video');
            const statusEl = document.getElementById('scanner-status');
            
            // Try native BarcodeDetector first (Chrome only, very fast)
            if('BarcodeDetector' in window) {
                console.log('üì∑ Using native BarcodeDetector API');
                if(statusEl) statusEl.innerHTML = '‚ö° Fast Scanner Active';
                
                try {
                    // Create our own stream for native API
                    skuGateStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: cameraId }, width: { ideal: 1280 }, height: { ideal: 720 } }
                    });
                    video.srcObject = skuGateStream;
                    await video.play();
                    
                    const barcodeDetector = new BarcodeDetector({
                        formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code', 'codabar']
                    });
                    
                    let scanning = true;
                    
                    const scanFrame = async () => {
                        if(!scanning || !skuGateStream) return;
                        
                        if(video.readyState >= 2 && !video.paused) {
                            try {
                                const barcodes = await barcodeDetector.detect(video);
                                if(barcodes.length > 0) {
                                    const result = barcodes[0].rawValue;
                                    console.log('üì∑ Barcode detected (native):', result);
                                    scanning = false;
                                    
                                    const input = document.getElementById('sku-gate-scan-input');
                                    input.value = result;
                                    input.classList.add('valid');
                                    if(navigator.vibrate) navigator.vibrate(100);
                                    
                                    setTimeout(() => {
                                        if(input.value === result) lockSku(result);
                                    }, 300);
                                    return;
                                }
                            } catch(e) {}
                        }
                        
                        if(scanning && skuGateStream) {
                            skuGateScanInterval = setTimeout(scanFrame, 150);
                        }
                    };
                    
                    skuGateBarcodeReader = { _stopScanning: () => { scanning = false; }, reset: () => { scanning = false; } };
                    
                    // Start stabilizer
                    startSkuGateStabilizer(video);
                    
                    // Start scanning
                    setTimeout(scanFrame, 500);
                    console.log('üì∑ Native barcode scanning started');
                    
                } catch(err) {
                    console.warn('Native BarcodeDetector failed:', err);
                    // Fall through to ZXing
                }
            }
            
            // Fallback: Use ZXing (let it manage its own stream)
            if(!skuGateBarcodeReader && typeof ZXing !== 'undefined') {
                console.log('üì∑ Using ZXing library');
                if(statusEl) statusEl.innerHTML = 'üì∑ Camera Scanner Active';
                
                try {
                    const codeReader = new ZXing.BrowserMultiFormatReader();
                    skuGateBarcodeReader = codeReader;
                    
                    let scanning = true;
                    
                    // Let ZXing manage the video stream - pass the camera ID
                    codeReader.decodeFromVideoDevice(cameraId, 'sku-gate-video', (result, err) => {
                        if(!scanning) return;
                        
                        // Update stream reference for cleanup
                        if(!skuGateStream && video.srcObject) {
                            skuGateStream = video.srcObject;
                            // Start stabilizer once video is ready
                            if(video.readyState >= 2) {
                                startSkuGateStabilizer(video);
                            } else {
                                video.onloadeddata = () => startSkuGateStabilizer(video);
                            }
                        }
                        
                        if(result && result.text) {
                            console.log('üì∑ Barcode detected (ZXing):', result.text);
                            scanning = false;
                            
                            const input = document.getElementById('sku-gate-scan-input');
                            input.value = result.text;
                            input.classList.add('valid');
                            if(navigator.vibrate) navigator.vibrate(100);
                            
                            setTimeout(() => {
                                if(input.value === result.text) lockSku(result.text);
                            }, 300);
                        }
                    });
                    
                    skuGateBarcodeReader._stopScanning = () => {
                        scanning = false;
                        try { codeReader.reset(); } catch(e) {}
                    };
                    
                    console.log('üì∑ ZXing scanning started with camera:', cameraId.slice(0, 8));
                    
                } catch(err) {
                    console.error('ZXing init error:', err);
                    if(statusEl) statusEl.innerHTML = 'üîå Use USB Scanner';
                }
            }
            
            // If nothing worked, show USB scanner message
            if(!skuGateBarcodeReader) {
                if(statusEl) statusEl.innerHTML = 'üîå Use USB Scanner';
                document.getElementById('sku-gate-scan-input').placeholder = 'Use USB scanner...';
            }
            
            // Focus scan input for USB scanner
            setTimeout(() => document.getElementById('sku-gate-scan-input').focus(), 100);
        }
        
        async function startSkuGateBarcodeScanning(video) {
            console.log('üì∑ Starting barcode scanning...');
            const statusEl = document.getElementById('scanner-status');
            
            // Try native BarcodeDetector API first (FAST - hardware accelerated)
            if('BarcodeDetector' in window) {
                console.log('üì∑ Using native BarcodeDetector API (fast!)');
                if(statusEl) statusEl.innerHTML = '‚ö° Fast Scanner Active';
                try {
                    const barcodeDetector = new BarcodeDetector({
                        formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code', 'codabar']
                    });
                    
                    let scanning = true;
                    
                    const scanFrame = async () => {
                        if(!scanning || !skuGateStream) return;
                        
                        // Make sure video is actually playing
                        if(video.readyState < 2 || video.paused) {
                            if(scanning && skuGateStream) {
                                skuGateScanInterval = setTimeout(scanFrame, 200);
                            }
                            return;
                        }
                        
                        try {
                            const barcodes = await barcodeDetector.detect(video);
                            
                            if(barcodes.length > 0) {
                                const result = barcodes[0].rawValue;
                                console.log('üì∑ Barcode detected (native):', result);
                                scanning = false;
                                
                                const input = document.getElementById('sku-gate-scan-input');
                                input.value = result;
                                input.classList.add('valid');
                                
                                if(navigator.vibrate) navigator.vibrate(100);
                                
                                setTimeout(() => {
                                    if(input.value === result) {
                                        lockSku(result);
                                    }
                                }, 300);
                                return;
                            }
                        } catch(e) {
                            // Frame not ready or no barcode - ignore
                        }
                        
                        // Scan every 200ms to prevent flashing (not every frame)
                        if(scanning && skuGateStream) {
                            skuGateScanInterval = setTimeout(scanFrame, 200);
                        }
                    };
                    
                    skuGateBarcodeReader = { 
                        _stopScanning: () => { scanning = false; },
                        reset: () => { scanning = false; }
                    };
                    
                    // Start scanning after a brief delay
                    setTimeout(scanFrame, 500);
                    
                    console.log('üì∑ Native barcode scanning started');
                    return;
                    
                } catch(err) {
                    console.warn('BarcodeDetector failed, falling back to ZXing:', err);
                }
            }
            
            // Fallback to ZXing (slower, but works everywhere)
            if(typeof ZXing === 'undefined') {
                console.warn('‚ö†Ô∏è No barcode library available - use USB scanner');
                if(statusEl) statusEl.innerHTML = 'üîå Use USB Scanner';
                document.getElementById('sku-gate-scan-input').placeholder = 'Use USB scanner...';
                return;
            }
            
            console.log('üì∑ Using ZXing fallback');
            if(statusEl) statusEl.innerHTML = 'üì∑ Camera Scanner Active';
            try {
                const codeReader = new ZXing.BrowserMultiFormatReader();
                skuGateBarcodeReader = codeReader;
                
                let scanning = true;
                let scanCount = 0;
                
                // Use continuous decode from the existing video element
                codeReader.decodeFromVideoDevice(null, 'sku-gate-video', (result, err) => {
                    if(!scanning) return;
                    
                    scanCount++;
                    if(scanCount % 30 === 0) {
                        console.log(`üì∑ Scanning... (${scanCount} frames)`);
                    }
                    
                    if(result && result.text) {
                        console.log('üì∑ Barcode detected (ZXing):', result.text);
                        scanning = false;
                        codeReader.reset();
                        
                        const input = document.getElementById('sku-gate-scan-input');
                        input.value = result.text;
                        input.classList.add('valid');
                        
                        if(navigator.vibrate) navigator.vibrate(100);
                        
                        setTimeout(() => {
                            if(input.value === result.text) {
                                lockSku(result.text);
                            }
                        }, 300);
                    }
                    // Errors are expected when no barcode is in frame - ignore them
                });
                
                skuGateBarcodeReader._stopScanning = () => { 
                    scanning = false;
                    try { codeReader.reset(); } catch(e) {}
                };
                
                console.log('üì∑ ZXing continuous scanning started');
                
            } catch(err) {
                console.error('ZXing init error:', err);
                if(statusEl) statusEl.innerHTML = 'üîå Use USB Scanner';
                document.getElementById('sku-gate-scan-input').placeholder = 'Use USB scanner...';
            }
        }
        
        function stopSkuGateBarcodeScanning() {
            if(skuGateBarcodeReader) {
                try { 
                    if(skuGateBarcodeReader._stopScanning) {
                        skuGateBarcodeReader._stopScanning();
                    }
                    if(skuGateBarcodeReader.reset) {
                        skuGateBarcodeReader.reset();
                    }
                    console.log('üì∑ Barcode scanning stopped');
                } catch(e) {}
                skuGateBarcodeReader = null;
            }
            if(skuGateScanInterval) {
                cancelAnimationFrame(skuGateScanInterval);
                clearTimeout(skuGateScanInterval);
                skuGateScanInterval = null;
            }
        }
        
        function startSkuGateStabilizer(video) {
            // Use a canvas to sample frames for motion detection
            const canvas = document.createElement('canvas');
            canvas.width = 64; // Small size for fast processing
            canvas.height = 48;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            let lastFrame = null;
            let stableFrames = 0;
            const STABLE_THRESHOLD = 8; // Frames needed to be "stable"
            const MOTION_THRESHOLD = 15; // Pixel difference threshold
            
            skuGateStabilizer = setInterval(() => {
                if(!skuGateStream) {
                    clearInterval(skuGateStabilizer);
                    return;
                }
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                if(lastFrame) {
                    let diff = 0;
                    for(let i = 0; i < frame.data.length; i += 16) { // Sample every 16th pixel
                        diff += Math.abs(frame.data[i] - lastFrame.data[i]);
                    }
                    const avgDiff = diff / (frame.data.length / 16);
                    
                    if(avgDiff < MOTION_THRESHOLD) {
                        stableFrames++;
                        if(stableFrames >= STABLE_THRESHOLD) {
                            updateSkuGateStabilizer(true);
                        }
                    } else {
                        stableFrames = 0;
                        updateSkuGateStabilizer(false);
                    }
                }
                
                lastFrame = frame;
            }, 100); // Check every 100ms
        }
        
        function updateSkuGateStabilizer(stable) {
            skuGateIsStable = stable;
            const indicator = document.getElementById('sku-gate-stabilizer');
            const dot = document.getElementById('sku-gate-stabilizer-dot');
            const text = document.getElementById('sku-gate-stabilizer-text');
            
            if(!indicator) return;
            
            if(stable) {
                indicator.classList.add('stable');
                dot.classList.add('stable');
                text.textContent = '‚úì STABLE';
            } else {
                indicator.classList.remove('stable');
                dot.classList.remove('stable');
                text.textContent = 'HOLD STEADY';
            }
        }
        
        function stopSkuGateStabilizer() {
            if(skuGateStabilizer) {
                clearInterval(skuGateStabilizer);
                skuGateStabilizer = null;
            }
        }
        
        function onSkuGateScanInput() {
            const input = document.getElementById('sku-gate-scan-input');
            const value = input.value.trim();
            
            if(value.length >= 3) {
                input.classList.add('valid');
            } else {
                input.classList.remove('valid');
            }
        }
        
        function handleSkuGateScanKeydown(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const value = document.getElementById('sku-gate-scan-input').value.trim();
                if(value.length >= 1) {
                    lockSku(value);
                }
            }
        }
        
        function cancelSkuGateScan() {
            // Stop barcode scanning
            stopSkuGateBarcodeScanning();
            
            // Stop stabilizer
            stopSkuGateStabilizer();
            
            // Stop video stream
            if(skuGateStream) {
                skuGateStream.getTracks().forEach(t => t.stop());
                skuGateStream = null;
            }
            
            // Hide camera, show entry form
            document.getElementById('sku-gate-camera').classList.add('hidden');
            document.getElementById('sku-gate-entry').classList.remove('hidden');
            document.getElementById('sku-gate-status').textContent = '';
            document.getElementById('sku-gate-scan-input').placeholder = 'Waiting for scan...';
            
            // Focus input
            document.getElementById('sku-gate-input').focus();
        }
        
        function lockSku(value) {
            data.sku = value;
            skuLocked = true;
            
            // Stop SKU gate barcode scanning, stabilizer and camera
            stopSkuGateBarcodeScanning();
            stopSkuGateStabilizer();
            if(skuGateStream) {
                skuGateStream.getTracks().forEach(t => t.stop());
                skuGateStream = null;
            }
            
            // Hide SKU gate
            hideSkuGate();
            
            // Update locked badge in progress bar
            document.getElementById('sku-locked-badge').classList.remove('hidden');
            document.getElementById('sku-locked-value').textContent = value;
            
            // Update SKU section in Step 3
            document.getElementById('sku-locked-display').classList.remove('hidden');
            document.getElementById('sku-locked-display').style.display = 'flex';
            document.getElementById('sku-display-value').textContent = value;
            document.getElementById('sku-manual-input').classList.add('hidden');
            document.getElementById('sku-input').value = value;
            
            // Mark SKU as complete
            document.getElementById('check-sku').innerHTML = '‚úì';
            document.getElementById('check-sku').classList.add('complete');
            
            // Stop barcode scanning if active
            stopBarcodeScanning();
            
            // Switch back to main camera mode
            setPhotoMode('main');
            
            showToast('success', 'SKU Locked', `Item: ${value}`, 2000);
            updateValidation();
        }
        
        function unlockSku() {
            // Allow editing the SKU
            document.getElementById('sku-locked-display').classList.add('hidden');
            document.getElementById('sku-locked-display').style.display = 'none';
            document.getElementById('sku-manual-input').classList.remove('hidden');
            document.getElementById('sku-input').focus();
            document.getElementById('sku-input').select();
        }
        
        // Override onSkuInput to update locked state
        function onSkuInput() { 
            const val = document.getElementById('sku-input').value.trim();
            data.sku = val;
            
            if(val) {
                // Update locked badge
                document.getElementById('sku-locked-badge').classList.remove('hidden');
                document.getElementById('sku-locked-value').textContent = val;
            }
            
            updateValidation();
        }
        
        function goToStep(step) { currentStep = step; document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active')); document.getElementById(`step-${step}`).classList.add('active'); document.querySelectorAll('.progress-dot').forEach((d,i) => { d.classList.remove('active'); if(i+1 < step) d.classList.add('complete'); else d.classList.remove('complete'); if(i+1 === step) d.classList.add('active'); }); const labels = {1:'Step 1: Tag', 2:'Step 2: Check', 3:'Step 3: Snap', 4:'Step 4: Review'}; document.getElementById('step-label').textContent = labels[step] || ''; if(step===4) updateReviewCards(); }
        
        function updateReviewCards() {
            document.getElementById('summary-tag').innerHTML = `${data.category||'?'} ‚Ä¢ ${data.tagSize||'?'}<br>${data.origin==='usa'?'<img src="https://flagcdn.com/w16/us.png" style="vertical-align:middle;"> USA':data.country||''} ‚Ä¢ ${data.gender||''}`;
            document.getElementById('summary-check').innerHTML = `${data.fabricType||'?'} / ${data.materials.length?data.materials.join('+'):'?'}<br>${(data.colors||[]).slice(0,3).join(', ')||'?'} ‚Ä¢ ${data.pattern||'?'}`;
            const pc = data.mainPhotos.length + data.tagPhotos.length + data.defectPhotos.length;
            document.getElementById('summary-snap').innerHTML = `${pc} photo(s)<br>${data.audioMeasure?'Audio: '+formatTime(data.audioDuration):'No audio'}`;
            document.getElementById('summary-weight').innerHTML = (data.weightLb>0||data.weightOz>0) ? `${data.weightLb} lb ${data.weightOz} oz<br>SKU: ${data.sku||'?'}` : 'No weight';
            
            setCardStatus('tag', !!data.category && !!data.tagStatus);
            setCardStatus('check', !!data.fabricType && data.colors.length>0 && !!data.pattern && data.materials.length>0);
            setCardStatus('snap', data.mainPhotos.length>0 && !!data.audioMeasure);
            setCardStatus('weight', (data.weightLb>0 || data.weightOz>0) && !!data.sku);
        }
        function setCardStatus(name, ok) { const card = document.getElementById(`card-${name}`); const icon = document.getElementById(`icon-${name}`); card.classList.remove('card-green','card-yellow'); card.classList.add(ok?'card-green':'card-yellow'); icon.textContent = ok?'‚úÖ':'‚ö†Ô∏è'; }
        
        function startTimer() { timerStart = Date.now(); if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimerDisplay, 1000); updateTimerDisplay(); }
        function updateTimerDisplay() { if (!timerStart) return; const elapsed = Math.floor((Date.now() - timerStart) / 1000); document.getElementById('timer-current').textContent = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`; }
        function recordItemTime() { if (!timerStart) return; const elapsed = Math.floor((Date.now() - timerStart) / 1000); itemTimes.push(elapsed); document.getElementById('timer-last').textContent = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`; const avg = Math.floor(itemTimes.reduce((a,b)=>a+b,0)/itemTimes.length); document.getElementById('timer-avg').textContent = `${Math.floor(avg/60)}:${(avg%60).toString().padStart(2,'0')}`; startTimer(); }
        
        async function enumerateCameras() { 
            try { 
                // IMPORTANT: Request permission with HIGH resolution to avoid Chrome caching low res
                console.log('üì∑ Requesting camera permission with high resolution hint...');
                const permStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 3840 }, 
                        height: { ideal: 2160 } 
                    }
                }); 
                // Stop permission stream immediately
                permStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 300));
                
                const devices = await navigator.mediaDevices.enumerateDevices(); 
                // Filter out virtual cameras (DroidCam, OBS, ManyCam, etc.)
                const videoDevices = devices.filter(d => {
                    if(d.kind !== 'videoinput') return false;
                    const label = (d.label || '').toLowerCase();
                    const virtualCameras = ['droidcam', 'obs', 'manycam', 'virtual', 'snap camera', 'xsplit', 'streamlabs'];
                    return !virtualCameras.some(v => label.includes(v));
                });
                const select = document.getElementById('camera-select'); 
                select.innerHTML = '<option value="">Select Camera...</option>'; 
                
                console.log(`üì∑ Found ${videoDevices.length} cameras (virtual cameras filtered out):`);
                
                videoDevices.forEach((device,i)=>{ 
                    const option = document.createElement('option'); 
                    option.value = device.deviceId; 
                    option.textContent = device.label || `Camera ${i+1}`; 
                    select.appendChild(option);
                    
                    console.log(`  ${i+1}. ${device.label} (${device.deviceId.slice(0,8)}...)`);
                    
                    // Auto-detect cameras by name
                    const label = device.label.toLowerCase();
                    if(label.includes('brio')) {
                        mainCameraId = device.deviceId;
                        console.log('  ‚Üí Set as MAIN camera (Brio 4K)');
                    }
                    if(label.includes('c922') || label.includes('922')) {
                        secondaryCameraId = device.deviceId;
                        console.log('  ‚Üí Set as SECONDARY camera (C922X)');
                    }
                });
                
                // Start with main camera if detected
                if(mainCameraId) {
                    select.value = mainCameraId;
                    // For BRIO, use aggressive max resolution
                    await switchCameraMaxRes(mainCameraId);
                    // Auto-trigger full resolution to ensure max quality
                    setTimeout(() => {
                        console.log('üì∑ Auto-triggering FULL RES on startup...');
                        forceMaxResolution();
                    }, 1000);
                } else if(videoDevices.length > 0) {
                    // Fallback to first camera
                    mainCameraId = videoDevices[0].deviceId;
                    select.value = mainCameraId;
                    await switchCamera(mainCameraId);
                }
                
                updateCameraIndicator();
                
                // Enable defect marking since we start in main mode
                if(photoMode === 'main') {
                    enableDefectMarking();
                    console.log('üì∑ Defect marking enabled on startup');
                }
            } catch(err){ console.error('Camera error:', err); } 
        }
        
        // V99.45: Aggressive max resolution switch for BRIO
        async function switchCameraMaxRes(deviceId) {
            if(!deviceId) return;
            
            console.log('üì∑ switchCameraMaxRes: Forcing 4K...');
            const video = document.getElementById('camera-video');
            video.classList.add('switching');
            
            // Stop everything first
            stopStabilizer();
            if(currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            
            // Longer delay for camera to fully release
            await new Promise(r => setTimeout(r, 500));
            
            // Try Brio's max resolution (4096x2160) first, then fall back
            const resolutions = [
                { w: 4096, h: 2160, name: '4K DCI (Brio Max)' },
                { w: 3840, h: 2160, name: '4K UHD' },
                { w: 2560, h: 1440, name: '1440p' },
                { w: 1920, h: 1080, name: '1080p' },
                { w: 1280, h: 720, name: '720p' }
            ];
            
            for(const res of resolutions) {
                try {
                    console.log(`üì∑ Trying ${res.name} (${res.w}x${res.h})...`);
                    
                    // Use EXACT constraint - this forces the resolution or fails
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: { exact: deviceId },
                            width: { exact: res.w },
                            height: { exact: res.h }
                        }
                    });
                    
                    const track = currentStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    console.log(`‚úÖ Got ${settings.width}x${settings.height}`);
                    
                    video.srcObject = currentStream;
                    video.style.display = 'block';
                    document.getElementById('camera-placeholder').style.display = 'none';
                    document.getElementById('camera-overlay').style.display = 'block';
                    document.getElementById('camera-status').textContent = 'LIVE';
                    document.getElementById('camera-status').classList.add('live');
                    activeCameraId = deviceId;
                    document.getElementById('camera-select').value = deviceId;
                    
                    video.onloadedmetadata = () => {
                        const w = video.videoWidth;
                        const h = video.videoHeight;
                        console.log(`üì∑ Video ready: ${w}x${h}`);
                        document.getElementById('camera-resolution').textContent = `${w}√ó${h}`;
                        
                        const resEl = document.getElementById('camera-resolution');
                        if(w >= 3800) {
                            resEl.style.color = '#22c55e';
                        } else if(w >= 1900) {
                            resEl.style.color = '#3b82f6';
                        } else if(w >= 1200) {
                            resEl.style.color = '#f59e0b';
                        } else {
                            resEl.style.color = '#ef4444';
                        }
                        
                        video.classList.remove('switching');
                        
                        // Apply portrait mode if in main photo mode
                        if(photoMode === 'main') {
                            video.classList.add('portrait-mode');
                            console.log('üì∑ Portrait mode applied on load');
                            setTimeout(() => updatePortraitTransform(), 100);
                        }
                        
                        setTimeout(() => startStabilizer(), 200);
                    };
                    
                    updateCameraIndicator();
                    return; // Success!
                    
                } catch(err) {
                    console.log(`‚ùå ${res.name} failed: ${err.message}`);
                    if(currentStream) {
                        currentStream.getTracks().forEach(t => t.stop());
                        currentStream = null;
                    }
                    await new Promise(r => setTimeout(r, 200));
                }
            }
            
            // All exact resolutions failed - fall back to ideal constraints
            console.log('‚ö†Ô∏è Exact constraints failed, trying ideal...');
            await switchCamera(deviceId);
        }
        
        // Force maximum resolution by restarting camera with strict constraints
        async function forceMaxResolution() {
            if(!activeCameraId) {
                showToast('warning', 'No Camera', 'Select a camera first');
                return;
            }
            
            console.log('üîÑ FULL RES: Forcing maximum resolution...');
            document.getElementById('camera-resolution').textContent = 'Switching...';
            document.getElementById('camera-resolution').style.color = '#f59e0b';
            
            const video = document.getElementById('camera-video');
            
            // Stop current stream completely
            if(currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            
            // Wait for camera to fully release
            await new Promise(r => setTimeout(r, 500));
            
            // Get max capabilities
            let maxWidth = 1920, maxHeight = 1080;
            try {
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: activeCameraId } }
                });
                const track = tempStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if(capabilities.width?.max) maxWidth = capabilities.width.max;
                if(capabilities.height?.max) maxHeight = capabilities.height.max;
                
                console.log(`üì∑ FULL RES: Max capability: ${maxWidth}x${maxHeight}`);
                tempStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 300));
            } catch(e) {
                console.log('üì∑ FULL RES: Could not get capabilities, trying defaults');
            }
            
            // Now request EXACT max resolution
            try {
                const constraints = {
                    video: {
                        deviceId: { exact: activeCameraId },
                        width: { ideal: maxWidth, min: Math.min(maxWidth, 1920) },
                        height: { ideal: maxHeight, min: Math.min(maxHeight, 1080) }
                    }
                };
                
                console.log(`üì∑ FULL RES: Requesting ${maxWidth}x${maxHeight}...`);
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = currentStream;
                video.style.display = 'block';
                document.getElementById('camera-placeholder').style.display = 'none';
                document.getElementById('camera-overlay').style.display = 'block';
                document.getElementById('camera-status').textContent = 'LIVE';
                document.getElementById('camera-status').classList.add('live');
                
                video.onloadedmetadata = () => {
                    const actualW = video.videoWidth;
                    const actualH = video.videoHeight;
                    console.log(`‚úÖ FULL RES: Got ${actualW}x${actualH}`);
                    document.getElementById('camera-resolution').textContent = `${actualW}√ó${actualH}`;
                    
                    // Apply portrait mode if in main photo mode
                    if(photoMode === 'main') {
                        video.classList.add('portrait-mode');
                        setTimeout(() => updatePortraitTransform(), 100);
                    } else {
                        video.classList.remove('portrait-mode');
                    }
                    
                    if(actualW >= 3800) {
                        document.getElementById('camera-resolution').style.color = '#22c55e';
                        showToast('success', '4K Resolution Active', `${actualW}√ó${actualH} - Full quality for AI processing`);
                    } else if(actualW >= 1900) {
                        document.getElementById('camera-resolution').style.color = '#3b82f6';
                        showToast('info', '1080p Resolution', `${actualW}√ó${actualH} - Good quality`, 3000);
                    } else {
                        document.getElementById('camera-resolution').style.color = '#ef4444';
                        showToast('warning', 'Low Resolution', `${actualW}√ó${actualH} - Check USB 3.0 port`, 5000);
                    }
                };
                
            } catch(err) {
                console.error('üì∑ FULL RES: Failed:', err);
                showToast('error', 'Resolution Error', err.message);
                // Fall back to normal switch
                switchCamera(activeCameraId);
            }
        }
        
        // ============ PORTRAIT MODE SIZING ============
        function updatePortraitTransform() {
            const video = document.getElementById('camera-video');
            if(!video.classList.contains('portrait-mode')) {
                video.style.transform = currentZoom !== 1.0 ? `scale(${currentZoom})` : '';
                // Reset defect layer to full container
                const layer = document.getElementById('defect-markers-layer');
                if(layer) layer.style.cssText = 'position:absolute;inset:0;pointer-events:none;z-index:5;';
                return;
            }
            
            // Get container dimensions
            const container = document.querySelector('.camera-view');
            if(!container) return;
            
            const containerW = container.clientWidth;
            const containerH = container.clientHeight;
            
            // Video dimensions (before rotation)
            const videoW = video.videoWidth || 1920;
            const videoH = video.videoHeight || 1080;
            
            // After 90¬∞ rotation, dimensions swap: visual width = videoH, visual height = videoW
            const rotatedW = videoH; // e.g., 2168 from 4096x2168
            const rotatedH = videoW; // e.g., 4096 from 4096x2168
            
            // For preview: FILL the container width (height will overflow/clip - that's OK)
            // This eliminates black bars on the sides
            const fillScale = containerW / rotatedW;
            
            // Apply rotation + fill scale + user zoom
            const totalScale = fillScale * currentZoom;
            video.style.transform = `rotate(-90deg) scale(${totalScale})`;
            
            // Update defect markers layer to match visible video area
            updateDefectLayerBounds(containerW, containerH, rotatedW, rotatedH, fillScale);
            
            console.log(`üìê Portrait: container ${containerW}x${containerH}, rotated ${rotatedW}x${rotatedH}, scale ${fillScale.toFixed(3)}`);
        }
        
        function updateDefectLayerBounds(containerW, containerH, rotatedW, rotatedH, scale) {
            const layer = document.getElementById('defect-markers-layer');
            if(!layer) return;
            
            // Calculate the actual displayed size of the rotated video
            const displayedW = rotatedW * scale; // This should equal containerW
            const displayedH = rotatedH * scale; // This may be taller than containerH
            
            // The video fills width, may overflow height
            // Layer should cover the VISIBLE portion only
            const visibleW = containerW;
            const visibleH = Math.min(displayedH, containerH);
            
            // Center vertically if video is shorter than container (unlikely with portrait)
            const offsetY = displayedH < containerH ? (containerH - displayedH) / 2 : 0;
            
            // DON'T set pointer-events here - let the CSS .active class handle it
            layer.style.position = 'absolute';
            layer.style.width = visibleW + 'px';
            layer.style.height = visibleH + 'px';
            layer.style.left = '0';
            layer.style.top = offsetY + 'px';
            layer.style.zIndex = '5';
            // pointer-events is controlled by .active class
        }
        
        // Update on window resize
        window.addEventListener('resize', () => {
            if(document.getElementById('camera-video')?.classList.contains('portrait-mode')) {
                updatePortraitTransform();
            }
            // Re-render markers when window resizes (image bounds change)
            if(defectMarkers.length > 0) {
                renderDefectMarkers();
            }
        });
        
        // ============ ZOOM FUNCTIONS ============
        let currentZoom = 1.0;
        
        function resetZoom() {
            currentZoom = 1.0;
            updatePortraitTransform();
        }
        
        async function switchCamera(deviceId) { 
            if(!deviceId) {
                console.error('‚ùå switchCamera called with no deviceId');
                return; 
            }
            
            console.log(`üì∑ Switching to camera: ${deviceId.slice(0,8)}...`);
            
            const video = document.getElementById('camera-video');
            
            // Add switching class for smooth transition
            video.classList.add('switching');
            
            // Stop stabilizer first
            stopStabilizer();
            
            // Reset zoom when switching cameras
            resetZoom();
            
            // Stop current stream first
            if(currentStream) {
                console.log('üì∑ Stopping current stream...');
                currentStream.getTracks().forEach(t=>t.stop()); 
                currentStream = null;
            }
            
            // Small delay to let camera release
            await new Promise(r => setTimeout(r, 200));
            
            // STEP 1: Get camera capabilities first
            let maxWidth = 1920, maxHeight = 1080;
            try {
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: deviceId } }
                });
                const track = tempStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if(capabilities.width?.max) maxWidth = capabilities.width.max;
                if(capabilities.height?.max) maxHeight = capabilities.height.max;
                
                console.log(`üì∑ Camera capabilities: max ${maxWidth}x${maxHeight}`);
                tempStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 100));
            } catch(e) {
                console.log('üì∑ Could not get capabilities, using defaults');
            }
            
            // STEP 2: Request the MAXIMUM resolution with exact/min constraints
            const isBrio = deviceId === mainCameraId;
            let success = false;
            
            // Try exact max resolution first, then fall back
            const resolutions = [];
            
            if(maxWidth >= 3840) {
                resolutions.push({ width: 3840, height: 2160, name: '4K' });
            }
            if(maxWidth >= 1920) {
                resolutions.push({ width: 1920, height: 1080, name: '1080p' });
            }
            resolutions.push({ width: 1280, height: 720, name: '720p' });
            resolutions.push({ width: 640, height: 480, name: '480p' });
            
            for(const res of resolutions) {
                try {
                    console.log(`üì∑ Requesting ${res.name} (${res.width}x${res.height}) with min constraint...`);
                    
                    // Use 'min' to FORCE at least this resolution, 'ideal' for target
                    const constraints = {
                        video: {
                            deviceId: { exact: deviceId },
                            width: { min: res.width, ideal: res.width },
                            height: { min: res.height, ideal: res.height }
                        }
                    };
                    
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Verify we got what we asked for
                    const track = currentStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    console.log(`‚úÖ Got stream: ${settings.width}x${settings.height}`);
                    
                    // Check if resolution is acceptable
                    if(settings.width < res.width * 0.9) {
                        console.log(`‚ö†Ô∏è Resolution too low (${settings.width} < ${res.width}), trying next...`);
                        currentStream.getTracks().forEach(t => t.stop());
                        currentStream = null;
                        continue;
                    }
                    
                    video.srcObject = currentStream; 
                    video.style.display = 'block'; 
                    document.getElementById('camera-placeholder').style.display = 'none'; 
                    document.getElementById('camera-overlay').style.display = 'block'; 
                    document.getElementById('camera-status').textContent = 'LIVE'; 
                    document.getElementById('camera-status').classList.add('live'); 
                    activeCameraId = deviceId;
                    document.getElementById('camera-select').value = deviceId;
                    
                    video.onloadedmetadata = () => {
                        console.log(`üì∑ Video element ready: ${video.videoWidth}x${video.videoHeight}`);
                        document.getElementById('camera-resolution').textContent = `${video.videoWidth}√ó${video.videoHeight}`;
                        
                        // Color code resolution
                        const resEl = document.getElementById('camera-resolution');
                        if(video.videoWidth >= 3800) {
                            resEl.style.color = '#22c55e'; // Green for 4K
                        } else if(video.videoWidth >= 1900) {
                            resEl.style.color = '#3b82f6'; // Blue for 1080p
                        } else if(video.videoWidth >= 1200) {
                            resEl.style.color = '#f59e0b'; // Orange for 720p
                        } else {
                            resEl.style.color = '#ef4444'; // Red for low res
                        }
                        
                        setTimeout(() => video.classList.remove('switching'), 50);
                        
                        // Apply portrait mode if in main photo mode
                        if(photoMode === 'main') {
                            video.classList.add('portrait-mode');
                            setTimeout(() => updatePortraitTransform(), 100);
                        } else {
                            video.classList.remove('portrait-mode');
                        }
                        
                        // Start stabilizer after video is ready
                        stopStabilizer();
                        setTimeout(() => startStabilizer(), 200);
                    };
                    
                    updateCameraIndicator();
                    success = true;
                    break;
                    
                } catch(err) {
                    console.log(`‚ùå ${res.name} failed:`, err.message);
                }
            }
            
            if(!success) {
                // Last resort: let browser pick any resolution
                console.log('üì∑ Fallback: letting browser choose resolution...');
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: deviceId } }
                    });
                    video.srcObject = currentStream;
                    video.style.display = 'block';
                    document.getElementById('camera-placeholder').style.display = 'none';
                    document.getElementById('camera-overlay').style.display = 'block';
                    document.getElementById('camera-status').textContent = 'LIVE';
                    document.getElementById('camera-status').classList.add('live');
                    activeCameraId = deviceId;
                    document.getElementById('camera-select').value = deviceId;
                    
                    video.onloadedmetadata = () => {
                        console.log(`‚ö†Ô∏è Fallback resolution: ${video.videoWidth}x${video.videoHeight}`);
                        document.getElementById('camera-resolution').textContent = `${video.videoWidth}√ó${video.videoHeight}`;
                        document.getElementById('camera-resolution').style.color = '#ef4444';
                        video.classList.remove('switching');
                        
                        // Apply portrait mode if in main photo mode
                        if(photoMode === 'main') {
                            video.classList.add('portrait-mode');
                            setTimeout(() => updatePortraitTransform(), 100);
                        } else {
                            video.classList.remove('portrait-mode');
                        }
                        
                        // Start stabilizer after video is ready
                        stopStabilizer();
                        setTimeout(() => startStabilizer(), 200);
                    };
                    updateCameraIndicator();
                    success = true;
                } catch(err2) {
                    console.error('‚ùå All camera attempts failed:', err2);
                    showToast('error', 'Camera Error', err2.message);
                    video.classList.remove('switching');
                }
            }
            
            console.log(`üì∑ Camera switch ${success ? 'SUCCESS' : 'FAILED'}, activeCameraId: ${activeCameraId?.slice(0,8)}...`);
        }
        
        async function setPhotoMode(mode) { 
            console.log(`üì∑ setPhotoMode: ${mode}`);
            console.log(`   mainCameraId: ${mainCameraId?.slice(0,8) || 'null'}`);
            console.log(`   secondaryCameraId: ${secondaryCameraId?.slice(0,8) || 'null'}`);
            console.log(`   activeCameraId: ${activeCameraId?.slice(0,8) || 'null'}`);
            
            const previousMode = photoMode;
            photoMode = mode; 
            document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); 
            document.getElementById(`mode-${mode}`).classList.add('active'); 
            
            // Toggle portrait mode for main photos only
            const video = document.getElementById('camera-video');
            if(mode === 'main') {
                video.classList.add('portrait-mode');
                console.log('üì∑ Portrait mode ON (rotated 90¬∞)');
                enableDefectMarking();
            } else {
                video.classList.remove('portrait-mode');
                video.style.transform = ''; // Clear transform
                console.log('üì∑ Portrait mode OFF (landscape)');
                disableDefectMarking();
            }
            
            // Reset zoom when switching modes
            resetZoom();
            
            // Auto-switch cameras based on mode
            if(mode === 'main') {
                video.style.display = 'block';
                
                if(mainCameraId) {
                    console.log(`üì∑ Main mode: checking if need to switch (active=${activeCameraId?.slice(0,8)}, main=${mainCameraId?.slice(0,8)})`);
                    if(activeCameraId !== mainCameraId) {
                        console.log('üì∑ SWITCHING to MAIN camera (BRIO)...');
                        try {
                            await switchCameraMaxRes(mainCameraId);
                            console.log('üì∑ Switch to BRIO complete');
                            // Ensure full resolution after switch
                            setTimeout(() => {
                                forceMaxResolution();
                                // Re-enable defect marking after camera switch
                                enableDefectMarking();
                            }, 500);
                        } catch(e) {
                            console.error('üì∑ Switch to BRIO failed:', e);
                        }
                    } else {
                        console.log('üì∑ Already on MAIN camera');
                        // Apply portrait transform
                        setTimeout(() => {
                            updatePortraitTransform();
                            // Re-enable defect marking
                            enableDefectMarking();
                        }, 50);
                    }
                } else {
                    console.warn('‚ö†Ô∏è mainCameraId not set');
                }
            } else if(mode === 'tag' || mode === 'defect' || mode === 'defect-closeup' || mode === 'features') {
                video.style.display = 'block';
                
                if(secondaryCameraId) {
                    console.log(`üì∑ ${mode} mode: checking if need to switch (active=${activeCameraId?.slice(0,8)}, secondary=${secondaryCameraId?.slice(0,8)})`);
                    if(activeCameraId !== secondaryCameraId) {
                        console.log('üì∑ SWITCHING to SECONDARY camera (C922X)...');
                        try {
                            await switchCamera(secondaryCameraId);
                            console.log('üì∑ Switch to C922X complete');
                        } catch(e) {
                            console.error('üì∑ Switch to C922X failed:', e);
                        }
                    } else {
                        console.log('üì∑ Already on SECONDARY camera');
                    }
                } else {
                    console.warn('‚ö†Ô∏è No secondary camera detected');
                }
            }
            
            // Always update camera indicator after mode change
            updateCameraIndicator();
            
            // Update selection panels based on mode
            updateDefectLinkPanel();
            updateFeatureTypePanel();
        }
        
        function updateCameraIndicator() {
            const indicator = document.getElementById('camera-indicator');
            if(!indicator) return;
            if(activeCameraId === mainCameraId) {
                indicator.textContent = 'üì¶ BRIO 4K (Main)';
                indicator.style.background = '#3b82f6';
            } else if(activeCameraId === secondaryCameraId) {
                if(photoMode === 'defect-closeup') {
                    indicator.textContent = 'üî¥ C922X (Defect Close-up)';
                    indicator.style.background = '#dc2626';
                } else if(photoMode === 'features') {
                    indicator.textContent = '‚ú® C922X (Feature Close-up)';
                    indicator.style.background = '#7c3aed';
                } else {
                    indicator.textContent = 'üè∑Ô∏è C922X (Tag)';
                    indicator.style.background = '#f59e0b';
                }
            } else {
                indicator.textContent = 'Camera';
                indicator.style.background = '#64748b';
            }
        }
        function capturePhoto() { 
            const video = document.getElementById('camera-video'); 
            if(!video.srcObject) return; 
            
            // Warn if not stable but still allow capture
            if(!isStable && navigator.vibrate) navigator.vibrate(100);
            
            // Check resolution before capture
            if(video.videoWidth < 1280) {
                console.error(`‚ö†Ô∏è LOW RESOLUTION CAPTURE: ${video.videoWidth}x${video.videoHeight}`);
                showToast('warning', 'Low Resolution', `Capturing at ${video.videoWidth}x${video.videoHeight}`, 3000);
            }
            
            // Flash effect
            document.getElementById('flash-overlay').classList.add('flash'); 
            setTimeout(()=>document.getElementById('flash-overlay').classList.remove('flash'),100); 
            
            const sourceW = video.videoWidth;
            const sourceH = video.videoHeight;
            
            if(photoMode === 'main') {
                // MAIN PHOTOS: Handle defect markers if any
                captureMainWithDefects(video, sourceW, sourceH);
            } else {
                // TAG/DEFECTS/SKU: Square 1:1 ratio (center crop)
                const canvas = document.createElement('canvas'); 
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                const size = Math.min(sourceW, sourceH);
                const cropX = Math.round((sourceW - size) / 2);
                const cropY = Math.round((sourceH - size) / 2);
                
                canvas.width = size;
                canvas.height = size;
                ctx.drawImage(video, cropX, cropY, size, size, 0, 0, size, size);
                
                console.log(`üì∏ ${photoMode.toUpperCase()} Square: ${sourceW}x${sourceH} ‚Üí ${canvas.width}x${canvas.height} (1:1 ratio)`);
                
                // Maximum JPEG quality (0.95) for best detail preservation
                canvas.toBlob(blob => { 
                    const photo = { 
                        blob, 
                        url: URL.createObjectURL(blob), 
                        width: canvas.width, 
                        height: canvas.height 
                    }; 
                    if(photoMode === 'tag') {
                        data.tagPhotos.push(photo);
                        // Auto-save to folder if selected
                        if(saveDirectoryHandle) {
                            const filename = generatePhotoFilename('tag', data.tagPhotos.length);
                            savePhotoToFolder(blob, filename);
                        }
                        showToast('success', `Tag Photo ${data.tagPhotos.length}`, `${canvas.width}√ó${canvas.height}`, 1500);
                    }
                    else if(photoMode === 'defect-closeup') {
                        // Add linked defect index if available
                        photo.linkedDefectIndex = selectedDefectLink;
                        data.defectCloseupPhotos.push(photo);
                        // Auto-save to folder if selected
                        if(saveDirectoryHandle) {
                            const filename = generatePhotoFilename('defect-closeup', data.defectCloseupPhotos.length);
                            savePhotoToFolder(blob, filename);
                        }
                        const linkText = selectedDefectLink !== null ? ` ‚Üí Defect #${selectedDefectLink + 1}` : '';
                        showToast('success', `üî¥ Defect Close-up ${data.defectCloseupPhotos.length}${linkText}`, `${canvas.width}√ó${canvas.height}`, 1500);
                    }
                    else if(photoMode === 'features') {
                        // Add feature type if selected
                        photo.featureType = selectedFeatureType || null;
                        data.featuresPhotos.push(photo);
                        // Auto-save to folder if selected
                        if(saveDirectoryHandle) {
                            const filename = generatePhotoFilename('feature', data.featuresPhotos.length);
                            savePhotoToFolder(blob, filename);
                        }
                        const typeText = selectedFeatureType ? ` (${selectedFeatureType})` : '';
                        showToast('success', `‚ú® Feature Close-up ${data.featuresPhotos.length}${typeText}`, `${canvas.width}√ó${canvas.height}`, 1500);
                    }
                    else {
                        data.defectPhotos.push(photo);
                        // Auto-save to folder if selected
                        if(saveDirectoryHandle) {
                            const filename = generatePhotoFilename('defect', data.defectPhotos.length);
                            savePhotoToFolder(blob, filename);
                        }
                        showToast('success', `Defect Photo ${data.defectPhotos.length}`, `${canvas.width}√ó${canvas.height}`, 1500);
                    }
                    
                    const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
                    console.log(`üì∏ ${photoMode.toUpperCase()}: ${canvas.width}√ó${canvas.height} | ${sizeMB}MB`);
                    
                    updatePhotoGrids(); 
                    updateValidation(); 
                }, 'image/jpeg', 0.95); 
            }
        }
        
        function captureMainWithDefects(video, sourceW, sourceH) {
            // Step 1: Create rotated portrait image from landscape camera
            const rotatedCanvas = document.createElement('canvas');
            const rotatedCtx = rotatedCanvas.getContext('2d');
            rotatedCtx.imageSmoothingEnabled = true;
            rotatedCtx.imageSmoothingQuality = 'high';
            
            // Rotate 90¬∞ CCW: landscape (4096x2160) ‚Üí portrait (2160x4096)
            rotatedCanvas.width = sourceH;  // Height becomes width
            rotatedCanvas.height = sourceW; // Width becomes height
            
            rotatedCtx.translate(0, rotatedCanvas.height);
            rotatedCtx.rotate(-Math.PI / 2);
            rotatedCtx.drawImage(video, 0, 0, sourceW, sourceH);
            
            // Step 2: Use full rotated image (no cropping)
            const mainCanvas = rotatedCanvas;
            
            console.log(`üì∏ MAIN Portrait Full Res: ${sourceW}x${sourceH} ‚Üí rotated to ${mainCanvas.width}x${mainCanvas.height}`);
            
            // Step 3: Save main photo
            mainCanvas.toBlob(mainBlob => {
                const mainPhoto = { 
                    blob: mainBlob, 
                    url: URL.createObjectURL(mainBlob), 
                    width: mainCanvas.width, 
                    height: mainCanvas.height 
                };
                data.mainPhotos.push(mainPhoto);
                
                // Auto-save to folder if selected
                if(saveDirectoryHandle) {
                    const filename = generatePhotoFilename('main', data.mainPhotos.length);
                    savePhotoToFolder(mainBlob, filename);
                }
                
                const sizeMB = (mainBlob.size / 1024 / 1024).toFixed(2);
                console.log(`üì∏ MAIN: ${mainCanvas.width}√ó${mainCanvas.height} | ${sizeMB}MB`);
                
                // Step 4: If we have defect markers, create crops and annotated version
                if(defectMarkers.length > 0) {
                    createDefectCrops(mainCanvas);
                    createAnnotatedPhoto(mainCanvas);
                    showToast('success', 'Photos Captured!', `Main + ${defectMarkers.length} defect crops`, 2000);
                } else {
                    showToast('success', `Main Photo ${data.mainPhotos.length}`, `${mainCanvas.width}√ó${mainCanvas.height}`, 1500);
                }
                
                updatePhotoGrids();
                updateValidation();
            }, 'image/jpeg', 0.95);
        }
        
        function createDefectCrops(mainCanvas) {
            const mainW = mainCanvas.width;
            const mainH = mainCanvas.height;
            // Use MAX dimension so portrait photos get larger crops
            const cropSize = Math.round(Math.max(mainW, mainH) * DEFECT_CROP_SIZE);
            
            defectMarkers.forEach((marker, idx) => {
                // Convert marker percentage to pixel position on main canvas
                const centerX = Math.round((marker.x / 100) * mainW);
                const centerY = Math.round((marker.y / 100) * mainH);
                
                // Calculate crop bounds (centered on marker)
                let cropX = centerX - Math.round(cropSize / 2);
                let cropY = centerY - Math.round(cropSize / 2);
                
                // Clamp to image bounds
                cropX = Math.max(0, Math.min(cropX, mainW - cropSize));
                cropY = Math.max(0, Math.min(cropY, mainH - cropSize));
                
                // Create crop canvas
                const cropCanvas = document.createElement('canvas');
                const cropCtx = cropCanvas.getContext('2d');
                cropCanvas.width = cropSize;
                cropCanvas.height = cropSize;
                
                cropCtx.drawImage(mainCanvas, cropX, cropY, cropSize, cropSize, 0, 0, cropSize, cropSize);
                
                // Add small defect type indicator in corner
                cropCtx.fillStyle = DEFECT_COLORS[marker.type];
                cropCtx.beginPath();
                cropCtx.arc(cropSize - 30, 30, 20, 0, Math.PI * 2);
                cropCtx.fill();
                cropCtx.fillStyle = 'white';
                cropCtx.font = 'bold 16px Arial';
                cropCtx.textAlign = 'center';
                cropCtx.textBaseline = 'middle';
                cropCtx.fillText(idx + 1, cropSize - 30, 30);
                
                cropCanvas.toBlob(blob => {
                    const defectPhoto = {
                        blob,
                        url: URL.createObjectURL(blob),
                        width: cropSize,
                        height: cropSize,
                        defectType: marker.type,
                        markerIndex: idx + 1
                    };
                    data.defectPhotos.push(defectPhoto);
                    
                    // Auto-save to folder if selected
                    if(saveDirectoryHandle) {
                        const filename = generatePhotoFilename(`defect_${marker.type}`, idx + 1);
                        savePhotoToFolder(blob, filename);
                    }
                    
                    console.log(`üì∏ DEFECT CROP ${idx + 1} (${marker.type}): ${cropSize}√ó${cropSize}`);
                    updatePhotoGrids();
                }, 'image/jpeg', 0.95);
            });
        }
        
        function createAnnotatedPhoto(mainCanvas) {
            // Create a copy with markers drawn on it
            const annotatedCanvas = document.createElement('canvas');
            const ctx = annotatedCanvas.getContext('2d');
            annotatedCanvas.width = mainCanvas.width;
            annotatedCanvas.height = mainCanvas.height;
            
            // Draw original image
            ctx.drawImage(mainCanvas, 0, 0);
            
            // Draw markers
            defectMarkers.forEach((marker, idx) => {
                const x = (marker.x / 100) * annotatedCanvas.width;
                const y = (marker.y / 100) * annotatedCanvas.height;
                
                // Draw circle
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.fillStyle = DEFECT_COLORS[marker.type];
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw number
                ctx.fillStyle = 'white';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(idx + 1, x, y);
            });
            
            // Save as separate annotated photo (useful for customer reference)
            annotatedCanvas.toBlob(blob => {
                const annotatedPhoto = {
                    blob,
                    url: URL.createObjectURL(blob),
                    width: annotatedCanvas.width,
                    height: annotatedCanvas.height,
                    isAnnotated: true
                };
                // Store in main photos array (will be second photo)
                data.mainPhotos.push(annotatedPhoto);
                
                // Auto-save to folder if selected
                if(saveDirectoryHandle) {
                    const filename = generatePhotoFilename('main_annotated', data.mainPhotos.length);
                    savePhotoToFolder(blob, filename);
                }
                
                console.log(`üì∏ ANNOTATED: ${annotatedCanvas.width}√ó${annotatedCanvas.height} with ${defectMarkers.length} markers`);
                
                // Clear markers after successful capture
                clearDefectMarkers();
                disableDefectMarking();
                
                updatePhotoGrids();
            }, 'image/jpeg', 0.95);
        }
        
        // ============ STABILIZER FUNCTIONS ============
        function startStabilizer() {
            const video = document.getElementById('camera-video');
            if(!video || !video.srcObject) return;
            
            // Create small canvas for frame comparison (very lightweight)
            stabilizerCanvas = document.createElement('canvas');
            stabilizerCanvas.width = 64;
            stabilizerCanvas.height = 64;
            stabilizerCtx = stabilizerCanvas.getContext('2d', { willReadFrequently: true });
            
            previousFrame = null;
            stableFrameCount = 0;
            isStable = false;
            updateStabilizerUI(false);
            
            // Check frames 10x per second
            stabilizerInterval = setInterval(() => {
                checkStability(video);
            }, 100);
            
            console.log('üì∑ Stabilizer started');
        }
        
        function checkStability(video) {
            if(!video.videoWidth || !stabilizerCtx) return;
            
            // Draw scaled-down frame
            stabilizerCtx.drawImage(video, 0, 0, 64, 64);
            const currentFrame = stabilizerCtx.getImageData(0, 0, 64, 64).data;
            
            if(previousFrame) {
                const diff = calculateFrameDifference(previousFrame, currentFrame);
                
                if(diff < STABILITY_THRESHOLD) {
                    stableFrameCount++;
                    if(stableFrameCount >= FRAMES_NEEDED && !isStable) {
                        isStable = true;
                        updateStabilizerUI(true);
                    }
                } else {
                    stableFrameCount = 0;
                    if(isStable) {
                        isStable = false;
                        updateStabilizerUI(false);
                    }
                }
            }
            
            previousFrame = currentFrame;
        }
        
        function calculateFrameDifference(prev, curr) {
            let diff = 0;
            const sampleStep = 4; // Sample every 4th pixel for speed
            for(let i = 0; i < prev.length; i += 4 * sampleStep) {
                diff += Math.abs(prev[i] - curr[i]);     // R
                diff += Math.abs(prev[i+1] - curr[i+1]); // G
                diff += Math.abs(prev[i+2] - curr[i+2]); // B
            }
            return diff / (prev.length / sampleStep / 4) / 3; // Average per sampled pixel
        }
        
        function updateStabilizerUI(stable) {
            const dot = document.getElementById('stabilizer-dot');
            const text = document.getElementById('stabilizer-text');
            if(!dot || !text) return;
            
            if(stable) {
                dot.classList.add('stable');
                text.textContent = 'STABLE ‚úì';
                text.style.color = '#22c55e';
            } else {
                dot.classList.remove('stable');
                text.textContent = 'HOLD STEADY';
                text.style.color = 'white';
            }
        }
        
        function stopStabilizer() {
            if(stabilizerInterval) {
                clearInterval(stabilizerInterval);
                stabilizerInterval = null;
            }
            previousFrame = null;
            stableFrameCount = 0;
            isStable = false;
            console.log('üì∑ Stabilizer stopped');
        }
        
        function updatePhotoGrids() { 
            const renderGrid = (photos, gridId, mode) => { 
                // Main = portrait (full res), Tag/Defect/etc = square (1:1)
                const thumbClass = mode === 'main' ? 'photo-thumb' : 'photo-thumb square';
                let thumbStyle = '';
                if(mode === 'defect-closeup') thumbStyle = 'border-color:#dc2626;';
                else if(mode === 'features') thumbStyle = 'border-color:#7c3aed;';
                
                document.getElementById(gridId).innerHTML = photos.map((p,i) => {
                    let badge = '';
                    // Show linked defect number for defect close-ups
                    if(mode === 'defect-closeup' && p.linkedDefectIndex !== null && p.linkedDefectIndex !== undefined) {
                        badge = `<span style="position:absolute;top:2px;left:2px;background:#dc2626;color:white;font-size:9px;padding:1px 4px;border-radius:4px;font-weight:700;">#${p.linkedDefectIndex + 1}</span>`;
                    }
                    // Show feature type for feature close-ups
                    if(mode === 'features' && p.featureType) {
                        badge = `<span style="position:absolute;top:2px;left:2px;background:#7c3aed;color:white;font-size:8px;padding:1px 3px;border-radius:3px;font-weight:600;">${p.featureType}</span>`;
                    }
                    return `<div class="${thumbClass}" style="${thumbStyle}" ondblclick="openPreview('${mode}',${i})" title="Double-click to preview">
                        <img src="${p.url}">${badge}
                        <button class="photo-thumb-delete" onclick="event.stopPropagation();deletePhoto('${mode}',${i})">√ó</button>
                    </div>`;
                }).join('') + `<div class="${thumbClass} photo-thumb-empty" style="${thumbStyle}" onclick="setPhotoMode('${mode}')">+</div>`; 
            }; 
            renderGrid(data.mainPhotos,'main-photos-grid','main'); 
            renderGrid(data.tagPhotos,'tag-photos-grid','tag'); 
            renderGrid(data.defectPhotos,'defect-photos-grid','defect'); 
            renderGrid(data.defectCloseupPhotos,'defect-closeup-photos-grid','defect-closeup'); 
            renderGrid(data.featuresPhotos,'features-photos-grid','features'); 
            document.getElementById('main-count').textContent = data.mainPhotos.length; 
            document.getElementById('tag-count').textContent = data.tagPhotos.length; 
            document.getElementById('defect-count').textContent = data.defectPhotos.length; 
            document.getElementById('defect-closeup-count').textContent = data.defectCloseupPhotos.length; 
            document.getElementById('features-count').textContent = data.featuresPhotos.length; 
            document.getElementById('photo-count').textContent = data.mainPhotos.length+data.tagPhotos.length+data.defectPhotos.length+data.defectCloseupPhotos.length+data.featuresPhotos.length; 
        }
        function deletePhoto(mode,index) { 
            if(mode==='main'){URL.revokeObjectURL(data.mainPhotos[index].url);data.mainPhotos.splice(index,1);} 
            else if(mode==='tag'){URL.revokeObjectURL(data.tagPhotos[index].url);data.tagPhotos.splice(index,1);} 
            else if(mode==='defect-closeup'){URL.revokeObjectURL(data.defectCloseupPhotos[index].url);data.defectCloseupPhotos.splice(index,1);} 
            else if(mode==='features'){URL.revokeObjectURL(data.featuresPhotos[index].url);data.featuresPhotos.splice(index,1);} 
            else{URL.revokeObjectURL(data.defectPhotos[index].url);data.defectPhotos.splice(index,1);} 
            updatePhotoGrids(); updateValidation(); 
        }
        
        // Photo Preview Functions
        function openPreview(mode, index) {
            previewMode = mode;
            previewIndex = index;
            const photos = mode === 'main' ? data.mainPhotos : mode === 'tag' ? data.tagPhotos : mode === 'defect-closeup' ? data.defectCloseupPhotos : mode === 'features' ? data.featuresPhotos : data.defectPhotos;
            if(photos.length === 0) return;
            
            const photo = photos[index];
            document.getElementById('preview-image').src = photo.url;
            const is4K = photo.width >= 3800;
            const resLabel = photo.width ? `${photo.width}√ó${photo.height}${is4K ? ' 4K' : ''}` : '';
            let modeLabel = mode.toUpperCase();
            if(mode === 'defect-closeup') modeLabel = 'üî¥ DEFECT CLOSE-UP';
            else if(mode === 'features') modeLabel = '‚ú® FEATURE';
            document.getElementById('preview-type').textContent = modeLabel + (resLabel ? ` ‚Ä¢ ${resLabel}` : '');
            let bgColor = '#3b82f6'; // main default
            if(mode === 'tag') bgColor = '#f59e0b';
            else if(mode === 'defect-closeup') bgColor = '#dc2626';
            else if(mode === 'features') bgColor = '#7c3aed';
            else if(mode === 'defect') bgColor = '#ef4444';
            document.getElementById('preview-type').style.background = bgColor;
            updatePreviewNav();
            document.getElementById('preview-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
            document.body.style.overflow = '';
            previewMode = null;
            previewIndex = 0;
        }
        
        function navigatePreview(dir) {
            const photos = previewMode === 'main' ? data.mainPhotos : previewMode === 'tag' ? data.tagPhotos : previewMode === 'defect-closeup' ? data.defectCloseupPhotos : previewMode === 'features' ? data.featuresPhotos : data.defectPhotos;
            previewIndex += dir;
            if(previewIndex < 0) previewIndex = 0;
            if(previewIndex >= photos.length) previewIndex = photos.length - 1;
            const photo = photos[previewIndex];
            document.getElementById('preview-image').src = photo.url;
            const is4K = photo.width >= 3800;
            const resLabel = photo.width ? `${photo.width}√ó${photo.height}${is4K ? ' 4K' : ''}` : '';
            document.getElementById('preview-type').textContent = previewMode.toUpperCase() + (resLabel ? ` ‚Ä¢ ${resLabel}` : '');
            updatePreviewNav();
        }
        
        function updatePreviewNav() {
            const photos = previewMode === 'main' ? data.mainPhotos : previewMode === 'tag' ? data.tagPhotos : data.defectPhotos;
            document.getElementById('preview-prev').disabled = previewIndex <= 0;
            document.getElementById('preview-next').disabled = previewIndex >= photos.length - 1;
            document.getElementById('preview-counter').textContent = `${previewIndex + 1} / ${photos.length}`;
        }
        
        function deleteFromPreview() {
            if(!previewMode) return;
            deletePhoto(previewMode, previewIndex);
            const photos = previewMode === 'main' ? data.mainPhotos : previewMode === 'tag' ? data.tagPhotos : data.defectPhotos;
            if(photos.length === 0) {
                closePreview();
                return;
            }
            if(previewIndex >= photos.length) previewIndex = photos.length - 1;
            const photo = photos[previewIndex];
            document.getElementById('preview-image').src = photo.url;
            const is4K = photo.width >= 3800;
            const resLabel = photo.width ? `${photo.width}√ó${photo.height}${is4K ? ' 4K' : ''}` : '';
            document.getElementById('preview-type').textContent = previewMode.toUpperCase() + (resLabel ? ` ‚Ä¢ ${resLabel}` : '');
            updatePreviewNav();
        }
        
        // Keyboard navigation for preview
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('preview-modal').classList.contains('active')) {
                if(e.key === 'Escape') closePreview();
                if(e.key === 'ArrowLeft') navigatePreview(-1);
                if(e.key === 'ArrowRight') navigatePreview(1);
                if(e.key === 'Delete' || e.key === 'Backspace') deleteFromPreview();
            }
        });
        
        function setSuperCategory(cat, btn) { 
            data.superCategory = cat; 
            data.category = ''; 
            document.querySelectorAll('.super-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary'); 
            
            // Toggle Construction sections based on category type
            const isBottoms = (cat === 'bottoms');
            document.getElementById('tops-construction').classList.toggle('hidden', isBottoms);
            document.getElementById('bottoms-construction').classList.toggle('hidden', !isBottoms);
            
            // Clear construction data when switching and restore defaults
            if(isBottoms) {
                data.sleeveLength = ''; data.sleeveStyle = ''; data.stitch = ''; data.cutoffType = '';
                document.querySelectorAll('.sleeve-btn, .style-btn, .stitch-btn').forEach(b => { 
                    b.classList.remove('selected','btn-hero','btn-default'); 
                    b.classList.add('btn-secondary'); 
                });
                // Restore bottoms defaults
                restoreBottomsDefaults();
            } else {
                data.legStyle = ''; data.rise = '';
                document.querySelectorAll('.leg-btn, .rise-btn').forEach(b => { 
                    b.classList.remove('selected','btn-hero','btn-default'); 
                    b.classList.add('btn-secondary'); 
                });
                // Restore tops defaults
                restoreTopsDefaults();
            }
            
            renderSubCategories(cat); 
            updateValidation(); 
        }
        
        // Restore default styling for tops construction fields
        function restoreTopsDefaults() {
            // Sleeve: Short is default for T-Shirt (first category shown)
            document.querySelectorAll('.sleeve-btn').forEach(b => {
                if(b.textContent.trim() === 'Short') {
                    b.classList.remove('btn-secondary');
                    b.classList.add('btn-default');
                }
            });
            // Sleeve Style: Standard
            document.querySelectorAll('.style-btn').forEach(b => {
                if(b.textContent.trim() === 'Standard') {
                    b.classList.remove('btn-secondary');
                    b.classList.add('btn-default');
                }
            });
            // Stitch: Double
            document.querySelectorAll('.stitch-btn').forEach(b => {
                if(b.textContent.includes('Double')) {
                    b.classList.remove('btn-secondary');
                    b.classList.add('btn-default');
                }
            });
        }
        
        // Restore default styling for bottoms construction fields
        function restoreBottomsDefaults() {
            // Leg Style: Straight
            document.querySelectorAll('.leg-btn').forEach(b => {
                if(b.textContent.trim() === 'Straight') {
                    b.classList.remove('btn-secondary');
                    b.classList.add('btn-default');
                }
            });
            // Rise: Mid Rise
            document.querySelectorAll('.rise-btn').forEach(b => {
                if(b.textContent.includes('Mid')) {
                    b.classList.remove('btn-secondary');
                    b.classList.add('btn-default');
                }
            });
        }
        function renderSubCategories(superCat) { 
            const config = categoryConfig[superCat]; 
            const container = document.getElementById('sub-categories'); 
            // Only show default style on hero if no category is selected
            const heroClass = data.category ? 'cat-hero cat-btn' : 'cat-hero cat-btn cat-default';
            container.innerHTML = `<button onclick="setCategory('${config.heroes[0]}', this)" class="${heroClass}"><span style="font-size:20px;">${catEmojis[config.heroes[0]]||'üëï'}</span> ${config.heroes[0].toUpperCase()}</button><div class="btn-grid btn-grid-2" style="margin-bottom:8px;">${config.heroes.slice(1).map(c=>`<button onclick="setCategory('${c}', this)" class="cat-secondary cat-btn"><span>${catEmojis[c]||'üëï'}</span> ${c}</button>`).join('')}</div><div class="btn-grid btn-grid-4">${config.others.map(c=>`<button onclick="setCategory('${c}', this)" class="cat-other cat-btn">${c}</button>`).join('')}</div>`; 
        }
        function setCategory(cat, btn) { 
            data.category = cat; 
            // Remove selected AND default from ALL category buttons
            document.querySelectorAll('.cat-btn').forEach(b => { 
                b.classList.remove('selected'); 
                b.classList.remove('cat-default'); 
            }); 
            // Add selected to clicked button
            btn.classList.add('selected'); 
            document.getElementById('category-label').textContent = '‚Äî ' + cat.toUpperCase(); 
            // Show elastic check for Sweatpants
            const elasticSection = document.getElementById('elastic-section');
            if(elasticSection) elasticSection.classList.toggle('hidden', cat !== 'Sweatpants');
            // Update measurement hints based on category
            updateMeasurementHints(cat);
            // Update tag location help if panel is open
            if(!document.getElementById('tag-location-panel').classList.contains('hidden')) {
                updateTagLocationHelp();
            }
            // Update sleeve defaults based on category
            updateSleeveDefaults(cat);
            // Update stitch defaults based on category
            updateStitchDefaults(cat);
            // Update leg style defaults based on category (for bottoms)
            updateLegStyleDefaults(cat);
            renderFabricCards(); 
            renderMaterialCards(); 
            updateValidation(); 
        }
        
        // QA FIX: Dynamic sleeve defaults based on category
        function updateSleeveDefaults(cat) {
            // Reset all sleeve buttons to secondary (remove any defaults)
            document.querySelectorAll('.sleeve-btn').forEach(b => {
                b.classList.remove('btn-default');
                if(!b.classList.contains('selected')) {
                    b.classList.add('btn-secondary');
                }
            });
            
            // Determine correct default based on category
            let defaultSleeve = 'Short'; // fallback
            
            // Long sleeves default
            const longSleeveCategories = ['Sweatshirt', 'Hoodie', 'Sweater', 'Cardigan', 'Button Shirt', 'Blouse', 'Tunic', 'Jacket', 'Coat'];
            // Short sleeves default
            const shortSleeveCategories = ['T-Shirt', 'Polo', 'Jersey'];
            // None (sleeveless) default
            const noSleeveCategories = ['Tank Top', 'Vest'];
            
            if(longSleeveCategories.includes(cat)) {
                defaultSleeve = 'Long';
            } else if(shortSleeveCategories.includes(cat)) {
                defaultSleeve = 'Short';
            } else if(noSleeveCategories.includes(cat)) {
                defaultSleeve = 'None';
            }
            
            // Apply default styling to correct button (only if nothing selected yet)
            if(!data.sleeveLength) {
                document.querySelectorAll('.sleeve-btn').forEach(b => {
                    if(b.textContent.trim() === defaultSleeve || 
                       (defaultSleeve === 'None' && b.textContent.trim() === 'None')) {
                        b.classList.remove('btn-secondary');
                        b.classList.add('btn-default');
                    }
                });
            }
        }
        
        // QA FIX: Dynamic stitch defaults based on category
        function updateStitchDefaults(cat) {
            // Reset stitch buttons
            document.querySelectorAll('.stitch-btn').forEach(b => {
                b.classList.remove('btn-default');
                if(!b.classList.contains('selected')) {
                    b.classList.add('btn-secondary');
                }
            });
            
            // T-Shirts: Single stitch is the vintage indicator (pre-1990s)
            // But Double stitch is more common overall
            // Keep Double as default for most, but could be Single for T-Shirt if vintage-focused
            let defaultStitch = 'Double';
            
            // Apply default (only if nothing selected yet)
            if(!data.stitch) {
                document.querySelectorAll('.stitch-btn').forEach(b => {
                    if(b.textContent.includes(defaultStitch)) {
                        b.classList.remove('btn-secondary');
                        b.classList.add('btn-default');
                    }
                });
            }
        }
        
        // QA FIX: Dynamic leg style defaults based on bottoms category
        function updateLegStyleDefaults(cat) {
            // Only apply to bottoms categories
            const bottomsCategories = ['Jeans', 'Pants', 'Shorts', 'Sweatpants'];
            if(!bottomsCategories.includes(cat)) return;
            
            // Reset all leg buttons to secondary (remove any defaults)
            document.querySelectorAll('.leg-btn').forEach(b => {
                b.classList.remove('btn-default');
                if(!b.classList.contains('selected')) {
                    b.classList.add('btn-secondary');
                }
            });
            
            // Determine correct default based on category
            let defaultLeg = 'Straight'; // fallback for Jeans, Pants
            
            if(cat === 'Sweatpants') {
                defaultLeg = 'Straight'; // or could be 'Jogger' for modern sweats
            } else if(cat === 'Shorts') {
                defaultLeg = 'Relaxed'; // most shorts are relaxed fit
            }
            
            // Apply default styling to correct button (only if nothing selected yet)
            if(!data.legStyle) {
                document.querySelectorAll('.leg-btn').forEach(b => {
                    if(b.textContent.trim() === defaultLeg) {
                        b.classList.remove('btn-secondary');
                        b.classList.add('btn-default');
                    }
                });
            }
        }
        
        function updateMeasurementHints(cat) {
            // Hide all measurement hints first
            document.getElementById('measure-hint-tops').classList.add('hidden');
            document.getElementById('measure-hint-button-shirt').classList.add('hidden');
            document.getElementById('measure-hint-bottoms').classList.add('hidden');
            document.getElementById('measure-hint-outer').classList.add('hidden');
            
            // Show appropriate hint based on category
            if(cat === 'Button Shirt' || cat === 'Flannel') {
                document.getElementById('measure-hint-button-shirt').classList.remove('hidden');
            } else if(['Jeans','Pants','Shorts','Sweatpants'].includes(cat)) {
                document.getElementById('measure-hint-bottoms').classList.remove('hidden');
            } else if(['Jacket','Coat','Vest'].includes(cat)) {
                document.getElementById('measure-hint-outer').classList.remove('hidden');
            } else {
                document.getElementById('measure-hint-tops').classList.remove('hidden');
            }
            
            // Update sleeve-specific hints (standard/raglan/sleeveless)
            updateMeasurementHintsForSleeveStyle(data.sleeveStyle || 'Standard', data.sleeveLength || '');
        }
        
        function setTagStatus(status, btn) { 
            data.tagStatus = status; 
            document.querySelectorAll('.tag-btn').forEach(b => { 
                b.classList.remove('selected','btn-hero','btn-default'); 
                b.classList.add('btn-secondary'); 
            }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            document.getElementById('tag-details').classList.toggle('hidden', status !== 'has'); 
            document.getElementById('material-tag-warning').classList.toggle('hidden', status === 'has'); 
            
            // TAG CUT MODE: When tag is missing/cut, traits become mandatory, selections disabled
            tagCutMode = (status === 'cut' || status === 'missing');
            
            // Fabric tag cut section
            const fabricTagCutSection = document.getElementById('fabric-tag-cut-section');
            const fabricHelpBtn = document.getElementById('fabric-help-btn');
            const fabricHelpPanel = document.getElementById('fabric-help-panel');
            
            if(fabricTagCutSection) {
                fabricTagCutSection.classList.toggle('hidden', !tagCutMode);
            }
            if(fabricHelpBtn) {
                fabricHelpBtn.classList.toggle('hidden', tagCutMode);
            }
            if(fabricHelpPanel && tagCutMode) {
                fabricHelpPanel.classList.add('hidden');
            }
            
            // Material tag cut section
            const materialTagCutSection = document.getElementById('material-tag-cut-section');
            const materialHelpBtn = document.getElementById('material-help-btn');
            const materialHelpPanel = document.getElementById('material-help-panel');
            
            if(materialTagCutSection) {
                materialTagCutSection.classList.toggle('hidden', !tagCutMode);
            }
            if(materialHelpBtn) {
                materialHelpBtn.classList.toggle('hidden', tagCutMode);
            }
            if(materialHelpPanel && tagCutMode) {
                materialHelpPanel.classList.add('hidden');
            }
            
            // Re-render cards (they'll be disabled in tagCutMode)
            renderFabricCards();
            renderMaterialCards();
            updateValidation(); 
        }
        function setSize(size, btn) { data.tagSize = size; document.querySelectorAll('.size-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); document.getElementById('tag-size-input').value=''; }
        function clearSizeBtns() { document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); }
        function onSizeInput(el) { data.tagSize = el.value.trim(); document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); }
        function setOrigin(origin, btn) { data.origin = origin; document.querySelectorAll('.origin-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); document.getElementById('country-section').classList.toggle('hidden', origin !== 'import'); if(origin==='usa')data.country='USA'; }
        function setCountry(country, btn) { 
            document.querySelectorAll('.country-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); 
            if(country === 'Other') {
                document.getElementById('country-other-input').classList.remove('hidden');
                document.getElementById('country-other-input').focus();
            } else {
                document.getElementById('country-other-input').classList.add('hidden');
                document.getElementById('country-other-input').value = '';
                data.country = country;
            }
        }
        function onCountryOtherInput() { data.country = document.getElementById('country-other-input').value.trim(); }
        function setGender(gender, btn) { data.gender = gender; document.querySelectorAll('.gender-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function toggleColor(color, btn) { const idx = data.colors.indexOf(color); if(idx>-1){data.colors.splice(idx,1);btn.classList.remove('selected');} else{data.colors.push(color);btn.classList.add('selected');} updateValidation(); }
        function setFade(fade, btn) { data.fade = fade; document.querySelectorAll('.fade-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); updateValidation(); }
        function setPattern(pattern, btn) { 
            data.pattern = pattern; 
            document.querySelectorAll('.pattern-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            // Show/hide print type and graphic category sections for Graphic
            const showGraphicOptions = (pattern === 'Graphic');
            document.getElementById('print-type-section').classList.toggle('hidden', !showGraphicOptions);
            document.getElementById('graphic-category-section').classList.toggle('hidden', !showGraphicOptions);
            // Clear print type and graphic category if not Graphic
            if(!showGraphicOptions) { 
                data.printType = ''; data.graphicCategory = ''; 
                document.querySelectorAll('.print-btn, .graphic-cat-btn').forEach(b => b.classList.remove('selected','btn-hero')); 
            }
            updateValidation(); 
        }
        function toggleOtherPatterns() { 
            const el = document.getElementById('pattern-others'); 
            el.classList.toggle('hidden'); 
            document.getElementById('other-patterns-toggle').textContent = el.classList.contains('hidden') ? '+ More patterns' : '‚àí Hide patterns'; 
        }
        function setPrintType(type, btn) { data.printType = type; document.querySelectorAll('.print-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function setGraphicCategory(cat, btn) { data.graphicCategory = cat; document.querySelectorAll('.graphic-cat-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function setSleeve(length, btn) { 
            data.sleeveLength = length; 
            document.querySelectorAll('.sleeve-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            // Hide sleeve style when None
            document.getElementById('sleeve-style-section').classList.toggle('hidden', length==='None'); 
            // Show cutoff section for T-Shirts when sleeveless
            const isTShirt = ['T-Shirt','Sweatshirt','Hoodie'].includes(data.category);
            document.getElementById('cutoff-section').classList.toggle('hidden', !(length==='None' && isTShirt));
            // Clear cutoff if not sleeveless
            if(length !== 'None') { data.cutoffType = ''; document.querySelectorAll('.cutoff-btn').forEach(b => b.classList.remove('selected','btn-hero')); }
            // Update measurement hints for sleeveless
            updateMeasurementHintsForSleeveStyle(data.sleeveStyle, length);
            updateValidation(); 
        }
        function setCutoff(type, btn) { data.cutoffType = type; document.querySelectorAll('.cutoff-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function setSleeveStyle(style, btn) { 
            data.sleeveStyle = style; 
            document.querySelectorAll('.style-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            // Show/hide measurement notice for Raglan/Dolman
            const notice = document.getElementById('sleeve-measurement-notice');
            if(notice) notice.classList.toggle('hidden', style === 'Standard');
            // Update measurement hints based on sleeve style
            updateMeasurementHintsForSleeveStyle(data.sleeveStyle, data.sleeveLength);
        }
        function updateMeasurementHintsForSleeveStyle(sleeveStyle, sleeveLength) {
            const isRaglanDolman = (sleeveStyle === 'Raglan' || sleeveStyle === 'Dolman');
            const isSleeveless = (sleeveLength === 'Sleeveless' || sleeveLength === 'None' || data.category === 'Tank' || data.category === 'Vest');
            
            // TOPS hints
            const topsStd = document.getElementById('measure-tops-standard');
            const topsRag = document.getElementById('measure-tops-raglan');
            const topsSleeveless = document.getElementById('measure-tops-sleeveless');
            if(topsStd) topsStd.classList.toggle('hidden', isRaglanDolman || isSleeveless);
            if(topsRag) topsRag.classList.toggle('hidden', !isRaglanDolman || isSleeveless);
            if(topsSleeveless) topsSleeveless.classList.toggle('hidden', !isSleeveless);
            
            // BUTTON SHIRT hints
            const btnStd = document.getElementById('measure-button-standard');
            const btnRag = document.getElementById('measure-button-raglan');
            const btnSleeveless = document.getElementById('measure-button-sleeveless');
            if(btnStd) btnStd.classList.toggle('hidden', isRaglanDolman || isSleeveless);
            if(btnRag) btnRag.classList.toggle('hidden', !isRaglanDolman || isSleeveless);
            if(btnSleeveless) btnSleeveless.classList.toggle('hidden', !isSleeveless);
            
            // OUTER hints
            const outerStd = document.getElementById('measure-outer-standard');
            const outerRag = document.getElementById('measure-outer-raglan');
            const outerSleeveless = document.getElementById('measure-outer-sleeveless');
            if(outerStd) outerStd.classList.toggle('hidden', isRaglanDolman || isSleeveless);
            if(outerRag) outerRag.classList.toggle('hidden', !isRaglanDolman || isSleeveless);
            if(outerSleeveless) outerSleeveless.classList.toggle('hidden', !isSleeveless);
        }
        function setStitch(stitch, btn) { data.stitch = stitch; document.querySelectorAll('.stitch-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); }
        
        // BOTTOMS: Leg Style Functions
        function setLegStyle(style, btn) { 
            data.legStyle = style; 
            document.querySelectorAll('.leg-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            updateValidation(); 
        }
        function setRise(rise, btn) { 
            data.rise = rise; 
            document.querySelectorAll('.rise-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
        }
        function toggleLegStyleHelp() {
            document.getElementById('leg-style-help').classList.toggle('hidden');
        }
        
        function setThickness(thickness, btn) { data.thickness = thickness; document.querySelectorAll('.thickness-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); updateValidation(); }
        function setLayers(layers, btn) { data.layers = layers; document.querySelectorAll('.layers-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); updateValidation(); }
        function setWash(wash, btn) { data.wash = wash; document.querySelectorAll('.wash-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); }
        function setClean(btn) { data.hasDefects = false; data.defectTypes = []; document.getElementById('btn-clean').classList.remove('btn-default','btn-secondary'); document.getElementById('btn-clean').classList.add('selected','btn-hero'); document.querySelectorAll('.defect-type-btn').forEach(b => b.classList.remove('selected')); updateValidation(); }
        function toggleDefect(type, btn) { document.getElementById('btn-clean').classList.remove('selected','btn-hero','btn-default'); document.getElementById('btn-clean').classList.add('btn-secondary'); data.hasDefects = true; const idx = data.defectTypes.indexOf(type); if(idx>-1){data.defectTypes.splice(idx,1);btn.classList.remove('selected');} else{data.defectTypes.push(type);btn.classList.add('selected');} if(data.defectTypes.length===0){data.hasDefects=null; document.getElementById('btn-clean').classList.remove('btn-secondary'); document.getElementById('btn-clean').classList.add('btn-default');} updateValidation(); }
        
        // FLAG AS UNUSUAL
        function toggleFlagUnusual() { 
            data.flagged = !data.flagged; 
            const btn = document.getElementById('flag-btn');
            const flagStatus = document.getElementById('flag-status');
            if(data.flagged) {
                btn.classList.add('flagged');
                btn.querySelector('span:first-child').textContent = 'üö©';
                btn.querySelector('span:last-of-type').textContent = 'FLAGGED FOR REVIEW';
                if(flagStatus) flagStatus.classList.remove('hidden');
            } else {
                btn.classList.remove('flagged');
                btn.querySelector('span:first-child').textContent = 'ü§î';
                btn.querySelector('span:last-of-type').textContent = 'FLAG AS UNUSUAL';
                if(flagStatus) flagStatus.classList.add('hidden');
            }
        }
        
        // ELASTIC CHECK (for sweatpants)
        function setElastic(elastic, btn) {
            data.elasticCheck = elastic;
            document.querySelectorAll('.elastic-btn').forEach(b => {
                b.classList.remove('selected','btn-hero');
                b.classList.add('btn-secondary');
            });
            btn.classList.add('selected','btn-hero');
            btn.classList.remove('btn-secondary');
        }
        function updateWeight() { data.weightLb = parseInt(document.getElementById('weight-lb').value); data.weightOz = parseInt(document.getElementById('weight-oz').value); updateValidation(); }
        
        async function activateSkuScan() {
            console.log('üì∑ SKU Scan button clicked');
            console.log(`   secondaryCameraId: ${secondaryCameraId?.slice(0,8) || 'null'}`);
            
            // Show status
            const statusEl = document.getElementById('sku-camera-status');
            statusEl.style.display = 'block';
            statusEl.textContent = 'üì∑ Switching to C922X...';
            statusEl.style.color = '#f59e0b';
            
            // Switch to SKU photo mode (this will switch camera)
            setPhotoMode('sku');
            
            // Wait for camera to switch and provide feedback
            await new Promise(r => setTimeout(r, 500));
            
            if(activeCameraId === secondaryCameraId) {
                statusEl.textContent = 'üîç Scanning for barcode...';
                statusEl.style.color = '#3b82f6';
                // Start barcode scanning
                setTimeout(() => startBarcodeScanning(), 300);
            } else if(!secondaryCameraId) {
                statusEl.textContent = '‚ö†Ô∏è No C922X camera detected - type SKU manually';
                statusEl.style.color = '#ef4444';
            } else {
                statusEl.textContent = '‚ö†Ô∏è Camera switch may have failed - try again';
                statusEl.style.color = '#ef4444';
            }
            
            // Focus input for barcode scanner
            const skuInput = document.getElementById('sku-input');
            skuInput.value = '';
            skuInput.focus();
        }
        
        function onSkuInput() {
            const skuInput = document.getElementById('sku-input');
            data.sku = skuInput.value.trim();
            
            // Update SKU badge in progress bar
            const skuBadge = document.getElementById('sku-badge');
            if(data.sku) {
                skuBadge.textContent = 'SKU: ' + data.sku;
                skuBadge.classList.add('visible');
            } else {
                skuBadge.classList.remove('visible');
            }
            
            updateValidation();
        }
        
        function handleSkuKeydown(event) {
            // Barcode scanners typically send Enter after scanning
            if(event.key === 'Enter') {
                event.preventDefault();
                const skuInput = document.getElementById('sku-input');
                data.sku = skuInput.value.trim();
                
                if(data.sku) {
                    // Show success feedback
                    document.getElementById('sku-status').innerHTML = '‚úÖ SKU scanned: <strong>' + data.sku + '</strong>';
                    document.getElementById('sku-status').style.color = '#16a34a';
                    console.log('üì∑ SKU scanned:', data.sku);
                    
                    // Update badge
                    const skuBadge = document.getElementById('sku-badge');
                    skuBadge.textContent = 'SKU: ' + data.sku;
                    skuBadge.classList.add('visible');
                    
                    // Switch back to main photo mode after successful scan
                    setTimeout(() => {
                        setPhotoMode('main');
                    }, 500);
                }
                
                skuInput.blur();
                updateValidation();
            }
        }
        
        // V99.45: Camera-based Barcode Scanning using QuaggaJS (works in all browsers)
        let quaggaRunning = false;
        
        async function startBarcodeScanning() {
            const statusEl = document.getElementById('sku-camera-status');
            statusEl.style.display = 'block';
            
            // Check if Quagga loaded
            if(typeof Quagga === 'undefined') {
                statusEl.innerHTML = '‚ö†Ô∏è Barcode library failed to load<br><small style="font-size:9px;">Type SKU manually or use USB scanner</small>';
                statusEl.style.color = '#f59e0b';
                console.log('‚ùå QuaggaJS not loaded');
                return;
            }
            
            stopBarcodeScanning(); // Clear any existing
            
            const video = document.getElementById('camera-video');
            if(!video.srcObject) {
                statusEl.textContent = '‚ö†Ô∏è Camera not active';
                statusEl.style.color = '#f59e0b';
                return;
            }
            
            console.log('üîç Starting QuaggaJS barcode scanning...');
            statusEl.textContent = 'üîç Scanning for barcode...';
            statusEl.style.color = '#3b82f6';
            
            // Create a canvas to capture frames from video
            const scanCanvas = document.createElement('canvas');
            const scanCtx = scanCanvas.getContext('2d', { willReadFrequently: true });
            
            let scanCount = 0;
            
            barcodeScanInterval = setInterval(() => {
                if(!video.videoWidth || video.paused || video.ended) return;
                if(photoMode !== 'sku') {
                    stopBarcodeScanning();
                    return;
                }
                
                scanCount++;
                
                // Update status periodically
                if(scanCount % 5 === 0) {
                    statusEl.textContent = 'üîç Scanning... (point camera at barcode)';
                }
                
                // Capture current frame
                scanCanvas.width = video.videoWidth;
                scanCanvas.height = video.videoHeight;
                scanCtx.drawImage(video, 0, 0);
                
                // Decode using Quagga
                Quagga.decodeSingle({
                    src: scanCanvas.toDataURL('image/jpeg'),
                    numOfWorkers: 0, // Use main thread for speed
                    decoder: {
                        readers: ['code_128_reader', 'ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader', 'code_39_reader', 'codabar_reader', 'i2of5_reader']
                    },
                    locate: true
                }, function(result) {
                    if(result && result.codeResult) {
                        const barcodeValue = result.codeResult.code;
                        console.log('‚úÖ Barcode detected:', barcodeValue, result.codeResult.format);
                        
                        // Fill in the SKU
                        const skuInput = document.getElementById('sku-input');
                        skuInput.value = barcodeValue;
                        data.sku = barcodeValue;
                        
                        // Show success
                        statusEl.textContent = '‚úÖ Scanned: ' + barcodeValue;
                        statusEl.style.color = '#16a34a';
                        
                        document.getElementById('sku-status').innerHTML = '‚úÖ SKU scanned: <strong>' + barcodeValue + '</strong>';
                        document.getElementById('sku-status').style.color = '#16a34a';
                        
                        // Update badge
                        const skuBadge = document.getElementById('sku-badge');
                        skuBadge.textContent = 'SKU: ' + barcodeValue;
                        skuBadge.classList.add('visible');
                        
                        // Play success beep
                        try {
                            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                            const oscillator = audioCtx.createOscillator();
                            const gainNode = audioCtx.createGain();
                            oscillator.connect(gainNode);
                            gainNode.connect(audioCtx.destination);
                            oscillator.frequency.value = 1200;
                            oscillator.type = 'sine';
                            gainNode.gain.value = 0.1;
                            oscillator.start();
                            setTimeout(() => oscillator.stop(), 100);
                        } catch(e) {}
                        
                        // Stop scanning
                        stopBarcodeScanning();
                        
                        // Switch back to main after delay
                        setTimeout(() => {
                            setPhotoMode('main');
                        }, 1000);
                        
                        updateValidation();
                    }
                });
            }, 300); // Scan ~3 times per second
        }
        
        function stopBarcodeScanning() {
            if(barcodeScanInterval) {
                clearInterval(barcodeScanInterval);
                barcodeScanInterval = null;
                console.log('üõë Barcode scanning stopped');
            }
        }
        
        // Audio Recording
        async function toggleRecording() {
            if(mediaRecorder && mediaRecorder.state === 'recording') { stopRecording(); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, {type:'audio/webm'});
                    data.audioMeasure = blob;
                    stream.getTracks().forEach(t => t.stop());
                    updateValidation();
                };
                mediaRecorder.start();
                recordingStart = Date.now();
                document.getElementById('record-btn').innerHTML = '<span style="font-size:24px;">‚èπÔ∏è</span><span>RECORDING...</span>';
                document.getElementById('record-btn').style.background = '#dc2626';
                document.getElementById('record-btn').classList.add('recording');
                recordingInterval = setInterval(updateRecordingTime, 1000);
            } catch(e) { showToast('error', 'Microphone Error', 'Microphone access denied'); }
        }
        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                const duration = Math.floor((Date.now() - recordingStart) / 1000);
                data.audioDuration = duration;
                document.getElementById('recording-duration').textContent = formatTime(duration);
                document.getElementById('record-section').classList.add('hidden');
                document.getElementById('post-record-section').classList.remove('hidden');
            }
        }
        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStart) / 1000);
            document.getElementById('record-btn').querySelector('span:last-child').textContent = `RECORDING ${formatTime(elapsed)}`;
        }
        function reRecord() {
            data.audioMeasure = null; data.audioDuration = 0;
            document.getElementById('record-section').classList.remove('hidden');
            document.getElementById('post-record-section').classList.add('hidden');
            document.getElementById('record-btn').innerHTML = '<span style="font-size:24px;">üé§</span><span>TAP TO RECORD</span>';
            document.getElementById('record-btn').style.background = '#ef4444';
            document.getElementById('record-btn').classList.remove('recording');
            updateValidation();
        }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        
        function renderFabricCards() { 
            const grid = document.getElementById('fabric-cards-grid'); 
            const fabrics = fabricDB[data.category] || fabricDB['default']; 
            grid.innerHTML = ''; 
            fabrics.forEach(fab=>{ 
                let dimmed = false; 
                if(fabricFilters.stretch && fab.traits.stretch !== fabricFilters.stretch) dimmed = true; 
                if(fabricFilters.surface && fab.traits.surface !== fabricFilters.surface) dimmed = true; 
                if(fabricFilters.interior && fab.traits.interior !== fabricFilters.interior) dimmed = true; 
                const card = document.createElement('div'); 
                // In tagCutMode, all cards are visually dimmed and not clickable
                const disabled = tagCutMode;
                // Only show priority-1 (default) styling if NO fabric is selected yet
                const showDefault = fab.default && !data.fabricType;
                card.className = `card ${showDefault?'priority-1':''} ${data.fabricType===fab.name?'selected':''} ${dimmed||disabled?'dimmed':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showFabricHelp('${fab.name}', '${fab.desc.replace(/'/g, "\\'")}');">?</button><div class="card-name">${fab.name}</div><div class="card-desc">${fab.desc}</div>`; 
                if(!dimmed && !disabled) card.onclick = ()=>{ 
                    data.fabricType = fab.name; 
                    document.getElementById('wash-section').classList.toggle('hidden', fab.name!=='Denim'); 
                    renderFabricCards(); 
                    updateValidation(); 
                }; 
                grid.appendChild(card); 
            }); 
        }
        function showFabricHelp(name, desc) {
            openRefModal(name, desc, 'fabric');
        }
        function openRefModal(name, desc, type) {
            document.getElementById('ref-modal-title').textContent = name;
            document.getElementById('ref-modal-desc').textContent = desc;
            
            // Build Google image search URL
            let query = `${name} fabric texture close up`;
            if (name === 'Knit') query = 'knit t-shirt fabric texture close up';
            if (name === 'Jersey') query = 'jersey knit fabric texture athletic';
            if (name === 'Fleece') query = 'fleece fabric fuzzy inside sweatshirt';
            if (name === 'French Terry') query = 'french terry fabric loops inside';
            if (name === 'Selvage') query = 'selvage denim red line cuff';
            if (name === 'Pique') query = 'pique polo shirt fabric texture';
            if (name === 'Flannel') query = 'flannel shirt fabric brushed soft';
            if (name === 'Denim') query = 'denim fabric diagonal weave';
            if (name === 'Corduroy') query = 'corduroy fabric ridges texture';
            if (name === 'Mesh') query = 'mesh athletic fabric see through';
            if (name === '50/50 Blend') query = '50 50 cotton polyester blend t-shirt';
            if (name === 'Tri-Blend') query = 'tri-blend t-shirt fabric soft';
            if (name === 'Cotton') query = 'cotton fabric texture matte';
            if (name === 'Polyester') query = 'polyester fabric sheen synthetic';
            if (name === 'Wool') query = 'wool fabric texture sweater';
            if (name === 'Cashmere') query = 'cashmere fabric soft luxury';
            if (name === 'Rayon') query = 'rayon fabric silky drapey';
            if (name === 'Nylon') query = 'nylon windbreaker fabric shiny';
            if (name === 'Leather') query = 'leather jacket texture patina';
            
            // Pattern queries
            if (name === 'Solid') query = 'solid color t-shirt plain blank';
            if (name === 'Graphic') query = 'graphic tee print band shirt logo';
            if (name === 'Striped') query = 'striped shirt pattern sailor stripe';
            if (name === 'Color Block') query = 'color block shirt 90s panel';
            if (name === 'Plaid') query = 'plaid flannel pattern tartan buffalo check';
            if (name === 'Tie Dye') query = 'tie dye shirt spiral pattern';
            if (name === 'Camo') query = 'camo camouflage pattern military';
            if (name === 'Embroidered') query = 'embroidered shirt logo stitched';
            if (name === 'Polka Dot') query = 'polka dot pattern shirt dress';
            if (name === 'Paisley') query = 'paisley pattern bandana western shirt';
            if (name === 'Floral') query = 'floral pattern hawaiian shirt roses';
            if (name === 'Animal') query = 'animal print leopard zebra tiger';
            if (name === 'Geometric') query = 'geometric pattern 80s aztec chevron';
            if (name === 'Checkered') query = 'checkered pattern checkerboard vans';
            if (name === 'Houndstooth') query = 'houndstooth pattern coat jacket';
            if (name === 'Herringbone') query = 'herringbone pattern tweed suit';
            if (name === 'Abstract') query = 'abstract pattern 80s splatter';
            
            document.getElementById('ref-modal-link').href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
            document.getElementById('ref-modal-overlay').classList.add('visible');
        }
        function closeRefModal() {
            document.getElementById('ref-modal-overlay').classList.remove('visible');
        }
        function toggleFabricHelp() { document.getElementById('fabric-help-panel').classList.toggle('hidden'); }
        function toggleFabricFilter(type, value, btn) { 
            if(fabricFilters[type]===value){
                fabricFilters[type]=null;
                data.fabricTraits[type]='';
                btn.classList.remove('active');
            } 
            else{
                fabricFilters[type]=value;
                data.fabricTraits[type]=value;
                // Only deselect same-type buttons
                btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            } 
            renderFabricCards(); 
            updateFabricAdvice();
        }
        
        function updateFabricAdvice() {
            const helper = document.getElementById('fabric-helper');
            const helperTagcut = document.getElementById('fabric-helper-tagcut');
            const advice = getFabricAdvice();
            
            if(helper) {
                if(advice){helper.innerHTML=advice;helper.classList.remove('hidden');} 
                else helper.classList.add('hidden');
            }
            if(helperTagcut && tagCutMode) {
                helperTagcut.innerHTML = advice || '<span style="color:#6b7280;">Select traits above to see fabric matches</span>';
            }
        }
        
        // V99.45: TRULY DYNAMIC fabric advice based on actual fabricDB filtering
        function getFabricAdvice() {
            const cat = data.category || 'T-Shirt';
            const f = fabricFilters;
            const activeFilters = Object.values(f).filter(Boolean).length;
            
            if(activeFilters === 0) return '';
            
            // Get fabrics for this category
            const fabrics = fabricDB[cat] || fabricDB['default'];
            
            // TRULY DYNAMIC: Filter fabrics based on ALL selected traits
            const matches = fabrics.filter(fab => {
                if(f.stretch && fab.traits.stretch !== f.stretch) return false;
                if(f.surface && fab.traits.surface !== f.surface) return false;
                if(f.interior && fab.traits.interior !== f.interior) return false;
                return true;
            });
            
            // Build trait description for display
            const traitDesc = [];
            if(f.stretch) traitDesc.push(f.stretch === 'high' ? 'Stretchy' : 'Rigid');
            if(f.surface) traitDesc.push(f.surface === 'smooth' ? 'Smooth surface' : f.surface === 'diagonal' ? 'Diagonal weave' : f.surface === 'ridged' ? 'Ridged' : 'Textured');
            if(f.interior) traitDesc.push(f.interior === 'smooth' ? 'Smooth inside' : f.interior === 'fuzzy' ? 'Fuzzy inside' : 'Loops inside');
            
            // Build dynamic advice based on actual matches
            if(matches.length === 0) {
                // No matches - this combination is unusual for this category
                return `<div style="color:#b91c1c;"><strong>‚ö†Ô∏è Unusual combination for ${cat}!</strong></div>` +
                       `<div style="margin:4px 0;">${traitDesc.join(' + ')}</div>` +
                       `<div style="font-style:italic;font-size:10px;">This doesn't match any typical ${cat} fabrics. Double-check: Is this really a ${cat}?</div>`;
            } 
            else if(matches.length === 1) {
                // Perfect! One exact match
                const m = matches[0];
                return `<div style="color:#16a34a;"><strong>‚úÖ That's ${m.name}!</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">${m.desc}</div>`;
            } 
            else if(matches.length === 2) {
                // Two possibilities
                return `<div style="color:#2563eb;"><strong>üí° Could be one of these:</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">` +
                       `<strong>${matches[0].name}</strong> ‚Äì ${matches[0].desc}<br>` +
                       `<strong>${matches[1].name}</strong> ‚Äì ${matches[1].desc}</div>` +
                       `<div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
            } 
            else {
                // Multiple matches - show them all
                let html = `<div style="color:#2563eb;"><strong>üí° ${matches.length} possible fabrics:</strong></div><div style="margin:4px 0;font-size:11px;">`;
                matches.forEach(m => {
                    html += `<strong>${m.name}</strong> ‚Äì ${m.desc}<br>`;
                });
                html += `</div><div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
                return html;
            }
        }
        
        function renderMaterialCards() { 
            const grid = document.getElementById('material-cards-grid'); 
            const materials = materialDB[data.category] || materialDB['default']; 
            grid.innerHTML = ''; 
            materials.forEach(mat=>{ 
                let dimmed = false; 
                if(materialFilters.temp && mat.traits.temp !== materialFilters.temp) dimmed = true; 
                if(materialFilters.shine && mat.traits.shine !== materialFilters.shine) dimmed = true; 
                const card = document.createElement('div'); 
                // In tagCutMode, all cards are visually dimmed and not clickable
                const disabled = tagCutMode;
                // Only show priority-1 (default) styling if NO materials selected yet
                const showDefault = mat.default && data.materials.length === 0;
                const isSelected = data.materials.includes(mat.name);
                card.className = `card ${showDefault?'priority-1':''} ${isSelected?'selected':''} ${dimmed||disabled?'dimmed':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showMaterialHelp('${mat.name}', '${mat.desc.replace(/'/g, "\\'")}');">?</button><div class="card-name">${mat.name}</div><div class="card-desc">${mat.desc}</div>`; 
                if(!dimmed && !disabled) card.onclick = ()=>{ 
                    // Toggle selection (multi-select like colors)
                    const idx = data.materials.indexOf(mat.name);
                    if(idx > -1) {
                        data.materials.splice(idx, 1);
                    } else {
                        data.materials.push(mat.name);
                    }
                    document.getElementById('material-other-select').value=''; 
                    document.getElementById('material-custom-input').classList.add('hidden'); 
                    renderMaterialCards(); 
                    updateValidation(); 
                }; 
                grid.appendChild(card); 
            }); 
        }
        function showMaterialHelp(name, desc) {
            openRefModal(name, desc, 'material');
        }
        function onMaterialOtherChange() {
            const val = document.getElementById('material-other-select').value;
            if(!val) return;
            if(val === 'Custom') {
                document.getElementById('material-custom-input').classList.remove('hidden');
                document.getElementById('material-custom-input').focus();
            } else {
                document.getElementById('material-custom-input').classList.add('hidden');
                // Add to materials array if not already present
                if(!data.materials.includes(val)) {
                    data.materials.push(val);
                }
                renderMaterialCards();
                updateValidation();
            }
        }
        function onMaterialCustomInput() {
            const val = document.getElementById('material-custom-input').value.trim();
            if(val) {
                // Add custom material to array if not already present
                if(!data.materials.includes(val)) {
                    data.materials.push(val);
                }
                renderMaterialCards();
                updateValidation();
            }
        }
        
        // V99.45: Pattern Cards with ? help buttons
        function renderPatternCards() {
            const mainGrid = document.getElementById('pattern-cards-grid');
            const othersGrid = document.getElementById('pattern-cards-others');
            
            // Main patterns (priority 1-2)
            const mainPatterns = patternDB.filter(p => p.priority <= 2);
            // Other patterns (priority 3+)
            const otherPatterns = patternDB.filter(p => p.priority > 2);
            
            mainGrid.innerHTML = '';
            mainPatterns.forEach(pat => {
                const card = document.createElement('div');
                // Only show priority-1 (default) styling if NO pattern is selected yet
                const showDefault = pat.default && !data.pattern;
                card.className = `card ${showDefault?'priority-1':''} ${data.pattern===pat.name?'selected':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showPatternHelp('${pat.name}', '${pat.desc.replace(/'/g, "\\'")}', '${pat.examples.replace(/'/g, "\\'")}');">?</button><div class="card-name">${pat.name}</div><div class="card-desc">${pat.desc}</div>`;
                card.onclick = () => selectPattern(pat.name);
                mainGrid.appendChild(card);
            });
            
            othersGrid.innerHTML = '';
            otherPatterns.forEach(pat => {
                const card = document.createElement('div');
                card.className = `card ${data.pattern===pat.name?'selected':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showPatternHelp('${pat.name}', '${pat.desc.replace(/'/g, "\\'")}', '${pat.examples.replace(/'/g, "\\'")}');">?</button><div class="card-name">${pat.name}</div><div class="card-desc">${pat.desc}</div>`;
                card.onclick = () => selectPattern(pat.name);
                othersGrid.appendChild(card);
            });
        }
        
        function selectPattern(name) {
            data.pattern = name;
            renderPatternCards();
            
            // Show/hide print type and graphic category sections for Graphic
            const showGraphicOptions = (name === 'Graphic');
            document.getElementById('print-type-section').classList.toggle('hidden', !showGraphicOptions);
            document.getElementById('graphic-category-section').classList.toggle('hidden', !showGraphicOptions);
            // Clear print type and graphic category if not Graphic
            if(!showGraphicOptions) { 
                data.printType = ''; 
                data.graphicCategory = ''; 
                document.querySelectorAll('.print-btn, .graphic-cat-btn').forEach(b => b.classList.remove('selected','btn-hero')); 
            }
            
            updateValidation();
        }
        
        function showPatternHelp(name, desc, examples) {
            document.getElementById('ref-modal-title').textContent = name;
            document.getElementById('ref-modal-desc').textContent = desc + '\n\nExamples: ' + examples;
            
            // Build Google image search URL
            let query = name + ' pattern clothing';
            if (name === 'Solid') query = 'solid color t-shirt plain blank';
            if (name === 'Graphic') query = 'graphic tee print band shirt logo';
            if (name === 'Striped') query = 'striped shirt pattern sailor stripe';
            if (name === 'Color Block') query = 'color block shirt 90s panel';
            if (name === 'Plaid') query = 'plaid flannel pattern tartan buffalo check';
            if (name === 'Tie Dye') query = 'tie dye shirt spiral pattern';
            if (name === 'Camo') query = 'camo camouflage pattern military';
            if (name === 'Embroidered') query = 'embroidered shirt logo stitched';
            if (name === 'Polka Dot') query = 'polka dot pattern shirt dress';
            if (name === 'Paisley') query = 'paisley pattern bandana western shirt';
            if (name === 'Floral') query = 'floral pattern hawaiian shirt roses';
            if (name === 'Animal') query = 'animal print leopard zebra tiger';
            if (name === 'Geometric') query = 'geometric pattern 80s aztec chevron';
            if (name === 'Checkered') query = 'checkered pattern checkerboard vans';
            if (name === 'Houndstooth') query = 'houndstooth pattern coat jacket';
            if (name === 'Herringbone') query = 'herringbone pattern tweed suit';
            if (name === 'Abstract') query = 'abstract pattern 80s splatter';
            
            document.getElementById('ref-modal-link').href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
            document.getElementById('ref-modal-overlay').classList.add('visible');
        }
        
        function onFabricOtherChange() {
            const val = document.getElementById('fabric-other-select').value;
            if(!val) return;
            if(val === 'Custom') {
                document.getElementById('fabric-custom-input').classList.remove('hidden');
                document.getElementById('fabric-custom-input').focus();
            } else {
                document.getElementById('fabric-custom-input').classList.add('hidden');
                data.fabricType = val;
                // Deselect cards
                document.querySelectorAll('#fabric-cards-grid .card').forEach(c => c.classList.remove('selected'));
                document.getElementById('wash-section').classList.add('hidden');
                updateValidation();
            }
        }
        function onFabricCustomInput() {
            const val = document.getElementById('fabric-custom-input').value.trim();
            if(val) {
                data.fabricType = val;
                document.querySelectorAll('#fabric-cards-grid .card').forEach(c => c.classList.remove('selected'));
                document.getElementById('wash-section').classList.add('hidden');
                updateValidation();
            }
        }
        function toggleMaterialHelp() { document.getElementById('material-help-panel').classList.toggle('hidden'); }
        function toggleMaterialFilter(type, value, btn) { 
            if(materialFilters[type]===value){
                materialFilters[type]=null;
                data.materialTraits[type]='';
                btn.classList.remove('active');
            } 
            else{
                materialFilters[type]=value;
                data.materialTraits[type]=value;
                btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            } 
            renderMaterialCards(); 
            updateMaterialAdvice();
        }
        
        function updateMaterialAdvice() {
            const helper = document.getElementById('material-helper');
            const helperTagcut = document.getElementById('material-helper-tagcut');
            const advice = getMaterialAdvice();
            
            if(helper) {
                if(advice){helper.innerHTML=advice;helper.classList.remove('hidden');} 
                else helper.classList.add('hidden');
            }
            if(helperTagcut && tagCutMode) {
                helperTagcut.innerHTML = advice || '<span style="color:#6b7280;">Select traits above to see material matches</span>';
            }
        }
        // V99.45: TRULY DYNAMIC material advice based on actual materialDB filtering
        function getMaterialAdvice() {
            const cat = data.category || 'T-Shirt';
            const m = materialFilters;
            const activeFilters = Object.values(m).filter(Boolean).length;
            
            if(activeFilters === 0) return '';
            
            // Get materials for this category
            const materials = materialDB[cat] || materialDB['default'];
            
            // TRULY DYNAMIC: Filter materials based on ALL selected traits
            const matches = materials.filter(mat => {
                if(m.temp && mat.traits.temp !== m.temp) return false;
                if(m.shine && mat.traits.shine !== m.shine) return false;
                return true;
            });
            
            // Build trait description for display
            const traitDesc = [];
            if(m.temp) traitDesc.push(m.temp === 'cool' ? 'Cool to touch' : 'Warm to touch');
            if(m.shine) traitDesc.push(m.shine === 'matte' ? 'Matte (no shine)' : 'Has sheen/shine');
            
            // Build dynamic advice based on actual matches
            if(matches.length === 0) {
                // No matches - this combination is unusual for this category
                return `<div style="color:#b91c1c;"><strong>‚ö†Ô∏è Unusual combination for ${cat}!</strong></div>` +
                       `<div style="margin:4px 0;">${traitDesc.join(' + ')}</div>` +
                       `<div style="font-style:italic;font-size:10px;">This doesn't match typical ${cat} materials. Check the "Other materials" dropdown.</div>`;
            } 
            else if(matches.length === 1) {
                // Perfect! One exact match
                const mat = matches[0];
                return `<div style="color:#16a34a;"><strong>‚úÖ That's ${mat.name}!</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">${mat.desc}</div>`;
            } 
            else if(matches.length === 2) {
                // Two possibilities
                return `<div style="color:#2563eb;"><strong>üí° Could be one of these:</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">` +
                       `<strong>${matches[0].name}</strong> ‚Äì ${matches[0].desc}<br>` +
                       `<strong>${matches[1].name}</strong> ‚Äì ${matches[1].desc}</div>`;
            } 
            else {
                // Multiple matches - show them all
                let html = `<div style="color:#2563eb;"><strong>üí° ${matches.length} possible materials:</strong></div><div style="margin:4px 0;font-size:11px;">`;
                matches.forEach(mat => {
                    html += `<strong>${mat.name}</strong> ‚Äì ${mat.desc}<br>`;
                });
                html += `</div>`;
                return html;
            }
        }
        
        // V99.45: Tag Location Helper Functions
        function toggleTagLocationHelp() { 
            const panel = document.getElementById('tag-location-panel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                updateTagLocationHelp();
            }
        }
        
        function updateTagLocationHelp() {
            const cat = data.category || 'T-Shirt';
            const locations = tagLocationDB[cat] || tagLocationDB['default'];
            const content = document.getElementById('tag-location-content');
            
            let html = `<div style="font-weight:700;color:#92400e;margin-bottom:8px;font-size:13px;">üîç Where to find tags on: ${cat}</div>`;
            
            // Primary location
            html += `<div style="background:white;border-radius:8px;padding:10px;margin-bottom:8px;border-left:4px solid #16a34a;">`;
            html += `<div style="font-weight:700;color:#16a34a;font-size:12px;">‚úÖ CHECK FIRST: ${locations.primary.location}</div>`;
            html += `<div style="font-size:11px;color:#374151;">${locations.primary.desc}</div>`;
            html += `</div>`;
            
            // Secondary locations
            if(locations.secondary && locations.secondary.length > 0) {
                html += `<div style="font-weight:600;color:#92400e;font-size:11px;margin-bottom:6px;">Also check these spots:</div>`;
                locations.secondary.forEach(loc => {
                    const isImportant = loc.icon === '‚≠ê';
                    html += `<div style="background:${isImportant?'#fef3c7':'white'};border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid ${isImportant?'#f59e0b':'#d1d5db'};">`;
                    html += `<div style="font-weight:600;color:${isImportant?'#b45309':'#374151'};font-size:11px;">${loc.icon} ${loc.location}</div>`;
                    html += `<div style="font-size:10px;color:#6b7280;">${loc.desc}</div>`;
                    html += `</div>`;
                });
            }
            
            // Tips
            if(locations.tips) {
                html += `<div style="background:#dbeafe;border-radius:8px;padding:10px;margin-top:8px;">`;
                html += `<div style="font-weight:600;color:#1e40af;font-size:11px;">üí° Pro Tip:</div>`;
                html += `<div style="font-size:10px;color:#1e40af;">${locations.tips}</div>`;
                html += `</div>`;
            }
            
            content.innerHTML = html;
        }
        
        // V99.45: Pattern Helper Functions
        function togglePatternHelp() { 
            document.getElementById('pattern-help-panel').classList.toggle('hidden'); 
        }
        
        function togglePatternFilter(type, value, btn) { 
            if(patternFilters[type]===value){
                patternFilters[type]=null;
                data.patternTraits[type]='';
                btn.classList.remove('active');
            } 
            else{
                patternFilters[type]=value;
                data.patternTraits[type]=value;
                btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            } 
            updatePatternAdvice();
        }
        
        function updatePatternAdvice() {
            const helper = document.getElementById('pattern-helper');
            const advice = getPatternAdvice();
            
            if(helper) {
                if(advice){helper.innerHTML=advice;helper.classList.remove('hidden');} 
                else helper.classList.add('hidden');
            }
        }
        
        // V99.45: TRULY DYNAMIC pattern advice based on patternDB filtering
        function getPatternAdvice() {
            const p = patternFilters;
            const activeFilters = Object.values(p).filter(Boolean).length;
            
            if(activeFilters === 0) return '';
            
            // Filter patterns based on ALL selected traits
            const matches = patternDB.filter(pat => {
                // Handle "any" trait (matches everything)
                if(p.lines && pat.traits.lines !== 'any' && pat.traits.lines !== p.lines) return false;
                if(p.shapes && pat.traits.shapes !== 'any' && pat.traits.shapes !== p.shapes) return false;
                if(p.method && pat.traits.method !== 'any' && pat.traits.method !== p.method) return false;
                return true;
            }).filter(pat => pat.name !== 'Other'); // Exclude "Other" from suggestions
            
            // Build trait description for display
            const traitDesc = [];
            if(p.lines) traitDesc.push(p.lines === 'none' ? 'No lines' : p.lines === 'stripes' ? 'Parallel lines' : 'Crossing lines');
            if(p.shapes) traitDesc.push(p.shapes === 'none' ? 'No shapes' : p.shapes === 'dots' ? 'Dots/circles' : p.shapes === 'curved' ? 'Curved shapes' : p.shapes === 'geometric' ? 'Geometric shapes' : 'Irregular blobs');
            if(p.method) traitDesc.push(p.method === 'woven' ? 'Woven into fabric' : p.method === 'printed' ? 'Printed on surface' : 'Stitched on');
            
            // Build dynamic advice based on actual matches
            if(matches.length === 0) {
                return `<div style="color:#b91c1c;"><strong>‚ö†Ô∏è No common pattern matches!</strong></div>` +
                       `<div style="margin:4px 0;">${traitDesc.join(' + ')}</div>` +
                       `<div style="font-style:italic;font-size:10px;">Try selecting "Other" or adjust your selections.</div>`;
            } 
            else if(matches.length === 1) {
                const pat = matches[0];
                return `<div style="color:#16a34a;"><strong>‚úÖ That's ${pat.name}!</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">${pat.desc}</div>` +
                       `<div style="font-size:10px;color:#6b7280;"><em>Examples: ${pat.examples}</em></div>`;
            } 
            else if(matches.length === 2) {
                return `<div style="color:#2563eb;"><strong>üí° Could be one of these:</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">` +
                       `<strong>${matches[0].name}</strong> ‚Äì ${matches[0].desc}<br>` +
                       `<strong>${matches[1].name}</strong> ‚Äì ${matches[1].desc}</div>` +
                       `<div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
            } 
            else {
                // Multiple matches - show them all
                let html = `<div style="color:#2563eb;"><strong>üí° ${matches.length} possible patterns:</strong></div><div style="margin:4px 0;font-size:11px;">`;
                matches.slice(0, 5).forEach(pat => {
                    html += `<strong>${pat.name}</strong> ‚Äì ${pat.desc}<br>`;
                });
                if(matches.length > 5) html += `<em>...and ${matches.length - 5} more</em><br>`;
                html += `</div><div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
                return html;
            }
        }
        
        function updateValidation() { 
            // Construction check depends on superCategory: bottoms need legStyle, tops/outer need sleeveLength
            const constructionOk = data.superCategory === 'bottoms' ? !!data.legStyle : !!data.sleeveLength;
            const checks = { category:!!data.category, tag:!!data.tagStatus, color:data.colors.length>0, fade:!!data.fade, pattern:!!data.pattern, 'fabric-type':!!data.fabricType, material:data.materials.length>0, construction:constructionOk, feel:!!data.thickness&&!!data.layers, condition:data.hasDefects!==null, weight:data.weightLb>0||data.weightOz>0, audio:!!data.audioMeasure, sku:!!data.sku }; 
            Object.entries(checks).forEach(([key,ok])=>{ const el = document.getElementById(`check-${key}`); if(el){el.innerHTML=ok?'‚úì':'‚óã';el.classList.toggle('complete',ok);} }); 
            const allRequired = checks.category&&checks.tag&&checks.color&&checks.fade&&checks.pattern&&checks['fabric-type']&&checks.material&&checks.construction&&checks.feel&&checks.condition&&checks.weight&&checks.audio&&checks.sku; 
            const hasPhotos = data.mainPhotos.length>0; 
            document.getElementById('submit-btn').disabled = !(allRequired&&hasPhotos);
            if(currentStep===4) updateReviewCards();
        }
        
        function submitItem() { 
            if(!data.sku) { showToast('error', 'Missing SKU', 'Enter or scan a SKU number'); return; }
            if(data.mainPhotos.length===0) { showToast('error', 'Missing Photo', 'Add at least one main photo'); return; }
            if(data.weightLb===0 && data.weightOz===0) { showToast('error', 'Missing Weight', 'Enter the item weight'); return; }
            if(!data.audioMeasure) { showToast('error', 'Missing Measurements', 'Record voice measurements'); return; }
            
            // Send to n8n webhook
            const formData = new FormData();
            formData.append('sku', data.sku);
            formData.append('category', data.category);
            formData.append('superCategory', data.superCategory);
            formData.append('tagStatus', data.tagStatus);
            formData.append('tagSize', data.tagSize);
            formData.append('origin', data.origin);
            formData.append('country', data.country);
            formData.append('gender', data.gender);
            formData.append('colors', JSON.stringify(data.colors));
            formData.append('fade', data.fade);
            formData.append('pattern', data.pattern);
            formData.append('patternTraits', JSON.stringify(data.patternTraits));
            formData.append('printType', data.printType);
            formData.append('graphicCategory', data.graphicCategory);
            formData.append('fabricType', data.fabricType);
            formData.append('fabricTraits', JSON.stringify(data.fabricTraits));
            formData.append('wash', data.wash);
            formData.append('materials', JSON.stringify(data.materials));
            formData.append('materialTraits', JSON.stringify(data.materialTraits));
            formData.append('sleeveLength', data.sleeveLength);
            formData.append('sleeveStyle', data.sleeveStyle);
            formData.append('cutoffType', data.cutoffType);
            formData.append('stitch', data.stitch);
            formData.append('legStyle', data.legStyle);
            formData.append('rise', data.rise);
            formData.append('thickness', data.thickness);
            formData.append('layers', data.layers);
            formData.append('hasDefects', data.hasDefects);
            formData.append('defectTypes', JSON.stringify(data.defectTypes));
            formData.append('flagged', data.flagged);
            formData.append('elasticCheck', data.elasticCheck);
            formData.append('weightLb', data.weightLb);
            formData.append('weightOz', data.weightOz);
            formData.append('photographer', data.photographer);
            formData.append('audioDuration', data.audioDuration);
            if(data.audioMeasure) formData.append('audio', data.audioMeasure, 'measurements.webm');
            data.mainPhotos.forEach((p,i) => formData.append(`mainPhoto${i}`, p.blob, `main${i}.jpg`));
            data.tagPhotos.forEach((p,i) => formData.append(`tagPhoto${i}`, p.blob, `tag${i}.jpg`));
            data.defectPhotos.forEach((p,i) => formData.append(`defectPhoto${i}`, p.blob, `defect${i}.jpg`));
            data.defectCloseupPhotos.forEach((p,i) => {
                formData.append(`defectCloseupPhoto${i}`, p.blob, `defect-closeup${i}.jpg`);
                if(p.linkedDefectIndex !== null && p.linkedDefectIndex !== undefined) {
                    formData.append(`defectCloseupPhoto${i}_linkedTo`, p.linkedDefectIndex);
                }
            });
            data.featuresPhotos.forEach((p,i) => {
                formData.append(`featurePhoto${i}`, p.blob, `feature${i}.jpg`);
                if(p.featureType) {
                    formData.append(`featurePhoto${i}_type`, p.featureType);
                }
            });
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', N8N_WEBHOOK_URL, true);
            xhr.onload = () => { 
                if(xhr.status===200) { 
                    console.log('Submitted to n8n'); 
                    showToast('success', 'Item Submitted!', `SKU ${data.sku} saved successfully`);
                } else {
                    showToast('warning', 'Submission Issue', 'Item saved locally, server may have issues');
                }
            };
            xhr.onerror = () => { 
                console.error('Webhook error'); 
                showToast('error', 'Network Error', 'Item saved locally, check connection');
            };
            xhr.send(formData);
            
            recordItemTime(); stats.today++; stats.week++; stats.total++; saveStats(); updateStatsDisplay(); console.log('Submitted:',data); resetForm(); 
        }
        function resetForm(keepSku = false) { 
            // Store SKU if we want to keep it
            const preservedSku = keepSku ? data.sku : '';
            const wasSkuLocked = keepSku ? skuLocked : false;
            
            console.log(`üîÑ resetForm called - keepSku: ${keepSku}, preservedSku: ${preservedSku}`);
            
            // Revoke all photo URLs
            data.mainPhotos.forEach(p=>URL.revokeObjectURL(p.url)); 
            data.tagPhotos.forEach(p=>URL.revokeObjectURL(p.url)); 
            data.defectPhotos.forEach(p=>URL.revokeObjectURL(p.url)); 
            data.defectCloseupPhotos.forEach(p=>URL.revokeObjectURL(p.url)); 
            data.featuresPhotos.forEach(p=>URL.revokeObjectURL(p.url)); 
            
            // Reset data object
            data = {
                superCategory:'tops',
                category:'',
                tagStatus:'',
                tagSize:'',
                origin:'',
                country:'',
                gender:'',
                colors:[],
                fade:'',
                pattern:'',
                patternTraits:{lines:'',shapes:'',method:''},
                printType:'',
                graphicCategory:'',
                fabricType:'',
                fabricTraits:{stretch:'',surface:'',interior:''},
                wash:'',
                materials:[],
                materialTraits:{temp:'',shine:''},
                sleeveLength:'',
                sleeveStyle:'',
                cutoffType:'',
                stitch:'',
                legStyle:'',
                rise:'',
                thickness:'',
                layers:'',
                hasDefects:null,
                defectTypes:[],
                weightLb:0,
                weightOz:0,
                sku: preservedSku,
                photographer:data.photographer,
                audioMeasure:null,
                audioDuration:0,
                mainPhotos:[],
                tagPhotos:[],
                defectPhotos:[],
                defectCloseupPhotos:[],
                featuresPhotos:[],
                flagged:false,
                elasticCheck:''
            }; 
            
            // Reset state variables
            tagCutMode = false; 
            skuLocked = wasSkuLocked; 
            selectedDefectLink = null; 
            selectedFeatureType = null;
            fabricFilters = {stretch:null, surface:null, interior:null}; 
            materialFilters = {temp:null, shine:null}; 
            patternFilters = {lines:null, shapes:null, method:null};
            
            // === RESET ALL BUTTON SELECTIONS ===
            document.querySelectorAll('.selected').forEach(b => b.classList.remove('selected')); 
            document.querySelectorAll('.btn-hero').forEach(b => {
                if(!b.classList.contains('super-btn')) {
                    b.classList.remove('btn-hero');
                    b.classList.add('btn-secondary');
                }
            });
            
            // Reset super category buttons (Tops selected by default)
            document.querySelectorAll('.super-btn').forEach((b,i) => {
                if(i === 0) {
                    b.classList.add('selected', 'btn-hero');
                    b.classList.remove('btn-secondary');
                } else {
                    b.classList.remove('selected', 'btn-hero');
                    b.classList.add('btn-secondary');
                }
            });
            
            // Reset all other button types
            document.querySelectorAll('.cat-btn, .size-btn, .country-btn, .gender-btn, .tag-status-btn, .fade-btn, .pattern-btn, .defect-btn, .elastic-btn, .leg-btn, .rise-btn, .sleeve-btn, .stitch-btn').forEach(b => {
                b.classList.remove('selected', 'btn-hero');
                b.classList.add('btn-secondary');
            });
            
            // Reset color buttons
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            
            // Reset filter buttons
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            
            // === RESET INPUT FIELDS ===
            document.getElementById('sku-input').value = preservedSku;
            document.getElementById('weight-lb').value = '0';
            document.getElementById('weight-oz').value = '0';
            document.getElementById('tag-size-input').value = '';
            document.getElementById('country-other-input').value = '';
            document.getElementById('material-other-select').value = '';
            document.getElementById('material-custom-input').value = '';
            document.getElementById('fabric-other-select').value = '';
            document.getElementById('fabric-custom-input').value = '';
            
            // === HIDE SECTIONS ===
            ['tag-details', 'country-section', 'country-other-input', 'wash-section', 'print-type-section', 
             'graphic-category-section', 'pattern-others', 'cutoff-section', 'elastic-section', 
             'sleeve-measurement-notice', 'material-custom-input', 'fabric-custom-input', 'fabric-helper', 
             'material-helper', 'pattern-helper', 'pattern-help-panel', 'tag-location-panel', 
             'fabric-tag-cut-section', 'material-tag-cut-section', 'leg-style-help', 'flag-status',
             'bottoms-construction', 'measure-hint-button-shirt', 'measure-hint-bottoms', 'measure-hint-outer'
            ].forEach(id => document.getElementById(id)?.classList.add('hidden'));
            
            // === SHOW SECTIONS ===
            ['tops-construction', 'measure-hint-tops', 'fabric-help-btn', 'material-help-btn', 'record-section'
            ].forEach(id => document.getElementById(id)?.classList.remove('hidden'));
            
            document.getElementById('post-record-section').classList.add('hidden');
            
            // === RESET UI ELEMENTS ===
            document.getElementById('other-patterns-toggle').textContent = '+ More patterns';
            document.getElementById('category-label').textContent = '';
            updateMeasurementHintsForSleeveStyle('Standard', '');
            
            // Reset audio recording
            document.getElementById('record-btn').innerHTML = '<span style="font-size:24px;">üé§</span><span>TAP TO RECORD</span>';
            document.getElementById('record-btn').style.background = '#ef4444';
            
            // Reset flag button
            document.getElementById('flag-btn').classList.remove('flagged');
            document.getElementById('flag-btn').querySelector('span:first-child').textContent = 'ü§î';
            document.getElementById('flag-btn').querySelector('span:last-of-type').textContent = 'FLAG AS UNUSUAL';
            
            // === HANDLE SKU STATE ===
            if(keepSku && preservedSku) {
                document.getElementById('sku-locked-badge').classList.remove('hidden');
                document.getElementById('sku-locked-value').textContent = preservedSku;
                document.getElementById('sku-locked-display').classList.remove('hidden');
                document.getElementById('sku-locked-display').style.display = 'flex';
                document.getElementById('sku-display-value').textContent = preservedSku;
                document.getElementById('sku-manual-input').classList.add('hidden');
                document.getElementById('check-sku').innerHTML = '‚úì';
                document.getElementById('check-sku').classList.add('complete');
            } else {
                document.getElementById('sku-locked-badge').classList.add('hidden');
                document.getElementById('sku-locked-value').textContent = '';
                document.getElementById('sku-locked-display').classList.add('hidden');
                document.getElementById('sku-manual-input').classList.add('hidden');
                document.getElementById('check-sku').innerHTML = '‚óã';
                document.getElementById('check-sku').classList.remove('complete');
            }
            document.getElementById('sku-status').textContent = '';
            document.getElementById('sku-camera-status').style.display = 'none';
            
            // === RENDER/UPDATE ===
            renderSubCategories('tops'); 
            clearDefectMarkers(); 
            renderFabricCards(); 
            renderMaterialCards(); 
            renderPatternCards(); 
            updatePhotoGrids(); 
            updateValidation(); 
            
            // === NAVIGATION ===
            goToStep(1); 
            setPhotoMode('main'); 
            resetZoom(); 
            
            // Show SKU gate only if not keeping SKU
            if(!keepSku || !preservedSku) {
                showSkuGate();
            }
        }
        
        function loadStats() { try{ const saved = JSON.parse(localStorage.getItem(`vl_stats_${VERSION}`)||'{}'); if(saved.date!==new Date().toDateString()){saved.today=0;} stats = {today:saved.today||0,week:saved.week||0,total:saved.total||0}; itemTimes = saved.itemTimes||[]; updateStatsDisplay(); if(itemTimes.length>0){ const avg = Math.floor(itemTimes.reduce((a,b)=>a+b,0)/itemTimes.length); document.getElementById('timer-avg').textContent = `${Math.floor(avg/60)}:${(avg%60).toString().padStart(2,'0')}`; } }catch(e){} }
        function saveStats() { try{localStorage.setItem(`vl_stats_${VERSION}`,JSON.stringify({...stats,date:new Date().toDateString(),itemTimes:itemTimes.slice(-50)}));}catch(e){} }
        function updateStatsDisplay() { document.getElementById('stat-today').textContent = stats.today; document.getElementById('stat-week').textContent = stats.week; document.getElementById('stat-total').textContent = stats.total; }
    </script>
</body>
</html>

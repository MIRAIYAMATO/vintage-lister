<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VintageLister Browser v2.3</title>
    <style>
        :root {
            --color-primary: #3b82f6;
            --color-primary-dark: #2563eb;
            --color-primary-light: #dbeafe;
            --color-success: #22c55e;
            --color-success-dark: #16a34a;
            --color-warning: #f59e0b;
            --color-warning-dark: #d97706;
            --color-error: #ef4444;
            --color-error-dark: #dc2626;
            --color-surface: #ffffff;
            --color-background: #f1f5f9;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-border: #e2e8f0;
            --color-dark: #1e293b;
            --color-dark-lighter: #334155;
            --color-purple: #7c3aed;
            --color-cyan: #0891b2;
            --radius-md: 8px;
            --radius-lg: 10px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            height: 100vh;
            overflow: hidden;
        }
        
        /* LAYOUT */
        .desktop-layout {
            display: grid;
            grid-template-columns: 340px 1fr 300px;
            height: 100vh;
            overflow: hidden;
        }
        
        /* LEFT PANEL */
        .form-panel {
            background: var(--color-surface);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* TIMER HEADER */
        .floating-timer {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timer-main { font-size: 28px; font-weight: 800; font-family: monospace; }
        .timer-stats { text-align: right; font-size: 11px; }
        .version-badge { background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        
        /* FORM CONTENT */
        .form-content { flex: 1; overflow-y: auto; padding: 16px; }
        
        .section-card {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }
        
        .section-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .check-circle {
            width: 20px; height: 20px;
            border-radius: 50%;
            background: var(--color-border);
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        .check-circle.complete { background: var(--color-success); color: white; }
        
        /* SKU Input */
        .sku-input-row { display: flex; gap: 8px; }
        .sku-input {
            flex: 1; padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 16px; font-weight: 600;
        }
        .sku-input:focus { outline: none; border-color: var(--color-primary); }
        .sku-display {
            padding: 12px;
            background: var(--color-success);
            color: white;
            border-radius: var(--radius-md);
            font-size: 16px; font-weight: 700;
            text-align: center;
            display: none;
        }
        .sku-display.visible { display: block; }
        
        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 13px; font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--color-primary); color: white; border-color: var(--color-primary-dark); }
        .btn-primary:hover { background: var(--color-primary-dark); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-success:hover { background: var(--color-success-dark); }
        
        /* Camera Select */
        .camera-select {
            width: 100%; padding: 10px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 13px;
            margin-bottom: 8px;
        }
        .camera-select:focus { outline: none; border-color: var(--color-primary); }
        
        /* MODE BUTTONS - 3 modes */
        .mode-buttons { display: flex; flex-direction: column; gap: 8px; }
        
        .mode-btn {
            padding: 16px;
            border: 3px solid var(--color-border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.15s;
        }
        .mode-btn:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
        .mode-btn.active { border-color: var(--color-primary); background: var(--color-primary); color: white; }
        .mode-btn.active[data-mode="main"] { background: var(--color-primary); border-color: var(--color-primary-dark); }
        .mode-btn.active[data-mode="closeup"] { background: var(--color-purple); border-color: #6d28d9; }
        .mode-btn.active[data-mode="handheld"] { background: var(--color-warning); border-color: var(--color-warning-dark); }
        
        .mode-icon { font-size: 28px; }
        .mode-info { flex: 1; }
        .mode-name { font-size: 16px; font-weight: 700; }
        .mode-desc { font-size: 11px; opacity: 0.8; }
        .mode-count { font-size: 20px; font-weight: 700; opacity: 0.9; }
        
        /* AI Status */
        .ai-status {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border-radius: 10px;
            padding: 12px;
            color: white;
        }
        .ai-status-title { font-size: 11px; font-weight: 700; opacity: 0.7; margin-bottom: 8px; }
        .ai-status-chain { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .ai-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }
        .ai-badge.claude { background: #d97706; }
        .ai-badge.openai { background: #059669; }
        .ai-badge.gemini { background: #7c3aed; }
        .ai-badge.manual { background: #64748b; }
        .ai-badge.active { box-shadow: 0 0 0 2px white; }
        .ai-arrow { color: #64748b; font-size: 10px; }
        
        /* Complete Button */
        .complete-section { padding: 16px; border-top: 1px solid var(--color-border); }
        .complete-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--color-success), var(--color-success-dark));
            color: white; border: none;
            border-radius: var(--radius-lg);
            font-size: 16px; font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }
        .complete-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34,197,94,0.4); }
        .complete-btn:disabled { background: var(--color-border); cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* CENTER - Camera */
        .camera-panel {
            background: #000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .camera-header {
            background: rgba(0,0,0,0.8);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10;
        }
        .camera-mode-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }
        .camera-mode-badge.main { background: var(--color-primary); }
        .camera-mode-badge.closeup { background: var(--color-purple); }
        .camera-mode-badge.handheld { background: var(--color-warning); }
        .camera-resolution { color: var(--color-success); font-size: 12px; font-family: monospace; }
        .fullres-btn {
            padding: 6px 12px;
            background: var(--color-warning);
            color: white; border: none;
            border-radius: 6px;
            font-size: 11px; font-weight: 700;
            cursor: pointer;
        }
        .fullres-btn:hover { background: var(--color-warning-dark); }
        .camera-status { margin-left: auto; font-size: 12px; color: var(--color-success); }
        .camera-status::before { content: '‚óè'; margin-right: 6px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Camera View */
        .camera-view {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        #camera-video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .camera-placeholder { color: #666; text-align: center; }
        .camera-placeholder-icon { font-size: 64px; margin-bottom: 16px; }
        
        /* Blur Warning */
        .blur-warning {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            display: none;
            z-index: 20;
        }
        .blur-warning.visible { display: block; }
        
        /* Camera Footer */
        .camera-footer {
            background: var(--color-dark);
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        .shutter-btn {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: white;
            border: 4px solid #666;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .shutter-btn:hover { transform: scale(1.05); }
        .shutter-btn:active { transform: scale(0.95); background: #ddd; }
        .shutter-hint { font-size: 11px; color: #888; text-align: center; }
        .shutter-hint kbd { background: #444; color: white; padding: 2px 6px; border-radius: 4px; }
        
        /* Flash */
        .flash-overlay {
            position: absolute; inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.05s;
            z-index: 100;
        }
        .flash-overlay.flash { opacity: 1; }
        
        /* RIGHT PANEL - Photos */
        .photos-panel {
            background: var(--color-background);
            overflow-y: auto;
            padding: 16px;
            border-left: 1px solid var(--color-border);
        }
        
        .photos-section { margin-bottom: 16px; }
        .photos-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .photos-section-title { font-size: 12px; font-weight: 700; color: var(--color-text); }
        .photos-section-count {
            font-size: 11px;
            background: var(--color-border);
            padding: 2px 8px;
            border-radius: 10px;
            color: var(--color-text-muted);
        }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .photo-thumb {
            aspect-ratio: 1;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 2px solid var(--color-border);
        }
        .photo-thumb:hover { border-color: var(--color-primary); }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb .photo-label {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            text-align: center;
            font-weight: 600;
        }
        .photo-thumb .delete-btn {
            position: absolute;
            top: 2px; right: 2px;
            width: 18px; height: 18px;
            background: var(--color-error);
            border: none; border-radius: 50%;
            color: white; font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .photo-thumb:hover .delete-btn { opacity: 1; }
        .photo-thumb.blur-detected { border-color: var(--color-error); }
        .photo-thumb.blur-detected::after {
            content: '‚ö†Ô∏è BLUR';
            position: absolute;
            top: 2px; left: 2px;
            background: var(--color-error);
            color: white;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 700;
        }
        
        /* TOAST */
        .toast-container {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: var(--color-dark);
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        .toast.success { background: linear-gradient(135deg, #059669, #047857); }
        .toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .toast.warning { background: linear-gradient(135deg, #d97706, #b45309); }
        .toast.info { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .toast-icon { font-size: 18px; }
        .toast-message { font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
        
        /* PROCESSING OVERLAY */
        .processing-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }
        .processing-overlay.active { display: flex; }
        .processing-spinner {
            width: 60px; height: 60px;
            border: 4px solid #333;
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-text { color: white; font-size: 18px; font-weight: 600; }
        .processing-subtext { color: #888; font-size: 13px; }
        .processing-progress {
            width: 300px; height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        .processing-progress-bar {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="desktop-layout">
        <!-- LEFT PANEL -->
        <div class="form-panel">
            <div class="floating-timer">
                <div>
                    <div class="timer-main" id="timer-display">0:00</div>
                    <div style="font-size:10px; opacity:0.7;">ITEM TIME</div>
                </div>
                <div class="timer-stats">
                    <div><strong id="stat-today">0</strong> today</div>
                    <div class="version-badge">v2.3</div>
                </div>
            </div>
            
            <div class="form-content">
                <!-- SKU -->
                <div class="section-card">
                    <div class="section-label">
                        <span class="check-circle" id="check-sku">‚óã</span>
                        üè∑Ô∏è Item SKU
                    </div>
                    <div class="sku-input-row" id="sku-input-row">
                        <input type="text" class="sku-input" id="sku-input" placeholder="Scan or type SKU...">
                        <button class="btn btn-success" onclick="startNewItem()">START</button>
                    </div>
                    <div class="sku-display" id="sku-display"></div>
                </div>
                
                <!-- Camera -->
                <div class="section-card">
                    <div class="section-label">
                        <span class="check-circle" id="check-camera">‚óã</span>
                        üì∑ Camera
                    </div>
                    <select class="camera-select" id="camera-select-main" onchange="switchCamera('main', this.value)">
                        <option value="">Main Camera (Tripod)...</option>
                    </select>
                    <select class="camera-select" id="camera-select-handheld" onchange="switchCamera('handheld', this.value)">
                        <option value="">Handheld Camera...</option>
                    </select>
                </div>
                
                <!-- Photo Mode - 3 modes -->
                <div class="section-card">
                    <div class="section-label">üì∏ Photo Mode</div>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="main" onclick="setMode('main')">
                            <span class="mode-icon">üì¶</span>
                            <div class="mode-info">
                                <div class="mode-name">MAIN</div>
                                <div class="mode-desc">Tripod overhead ‚Ä¢ Flat-lay & T-pose</div>
                            </div>
                            <span class="mode-count" id="count-main">0</span>
                        </button>
                        <button class="mode-btn" data-mode="closeup" onclick="setMode('closeup')">
                            <span class="mode-icon">üîç</span>
                            <div class="mode-info">
                                <div class="mode-name">CLOSE-UP</div>
                                <div class="mode-desc">Tripod macro ‚Ä¢ Tags, defects, details</div>
                            </div>
                            <span class="mode-count" id="count-closeup">0</span>
                        </button>
                        <button class="mode-btn" data-mode="handheld" onclick="setMode('handheld')">
                            <span class="mode-icon">‚úã</span>
                            <div class="mode-info">
                                <div class="mode-name">HANDHELD</div>
                                <div class="mode-desc">Freestanding ‚Ä¢ Scale, angles, details</div>
                            </div>
                            <span class="mode-count" id="count-handheld">0</span>
                        </button>
                    </div>
                </div>
                
                <!-- AI Status -->
                <div class="section-card">
                    <div class="ai-status">
                        <div class="ai-status-title">ü§ñ AI PROCESSING (on Complete)</div>
                        <div class="ai-status-chain">
                            <span class="ai-badge claude active">CLAUDE</span>
                            <span class="ai-arrow">‚Üí</span>
                            <span class="ai-badge openai">OPENAI</span>
                            <span class="ai-arrow">‚Üí</span>
                            <span class="ai-badge gemini">GEMINI</span>
                            <span class="ai-arrow">‚Üí</span>
                            <span class="ai-badge manual">MANUAL</span>
                        </div>
                        <div style="font-size:10px; margin-top:8px; opacity:0.7;">
                            Auto-classify ‚Ä¢ Rotate ‚Ä¢ Crop ‚Ä¢ Quality check
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Complete -->
            <div class="complete-section">
                <button class="complete-btn" id="complete-btn" onclick="completeItem()" disabled>
                    ü§ñ COMPLETE + AI PROCESS
                </button>
                <div style="text-align:center; margin-top:10px; font-size:10px; color:var(--color-text-muted);">
                    VintageLister Browser <span id="version-footer">v2.3</span>
                </div>
            </div>
        </div>
        
        <!-- CENTER - Camera -->
        <div class="camera-panel">
            <div class="camera-header">
                <span class="camera-mode-badge main" id="camera-mode-badge">MAIN</span>
                <span class="camera-resolution" id="camera-resolution">--</span>
                <button class="fullres-btn" onclick="forceMaxResolution()">FULL RES</button>
                <span class="camera-status" id="camera-status" style="display:none;">LIVE</span>
            </div>
            
            <div class="camera-view" id="camera-view">
                <div class="camera-placeholder" id="camera-placeholder">
                    <div class="camera-placeholder-icon">üì∑</div>
                    <div>Select a camera to start</div>
                </div>
                <video id="camera-video" autoplay playsinline style="display:none;"></video>
                <div class="blur-warning" id="blur-warning">‚ö†Ô∏è Image may be blurry - hold steady</div>
                <div class="flash-overlay" id="flash-overlay"></div>
            </div>
            
            <div class="camera-footer">
                <div style="text-align:center;">
                    <button class="shutter-btn" id="shutter-btn" onclick="capturePhoto()"></button>
                    <div class="shutter-hint">Press <kbd>SPACE</kbd> to capture</div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT PANEL - Photos -->
        <div class="photos-panel">
            <div class="photos-section">
                <div class="photos-section-header">
                    <span class="photos-section-title">üì∑ All Photos</span>
                    <span class="photos-section-count" id="total-count">0</span>
                </div>
                <div style="font-size:11px; color:var(--color-text-muted); margin-bottom:10px;">
                    AI will classify & organize on Complete
                </div>
                <div class="photo-grid" id="photos-grid"></div>
            </div>
            
            <div class="photos-section" id="classified-section" style="display:none;">
                <div class="photos-section-header">
                    <span class="photos-section-title">‚úÖ Classified Photos</span>
                </div>
                <div id="classified-results"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Processing -->
    <div class="processing-overlay" id="processing-overlay">
        <div class="processing-spinner"></div>
        <div class="processing-text" id="processing-text">Processing...</div>
        <div class="processing-subtext" id="processing-subtext"></div>
        <div class="processing-progress">
            <div class="processing-progress-bar" id="processing-progress" style="width:0%"></div>
        </div>
    </div>

    <script>
        // ============================================
        // VERSION INFO
        // ============================================
        const VERSION = '2.3';
        const VERSION_DATE = '2025-01-18';
        const CHANGELOG = {
            '2.3': 'New 3-mode system (Main/Close-up/Handheld), AI integration via Lambda, smart crop & classify',
            '2.2': 'Fixed camera init to match v100 - high res hints, virtual camera filter',
            '2.1': 'Added AbortError handling, improved camera error messages, versioning system',
            '2.0': 'Initial browser version with v100 color scheme and defect handling'
        };
        
        // Lambda endpoint (secure - API keys stored in Lambda env vars)
        const LAMBDA_URL = 'https://i745n2nibsrhx7ivc7w6mf7cgy0caatc.lambda-url.us-east-2.on.aws/';
        
        // ============================================
        // STATE
        // ============================================
        let currentMode = 'main';
        let currentSKU = '';
        let currentStream = null;
        let activeCameraId = null;
        let cameraIds = { main: null, handheld: null };
        
        // All photos go in one array - AI classifies them later
        let photos = []; // { blob, url, width, height, mode, timestamp }
        
        // Timer
        let itemStartTime = null;
        let timerInterval = null;
        let itemsToday = parseInt(localStorage.getItem('vl_items_today') || '0');
        
        // AI fallback tracking
        let currentAI = 'claude';
        const AI_ORDER = ['claude', 'openai', 'gemini', 'manual'];
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`%c VintageLister Browser v${VERSION} `, 'background: #3b82f6; color: white; font-size: 14px; font-weight: bold;');
            console.log(`üìÖ ${VERSION_DATE} | ${CHANGELOG[VERSION]}`);
            
            document.querySelector('.version-badge').textContent = `v${VERSION}`;
            document.getElementById('version-footer').textContent = `v${VERSION}`;
            document.title = `VintageLister Browser v${VERSION}`;
            document.getElementById('stat-today').textContent = itemsToday;
            
            initCamera();
            initKeyboard();
            updateUI();
        });
        
        async function initCamera() {
            console.log('üì∑ Initializing cameras...');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showCameraError('Camera API not available', 'Use Chrome or Edge');
                return;
            }
            
            try {
                console.log('üì∑ Requesting permission with high-res hint...');
                const permStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 3840 }, height: { ideal: 2160 } }
                });
                permStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 300));
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => {
                    if (d.kind !== 'videoinput') return false;
                    const label = (d.label || '').toLowerCase();
                    const virtual = ['droidcam', 'obs', 'manycam', 'virtual', 'snap camera'];
                    return !virtual.some(v => label.includes(v));
                });
                
                console.log(`üì∑ Found ${videoDevices.length} camera(s)`);
                
                const mainSelect = document.getElementById('camera-select-main');
                const handheldSelect = document.getElementById('camera-select-handheld');
                
                mainSelect.innerHTML = '<option value="">Main Camera (Tripod)...</option>';
                handheldSelect.innerHTML = '<option value="">Handheld Camera...</option>';
                
                videoDevices.forEach((d, i) => {
                    const label = d.label || `Camera ${i+1}`;
                    mainSelect.add(new Option(label, d.deviceId));
                    handheldSelect.add(new Option(label, d.deviceId));
                    console.log(`  ${i+1}. ${label}`);
                });
                
                if (videoDevices.length > 0) {
                    showToast('success', `Found ${videoDevices.length} camera(s)`);
                }
                
            } catch (err) {
                console.error('üì∑ Error:', err);
                showCameraError(err.name, err.message);
            }
        }
        
        function showCameraError(title, message) {
            document.getElementById('camera-placeholder').innerHTML = `
                <div class="camera-placeholder-icon">üö´</div>
                <div style="color:#ef4444; font-weight:600;">${title}</div>
                <div style="font-size:12px; color:#888; margin-top:8px;">${message}</div>
                <button onclick="initCamera()" style="margin-top:16px; padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer;">üîÑ Retry</button>
            `;
        }
        
        function initKeyboard() {
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    capturePhoto();
                }
                if (e.key === '1') setMode('main');
                if (e.key === '2') setMode('closeup');
                if (e.key === '3') setMode('handheld');
            });
        }
        
        // ============================================
        // CAMERA
        // ============================================
        async function switchCamera(type, deviceId) {
            if (!deviceId) return;
            
            cameraIds[type] = deviceId;
            
            // If current mode matches camera type, switch to it
            if ((type === 'main' && (currentMode === 'main' || currentMode === 'closeup')) ||
                (type === 'handheld' && currentMode === 'handheld')) {
                await startCamera(deviceId);
            }
            
            document.getElementById('check-camera').textContent = '‚úì';
            document.getElementById('check-camera').classList.add('complete');
        }
        
        async function startCamera(deviceId) {
            if (!deviceId) return;
            
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(t => t.stop());
                }
                
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 3840 },
                        height: { ideal: 2160 }
                    }
                });
                
                activeCameraId = deviceId;
                
                const video = document.getElementById('camera-video');
                video.srcObject = currentStream;
                video.style.display = 'block';
                document.getElementById('camera-placeholder').style.display = 'none';
                document.getElementById('camera-status').style.display = 'block';
                
                video.onloadedmetadata = () => {
                    const w = video.videoWidth, h = video.videoHeight;
                    document.getElementById('camera-resolution').textContent = `${w}√ó${h}`;
                    document.getElementById('camera-resolution').style.color = w >= 3800 ? '#22c55e' : w >= 1900 ? '#3b82f6' : '#f59e0b';
                };
                
            } catch (err) {
                console.error('Camera error:', err);
                showToast('error', `Camera: ${err.message}`);
            }
        }
        
        async function forceMaxResolution() {
            if (!activeCameraId) {
                showToast('warning', 'Select a camera first');
                return;
            }
            
            try {
                if (currentStream) currentStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 300));
                
                let maxW = 1920, maxH = 1080;
                try {
                    const temp = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: activeCameraId } } });
                    const caps = temp.getVideoTracks()[0].getCapabilities();
                    if (caps.width?.max) maxW = caps.width.max;
                    if (caps.height?.max) maxH = caps.height.max;
                    temp.getTracks().forEach(t => t.stop());
                    await new Promise(r => setTimeout(r, 200));
                } catch(e) {}
                
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: activeCameraId }, width: { ideal: maxW }, height: { ideal: maxH } }
                });
                
                const video = document.getElementById('camera-video');
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    const w = video.videoWidth, h = video.videoHeight;
                    document.getElementById('camera-resolution').textContent = `${w}√ó${h}`;
                    showToast('success', `Max res: ${w}√ó${h}`);
                };
            } catch (err) {
                showToast('error', 'Failed to set max resolution');
            }
        }
        
        // ============================================
        // MODE
        // ============================================
        function setMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            const badge = document.getElementById('camera-mode-badge');
            badge.className = `camera-mode-badge ${mode}`;
            badge.textContent = mode.toUpperCase();
            
            // Switch camera based on mode
            if (mode === 'handheld' && cameraIds.handheld) {
                startCamera(cameraIds.handheld);
            } else if ((mode === 'main' || mode === 'closeup') && cameraIds.main) {
                startCamera(cameraIds.main);
            }
        }
        
        // ============================================
        // CAPTURE
        // ============================================
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            if (!video.srcObject) {
                showToast('warning', 'No camera active');
                return;
            }
            if (!currentSKU) {
                showToast('warning', 'Start an item first');
                return;
            }
            
            // Flash
            const flash = document.getElementById('flash-overlay');
            flash.classList.add('flash');
            setTimeout(() => flash.classList.remove('flash'), 100);
            
            // Capture
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const photo = {
                    id: Date.now(),
                    blob,
                    url: URL.createObjectURL(blob),
                    width: canvas.width,
                    height: canvas.height,
                    mode: currentMode,
                    timestamp: new Date().toISOString()
                };
                
                photos.push(photo);
                updateUI();
                showToast('success', `Captured (${currentMode})`);
                
            }, 'image/jpeg', 0.95);
        }
        
        // ============================================
        // ITEM MANAGEMENT
        // ============================================
        function startNewItem() {
            const input = document.getElementById('sku-input');
            const sku = input.value.trim().toUpperCase();
            
            if (!sku) {
                showToast('warning', 'Enter a SKU');
                return;
            }
            
            // Reset
            photos.forEach(p => URL.revokeObjectURL(p.url));
            photos = [];
            
            currentSKU = sku;
            itemStartTime = Date.now();
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            document.getElementById('sku-input-row').style.display = 'none';
            document.getElementById('sku-display').textContent = sku;
            document.getElementById('sku-display').classList.add('visible');
            document.getElementById('check-sku').textContent = '‚úì';
            document.getElementById('check-sku').classList.add('complete');
            
            updateUI();
            showToast('success', `Started: ${sku}`);
        }
        
        async function completeItem() {
            if (!currentSKU || photos.length === 0) return;
            
            showProcessing('Starting AI processing...', '', 0);
            
            try {
                const processed = [];
                
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    const progress = ((i + 1) / photos.length) * 100;
                    
                    setProcessing(`Processing photo ${i+1}/${photos.length}`, 'Classifying & cropping...', progress);
                    
                    // Process with AI
                    const result = await processPhotoWithAI(photo);
                    processed.push(result);
                    
                    // Update photo with AI results
                    photo.aiResult = result;
                }
                
                setProcessing('Finalizing...', 'Preparing downloads', 100);
                
                // Download processed photos
                await downloadProcessedPhotos(processed);
                
                // Update stats
                itemsToday++;
                localStorage.setItem('vl_items_today', itemsToday.toString());
                document.getElementById('stat-today').textContent = itemsToday;
                
                hideProcessing();
                showToast('success', `Complete: ${currentSKU} (${photos.length} photos)`);
                
                // Reset
                resetItem();
                
            } catch (err) {
                console.error('Complete error:', err);
                hideProcessing();
                showToast('error', `Error: ${err.message}`);
            }
        }
        
        async function processPhotoWithAI(photo) {
            // Convert blob to base64
            const base64 = await blobToBase64(photo.blob);
            
            // Try AI chain
            for (const ai of AI_ORDER) {
                if (ai === 'manual') {
                    // Manual fallback - return original with defaults
                    return {
                        success: false,
                        ai: 'manual',
                        classification: guessClassification(photo.mode),
                        processedBlob: photo.blob,
                        processedUrl: photo.url,
                        rotation: 0,
                        quality: 'unknown'
                    };
                }
                
                try {
                    updateAIBadge(ai);
                    const aiResult = await callLambdaAI(ai, base64, photo);
                    
                    if (aiResult.success) {
                        // Apply rotation and crop locally using Canvas
                        const processed = await applyRotationAndCrop(photo, aiResult);
                        
                        return {
                            ...aiResult,
                            processedBlob: processed.blob,
                            processedUrl: processed.url
                        };
                    }
                } catch (err) {
                    console.warn(`${ai} failed:`, err.message);
                }
            }
            
            // Should never reach here
            return { success: false, ai: 'manual', classification: 'unknown', processedBlob: photo.blob, processedUrl: photo.url };
        }
        
        async function applyRotationAndCrop(photo, aiResult) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const rotation = aiResult.rotation || 0;
                    const crop = aiResult.crop || { x: 0, y: 0, width: 100, height: 100 };
                    
                    // Create canvas for processing
                    let canvas = document.createElement('canvas');
                    let ctx = canvas.getContext('2d');
                    
                    // Step 1: Rotate if needed
                    if (rotation !== 0) {
                        const radians = (rotation * Math.PI) / 180;
                        
                        // Calculate new dimensions after rotation
                        const sin = Math.abs(Math.sin(radians));
                        const cos = Math.abs(Math.cos(radians));
                        const newW = img.width * cos + img.height * sin;
                        const newH = img.width * sin + img.height * cos;
                        
                        canvas.width = newW;
                        canvas.height = newH;
                        
                        ctx.translate(newW / 2, newH / 2);
                        ctx.rotate(radians);
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                    }
                    
                    // Step 2: Crop based on AI bounding box
                    const cropX = Math.round((crop.x / 100) * canvas.width);
                    const cropY = Math.round((crop.y / 100) * canvas.height);
                    const cropW = Math.round((crop.width / 100) * canvas.width);
                    const cropH = Math.round((crop.height / 100) * canvas.height);
                    
                    // Create final cropped canvas
                    const finalCanvas = document.createElement('canvas');
                    const finalCtx = finalCanvas.getContext('2d');
                    finalCanvas.width = cropW;
                    finalCanvas.height = cropH;
                    
                    finalCtx.drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
                    
                    // Convert to blob
                    finalCanvas.toBlob(blob => {
                        resolve({
                            blob,
                            url: URL.createObjectURL(blob),
                            width: cropW,
                            height: cropH
                        });
                    }, 'image/jpeg', 0.95);
                };
                img.src = photo.url;
            });
        }
        
        async function callLambdaAI(aiProvider, base64, photo) {
            const response = await fetch(LAMBDA_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'process_photo',
                    provider: aiProvider,
                    image: base64,
                    mode: photo.mode,
                    sku: currentSKU
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            return {
                success: true,
                ai: aiProvider,
                classification: data.classification, // main_flat, main_tpose, tag, weight, defect, etc.
                croppedImage: data.croppedImage, // base64 of cropped image
                rotation: data.rotation || 0,
                quality: data.quality || 'good', // good, blurry, dark
                confidence: data.confidence || 0.8
            };
        }
        
        function guessClassification(mode) {
            // Simple fallback classification based on capture mode
            const map = {
                main: 'main',
                closeup: 'detail',
                handheld: 'other'
            };
            return map[mode] || 'other';
        }
        
        function updateAIBadge(activeAI) {
            document.querySelectorAll('.ai-badge').forEach(badge => {
                badge.classList.toggle('active', badge.classList.contains(activeAI));
            });
        }
        
        async function downloadProcessedPhotos(processed) {
            // Group by classification
            const grouped = {};
            processed.forEach((p, i) => {
                const type = p.classification || 'other';
                // Simplify classification for filename
                const simpleType = type.split('_')[0]; // main_flat_front -> main
                if (!grouped[simpleType]) grouped[simpleType] = [];
                grouped[simpleType].push(p);
            });
            
            // Download each
            for (const [type, items] of Object.entries(grouped)) {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const filename = `${currentSKU}_${type}_${String(i+1).padStart(2,'0')}.jpg`;
                    
                    // Use processed blob (rotated + cropped)
                    if (item.processedBlob) {
                        downloadBlob(item.processedBlob, filename);
                    } else if (item.processedUrl) {
                        // Fetch URL and download
                        const response = await fetch(item.processedUrl);
                        const blob = await response.blob();
                        downloadBlob(blob, filename);
                    }
                    
                    await new Promise(r => setTimeout(r, 150));
                }
            }
            
            // Show summary
            const summary = Object.entries(grouped).map(([k, v]) => `${v.length} ${k}`).join(', ');
            console.log(`üì¶ Downloaded: ${summary}`);
        }
        
        function downloadBase64(base64, filename) {
            const a = document.createElement('a');
            a.href = `data:image/jpeg;base64,${base64}`;
            a.download = filename;
            a.click();
        }
        
        function downloadBlob(blob, filename) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        function resetItem() {
            photos.forEach(p => URL.revokeObjectURL(p.url));
            photos = [];
            currentSKU = '';
            itemStartTime = null;
            
            if (timerInterval) clearInterval(timerInterval);
            
            document.getElementById('sku-input').value = '';
            document.getElementById('sku-input-row').style.display = 'flex';
            document.getElementById('sku-display').classList.remove('visible');
            document.getElementById('check-sku').textContent = '‚óã';
            document.getElementById('check-sku').classList.remove('complete');
            document.getElementById('timer-display').textContent = '0:00';
            
            updateUI();
        }
        
        // ============================================
        // UI
        // ============================================
        function updateUI() {
            // Counts by mode
            const counts = { main: 0, closeup: 0, handheld: 0 };
            photos.forEach(p => counts[p.mode]++);
            
            document.getElementById('count-main').textContent = counts.main;
            document.getElementById('count-closeup').textContent = counts.closeup;
            document.getElementById('count-handheld').textContent = counts.handheld;
            document.getElementById('total-count').textContent = photos.length;
            
            // Photo grid
            const grid = document.getElementById('photos-grid');
            grid.innerHTML = '';
            
            photos.forEach((photo, i) => {
                const thumb = document.createElement('div');
                thumb.className = 'photo-thumb';
                thumb.innerHTML = `
                    <img src="${photo.url}">
                    <div class="photo-label">${photo.mode.toUpperCase()}</div>
                    <button class="delete-btn" onclick="deletePhoto(${i})">√ó</button>
                `;
                grid.appendChild(thumb);
            });
            
            // Complete button
            document.getElementById('complete-btn').disabled = !currentSKU || photos.length === 0;
        }
        
        function deletePhoto(index) {
            URL.revokeObjectURL(photos[index].url);
            photos.splice(index, 1);
            updateUI();
        }
        
        function updateTimer() {
            if (!itemStartTime) return;
            const elapsed = Math.floor((Date.now() - itemStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('timer-display').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // ============================================
        // TOAST / PROCESSING
        // ============================================
        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const icons = { success: '‚úì', error: '‚úó', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span class="toast-message">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showProcessing(text, subtext, progress) {
            document.getElementById('processing-text').textContent = text;
            document.getElementById('processing-subtext').textContent = subtext || '';
            document.getElementById('processing-progress').style.width = `${progress || 0}%`;
            document.getElementById('processing-overlay').classList.add('active');
        }
        
        function setProcessing(text, subtext, progress) {
            document.getElementById('processing-text').textContent = text;
            document.getElementById('processing-subtext').textContent = subtext || '';
            document.getElementById('processing-progress').style.width = `${progress || 0}%`;
        }
        
        function hideProcessing() {
            document.getElementById('processing-overlay').classList.remove('active');
        }
    </script>
</body>
</html>

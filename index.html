<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VintageLister v75.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; min-height: 100vh; }
        .step-container { display: none; }
        .step-container.active { display: block; }
        
        .progress-dot { width: 12px; height: 12px; border-radius: 50%; transition: all 0.3s; }
        .progress-dot.completed { background: #22c55e; }
        .progress-dot.current { background: #3b82f6; transform: scale(1.3); }
        .progress-dot.pending { background: #d1d5db; }
        .progress-line { height: 2px; flex: 1; }
        .progress-line.completed { background: #22c55e; }
        .progress-line.pending { background: #d1d5db; }
        
        .check-circle { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; transition: all 0.2s; color: #d1d5db; }
        .check-circle.complete { background: #22c55e; border-color: #22c55e; color: white; }
        
        .section-card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; }
        
        .btn-select { transition: all 0.15s; }
        .btn-select.selected { background: #3b82f6 !important; color: white !important; border-color: #2563eb !important; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }
        .size-btn.selected { background: #3b82f6 !important; color: white !important; border-color: #2563eb !important; }
        
        .defect-stain { background: #fef9c3; color: #854d0e; border: 2px solid #facc15; }
        .defect-hole { background: #fee2e2; color: #991b1b; border: 2px solid #f87171; }
        .defect-repair { background: #dbeafe; color: #1e40af; border: 2px solid #60a5fa; }
        .defect-other { background: #f3e8ff; color: #6b21a8; border: 2px solid #c084fc; }
        
        .zone-hit { cursor: pointer; fill: rgba(100,116,139,0.15); stroke: rgba(100,116,139,0.3); stroke-width: 1px; transition: all 0.1s; }
        .zone-hit:active { fill: rgba(59,130,246,0.5) !important; }
        .map-wrapper { position: relative; width: 100%; touch-action: manipulation; }
        
        .defect-marker { position: absolute; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; transform: translate(-50%,-50%); z-index: 30; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: 2px solid white; animation: pop-in 0.2s ease-out; cursor: pointer; }
        @keyframes pop-in { from { transform: translate(-50%,-50%) scale(0); } to { transform: translate(-50%,-50%) scale(1); } }
        .defect-marker.stain { background: #facc15; color: #713f12; }
        .defect-marker.hole { background: #f87171; color: white; }
        .defect-marker.repair { background: #60a5fa; color: white; }
        .defect-marker.other { background: #c084fc; color: white; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { box-shadow: 0 0 0 15px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
        .recording { animation: pulse-red 1.5s infinite; background: #dc2626 !important; }
        
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.25s cubic-bezier(0.16,1,0.3,1); }
        
        #reader video { object-fit: cover; border-radius: 0.75rem; }
        
        .photo-btn.captured { background: #dcfce7 !important; border-color: #22c55e !important; border-style: solid !important; }
        .photo-btn.captured::after { content: '‚úì'; position: absolute; top: 4px; right: 4px; background: #22c55e; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        
        .flag-btn { background: linear-gradient(135deg,#fef3c7 0%,#fde68a 100%); border: 2px dashed #d97706; }
        .flag-btn.flagged { background: linear-gradient(135deg,#fde68a 0%,#fbbf24 100%); border: 2px solid #b45309; }
        
        .card-green { border-left: 4px solid #22c55e; background: #f0fdf4; }
        .card-yellow { border-left: 4px solid #eab308; background: #fefce8; }
        
        /* Camera overlay */
        #camera-overlay { position: fixed; inset: 0; z-index: 100; background: black; }
        #camera-overlay video { width: 100%; height: 100%; object-fit: cover; }
        .cam-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.5); }
        .shutter-btn:active { transform: scale(0.9); }
        
        /* Defect photo list */
        .defect-photo-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 10px; }
        .defect-photo-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="pb-24">

    <!-- HEADER -->
    <div class="sticky top-0 z-50 bg-white border-b border-gray-200 px-4 py-3 shadow-sm">
        <div class="flex items-center justify-between mb-2">
            <span class="text-gray-800 font-bold text-base">Vintage<span class="text-blue-600">Lister</span></span>
            <span class="text-gray-400 text-xs">v75.3</span>
        </div>
        <div class="flex items-center gap-1 mb-1">
            <div id="dot-1" class="progress-dot current"></div>
            <div id="line-1" class="progress-line pending"></div>
            <div id="dot-2" class="progress-dot pending"></div>
            <div id="line-2" class="progress-line pending"></div>
            <div id="dot-3" class="progress-dot pending"></div>
            <div id="line-3" class="progress-line pending"></div>
            <div id="dot-4" class="progress-dot pending"></div>
        </div>
        <div id="step-label" class="text-center text-gray-600 text-xs font-medium">STEP 1: IDENTIFY</div>
    </div>

    <!-- ========== STEP 1: IDENTIFY ========== -->
    <div id="step-1" class="step-container active p-4 space-y-4">
        
        <!-- CATEGORY -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-category" class="check-circle">‚óã</span>
                1. Category
            </label>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <button onclick="setSuperCategory('tops', this)" class="btn-select super-btn py-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-gray-700 text-sm">üëï Tops</button>
                <button onclick="setSuperCategory('bottoms', this)" class="btn-select super-btn py-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-gray-700 text-sm">üëñ Bottoms</button>
                <button onclick="setSuperCategory('outer', this)" class="btn-select super-btn py-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-gray-700 text-sm">üß• Outer</button>
            </div>
            <select id="cat-select" onchange="onCategoryChange()" class="w-full p-3 border-2 border-blue-100 bg-blue-50/50 rounded-xl text-sm font-bold outline-none focus:border-blue-500 text-gray-800 hidden"></select>
        </div>
        
        <!-- SKU -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-2">
                <span id="check-sku" class="check-circle">‚óã</span>
                2. SKU
            </label>
            <div class="flex gap-2">
                <input type="number" id="sku-input" inputmode="numeric" placeholder="Scan SKU" oninput="onSkuInput()" onkeydown="if(event.key==='Enter')this.blur();" class="w-full text-3xl font-mono p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-300">
                <button onclick="toggleScanner()" class="bg-gray-900 text-white p-3 rounded-xl flex-shrink-0 active:scale-95 shadow-lg">
                    <i data-lucide="scan-barcode" class="w-8 h-8"></i>
                </button>
            </div>
            <div id="scanner-view" class="hidden mt-3 rounded-xl overflow-hidden border-4 border-gray-900 relative bg-black h-56">
                <div id="reader" class="w-full h-full"></div>
                <button onclick="toggleScanner()" class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded shadow">CLOSE</button>
            </div>
        </div>
        
        <!-- TAG STATUS -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-tag" class="check-circle">‚óã</span>
                3. Tag Info
            </label>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <button onclick="setTagStatus('has', this)" class="btn-select tag-status-btn py-4 border-2 border-dashed border-sky-300 bg-sky-50 text-sky-600 rounded-xl font-bold text-xs">‚úì Readable</button>
                <button onclick="setTagStatus('worn', this)" class="btn-select tag-status-btn py-4 border border-gray-200 bg-white rounded-xl font-bold text-gray-400 text-xs">üëÄ Worn</button>
                <button onclick="setTagStatus('none', this)" class="btn-select tag-status-btn py-4 border border-gray-200 bg-white rounded-xl font-bold text-gray-400 text-xs">‚úÇÔ∏è Missing</button>
            </div>
            
            <!-- TAG SIZE -->
            <div id="tag-size-section" class="hidden bg-amber-50 p-3 rounded-xl border border-amber-200 mb-3">
                <label class="text-[10px] font-bold text-amber-700 uppercase tracking-widest mb-2 block">Tag Reads</label>
                <div class="grid grid-cols-6 gap-1 mb-2">
                    <button onclick="setTagSize('XS', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">XS</button>
                    <button onclick="setTagSize('S', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">S</button>
                    <button onclick="setTagSize('M', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">M</button>
                    <button onclick="setTagSize('L', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">L</button>
                    <button onclick="setTagSize('XL', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">XL</button>
                    <button onclick="setTagSize('XXL', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">XXL</button>
                </div>
                <input type="text" id="tag-size-input" placeholder="Or type (e.g. 42R, 32x30)" onfocus="clearSizeBtns()" oninput="onCustomSizeInput()" class="w-full p-2 border border-gray-200 rounded-lg text-sm text-center outline-none bg-white">
            </div>
            
            <!-- ORIGIN -->
            <div id="origin-section" class="hidden mb-3">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="setOrigin('usa', this)" class="btn-select origin-btn py-3 border border-gray-200 rounded-xl font-bold text-gray-500 text-xs flex items-center justify-center gap-2"><span class="text-base">üá∫üá∏</span> USA Made</button>
                    <button onclick="setOrigin('import', this)" class="btn-select origin-btn py-3 border border-gray-200 rounded-xl font-bold text-gray-500 text-xs flex items-center justify-center gap-2"><span class="text-base">üåç</span> Import</button>
                </div>
                <select id="country-select" onchange="data.madeInCountry=this.value" class="hidden w-full p-2 border border-gray-200 rounded-xl text-gray-800 outline-none text-[11px]">
                    <option value="" disabled selected>Select Country...</option>
                    <option>Bangladesh</option><option>Cambodia</option><option>Canada</option><option>China</option><option>Honduras</option><option>India</option><option>Indonesia</option><option>Italy</option><option>Japan</option><option>Mexico</option><option>Pakistan</option><option>Philippines</option><option>Portugal</option><option>South Korea</option><option>Sri Lanka</option><option>Taiwan</option><option>Turkey</option><option>United Kingdom</option><option>Vietnam</option><option>Other / Unknown</option>
                </select>
            </div>
            
            <!-- COPYRIGHT -->
            <div id="copyright-section" class="hidden mb-3">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Copyright Year (Optional)</label>
                <input type="tel" id="copyright-year" placeholder="YYYY (e.g. 1994)" oninput="data.copyrightYear=this.value" class="w-full p-2 border border-gray-200 rounded-xl text-sm text-center outline-none" maxlength="4">
            </div>
            
            <!-- TAG GENDER -->
            <div id="tag-gender-section" class="hidden">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block">Tag Gender</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setGender('Men', this)" class="btn-select gender-btn py-2 bg-white border border-gray-200 rounded-lg font-bold text-gray-600 text-xs">Men's</button>
                    <button onclick="setGender('Women', this)" class="btn-select gender-btn py-2 bg-white border border-gray-200 rounded-lg font-bold text-gray-600 text-xs">Women's</button>
                    <button onclick="setGender('Unisex', this)" class="btn-select gender-btn py-2 bg-white border border-gray-200 rounded-lg font-bold text-gray-600 text-xs">Unisex</button>
                    <button onclick="setGender('None', this)" class="btn-select gender-btn py-2 bg-white border border-gray-200 rounded-lg font-bold text-gray-600 text-xs">None</button>
                </div>
            </div>
        </div>
        
        <!-- COLORS -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-color" class="check-circle">‚óã</span>
                4. Colors
            </label>
            <div class="mb-3">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Primary Color</label>
                <select id="color-primary" onchange="data.colorPrimary=this.value; updateAllChecks();" class="w-full p-2 border border-gray-300 rounded-xl text-gray-800 outline-none text-[11px]">
                    <option value="" disabled selected>Select Color...</option>
                    <option>Beige</option><option>Black</option><option>Blue</option><option>Brown</option><option>Gold</option><option>Gray</option><option>Green</option><option>Ivory</option><option>Orange</option><option>Pink</option><option>Purple</option><option>Red</option><option>Silver</option><option>White</option><option>Yellow</option><option>Multicolor</option>
                </select>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Secondary Color <span class="text-gray-300">(optional)</span></label>
                <select id="color-secondary" onchange="data.colorSecondary=this.value" class="w-full p-2 border border-gray-200 rounded-xl text-gray-800 outline-none text-[11px]">
                    <option value="" selected>None / N/A</option>
                    <option>Beige</option><option>Black</option><option>Blue</option><option>Brown</option><option>Gold</option><option>Gray</option><option>Green</option><option>Ivory</option><option>Orange</option><option>Pink</option><option>Purple</option><option>Red</option><option>Silver</option><option>White</option><option>Yellow</option><option>Multicolor</option>
                </select>
            </div>
        </div>
        
        <!-- SLEEVE -->
        <div id="sleeve-section" class="section-card p-4 hidden">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-sleeve" class="check-circle">‚óã</span>
                5. Sleeve Length
            </label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setSleeve('Short', this)" class="btn-select sleeve-btn py-3 border-2 border-dashed border-blue-300 bg-blue-50 rounded-xl font-bold text-blue-600 text-xs">Short Sleeve</button>
                <button onclick="setSleeve('Long', this)" class="btn-select sleeve-btn py-3 border border-gray-200 bg-white rounded-xl font-bold text-gray-500 text-xs">Long Sleeve</button>
                <button onclick="setSleeve('3/4', this)" class="btn-select sleeve-btn py-3 border border-gray-200 bg-white rounded-xl font-bold text-gray-500 text-xs">3/4 Sleeve</button>
                <button onclick="setSleeve('Sleeveless', this)" class="btn-select sleeve-btn py-3 border border-gray-200 bg-white rounded-xl font-bold text-gray-500 text-xs">Sleeveless</button>
            </div>
            <div id="cutoff-section" class="hidden mt-3">
                <label class="text-xs font-bold text-orange-600 uppercase tracking-wide">üî™ Cut-off / Muscle Tee?</label>
                <div class="mt-2 p-3 bg-orange-50 rounded-xl border border-orange-200">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setCutOff(true, this)" class="btn-select cutoff-btn py-3 border-2 border-gray-200 rounded-xl font-bold text-gray-600 text-xs bg-white flex flex-col items-center">
                            <span class="text-lg">‚úÇÔ∏è</span><span>DIY Cut-off</span>
                        </button>
                        <button onclick="setCutOff(false, this)" class="btn-select cutoff-btn py-3 border-2 border-gray-200 rounded-xl font-bold text-gray-600 text-xs bg-white flex flex-col items-center">
                            <span class="text-lg">üëï</span><span>Manufactured</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FABRIC FEEL -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-teal-600 uppercase tracking-wide mb-2 block">üìê Fabric Feel</label>
            <p class="text-[10px] text-gray-400 mb-3">You're already holding it ‚Äî feel the fabric!</p>
            <div class="mb-3">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block">Thickness</label>
                <div class="grid grid-cols-4 gap-1">
                    <button onclick="setThickness('Paper', this)" class="btn-select thickness-btn py-2 border border-gray-200 rounded-lg font-bold text-gray-500 text-[9px] bg-white flex flex-col items-center"><span>Paper</span><span class="text-[8px] text-gray-400">see-thru</span></button>
                    <button onclick="setThickness('Light', this)" class="btn-select thickness-btn py-2 border border-gray-200 rounded-lg font-bold text-gray-500 text-[9px] bg-white flex flex-col items-center"><span>Light</span><span class="text-[8px] text-gray-400">50/50</span></button>
                    <button onclick="setThickness('Standard', this)" class="btn-select thickness-btn py-2 border border-gray-200 rounded-lg font-bold text-gray-500 text-[9px] bg-white flex flex-col items-center"><span>Standard</span><span class="text-[8px] text-gray-400">Gildan</span></button>
                    <button onclick="setThickness('Heavy', this)" class="btn-select thickness-btn py-2 border border-gray-200 rounded-lg font-bold text-gray-500 text-[9px] bg-white flex flex-col items-center"><span>Heavy</span><span class="text-[8px] text-gray-400">Beefy</span></button>
                </div>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block">Texture</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setTexture('Stiff', this)" class="btn-select texture-btn py-2 border border-gray-200 rounded-lg font-bold text-gray-500 text-xs bg-white">Stiff / Crisp</button>
                    <button onclick="setTexture('Soft', this)" class="btn-select texture-btn py-2 border border-gray-200 rounded-lg font-bold text-gray-500 text-xs bg-white">Soft / Broken-In</button>
                </div>
            </div>
        </div>
        
        <button onclick="goToStep(2)" class="w-full py-4 bg-blue-600 rounded-2xl text-white font-bold flex items-center justify-center gap-2 shadow-lg active:scale-[0.98]">
            Next: INSPECT ‚Üí
        </button>
    </div>

    <!-- ========== STEP 2: INSPECT (Quick assessment only) ========== -->
    <div id="step-2" class="step-container p-4 space-y-4">
        
        <!-- CONDITION -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-condition" class="check-circle">‚óã</span>
                Condition Check
            </label>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="setCondition('none', this)" class="btn-select condition-btn py-5 bg-green-50 border-2 border-green-200 rounded-xl font-bold text-green-700 text-sm flex flex-col items-center gap-1">
                    <span class="text-3xl">‚úì</span><span>No Flaws</span>
                </button>
                <button onclick="setCondition('found', this)" class="btn-select condition-btn py-5 bg-gray-50 border-2 border-gray-200 rounded-xl font-bold text-gray-600 text-sm flex flex-col items-center gap-1">
                    <span class="text-3xl">‚ö†Ô∏è</span><span>Found Issues</span>
                </button>
            </div>
            <p id="defect-hint" class="hidden text-[10px] text-orange-600 text-center mt-3 font-medium">üì∏ You'll mark & photograph defects in the next step</p>
        </div>
        
        <!-- FADE -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-fade" class="check-circle">‚óã</span>
                Fade Level
            </label>
            <div class="grid grid-cols-4 gap-2">
                <button onclick="setFade('None', this)" class="btn-select fade-btn py-3 bg-white border border-gray-200 rounded-xl font-bold text-gray-600 text-xs">None</button>
                <button onclick="setFade('Light', this)" class="btn-select fade-btn py-3 bg-white border border-gray-200 rounded-xl font-bold text-gray-600 text-xs">Light</button>
                <button onclick="setFade('Sun', this)" class="btn-select fade-btn py-3 bg-amber-50 border border-amber-300 rounded-xl font-bold text-amber-700 text-xs">Sun ‚≠ê</button>
                <button onclick="setFade('Heavy', this)" class="btn-select fade-btn py-3 bg-white border border-gray-200 rounded-xl font-bold text-gray-600 text-xs">Heavy</button>
            </div>
        </div>
        
        <!-- VISUAL TAG AUDIT -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3 block">Visual Tag Audit</label>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setAudit('True', this)" class="btn-select audit-btn py-3 bg-green-50 border border-green-200 rounded-xl font-bold text-green-700 text-xs">True to Size ‚úì</button>
                <button onclick="setAudit('Small', this)" class="btn-select audit-btn py-3 bg-amber-50 border border-amber-200 rounded-xl font-bold text-amber-700 text-xs">Runs Small</button>
                <button onclick="setAudit('Big', this)" class="btn-select audit-btn py-3 bg-amber-50 border border-amber-200 rounded-xl font-bold text-amber-700 text-xs">Runs Big</button>
            </div>
        </div>
        
        <!-- FLAG -->
        <button id="flag-btn" onclick="flagUnusual()" class="flag-btn w-full py-4 rounded-2xl text-amber-800 font-bold">
            <div class="flex items-center justify-center gap-2 text-lg">ü§î THIS SEEMS UNUSUAL</div>
            <div class="text-xs font-normal mt-1 opacity-70">Brand you don't recognize ‚Ä¢ Special construction</div>
        </button>
        
        <div class="flex gap-3">
            <button onclick="goToStep(1)" class="flex-1 py-4 bg-gray-200 rounded-2xl text-gray-700 font-bold active:scale-[0.98]">‚Üê Back</button>
            <button onclick="goToStep(3)" class="flex-[2] py-4 bg-blue-600 rounded-2xl text-white font-bold shadow-lg active:scale-[0.98]">Next: DOCUMENT ‚Üí</button>
        </div>
    </div>

    <!-- ========== STEP 3: DOCUMENT (ALL photos here) ========== -->
    <div id="step-3" class="step-container p-4 space-y-4">
        
        <!-- ITEM PHOTOS -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-photos" class="check-circle">‚óã</span>
                üì∏ Item Photos
            </label>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <button onclick="openCamera('front')" id="photo-front" class="photo-btn relative py-5 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-xs flex flex-col items-center gap-1">üì∑ Full Front</button>
                <button onclick="openCamera('back')" id="photo-back" class="photo-btn relative py-5 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-xs flex flex-col items-center gap-1">üì∑ Full Back</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="openCamera('brandTag')" id="photo-brandTag" class="photo-btn relative py-4 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-[10px] flex flex-col items-center">üì∑ Brand Tag</button>
                <button onclick="openCamera('careLabel')" id="photo-careLabel" class="photo-btn relative py-4 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-[10px] flex flex-col items-center">üì∑ Care Label</button>
            </div>
        </div>
        
        <!-- DEFECT MAPPING (only shows if hasDefects) -->
        <div id="defect-section" class="section-card p-4 hidden">
            <label class="text-xs font-bold text-orange-600 uppercase tracking-wide mb-2 block">
                üîç Defect Photos ‚Äî Tap location ‚Üí Select type ‚Üí Snap photo
            </label>
            <div class="flex gap-1 mb-3 justify-center text-[10px] text-gray-500">
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-400"></span>Stain</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-400"></span>Hole</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-400"></span>Repair</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-400"></span>Other</span>
            </div>
            
            <!-- Body Maps -->
            <div class="mb-3">
                <div class="text-center text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 bg-gray-100 rounded py-1">FRONT</div>
                <div id="defect-map-front" class="map-wrapper bg-slate-100 rounded-xl p-2 relative" style="min-height:180px;"><div id="defect-svg-front"></div><div id="defect-markers-front"></div></div>
            </div>
            <div class="mb-3">
                <div class="text-center text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 bg-gray-100 rounded py-1">BACK</div>
                <div id="defect-map-back" class="map-wrapper bg-slate-100 rounded-xl p-2 relative" style="min-height:180px;"><div id="defect-svg-back"></div><div id="defect-markers-back"></div></div>
            </div>
            
            <!-- Defect Photo List -->
            <div id="defect-list" class="space-y-2">
                <p class="text-gray-400 text-xs text-center py-2">Tap on the body map above to mark defects</p>
            </div>
        </div>
        
        <!-- FEATURE PHOTOS -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3 block">üì∏ Feature Photos</label>
            <div id="features-grid" class="grid grid-cols-3 gap-2"></div>
        </div>
        
        <!-- MEASUREMENTS -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-3">
                <span id="check-measure" class="check-circle">‚óã</span>
                üé§ Measurements
            </label>
            <div id="measure-hint" class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4 text-gray-700 text-xs"></div>
            <div id="record-section">
                <button id="record-btn" onclick="toggleRecording()" class="w-full py-5 bg-red-500 rounded-2xl text-white font-bold text-lg flex flex-col items-center gap-2 shadow-lg active:scale-[0.98]">
                    <span class="text-2xl">üé§</span><span>TAP TO RECORD</span>
                </button>
            </div>
            <div id="post-record-section" class="hidden">
                <div class="bg-green-50 border border-green-300 rounded-xl p-4 mb-3">
                    <div class="text-green-700 font-bold mb-1">‚úì RECORDING SAVED</div>
                    <div class="text-green-600 text-sm">Duration: <span id="recording-duration">0:00</span></div>
                </div>
                <button onclick="reRecord()" class="text-gray-500 text-sm underline">Re-record</button>
            </div>
        </div>
        
        <!-- WEIGHT -->
        <div class="section-card p-4">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2 mb-2">
                <span id="check-weight" class="check-circle">‚óã</span>
                ‚öñÔ∏è Weight
            </label>
            <div id="weight-hint" class="mb-3 p-2 bg-purple-50 rounded-lg border border-purple-100">
                <p class="text-[10px] text-purple-600 font-medium text-center">üí° Select category for weight hint</p>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Pounds</label>
                    <select id="weight-lb" onchange="updateWeight()" class="w-full p-3 border border-gray-300 rounded-xl font-bold text-gray-800 text-sm bg-white">
                        <option value="0" selected>0 lb</option><option value="1">1 lb</option><option value="2">2 lb</option><option value="3">3 lb</option><option value="4">4 lb</option><option value="5">5 lb</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Ounces</label>
                    <select id="weight-oz" onchange="updateWeight()" class="w-full p-3 border border-gray-300 rounded-xl font-bold text-gray-800 text-sm bg-white">
                        <option value="0" selected>0 oz</option><option value="1">1 oz</option><option value="2">2 oz</option><option value="3">3 oz</option><option value="4">4 oz</option><option value="5">5 oz</option><option value="6">6 oz</option><option value="7">7 oz</option><option value="8">8 oz</option><option value="9">9 oz</option><option value="10">10 oz</option><option value="11">11 oz</option><option value="12">12 oz</option><option value="13">13 oz</option><option value="14">14 oz</option><option value="15">15 oz</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="goToStep(2)" class="flex-1 py-4 bg-gray-200 rounded-2xl text-gray-700 font-bold active:scale-[0.98]">‚Üê Back</button>
            <button onclick="goToStep(4)" class="flex-[2] py-4 bg-blue-600 rounded-2xl text-white font-bold shadow-lg active:scale-[0.98]">Next: REVIEW ‚Üí</button>
        </div>
    </div>

    <!-- ========== STEP 4: REVIEW ========== -->
    <div id="step-4" class="step-container p-4 space-y-4">
        <div class="text-gray-800 font-bold text-lg text-center mb-2">REVIEW BEFORE SUBMIT</div>
        <div class="grid grid-cols-2 gap-3">
            <div id="card-identify" onclick="goToStep(1)" class="card-yellow rounded-xl p-3 cursor-pointer">
                <div class="flex items-center gap-2 mb-1"><span id="icon-identify">üü°</span><span class="font-bold text-sm">IDENTIFY</span></div>
                <div id="summary-identify" class="text-gray-600 text-xs"></div>
            </div>
            <div id="card-inspect" onclick="goToStep(2)" class="card-yellow rounded-xl p-3 cursor-pointer">
                <div class="flex items-center gap-2 mb-1"><span id="icon-inspect">üü°</span><span class="font-bold text-sm">INSPECT</span></div>
                <div id="summary-inspect" class="text-gray-600 text-xs"></div>
            </div>
            <div id="card-document" onclick="goToStep(3)" class="card-yellow rounded-xl p-3 cursor-pointer">
                <div class="flex items-center gap-2 mb-1"><span id="icon-document">üü°</span><span class="font-bold text-sm">DOCUMENT</span></div>
                <div id="summary-document" class="text-gray-600 text-xs"></div>
            </div>
            <div id="card-ready" class="card-yellow rounded-xl p-3">
                <div class="flex items-center gap-2 mb-1"><span id="icon-ready">üü°</span><span class="font-bold text-sm">READY</span></div>
                <div id="summary-ready" class="text-gray-600 text-xs"></div>
            </div>
        </div>
        <div id="flag-status" class="hidden bg-amber-50 border border-amber-400 rounded-xl p-3 text-amber-700 text-sm font-medium">‚úì FLAGGED FOR SPECIALIST REVIEW</div>
        <button onclick="submitListing()" class="w-full py-5 bg-green-600 rounded-2xl text-white font-bold text-xl shadow-xl active:scale-[0.98]">PROCESS LISTING ‚úì</button>
        <button onclick="goToStep(3)" class="w-full py-3 bg-gray-200 rounded-2xl text-gray-600 font-medium">‚Üê Back</button>
    </div>

    <!-- DEFECT TYPE MODAL -->
    <div id="defect-modal" class="fixed inset-0 z-[70] bg-black/80 hidden flex items-end justify-center p-4" onclick="closeDefectModal(event)">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 pb-6 animate-slide-up" onclick="event.stopPropagation()">
            <div class="text-center mb-4">
                <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase mb-1">SELECT DEFECT TYPE</p>
                <h3 id="zone-label" class="text-lg font-black text-gray-800"></h3>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectDefectType('Stain')" class="defect-stain py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center"><span class="text-lg">STAIN</span><span class="text-[10px] opacity-70">‚òùÔ∏è 1 Finger</span></button>
                <button onclick="selectDefectType('Hole')" class="defect-hole py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center"><span class="text-lg">HOLE</span><span class="text-[10px] opacity-70">‚úåÔ∏è 2 Fingers</span></button>
                <button onclick="selectDefectType('Repair')" class="defect-repair py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center"><span class="text-lg">REPAIR</span><span class="text-[10px] opacity-70">ü§ü 3 Fingers</span></button>
                <button onclick="selectDefectType('Other')" class="defect-other py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center"><span class="text-lg">OTHER</span><span class="text-[10px] opacity-70">üññ 4 Fingers</span></button>
            </div>
        </div>
    </div>

    <!-- CAMERA OVERLAY -->
    <div id="camera-overlay" class="hidden">
        <video id="cam-feed" autoplay playsinline></video>
        <div class="cam-controls">
            <div class="text-center mb-3">
                <span id="cam-mode-label" class="text-white font-bold text-sm bg-black/50 px-3 py-1 rounded-full"></span>
            </div>
            <div class="flex items-center justify-center gap-6">
                <button onclick="closeCamera()" class="text-white text-3xl">‚úï</button>
                <button onclick="capturePhoto()" class="shutter-btn"></button>
                <div class="w-10"></div>
            </div>
        </div>
    </div>

    <canvas id="photo-canvas" class="hidden"></canvas>

    <script>
        let currentStep = 1, pendingDefect = null, qrScanner = null, mediaRecorder = null, audioChunks = [], isRecording = false, recordingStart = null;
        let cameraStream = null, cameraMode = null;

        const data = {
            superCategory: '', category: '', sku: '',
            tagStatus: '', tagSize: '', gender: '',
            origin: 'usa', madeInCountry: 'USA', copyrightYear: '',
            colorPrimary: '', colorSecondary: '',
            sleeveType: '', isCutOff: null,
            thickness: '', texture: '',
            condition: '', defects: [], fadeLevel: '', visualAudit: '',
            flagged: false,
            photos: { front: null, back: null, brandTag: null, careLabel: null, features: {} },
            audioBlob: null, audioDuration: 0,
            weightLb: 0, weightOz: 0, weightTotalOz: 0,
            timestamps: {}
        };

        const categoryOptions = { tops: ['T-Shirt','Tank Top','Polo','Button Shirt','Sweatshirt','Hoodie','Sweater','Blouse','Jersey'], bottoms: ['Jeans','Pants','Shorts','Sweatpants','Skirt'], outer: ['Jacket','Coat','Vest','Cardigan'] };
        const featuresMap = { "T-Shirt":["Copyright","Hem Stitch","Sleeve Stitch"], "Jeans":["Hem/Selvage","Inside Tag","Red Tab"], "Sweatshirt":["V-Stitch","Cuff Rib"], "Hoodie":["Drawstrings","Hood"], "Jacket":["Zipper","Lining"], "default":["Logo","Detail"] };
        const measureMap = { tops:["SHOULDER","PIT TO PIT","WAIST","LENGTH","SLEEVE"], bottoms:["WAIST","INSEAM","RISE","LEG OPENING"], outer:["SHOULDER","PIT TO PIT","LENGTH","SLEEVE"] };
        const weightHints = { 'T-Shirt':'üí° T-Shirts: 4-8 oz', 'Sweatshirt':'üí° Sweatshirts: 12-20 oz', 'Hoodie':'üí° Hoodies: 1-1.5 lbs', 'Jeans':'üí° Jeans: 1-1.5 lbs', 'Jacket':'üí° Jackets: 1-2 lbs' };

        const SVG_TOP_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#334155" rx="6"/><rect x="69" y="139" width="141" height="141" fill="#334155" rx="6"/><rect x="558" y="139" width="141" height="141" fill="#334155" rx="6"/><rect class="zone-hit" data-zone="R SLEEVE" data-side="front" x="70" y="140" width="139" height="138" rx="4"/><rect class="zone-hit" data-zone="R SHOULDER" data-side="front" x="209" y="140" width="140" height="70" rx="4"/><rect class="zone-hit" data-zone="NECK" data-side="front" x="349" y="140" width="70" height="70" rx="4"/><rect class="zone-hit" data-zone="L SHOULDER" data-side="front" x="420" y="140" width="139" height="70" rx="4"/><rect class="zone-hit" data-zone="L SLEEVE" data-side="front" x="559" y="139" width="140" height="141" rx="4"/><rect class="zone-hit" data-zone="R CHEST" data-side="front" x="209" y="210" width="175" height="139" rx="4"/><rect class="zone-hit" data-zone="L CHEST" data-side="front" x="385" y="210" width="174" height="140" rx="4"/><rect class="zone-hit" data-zone="CENTER" data-side="front" x="209" y="349" width="350" height="208" rx="4"/><rect class="zone-hit" data-zone="HEM" data-side="front" x="209" y="557" width="350" height="70" rx="4"/></svg>`;
        const SVG_TOP_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#334155" rx="6"/><rect x="69" y="139" width="141" height="141" fill="#334155" rx="6"/><rect x="558" y="139" width="141" height="141" fill="#334155" rx="6"/><rect class="zone-hit" data-zone="L SLEEVE" data-side="back" x="70" y="140" width="139" height="138" rx="4"/><rect class="zone-hit" data-zone="L SHOULDER" data-side="back" x="209" y="140" width="140" height="70" rx="4"/><rect class="zone-hit" data-zone="NECK" data-side="back" x="349" y="140" width="70" height="70" rx="4"/><rect class="zone-hit" data-zone="R SHOULDER" data-side="back" x="420" y="140" width="139" height="70" rx="4"/><rect class="zone-hit" data-zone="R SLEEVE" data-side="back" x="559" y="139" width="140" height="141" rx="4"/><rect class="zone-hit" data-zone="UPPER BACK" data-side="back" x="209" y="210" width="350" height="140" rx="4"/><rect class="zone-hit" data-zone="LOWER BACK" data-side="back" x="209" y="349" width="350" height="208" rx="4"/><rect class="zone-hit" data-zone="HEM" data-side="back" x="209" y="557" width="350" height="70" rx="4"/></svg>`;
        const SVG_PANTS_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="140" y="69" width="488" height="141" fill="#334155" rx="6"/><rect x="140" y="209" width="210" height="488" fill="#334155" rx="6"/><rect x="419" y="209" width="209" height="488" fill="#334155" rx="6"/><rect x="347" y="209" width="75" height="72" fill="#334155"/><rect class="zone-hit" data-zone="WAIST" data-side="front" x="140" y="69" width="488" height="70" rx="4"/><rect class="zone-hit" data-zone="HIP" data-side="front" x="140" y="140" width="488" height="70" rx="4"/><rect class="zone-hit" data-zone="R THIGH" data-side="front" x="140" y="209" width="210" height="210" rx="4"/><rect class="zone-hit" data-zone="L THIGH" data-side="front" x="419" y="209" width="209" height="210" rx="4"/><rect class="zone-hit" data-zone="R KNEE" data-side="front" x="140" y="417" width="210" height="140" rx="4"/><rect class="zone-hit" data-zone="L KNEE" data-side="front" x="419" y="417" width="209" height="140" rx="4"/><rect class="zone-hit" data-zone="R LEG" data-side="front" x="140" y="557" width="210" height="140" rx="4"/><rect class="zone-hit" data-zone="L LEG" data-side="front" x="419" y="557" width="209" height="140" rx="4"/></svg>`;
        const SVG_PANTS_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="140" y="69" width="488" height="141" fill="#334155" rx="6"/><rect x="140" y="209" width="210" height="488" fill="#334155" rx="6"/><rect x="419" y="209" width="209" height="488" fill="#334155" rx="6"/><rect x="347" y="209" width="75" height="72" fill="#334155"/><rect class="zone-hit" data-zone="WAIST" data-side="back" x="140" y="69" width="488" height="70" rx="4"/><rect class="zone-hit" data-zone="SEAT" data-side="back" x="140" y="140" width="488" height="70" rx="4"/><rect class="zone-hit" data-zone="L HAM" data-side="back" x="140" y="209" width="210" height="210" rx="4"/><rect class="zone-hit" data-zone="R HAM" data-side="back" x="419" y="209" width="209" height="210" rx="4"/><rect class="zone-hit" data-zone="L KNEE" data-side="back" x="140" y="417" width="210" height="140" rx="4"/><rect class="zone-hit" data-zone="R KNEE" data-side="back" x="419" y="417" width="209" height="140" rx="4"/><rect class="zone-hit" data-zone="L CALF" data-side="back" x="140" y="557" width="210" height="140" rx="4"/><rect class="zone-hit" data-zone="R CALF" data-side="back" x="419" y="557" width="209" height="140" rx="4"/></svg>`;

        const zonePos = { 'front-R SLEEVE':{x:18,y:33},'front-R SHOULDER':{x:36,y:23},'front-NECK':{x:50,y:23},'front-L SHOULDER':{x:64,y:23},'front-L SLEEVE':{x:82,y:33},'front-R CHEST':{x:36,y:44},'front-L CHEST':{x:64,y:44},'front-CENTER':{x:50,y:65},'front-HEM':{x:50,y:88},'back-L SLEEVE':{x:18,y:33},'back-L SHOULDER':{x:36,y:23},'back-NECK':{x:50,y:23},'back-R SHOULDER':{x:64,y:23},'back-R SLEEVE':{x:82,y:33},'back-UPPER BACK':{x:50,y:44},'back-LOWER BACK':{x:50,y:65},'back-HEM':{x:50,y:88},'front-WAIST':{x:50,y:14},'front-HIP':{x:50,y:24},'front-R THIGH':{x:30,y:45},'front-L THIGH':{x:70,y:45},'front-R KNEE':{x:30,y:65},'front-L KNEE':{x:70,y:65},'front-R LEG':{x:30,y:85},'front-L LEG':{x:70,y:85},'back-WAIST':{x:50,y:14},'back-SEAT':{x:50,y:24},'back-L HAM':{x:30,y:45},'back-R HAM':{x:70,y:45},'back-L KNEE':{x:30,y:65},'back-R KNEE':{x:70,y:65},'back-L CALF':{x:30,y:85},'back-R CALF':{x:70,y:85} };

        const defectColors = { Stain:{bg:'bg-yellow-100',border:'border-yellow-400',text:'text-yellow-800'}, Hole:{bg:'bg-red-100',border:'border-red-400',text:'text-red-800'}, Repair:{bg:'bg-blue-100',border:'border-blue-400',text:'text-blue-800'}, Other:{bg:'bg-purple-100',border:'border-purple-400',text:'text-purple-800'} };

        document.addEventListener('DOMContentLoaded', () => { data.timestamps.start = new Date().toISOString(); lucide.createIcons(); });

        function updateCheck(id, complete) { const el = document.getElementById(id); if(!el) return; el.innerHTML = complete ? '‚úì' : '‚óã'; el.classList.toggle('complete', complete); }
        function updateAllChecks() {
            updateCheck('check-category', !!data.category);
            updateCheck('check-sku', !!data.sku);
            updateCheck('check-tag', !!data.tagStatus);
            updateCheck('check-color', !!data.colorPrimary);
            updateCheck('check-sleeve', !!data.sleeveType);
            updateCheck('check-condition', !!data.condition);
            updateCheck('check-fade', !!data.fadeLevel);
            updateCheck('check-photos', !!data.photos.front || !!data.photos.back);
            updateCheck('check-measure', !!data.audioBlob);
            updateCheck('check-weight', data.weightTotalOz > 0);
        }

        function goToStep(step) {
            data.timestamps[`step${currentStep}End`] = new Date().toISOString();
            data.timestamps[`step${step}Start`] = new Date().toISOString();
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
            updateProgressBar(step);
            document.getElementById('step-label').textContent = ['','STEP 1: IDENTIFY','STEP 2: INSPECT','STEP 3: DOCUMENT','STEP 4: REVIEW'][step];
            if(step===3) { initDefectSection(); updateMeasureHint(); updateFeaturesGrid(); updateWeightHint(); }
            if(step===4) updateReviewCards();
            window.scrollTo(0,0);
            updateAllChecks();
        }

        function updateProgressBar(step) {
            for(let i=1;i<=4;i++) { const d=document.getElementById(`dot-${i}`); d.classList.remove('completed','current','pending'); d.classList.add(i<step?'completed':i===step?'current':'pending'); }
            for(let i=1;i<=3;i++) { const l=document.getElementById(`line-${i}`); l.classList.remove('completed','pending'); l.classList.add(i<step?'completed':'pending'); }
        }

        // === STEP 1 ===
        function setSuperCategory(cat, btn) {
            data.superCategory = cat;
            document.querySelectorAll('.super-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            const sel = document.getElementById('cat-select');
            sel.innerHTML = '<option value="" disabled selected>Select type...</option>';
            categoryOptions[cat].forEach(o => sel.innerHTML += `<option value="${o}">${o}</option>`);
            sel.classList.remove('hidden');
            document.getElementById('sleeve-section').classList.toggle('hidden', cat !== 'tops');
            updateAllChecks();
        }

        function onCategoryChange() { data.category = document.getElementById('cat-select').value; updateAllChecks(); }
        function onSkuInput() { data.sku = document.getElementById('sku-input').value; updateAllChecks(); }

        function toggleScanner() { const v = document.getElementById('scanner-view'); if(v.classList.contains('hidden')) { v.classList.remove('hidden'); startScanner(); } else { v.classList.add('hidden'); stopScanner(); } }
        function startScanner() { if(!qrScanner) qrScanner = new Html5Qrcode("reader"); qrScanner.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:100}}, t => { document.getElementById('sku-input').value = t; data.sku = t; toggleScanner(); updateAllChecks(); }, () => {}).catch(e => console.error(e)); }
        function stopScanner() { if(qrScanner?.isScanning) qrScanner.stop().catch(e => console.error(e)); }

        function setTagStatus(status, btn) {
            data.tagStatus = status;
            document.querySelectorAll('.tag-status-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('tag-size-section').classList.toggle('hidden', status !== 'has');
            document.getElementById('origin-section').classList.remove('hidden');
            document.getElementById('copyright-section').classList.remove('hidden');
            document.getElementById('tag-gender-section').classList.remove('hidden');
            updateAllChecks();
        }

        function setTagSize(size, btn) { data.tagSize = size; document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); document.getElementById('tag-size-input').value = ''; }
        function clearSizeBtns() { document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); }
        function onCustomSizeInput() { data.tagSize = document.getElementById('tag-size-input').value; clearSizeBtns(); }

        function setOrigin(type, btn) {
            data.origin = type;
            document.querySelectorAll('.origin-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('country-select').classList.toggle('hidden', type === 'usa');
            data.madeInCountry = type === 'usa' ? 'USA' : '';
        }

        function setGender(g, btn) { data.gender = g; document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }

        function setSleeve(type, btn) {
            data.sleeveType = type;
            document.querySelectorAll('.sleeve-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('cutoff-section').classList.toggle('hidden', !(data.category === 'T-Shirt' && type === 'Sleeveless'));
            updateAllChecks();
        }

        function setCutOff(val, btn) { data.isCutOff = val; document.querySelectorAll('.cutoff-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        function setThickness(t, btn) { data.thickness = t; document.querySelectorAll('.thickness-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        function setTexture(t, btn) { data.texture = t; document.querySelectorAll('.texture-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }

        // === STEP 2 ===
        function setCondition(cond, btn) {
            data.condition = cond;
            document.querySelectorAll('.condition-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('defect-hint').classList.toggle('hidden', cond !== 'found');
            updateAllChecks();
        }

        function setFade(level, btn) { data.fadeLevel = level; document.querySelectorAll('.fade-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); updateAllChecks(); }
        function setAudit(val, btn) { data.visualAudit = val; document.querySelectorAll('.audit-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        function flagUnusual() { data.flagged = true; const btn = document.getElementById('flag-btn'); btn.classList.add('flagged'); btn.innerHTML = '<div class="flex items-center justify-center gap-2 text-lg">‚úì FLAGGED FOR REVIEW</div>'; }

        // === STEP 3 ===
        function initDefectSection() {
            const show = data.condition === 'found';
            document.getElementById('defect-section').classList.toggle('hidden', !show);
            if(show) {
                const isTops = data.superCategory === 'tops' || data.superCategory === 'outer';
                document.getElementById('defect-svg-front').innerHTML = isTops ? SVG_TOP_FRONT : SVG_PANTS_FRONT;
                document.getElementById('defect-svg-back').innerHTML = isTops ? SVG_TOP_BACK : SVG_PANTS_BACK;
                document.querySelectorAll('.zone-hit').forEach(z => {
                    z.onclick = e => {
                        pendingDefect = { zone: e.target.dataset.zone, side: e.target.dataset.side };
                        document.getElementById('zone-label').textContent = `${pendingDefect.side.toUpperCase()} ‚Ä¢ ${pendingDefect.zone}`;
                        document.getElementById('defect-modal').classList.remove('hidden');
                    };
                });
                renderDefectMarkers();
                updateDefectList();
            }
        }

        function closeDefectModal(e) { if(!e || e.target === e.currentTarget) { document.getElementById('defect-modal').classList.add('hidden'); pendingDefect = null; } }

        function selectDefectType(type) {
            if(pendingDefect) {
                pendingDefect.type = type;
                pendingDefect.id = `defect-${Date.now()}`;
                document.getElementById('defect-modal').classList.add('hidden');
                // Immediately open camera to capture defect photo
                cameraMode = { type: 'defect', defect: pendingDefect };
                openCameraOverlay(`DEFECT: ${type}`);
            }
        }

        function renderDefectMarkers() {
            document.getElementById('defect-markers-front').innerHTML = '';
            document.getElementById('defect-markers-back').innerHTML = '';
            data.defects.forEach((d, i) => {
                const pos = zonePos[`${d.side}-${d.zone}`];
                if(!pos) return;
                const m = document.createElement('div');
                m.className = `defect-marker ${d.type.toLowerCase()}`;
                m.style.cssText = `left:${pos.x}%;top:${pos.y}%`;
                m.textContent = i + 1;
                m.onclick = () => removeDefect(i);
                document.getElementById(`defect-markers-${d.side}`).appendChild(m);
            });
        }

        function updateDefectList() {
            const el = document.getElementById('defect-list');
            if(!data.defects.length) { el.innerHTML = '<p class="text-gray-400 text-xs text-center py-2">Tap on the body map above to mark defects</p>'; return; }
            el.innerHTML = data.defects.map((d, i) => {
                const c = defectColors[d.type];
                return `<div class="defect-photo-item ${c.bg} ${c.border} border rounded-lg">
                    ${d.photo ? `<img src="${d.photo}" class="defect-photo-thumb">` : '<div class="w-[50px] h-[50px] bg-gray-200 rounded-lg flex items-center justify-center text-gray-400">?</div>'}
                    <div class="flex-1">
                        <div class="font-bold text-xs ${c.text}">${i+1}. ${d.type}</div>
                        <div class="text-[10px] opacity-70">${d.side} ‚Ä¢ ${d.zone}</div>
                    </div>
                    <button onclick="removeDefect(${i})" class="text-gray-400 text-xl px-2">√ó</button>
                </div>`;
            }).join('');
        }

        function removeDefect(i) { data.defects.splice(i, 1); renderDefectMarkers(); updateDefectList(); updateAllChecks(); }

        // === CAMERA ===
        async function openCamera(mode) {
            cameraMode = { type: mode };
            let label = mode.toUpperCase();
            if(mode === 'front') label = 'FULL FRONT';
            if(mode === 'back') label = 'FULL BACK';
            if(mode === 'brandTag') label = 'BRAND TAG';
            if(mode === 'careLabel') label = 'CARE LABEL';
            if(mode.startsWith('feature-')) label = `FEATURE: ${mode.replace('feature-','')}`;
            openCameraOverlay(label);
        }

        async function openCameraOverlay(label) {
            document.getElementById('cam-mode-label').textContent = label;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } });
                document.getElementById('cam-feed').srcObject = cameraStream;
                document.getElementById('camera-overlay').classList.remove('hidden');
            } catch(e) { alert('Camera error: ' + e.message); }
        }

        function closeCamera() {
            if(cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
            document.getElementById('camera-overlay').classList.add('hidden');
            pendingDefect = null;
        }

        function capturePhoto() {
            const video = document.getElementById('cam-feed');
            const canvas = document.getElementById('photo-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

            if(cameraMode.type === 'defect' && cameraMode.defect) {
                cameraMode.defect.photo = dataUrl;
                data.defects.push(cameraMode.defect);
                renderDefectMarkers();
                updateDefectList();
            } else if(cameraMode.type.startsWith('feature-')) {
                data.photos.features[cameraMode.type.replace('feature-','')] = dataUrl;
                const btn = document.getElementById(`photo-${cameraMode.type}`);
                if(btn) btn.classList.add('captured');
            } else {
                data.photos[cameraMode.type] = dataUrl;
                const btn = document.getElementById(`photo-${cameraMode.type}`);
                if(btn) btn.classList.add('captured');
            }

            closeCamera();
            updateAllChecks();
        }

        function updateFeaturesGrid() {
            const feats = featuresMap[data.category] || featuresMap.default;
            document.getElementById('features-grid').innerHTML = feats.map(f => `<button onclick="openCamera('feature-${f}')" id="photo-feature-${f}" class="photo-btn relative py-3 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-[10px]">üì∑ ${f}</button>`).join('');
        }

        function updateMeasureHint() {
            const m = measureMap[data.superCategory] || measureMap.tops;
            document.getElementById('measure-hint').innerHTML = `<b class="text-blue-800 text-[10px]">üìè SPEAK THESE:</b><div class="mt-1 text-[11px]">${m.join(' ‚Ä¢ ')}</div>`;
        }

        function updateWeightHint() {
            const h = weightHints[data.category] || 'üí° Select category for weight hint';
            document.getElementById('weight-hint').innerHTML = `<p class="text-[10px] text-purple-600 font-medium text-center">${h}</p>`;
        }

        // === AUDIO ===
        async function toggleRecording() {
            if(!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        data.audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        data.audioDuration = Math.round((Date.now() - recordingStart) / 1000);
                        document.getElementById('record-section').classList.add('hidden');
                        document.getElementById('post-record-section').classList.remove('hidden');
                        document.getElementById('recording-duration').textContent = formatTime(data.audioDuration);
                        stream.getTracks().forEach(t => t.stop());
                        updateAllChecks();
                    };
                    mediaRecorder.start();
                    recordingStart = Date.now();
                    isRecording = true;
                    const btn = document.getElementById('record-btn');
                    btn.classList.add('recording');
                    btn.innerHTML = '<span class="text-2xl">‚èπÔ∏è</span><span>TAP TO STOP</span><span id="rec-timer" class="text-sm font-mono">0:00</span>';
                    updateRecTimer();
                } catch(e) { alert('Microphone access denied'); }
            } else { mediaRecorder.stop(); isRecording = false; }
        }

        function updateRecTimer() { if(!isRecording) return; const t = document.getElementById('rec-timer'); if(t) t.textContent = formatTime(Math.round((Date.now()-recordingStart)/1000)); setTimeout(updateRecTimer, 1000); }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function reRecord() { data.audioBlob = null; data.audioDuration = 0; document.getElementById('record-section').classList.remove('hidden'); document.getElementById('post-record-section').classList.add('hidden'); document.getElementById('record-btn').classList.remove('recording'); document.getElementById('record-btn').innerHTML = '<span class="text-2xl">üé§</span><span>TAP TO RECORD</span>'; updateAllChecks(); }

        function updateWeight() { data.weightLb = +document.getElementById('weight-lb').value||0; data.weightOz = +document.getElementById('weight-oz').value||0; data.weightTotalOz = data.weightLb*16 + data.weightOz; updateAllChecks(); }

        // === STEP 4 ===
        function updateReviewCards() {
            document.getElementById('summary-identify').innerHTML = `${data.category||'?'} ‚Ä¢ ${data.sku||'?'}<br>${data.tagSize||''} ${data.gender||''}<br>${data.colorPrimary||'No color'}`;
            document.getElementById('summary-inspect').innerHTML = `${data.condition==='none'?'No flaws':data.defects.length+' defects'}<br>${data.fadeLevel||'?'} fade`;
            const pc = Object.values(data.photos).filter(p=>p&&typeof p==='string').length + Object.values(data.photos.features||{}).filter(p=>p).length + data.defects.filter(d=>d.photo).length;
            document.getElementById('summary-document').innerHTML = `${pc} photos<br>${data.audioBlob?formatTime(data.audioDuration)+' audio':'‚ö†Ô∏è No audio'}`;
            document.getElementById('summary-ready').innerHTML = data.weightTotalOz > 0 ? `${data.weightLb} lb ${data.weightOz} oz` : '‚ö†Ô∏è No weight';
            setCardStatus('identify', !!data.category && !!data.sku && !!data.colorPrimary);
            setCardStatus('inspect', !!data.fadeLevel);
            setCardStatus('document', !!data.audioBlob && (!!data.photos.front || !!data.photos.back));
            setCardStatus('ready', data.weightTotalOz > 0);
            if(data.flagged) document.getElementById('flag-status').classList.remove('hidden');
        }

        function setCardStatus(name, ok) { const card = document.getElementById(`card-${name}`); const icon = document.getElementById(`icon-${name}`); card.classList.remove('card-green','card-yellow'); card.classList.add(ok?'card-green':'card-yellow'); icon.textContent = ok?'üü¢':'üü°'; }

        function submitListing() {
            data.timestamps.submitted = new Date().toISOString();
            console.log('=== PAYLOAD ===', JSON.stringify(data, null, 2));
            alert(`Submitted!\n\nSKU: ${data.sku}\nCategory: ${data.category}\nDefects: ${data.defects.length}\nPhotos: ${Object.values(data.photos).filter(p=>p&&typeof p==='string').length + data.defects.filter(d=>d.photo).length}\nWeight: ${data.weightLb}lb ${data.weightOz}oz`);
        }
    </script>
</body>
</html>

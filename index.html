<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>VintageLister v78</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ============ DESIGN SYSTEM ============ */
        :root {
            /* Colors */
            --color-primary: #3b82f6;
            --color-primary-dark: #2563eb;
            --color-primary-light: #dbeafe;
            --color-success: #22c55e;
            --color-success-light: #dcfce7;
            --color-warning: #f59e0b;
            --color-warning-light: #fef3c7;
            --color-error: #ef4444;
            --color-error-light: #fee2e2;
            --color-surface: #ffffff;
            --color-background: #f8fafc;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-border: #e2e8f0;
            --color-border-dark: #cbd5e1;
            
            /* Spacing Scale - ONLY these values allowed */
            --space-xs: 4px;   /* 1 */
            --space-sm: 8px;   /* 2 */
            --space-md: 12px;  /* 3 */
            --space-lg: 16px;  /* 4 */
            --space-xl: 20px;  /* 5 */
            --space-2xl: 24px; /* 6 */
            
            /* Border Radius - 3 levels */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            /* Shadows - 3 levels */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 12px 32px rgba(0,0,0,0.15);
            
            /* Z-Index Scale */
            --z-base: 0;
            --z-dropdown: 10;
            --z-sticky: 20;
            --z-header: 30;
            --z-modal-backdrop: 40;
            --z-modal: 50;
            --z-camera: 60;
            --z-toast: 70;
            --z-celebration: 80;
            --z-login: 90;
            
            /* Touch target minimum (WCAG 2.5.5) */
            --touch-min: 44px;
            
            /* Layout */
            --header-height: calc(235px + env(safe-area-inset-top, 0px));
            
            /* Typography - ONLY 3 sizes for small text */
            --text-xs: 11px;   /* Compact labels, badges */
            --text-sm: 13px;   /* Secondary text */
            --text-base: 14px; /* Body text */
        }
        
        /* ============ BASE STYLES ============ */
        * { 
            -webkit-tap-highlight-color: transparent; 
            box-sizing: border-box; 
        }
        
        html, body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--color-background); 
            min-height: 100vh; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
            color: var(--color-text); 
            font-size: var(--text-base); 
            line-height: 1.5; 
            -webkit-font-smoothing: antialiased; 
        }
        
        /* ============ LAYOUT ============ */
        .step-container { display: none; }
        .step-container.active { display: block; }
        /* V78: Fixed safe-top - base padding plus safe-area-inset for notch/dynamic island */
        .safe-top { padding-top: calc(12px + env(safe-area-inset-top, 20px)); }
        .safe-bottom { padding-bottom: max(100px, calc(80px + env(safe-area-inset-bottom))); }
        
        /* ============ SECTION LABELS - CONSISTENT ============ */
        .section-label {
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md); /* ALWAYS 12px */
        }
        
        /* ============ PROGRESS INDICATOR ============ */
        .progress-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 0 var(--space-sm); /* Prevent edge overflow */
        }
        
        .progress-dot { 
            width: 44px;  /* Touch target IS the element */
            height: 44px; 
            border-radius: 50%; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            margin: 0 -6px; /* Overlap reduction while maintaining touch */
        }
        .progress-dot::before { 
            content: ''; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            transition: all 0.3s ease; 
        }
        .progress-dot:active::before { transform: scale(0.85); }
        .progress-dot.completed::before { background: var(--color-success); }
        .progress-dot.current::before { 
            background: var(--color-primary); 
            box-shadow: 0 0 0 4px rgba(59,130,246,0.25); 
        }
        .progress-dot.pending::before { background: var(--color-border-dark); }
        
        .progress-line { 
            height: 4px; 
            flex: 1; 
            min-width: 20px;
            max-width: 40px;
            border-radius: 2px; 
            transition: background 0.3s ease;
            margin: 0 -4px; /* Visual connection */
        }
        .progress-line.completed { background: var(--color-success); }
        .progress-line.pending { background: var(--color-border); }
        
        /* ============ CHECK CIRCLES ============ */
        .check-circle { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            border: 2px solid var(--color-border-dark); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: 700; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            color: var(--color-border-dark); 
            flex-shrink: 0; 
            background: var(--color-surface); 
        }
        .check-circle.complete { 
            background: var(--color-success); 
            border-color: var(--color-success); 
            color: white; 
        }
        @keyframes checkPop { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.25); } 
            100% { transform: scale(1); } 
        }
        .check-circle.just-completed { animation: checkPop 0.4s ease-out; }
        
        /* ============ CARDS ============ */
        .section-card { 
            background: var(--color-surface); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); 
            border: 1px solid var(--color-border); 
            scroll-margin-top: calc(var(--header-height) + var(--space-lg)); 
            padding: var(--space-lg); 
        }
        
        /* ============ BUTTONS - 3 SIZES ONLY ============ */
        
        /* Standard Button (44px) */
        .btn-standard {
            min-height: var(--touch-min);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--text-base);
            font-weight: 600;
            border-radius: var(--radius-md);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Large Button (56px) */
        .btn-large {
            min-height: 56px;
            padding: var(--space-lg) var(--space-xl);
            font-size: 16px;
            font-weight: 700;
            border-radius: var(--radius-lg);
        }
        
        /* Compact Button (44px but denser text) */
        .btn-compact {
            min-height: var(--touch-min);
            padding: var(--space-sm) var(--space-xs);
            font-size: var(--text-xs);
            font-weight: 700;
            border-radius: var(--radius-sm);
        }
        
        /* Hero (Primary) */
        .btn-hero { 
            background: var(--color-primary); 
            color: white !important; 
            border: 2px solid var(--color-primary-dark) !important; 
            box-shadow: var(--shadow-md); 
        }
        .btn-hero:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }
        .btn-hero.selected { 
            background: var(--color-primary-dark); 
            box-shadow: 0 0 0 3px rgba(59,130,246,0.3), var(--shadow-md); 
        }
        
        /* Secondary */
        .btn-secondary { 
            background: var(--color-surface); 
            color: var(--color-text); 
            border: 2px solid var(--color-border); 
        }
        .btn-secondary:active { transform: scale(0.98); background: var(--color-background); }
        .btn-secondary.selected { 
            border-color: var(--color-primary); 
            background: var(--color-primary-light); 
            color: var(--color-primary-dark); 
        }
        
        /* Tertiary (for nested/compact areas) */
        .btn-tertiary {
            background: var(--color-surface);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }
        .btn-tertiary.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            color: var(--color-primary-dark);
        }
        
        /* Default (pre-selected value that needs confirmation - lighter blue with dashed border) */
        .btn-default {
            background: #e0f2fe;
            color: #0369a1;
            border: 2px dashed #7dd3fc;
        }
        .btn-default.selected, .btn-default.confirmed {
            border: 2px solid var(--color-primary);
            background: var(--color-primary);
            color: white;
            border-style: solid;
        }
        
        /* Confirmed state for any button */
        .btn-compact.confirmed, .btn-standard.confirmed {
            border: 2px solid var(--color-primary);
            background: var(--color-primary);
            color: white;
        }
        
        /* ============ COLOR SWATCHES ============ */
        .color-swatch {
            width: 100%;
            aspect-ratio: 1;
            min-height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .color-swatch:active { transform: scale(0.95); }
        .color-swatch.selected {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 3px var(--color-primary-light), var(--shadow-md);
            transform: scale(1.05);
        }
        /* V78: Labeled color swatches */
        .color-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 2px;
            border-radius: 8px;
            transition: all 0.15s ease;
        }
        .color-item:active { transform: scale(0.95); }
        .color-item span {
            font-size: 9px;
            color: #64748b;
            margin-top: 2px;
            text-align: center;
            line-height: 1.1;
        }
        .color-item.selected .color-swatch-labeled {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 3px var(--color-primary-light);
            transform: scale(1.05);
        }
        .color-item.selected span {
            color: var(--color-primary);
            font-weight: 700;
        }
        .color-swatch-labeled {
            width: 100%;
            aspect-ratio: 1;
            min-height: 36px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.15s ease;
        }
        .color-swatch-sm {
            width: 100%;
            aspect-ratio: 1;
            min-height: 32px;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .color-swatch-sm.selected {
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 2px var(--color-primary-light);
        }
        
        /* ============ CATEGORY HERO BUTTONS ============ */
        .cat-hero { 
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); 
            color: white; 
            border: none; 
            box-shadow: var(--shadow-md); 
            font-size: 16px; 
            font-weight: 800; 
            border-radius: var(--radius-lg); 
            min-height: 64px; 
        }
        .cat-hero:active { transform: scale(0.98); }
        .cat-hero.selected { box-shadow: 0 0 0 4px rgba(59,130,246,0.4), var(--shadow-lg); }
        
        .cat-secondary { 
            background: var(--color-surface); 
            color: var(--color-text); 
            border: 2px solid var(--color-border); 
            font-weight: 700; 
            border-radius: var(--radius-md); 
            min-height: 52px; 
        }
        .cat-secondary.selected { 
            border-color: var(--color-primary); 
            background: var(--color-primary-light); 
            color: var(--color-primary-dark); 
        }
        
        /* ============ STATS BAR ============ */
        .stats-bar { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: var(--space-md); 
            background: linear-gradient(135deg, #1e293b, #334155); 
            padding: var(--space-sm) var(--space-lg); 
            border-radius: var(--radius-md); 
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 16px; font-weight: 800; color: white; line-height: 1.2; }
        .stat-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; font-weight: 600; }
        .stat-divider { width: 1px; height: 28px; background: #475569; }
        
        /* ============ STREAK BADGE ============ */
        .streak-badge { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
            font-size: var(--text-sm); 
            font-weight: 800; 
            padding: var(--space-xs) 10px; 
            border-radius: 20px; 
            display: flex; 
            align-items: center; 
            gap: var(--space-xs); 
            box-shadow: var(--shadow-sm); 
        }
        
        /* ============ NESTED SECTIONS ============ */
        .nested-section {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid;
        }
        .nested-section-amber {
            background: #fffbeb;
            border-color: #fcd34d;
        }
        .nested-section-indigo {
            background: #eef2ff;
            border-color: #a5b4fc;
        }
        .nested-section-violet {
            background: #f5f3ff;
            border-color: #c4b5fd;
        }
        .nested-label {
            font-size: var(--text-xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-sm);
            display: block;
        }
        
        /* ============ CELEBRATION ============ */
        #celebration { 
            position: fixed; 
            inset: 0; 
            z-index: var(--z-celebration); 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease; 
        }
        #celebration.show { opacity: 1; }
        #celebration .content { 
            background: var(--color-surface); 
            border-radius: var(--radius-lg); 
            padding: var(--space-2xl); 
            box-shadow: var(--shadow-lg); 
            transform: scale(0.8) translateY(20px); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            text-align: center; 
            max-width: calc(100vw - 48px); 
        }
        #celebration.show .content { transform: scale(1) translateY(0); }
        
        /* ============ SCAN FLASH ============ */
        #scan-flash { 
            position: fixed; 
            inset: 0; 
            background: rgba(34,197,94,0.3); 
            pointer-events: none; 
            opacity: 0; 
            z-index: var(--z-toast); 
        }
        @keyframes scanFlash { 0% { opacity: 0; } 30% { opacity: 1; } 100% { opacity: 0; } }
        #scan-flash.flash { animation: scanFlash 0.35s ease-out; }
        
        /* ============ WARNING CARDS ============ */
        .warning-card { 
            background: var(--color-warning-light); 
            border: 2px solid var(--color-warning); 
            border-radius: var(--radius-md); 
            padding: var(--space-md); 
        }
        
        /* ============ DEFECT STYLING ============ */
        .defect-stain { background: #fef9c3; color: #854d0e; border: 2px solid #facc15; }
        .defect-hole { background: #fee2e2; color: #991b1b; border: 2px solid #f87171; }
        .defect-repair { background: #dbeafe; color: #1e40af; border: 2px solid #60a5fa; }
        .defect-other { background: #f3e8ff; color: #6b21a8; border: 2px solid #c084fc; }
        
        .zone-hit { 
            cursor: pointer; 
            fill: rgba(100,116,139,0.12); 
            stroke: rgba(100,116,139,0.25); 
            stroke-width: 1.5px; 
            transition: fill 0.15s ease; 
        }
        .zone-hit:active { fill: rgba(59,130,246,0.4) !important; }
        .map-wrapper { position: relative; width: 100%; touch-action: manipulation; }
        
        .defect-marker { 
            position: absolute; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: var(--text-sm); 
            font-weight: 800; 
            transform: translate(-50%,-50%); 
            z-index: 5; /* Below dropdown (10) */
            box-shadow: var(--shadow-md); 
            border: 2px solid white; 
            cursor: pointer; 
        }
        @keyframes markerPop { 
            from { transform: translate(-50%,-50%) scale(0); } 
            to { transform: translate(-50%,-50%) scale(1); } 
        }
        @media (prefers-reduced-motion: no-preference) { 
            .defect-marker { animation: markerPop 0.25s ease-out; } 
        }
        .defect-marker.stain { background: #facc15; color: #713f12; }
        .defect-marker.hole { background: #f87171; color: white; }
        .defect-marker.repair { background: #60a5fa; color: white; }
        .defect-marker.other { background: #c084fc; color: white; }
        
        /* ============ RECORDING ============ */
        @keyframes pulse-red { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.6); } 
            50% { box-shadow: 0 0 0 12px rgba(239,68,68,0); } 
        }
        @media (prefers-reduced-motion: no-preference) { 
            .recording { animation: pulse-red 1.2s infinite; } 
        }
        .recording { background: var(--color-error) !important; }
        
        /* ============ ANIMATIONS ============ */
        @keyframes slide-up { 
            from { transform: translateY(100%); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            20%, 60% { transform: translateX(-5px); } 
            40%, 80% { transform: translateX(5px); } 
        }
        .shake { animation: shake 0.4s ease-out; }
        
        @keyframes pulse-attention { 
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); } 
            50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); } 
        }
        @media (prefers-reduced-motion: no-preference) { 
            .needs-attention { animation: pulse-attention 2s infinite; } 
        }
        
        /* ============ PHOTO THUMBS ============ */
        .photo-thumb { 
            width: 64px; 
            height: 64px; 
            object-fit: cover; 
            border-radius: var(--radius-sm); 
            border: 2px solid white; 
            box-shadow: var(--shadow-sm); 
            cursor: pointer; 
            transition: transform 0.15s ease; 
        }
        .photo-thumb:active { transform: scale(0.95); }
        
        /* ============ FLAG BUTTON ============ */
        .flag-btn { 
            background: var(--color-warning-light); 
            border: 2px dashed var(--color-warning); 
            border-radius: var(--radius-lg); 
            min-height: var(--touch-min); 
        }
        .flag-btn.flagged { 
            background: #fde68a; 
            border: 2px solid #b45309; 
        }
        
        /* ============ REVIEW CARDS ============ */
        .review-card {
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            cursor: pointer;
            transition: transform 0.15s ease;
        }
        .review-card:active { transform: scale(0.98); }
        .card-green { border-left: 4px solid var(--color-success); background: var(--color-success-light); }
        .card-yellow { border-left: 4px solid var(--color-warning); background: var(--color-warning-light); }
        
        /* ============ CAMERA ============ */
        #camera-overlay { 
            position: fixed; 
            inset: 0; 
            z-index: var(--z-camera); 
            background: black; 
        }
        #camera-overlay video { width: 100%; height: 100%; object-fit: cover; }
        .cam-controls { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            padding: var(--space-2xl); 
            padding-bottom: max(var(--space-2xl), env(safe-area-inset-bottom)); 
            background: linear-gradient(transparent, rgba(0,0,0,0.85)); 
        }
        .shutter-btn { 
            width: 72px; 
            height: 72px; 
            border-radius: 50%; 
            background: white; 
            border: 4px solid rgba(255,255,255,0.4); 
            transition: transform 0.15s ease; 
        }
        .shutter-btn:active { transform: scale(0.9); background: #e5e7eb; }
        
        /* ============ MODAL ============ */
        #upload-modal { 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            background: rgba(0,0,0,0.5); 
        }
        .upload-progress-bar { transition: width 0.3s ease; }
        
        /* ============ MOTIVATION BANNER ============ */
        .motivation-banner { 
            background: var(--color-primary); 
            color: white; 
            padding: var(--space-md) var(--space-lg); 
            border-radius: var(--radius-md); 
            text-align: center; 
            font-size: var(--text-sm); 
            font-weight: 600; 
        }
        
        /* ============ FORM INPUTS ============ */
        .form-select {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text);
            background: var(--color-surface);
            outline: none;
            min-height: var(--touch-min);
        }
        .form-select:focus { border-color: var(--color-primary); }
        
        .form-input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            outline: none;
            min-height: var(--touch-min);
        }
        .form-input:focus { border-color: var(--color-primary); }
        
        /* ============ UTILITY CLASSES ============ */
        .text-label { font-size: var(--text-xs); }
        .text-body { font-size: var(--text-base); }
        .text-secondary { font-size: var(--text-sm); color: var(--color-text-muted); }
        
        /* ============ RESPONSIVE ============ */
        @media (max-width: 360px) {
            :root { --header-height: calc(240px + env(safe-area-inset-top, 0px)); }
            .stat-value { font-size: 14px; }
            .section-card { padding: var(--space-md); }
        }
        
        @media (min-width: 768px) {
            .main-container { max-width: 480px; margin: 0 auto; }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { 
                animation-duration: 0.01ms !important; 
                animation-iteration-count: 1 !important; 
                transition-duration: 0.01ms !important; 
            }
        }
    </style>
    <script>
        const N8N_WEBHOOK_URL = "https://jeffkoga.app.n8n.cloud/webhook/0845a6d3-be69-4b68-aba7-28f55112678c";
        const APP_PIN = "1234";
    </script>
</head>
<body>

    <div id="scan-flash"></div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center p-6" style="z-index: var(--z-login);">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <div class="text-5xl mb-3">üëï</div>
            <h1 class="text-xl font-bold text-slate-800 mb-1">VintageLister</h1>
            <p class="text-secondary mb-5">Enter Warehouse PIN</p>
            <input type="tel" id="pin-input" maxlength="4" 
                   class="form-input text-center text-3xl font-mono mb-4 tracking-[0.3em]" 
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="off">
            <div class="mb-5">
                <label class="text-label font-bold text-slate-400 uppercase tracking-wide block mb-2">Photographer</label>
                <select id="photographer-select" class="form-select">
                    <option value="P01">P01 ‚Äì Jeff Koga</option>
                    <option value="P02" selected>P02 ‚Äì Elaine Donato</option>
                    <option value="P03">P03 ‚Äì Kobe Gaza</option>
                </select>
            </div>
            <button onclick="checkPin()" class="btn-standard btn-hero w-full text-lg">START LISTING ‚Üí</button>
        </div>
        <p class="text-slate-500 text-label mt-4">v78</p>
    </div>

    <!-- CELEBRATION -->
    <div id="celebration">
        <div class="content">
            <div id="celebration-emoji" class="text-5xl mb-2">üéâ</div>
            <div id="celebration-text" class="text-xl font-bold text-slate-800"></div>
            <div id="celebration-sub" class="text-secondary mt-1"></div>
        </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div id="upload-modal" class="fixed inset-0 hidden flex items-center justify-center p-6" style="z-index: var(--z-modal);">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm text-center shadow-2xl">
            <div class="text-5xl mb-4">üì§</div>
            <h3 class="text-lg font-bold text-slate-800 mb-3">Uploading...</h3>
            <div class="w-full bg-slate-200 rounded-full h-3 mb-3 overflow-hidden">
                <div id="upload-progress-bar" class="upload-progress-bar bg-blue-600 h-full rounded-full" style="width: 0%"></div>
            </div>
            <p id="upload-status" class="text-secondary">Preparing...</p>
        </div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b border-slate-200 shadow-sm safe-top" style="z-index: var(--z-header);">
        <div class="px-4 py-2">
            <!-- Brand Row -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-slate-800 font-bold text-base">Vintage<span class="text-blue-600">Lister</span></span>
                    <span class="text-slate-400 text-label">v78</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="streak-badge">
                        <span>üî•</span>
                        <span id="streak-count">1</span>
                    </div>
                    <button onclick="showPhotographerChange()" id="photographer-badge" 
                            class="bg-indigo-100 text-indigo-700 text-label font-bold px-3 py-2 rounded-lg min-h-[36px] flex items-center">
                        P02
                    </button>
                </div>
            </div>
            
            <!-- Stats Bar -->
            <div class="stats-bar mb-3">
                <div class="stat-item">
                    <div class="stat-value" id="items-today">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-time">--</div>
                    <div class="stat-label">Avg</div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <div class="stat-value text-emerald-400" id="current-timer">0:00</div>
                    <div class="stat-label">Now</div>
                </div>
            </div>
            
            <!-- Progress: TAG ‚Ä¢ CHECK ‚Ä¢ SNAP ‚Ä¢ SEND -->
            <div class="progress-container">
                <div id="dot-1" onclick="goToStep(1)" class="progress-dot current" role="button" aria-label="Step 1: Tag"></div>
                <div id="line-1" class="progress-line pending"></div>
                <div id="dot-2" onclick="goToStep(2)" class="progress-dot pending" role="button" aria-label="Step 2: Check"></div>
                <div id="line-2" class="progress-line pending"></div>
                <div id="dot-3" onclick="goToStep(3)" class="progress-dot pending" role="button" aria-label="Step 3: Snap"></div>
                <div id="line-3" class="progress-line pending"></div>
                <div id="dot-4" onclick="goToStep(4)" class="progress-dot pending" role="button" aria-label="Step 4: Send"></div>
            </div>
            <div id="step-label" class="text-center text-slate-400 text-label font-semibold mt-2 uppercase tracking-wider">Tag</div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="main-container" style="padding-top: var(--header-height);">
        <div class="safe-bottom px-4">

        <!-- ========== STEP 1: TAG ========== -->
        <div id="step-1" class="step-container active space-y-3">
            
            <div id="motivation-banner" class="motivation-banner hidden"></div>
            
            <!-- SKU (V78: Moved to first) -->
            <section id="section-sku" class="section-card">
                <label class="section-label">
                    <span id="check-sku" class="check-circle">‚óã</span>
                    SKU
                    <span class="text-slate-400 text-label font-normal ml-1">Scan to start timer ‚è±Ô∏è</span>
                </label>
                <div class="flex gap-2">
                    <input type="text" id="sku-input" inputmode="numeric" placeholder="Scan barcode..." 
                           oninput="onSkuInput()" onkeydown="if(event.key==='Enter')this.blur();" 
                           class="form-input flex-1 text-xl font-mono bg-slate-50">
                    <button onclick="toggleScanner()" 
                            class="btn-standard bg-slate-800 text-white min-w-[52px] active:scale-95 shadow-md">
                        <i data-lucide="scan-barcode" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="scanner-view" class="hidden mt-3 rounded-xl overflow-hidden border-4 border-slate-800 relative bg-black" style="height: 180px;">
                    <div id="reader" class="w-full h-full"></div>
                    <button onclick="toggleScanner()" class="absolute top-2 right-2 bg-red-600 text-white text-label font-bold px-4 py-2 rounded-lg shadow min-h-[36px]">‚úï CLOSE</button>
                </div>
            </section>
            
            <!-- CATEGORY -->
            <section id="section-category" class="section-card">
                <label class="section-label">
                    <span id="check-category" class="check-circle">‚óã</span>
                    What is it?
                </label>
                
                <!-- Super Category -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button onclick="setSuperCategory('tops', this)" class="btn-standard btn-hero super-btn flex flex-col items-center gap-1 py-3">
                        <span class="text-xl">üëï</span>
                        <span class="text-label">TOPS</span>
                    </button>
                    <button onclick="setSuperCategory('bottoms', this)" class="btn-standard btn-secondary super-btn flex flex-col items-center gap-1 py-3">
                        <span class="text-xl">üëñ</span>
                        <span class="text-label">BOTTOMS</span>
                    </button>
                    <button onclick="setSuperCategory('outer', this)" class="btn-standard btn-secondary super-btn flex flex-col items-center gap-1 py-3">
                        <span class="text-xl">üß•</span>
                        <span class="text-label">OUTER</span>
                    </button>
                </div>
                
                <!-- Dynamic Sub-Categories -->
                <div id="sub-category-heroes" class="hidden">
                    <div id="hero-cats" class="mb-2"></div>
                    <div id="other-cats" class="hidden">
                        <button onclick="toggleOtherCats()" id="other-cats-toggle" 
                                class="w-full text-slate-400 text-label py-3 mb-2 min-h-[44px]">+ Other types</button>
                        <div id="other-cats-grid" class="hidden grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
            </section>
            
            <!-- TAG INFO -->
            <section id="section-tag" class="section-card">
                <label class="section-label">
                    <span id="check-tag" class="check-circle">‚óã</span>
                    Tag Info
                </label>
                
                <button onclick="setTagStatus('has', this)" class="btn-standard btn-hero tag-status-btn w-full mb-2">
                    ‚úì TAG READABLE
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setTagStatus('worn', this)" class="btn-standard btn-secondary tag-status-btn">üëÄ Worn/Faded</button>
                    <button onclick="setTagStatus('none', this)" class="btn-standard btn-secondary tag-status-btn">‚úÇÔ∏è Missing/Cut</button>
                </div>
                
                <!-- Tag Size (conditional) -->
                <div id="tag-size-section" class="hidden nested-section nested-section-amber mt-3">
                    <label class="nested-label text-amber-700">Tag Size</label>
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <button onclick="setTagSize('S', this)" class="btn-compact btn-tertiary size-btn">S</button>
                        <button onclick="setTagSize('M', this)" class="btn-compact btn-tertiary size-btn">M</button>
                        <button onclick="setTagSize('L', this)" class="btn-compact btn-tertiary size-btn">L</button>
                        <button onclick="setTagSize('XL', this)" class="btn-compact btn-tertiary size-btn">XL</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <button onclick="setTagSize('XS', this)" class="btn-compact btn-tertiary size-btn">XS</button>
                        <button onclick="setTagSize('2XL', this)" class="btn-compact btn-tertiary size-btn">2XL</button>
                        <button onclick="setTagSize('3XL', this)" class="btn-compact btn-tertiary size-btn">3XL</button>
                    </div>
                    <input type="text" id="tag-size-input" placeholder="Or type: 42R, 32x30, etc." 
                           onfocus="clearSizeBtns()" oninput="onCustomSizeInput()" 
                           class="form-input text-center text-sm">
                </div>
                
                <!-- Origin (conditional) -->
                <div id="origin-section" class="hidden mt-3">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="setOrigin('usa', this)" class="btn-standard btn-hero origin-btn text-sm">üá∫üá∏ USA MADE</button>
                        <button onclick="setOrigin('import', this)" class="btn-standard btn-secondary origin-btn">üåç Import</button>
                    </div>
                    <select id="country-select" onchange="data.madeInCountry=this.value; haptic('light');" 
                            class="hidden form-select text-sm">
                        <option value="" disabled selected>Select Country...</option>
                        <optgroup label="Common">
                            <option value="Mexico">üá≤üáΩ Mexico</option>
                            <option value="Honduras">üá≠üá≥ Honduras</option>
                            <option value="Korea">üá∞üá∑ Korea</option>
                            <option value="Taiwan">üáπüáº Taiwan</option>
                            <option value="China">üá®üá≥ China</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="Vietnam">üáªüá≥ Vietnam</option>
                            <option value="Bangladesh">üáßüá© Bangladesh</option>
                            <option value="India">üáÆüá≥ India</option>
                            <option value="Indonesia">üáÆüá© Indonesia</option>
                            <option value="Cambodia">üá∞üá≠ Cambodia</option>
                            <option value="Pakistan">üáµüá∞ Pakistan</option>
                            <option value="Philippines">üáµüá≠ Philippines</option>
                            <option value="Japan">üáØüáµ Japan</option>
                            <option value="Italy">üáÆüáπ Italy</option>
                            <option value="Portugal">üáµüáπ Portugal</option>
                            <option value="Other">üåç Other</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Gender (conditional) -->
                <div id="tag-gender-section" class="hidden mt-3">
                    <label class="nested-label text-slate-500">Gender on Tag</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setGender('Men', this)" class="btn-compact btn-secondary gender-btn">Men's</button>
                        <button onclick="setGender('Women', this)" class="btn-compact btn-secondary gender-btn">Women's</button>
                        <button onclick="setGender('Unisex', this)" class="btn-compact btn-secondary gender-btn">Unisex</button>
                        <button onclick="setGender('None', this)" class="btn-compact btn-secondary gender-btn">None</button>
                    </div>
                </div>
            </section>
            
            <button onclick="goToStep(2)" class="btn-large btn-hero w-full shadow-lg">
                Next: Check ‚Üí
            </button>
        </div>

        <!-- ========== STEP 2: CHECK (V78: Reordered - Color ‚Üí Pattern ‚Üí Fabric ‚Üí Construction) ========== -->
        <div id="step-2" class="step-container space-y-3">
            
            <!-- COLOR - Ordered dark to light -->
            <section id="section-color" class="section-card">
                <label class="section-label">
                    <span id="check-color" class="check-circle">‚óã</span>
                    Color
                </label>
                <!-- Row 1: Darkest -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="color-item" onclick="setColor('Black', this)"><div class="color-swatch-labeled" style="background:#1a1a1a;border:2px solid #444;"></div><span>Black</span></div>
                    <div class="color-item" onclick="setColor('Charcoal', this)"><div class="color-swatch-labeled" style="background:#36454f;"></div><span>Char.</span></div>
                    <div class="color-item" onclick="setColor('Navy', this)"><div class="color-swatch-labeled" style="background:#1e3a5f;"></div><span>Navy</span></div>
                    <div class="color-item" onclick="setColor('Burgundy', this)"><div class="color-swatch-labeled" style="background:#722f37;"></div><span>Burg.</span></div>
                    <div class="color-item" onclick="setColor('Brown', this)"><div class="color-swatch-labeled" style="background:#78350f;"></div><span>Brown</span></div>
                    <div class="color-item" onclick="setColor('Olive', this)"><div class="color-swatch-labeled" style="background:#556b2f;"></div><span>Olive</span></div>
                    <div class="color-item" onclick="setColor('Gray', this)"><div class="color-swatch-labeled" style="background:#6b7280;"></div><span>Gray</span></div>
                </div>
                <!-- Row 2: Medium -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="color-item" onclick="setColor('Red', this)"><div class="color-swatch-labeled" style="background:#dc2626;"></div><span>Red</span></div>
                    <div class="color-item" onclick="setColor('Blue', this)"><div class="color-swatch-labeled" style="background:#3b82f6;"></div><span>Blue</span></div>
                    <div class="color-item" onclick="setColor('Green', this)"><div class="color-swatch-labeled" style="background:#16a34a;"></div><span>Green</span></div>
                    <div class="color-item" onclick="setColor('Teal', this)"><div class="color-swatch-labeled" style="background:#0d9488;"></div><span>Teal</span></div>
                    <div class="color-item" onclick="setColor('Purple', this)"><div class="color-swatch-labeled" style="background:#8b5cf6;"></div><span>Purple</span></div>
                    <div class="color-item" onclick="setColor('Orange', this)"><div class="color-swatch-labeled" style="background:#f97316;"></div><span>Orange</span></div>
                    <div class="color-item" onclick="setColor('Pink', this)"><div class="color-swatch-labeled" style="background:#ec4899;"></div><span>Pink</span></div>
                </div>
                <!-- Row 3: Lightest -->
                <div class="grid grid-cols-7 gap-1 mb-3">
                    <div class="color-item" onclick="setColor('Heather', this)"><div class="color-swatch-labeled" style="background:linear-gradient(135deg,#9ca3af 25%,#6b7280 50%,#9ca3af 75%);"></div><span>Heath.</span></div>
                    <div class="color-item" onclick="setColor('Tan', this)"><div class="color-swatch-labeled" style="background:#d2b48c;"></div><span>Tan</span></div>
                    <div class="color-item" onclick="setColor('Beige', this)"><div class="color-swatch-labeled" style="background:#d4b896;"></div><span>Beige</span></div>
                    <div class="color-item" onclick="setColor('Yellow', this)"><div class="color-swatch-labeled" style="background:#facc15;"></div><span>Yellow</span></div>
                    <div class="color-item" onclick="setColor('Cream', this)"><div class="color-swatch-labeled" style="background:#fffdd0;border:2px solid #ddd;"></div><span>Cream</span></div>
                    <div class="color-item" onclick="setColor('White', this)"><div class="color-swatch-labeled" style="background:#ffffff;border:2px solid #ddd;"></div><span>White</span></div>
                    <div class="color-item" onclick="setColor('Multi', this)"><div class="color-swatch-labeled" style="background:linear-gradient(135deg,#ef4444,#f97316,#facc15,#22c55e,#3b82f6,#8b5cf6);"></div><span>Multi</span></div>
                </div>
                <div id="selected-color" class="text-center text-slate-800 text-lg font-bold mb-2"></div>
                <button onclick="toggleSecondaryColor()" id="add-color-btn" 
                        class="text-slate-400 text-label min-h-[44px] w-full text-left px-2">+ Add second color</button>
                <div id="secondary-color-section" class="hidden mt-2">
                    <div class="text-label text-slate-500 mb-2">Secondary Color</div>
                    <select id="secondary-color-select" onchange="setSecondaryColorFromDropdown()" class="form-select text-sm">
                        <option value="" selected>Select secondary color...</option>
                        <option value="Black">‚¨õ Black</option>
                        <option value="White">‚¨ú White</option>
                        <option value="Gray">ü©∂ Gray</option>
                        <option value="Navy">üü¶ Navy</option>
                        <option value="Blue">üîµ Blue</option>
                        <option value="Red">üî¥ Red</option>
                        <option value="Green">üü¢ Green</option>
                        <option value="Yellow">üü° Yellow</option>
                        <option value="Orange">üü† Orange</option>
                        <option value="Pink">üíó Pink</option>
                        <option value="Purple">üü£ Purple</option>
                        <option value="Brown">üü§ Brown</option>
                        <option value="Tan">üèúÔ∏è Tan</option>
                        <option value="Cream">üç¶ Cream</option>
                        <option value="Burgundy">üç∑ Burgundy</option>
                        <option value="Teal">üßä Teal</option>
                        <option value="Olive">ü´í Olive</option>
                    </select>
                </div>
            </section>
            
            <!-- PATTERN (Second) - Simplified, no print type or graphic category -->
            <section id="section-pattern" class="section-card">
                <label class="section-label">
                    <span id="check-pattern" class="check-circle">‚óã</span>
                    Pattern
                </label>
                <div id="pattern-heroes" class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="setPattern('Solid', this)" class="btn-standard btn-tertiary pattern-btn">Solid</button>
                    <button onclick="setPattern('Graphic', this)" class="btn-standard btn-tertiary pattern-btn">üé® Graphic</button>
                </div>
                <div id="pattern-common" class="grid grid-cols-4 gap-2 mb-2">
                    <button onclick="setPattern('Striped', this)" class="btn-compact btn-tertiary pattern-btn">Striped</button>
                    <button onclick="setPattern('Plaid', this)" class="btn-compact btn-tertiary pattern-btn">Plaid</button>
                    <button onclick="setPattern('Tie Dye', this)" class="btn-compact btn-tertiary pattern-btn">Tie Dye</button>
                    <button onclick="setPattern('Camo', this)" class="btn-compact btn-tertiary pattern-btn">Camo</button>
                </div>
                <button onclick="toggleOtherPatterns()" id="other-patterns-toggle" class="text-slate-400 text-label min-h-[44px] w-full text-left px-2">+ Other patterns</button>
                <div id="pattern-others" class="hidden grid grid-cols-4 gap-2 mt-2">
                    <button onclick="setPattern('Color Block', this)" class="btn-compact btn-tertiary pattern-btn">Color Block</button>
                    <button onclick="setPattern('Embroidered', this)" class="btn-compact btn-tertiary pattern-btn">Emb.</button>
                    <button onclick="setPattern('Polka Dot', this)" class="btn-compact btn-tertiary pattern-btn">Polka</button>
                    <button onclick="setPattern('Paisley', this)" class="btn-compact btn-tertiary pattern-btn">Paisley</button>
                    <button onclick="setPattern('Floral', this)" class="btn-compact btn-tertiary pattern-btn">Floral</button>
                    <button onclick="setPattern('Animal', this)" class="btn-compact btn-tertiary pattern-btn">Animal</button>
                    <button onclick="setPattern('Geometric', this)" class="btn-compact btn-tertiary pattern-btn">Geo</button>
                    <button onclick="setPattern('Other', this)" class="btn-compact btn-tertiary pattern-btn">Other</button>
                </div>
            </section>
            
            <!-- FABRIC (Third) -->
            <section id="section-fabric" class="section-card">
                <label class="section-label">
                    <span id="check-fabric" class="check-circle">‚óã</span>
                    Fabric
                </label>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="setFabric('100% Cotton', this)" class="btn-standard btn-secondary fabric-btn">100% Cotton</button>
                    <button onclick="setFabric('50/50', this)" class="btn-standard btn-secondary fabric-btn">50/50 Blend</button>
                </div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <button onclick="setFabric('100% Polyester', this)" class="btn-compact btn-tertiary fabric-btn">Polyester</button>
                    <button onclick="setFabric('Tri-Blend', this)" class="btn-compact btn-tertiary fabric-btn">Tri-Blend</button>
                    <button onclick="setFabric('Denim', this)" class="btn-compact btn-tertiary fabric-btn">Denim</button>
                </div>
                <select id="fabric-other-select" onchange="onFabricOtherChange()" class="form-select text-sm">
                    <option value="" selected>Other fabrics...</option>
                    <option value="Fleece">Fleece</option>
                    <option value="Corduroy">Corduroy</option>
                    <option value="Wool">Wool</option>
                    <option value="Linen">Linen</option>
                    <option value="Rayon">Rayon</option>
                    <option value="Nylon">Nylon</option>
                    <option value="Silk">Silk</option>
                    <option value="Custom">Custom Blend...</option>
                </select>
                
                <div id="custom-blend-section" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                    <label class="text-label font-bold text-blue-700 mb-2 block">Build Your Blend</label>
                    <div class="flex gap-2 mb-2 items-center">
                        <select id="blend-mat-1" onchange="updateBlendPreview()" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-blue-500 bg-white">
                            <option value="">Material 1...</option>
                            <option>Cotton</option><option>Polyester</option><option>Rayon</option><option>Spandex</option><option>Nylon</option><option>Acrylic</option><option>Wool</option><option>Linen</option><option>Modal</option><option>Viscose</option><option>Other</option>
                        </select>
                        <select id="blend-pct-1" onchange="updateBlendPreview()" class="w-20 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-blue-500 bg-white font-bold text-center">
                            <option value="">%</option>
                            <option>5</option><option>10</option><option>15</option><option>20</option><option>25</option><option>30</option><option>35</option><option>40</option><option>45</option><option>50</option><option>55</option><option>60</option><option>65</option><option>70</option><option>75</option><option>80</option><option>85</option><option>90</option><option>95</option>
                        </select>
                    </div>
                    <div class="flex gap-2 mb-2 items-center">
                        <select id="blend-mat-2" onchange="updateBlendPreview()" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-blue-500 bg-white">
                            <option value="">Material 2...</option>
                            <option>Cotton</option><option>Polyester</option><option>Rayon</option><option>Spandex</option><option>Nylon</option><option>Acrylic</option><option>Wool</option><option>Linen</option><option>Modal</option><option>Viscose</option><option>Other</option>
                        </select>
                        <select id="blend-pct-2" onchange="updateBlendPreview()" class="w-20 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-blue-500 bg-white font-bold text-center">
                            <option value="">%</option>
                            <option>5</option><option>10</option><option>15</option><option>20</option><option>25</option><option>30</option><option>35</option><option>40</option><option>45</option><option>50</option><option>55</option><option>60</option><option>65</option><option>70</option><option>75</option><option>80</option><option>85</option><option>90</option><option>95</option>
                        </select>
                    </div>
                    <button onclick="toggleThirdMaterial()" id="btn-add-mat-3" class="text-xs text-blue-600 font-medium mb-2">+ Add 3rd material (tri-blend)</button>
                    <div id="blend-row-3" class="hidden flex gap-2 mb-2 items-center">
                        <select id="blend-mat-3" onchange="updateBlendPreview()" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-blue-500 bg-white">
                            <option value="">Material 3...</option>
                            <option>Cotton</option><option>Polyester</option><option>Rayon</option><option>Spandex</option><option>Nylon</option><option>Acrylic</option><option>Wool</option><option>Linen</option><option>Modal</option><option>Viscose</option><option>Other</option>
                        </select>
                        <select id="blend-pct-3" onchange="updateBlendPreview()" class="w-20 p-2 border border-gray-300 rounded-lg text-sm outline-none focus:border-blue-500 bg-white font-bold text-center">
                            <option value="">%</option>
                            <option>5</option><option>10</option><option>15</option><option>20</option><option>25</option><option>30</option><option>35</option><option>40</option><option>45</option><option>50</option><option>55</option><option>60</option><option>65</option><option>70</option><option>75</option><option>80</option><option>85</option><option>90</option><option>95</option>
                        </select>
                    </div>
                    <div id="blend-preview" class="mt-2 p-2 bg-white rounded-lg border border-blue-300 text-center">
                        <span class="text-sm text-slate-400">Select materials above</span>
                    </div>
                    <input type="hidden" id="fabric-custom" value="">
                </div>
                
                <div id="wash-section" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                    <div class="text-label text-blue-700 font-bold mb-2">Denim Wash</div>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setWash('Light', this)" class="btn-compact btn-tertiary wash-btn">Light</button>
                        <button onclick="setWash('Medium', this)" class="btn-compact btn-tertiary wash-btn">Medium</button>
                        <button onclick="setWash('Dark', this)" class="btn-compact btn-tertiary wash-btn">Dark</button>
                        <button onclick="setWash('Raw', this)" class="btn-compact btn-tertiary wash-btn">Raw</button>
                    </div>
                    <div class="grid grid-cols-4 gap-2 mt-2">
                        <button onclick="setWash('Acid', this)" class="btn-compact btn-tertiary wash-btn">Acid</button>
                        <button onclick="setWash('Stone', this)" class="btn-compact btn-tertiary wash-btn">Stone</button>
                        <button onclick="setWash('Rinse', this)" class="btn-compact btn-tertiary wash-btn">Rinse</button>
                        <button onclick="setWash('Charcoal', this)" class="btn-compact btn-tertiary wash-btn">Charcoal</button>
                    </div>
                </div>
            </section>
            
            <!-- CONSTRUCTION PROFILE (Sleeves + Stitch combined) -->
            <section id="section-construction" class="section-card hidden">
                <label class="section-label">
                    <span id="check-construction" class="check-circle">‚óã</span>
                    Construction Profile
                </label>
                
                <!-- Sleeve Length -->
                <div class="text-label text-slate-400 font-bold mb-2">Sleeve Length</div>
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button onclick="setSleeveType('Short', this)" id="btn-sleeve-short" class="btn-compact btn-tertiary sleeve-type-btn">Short</button>
                    <button onclick="setSleeveType('Long', this)" id="btn-sleeve-long" class="btn-compact btn-tertiary sleeve-type-btn">Long</button>
                    <button onclick="setSleeveType('3/4', this)" id="btn-sleeve-34" class="btn-compact btn-tertiary sleeve-type-btn">3/4</button>
                    <button onclick="setSleeveType('Sleeveless', this)" id="btn-sleeve-none" class="btn-compact btn-tertiary sleeve-type-btn">Sleeveless</button>
                </div>
                
                <!-- Cutoff Section (conditional) -->
                <div id="cutoff-section" class="hidden nested-section nested-section-amber mt-3 mb-3">
                    <label class="nested-label text-amber-700">Is this a cut-off?</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setCutoffType('diy', this)" class="btn-standard btn-tertiary cutoff-btn flex flex-col items-center py-3">
                            <span class="text-xl">‚úÇÔ∏è</span>
                            <span class="text-label font-bold">DIY Cut-off</span>
                        </button>
                        <button onclick="setCutoffType('manufactured', this)" class="btn-standard btn-tertiary cutoff-btn flex flex-col items-center py-3">
                            <span class="text-xl">üè≠</span>
                            <span class="text-label font-bold">Manufactured</span>
                        </button>
                    </div>
                </div>
                
                <!-- Sleeve Style (hidden when sleeveless) -->
                <div id="sleeve-style-section">
                    <div class="text-label text-slate-400 font-bold mb-2">Sleeve Style</div>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <button onclick="setSleeveStyle('Standard', this)" id="btn-style-standard" class="btn-compact btn-tertiary sleeve-style-btn">Standard</button>
                        <button onclick="setSleeveStyle('Raglan', this)" id="btn-style-raglan" class="btn-compact btn-tertiary sleeve-style-btn">Raglan</button>
                        <button onclick="setSleeveStyle('Dolman', this)" id="btn-style-dolman" class="btn-compact btn-tertiary sleeve-style-btn">Dolman</button>
                        <button onclick="setSleeveStyle('Other', this)" id="btn-style-other" class="btn-compact btn-tertiary sleeve-style-btn">Other</button>
                    </div>
                </div>
                
                <!-- Stitch Type (for T-Shirts only) -->
                <div id="stitch-section">
                    <div class="text-label text-slate-400 font-bold mb-2">Stitch Type</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setStitchType('Single', this)" id="btn-stitch-single" class="btn-standard btn-tertiary stitch-btn">Single Stitch</button>
                        <button onclick="setStitchType('Double', this)" id="btn-stitch-double" class="btn-standard btn-tertiary stitch-btn">Double Stitch</button>
                    </div>
                </div>
            </section>
            
            <!-- FABRIC FEEL -->
            <section id="section-feel" class="section-card">
                <label class="section-label">
                    <span id="check-feel" class="check-circle">‚óã</span>
                    Fabric Feel
                </label>
                <div class="text-label text-slate-400 font-bold mb-2">Thickness</div>
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button onclick="setThickness('Paper Thin', this)" class="btn-compact btn-tertiary thickness-btn">Paper</button>
                    <button onclick="setThickness('Light', this)" class="btn-compact btn-tertiary thickness-btn">Light</button>
                    <button onclick="setThickness('Standard', this)" class="btn-compact btn-tertiary thickness-btn">Standard</button>
                    <button onclick="setThickness('Heavy', this)" class="btn-compact btn-tertiary thickness-btn">Heavy</button>
                </div>
                <div class="text-label text-slate-400 font-bold mb-2">Layers</div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setConstruction('Single', this)" class="btn-compact btn-tertiary construction-btn">Single</button>
                    <button onclick="setConstruction('Reversible', this)" class="btn-compact btn-tertiary construction-btn">Reversible</button>
                    <button onclick="setConstruction('Lined', this)" class="btn-compact btn-tertiary construction-btn">Lined</button>
                </div>
            </section>
            
            <div class="flex gap-3">
                <button onclick="goToStep(1)" class="btn-large btn-secondary flex-1">‚Üê Back</button>
                <button onclick="goToStep(3)" class="btn-large btn-hero flex-[2] shadow-lg">Next: Snap ‚Üí</button>
            </div>
        </div>

        <!-- ========== STEP 3: SNAP (V78: Simplified - Photos ‚Üí Issues ‚Üí Measurements ‚Üí Weight) ========== -->
        <div id="step-3" class="step-container space-y-3">
            
            <!-- MAIN PHOTOS -->
            <section id="section-photos" class="section-card">
                <label class="section-label">
                    <span id="check-photos" class="check-circle">‚óã</span>
                    üì∏ Item Photos
                    <span id="photo-count-badge" class="bg-blue-100 text-blue-700 text-label font-bold px-2 py-1 rounded-full ml-auto">0</span>
                </label>
                <div class="flex gap-2 flex-wrap mb-3" id="main-photos-thumbs"></div>
                <button onclick="openCamera('main')" id="add-photo-btn" 
                        class="btn-standard btn-hero w-full shadow-lg flex items-center justify-center gap-2">
                    <span class="text-xl">üì∑</span> ADD PHOTO
                </button>
            </section>
            
            <!-- ISSUES (V78: Simplified with defect type buttons) -->
            <section id="section-issues" class="section-card">
                <label class="section-label">
                    <span id="check-issues" class="check-circle">‚óã</span>
                    Any Issues?
                </label>
                <button onclick="setHasDefects(false, this)" class="btn-large btn-hero defect-toggle-btn w-full mb-3 flex items-center justify-center gap-2">
                    <span class="text-xl">‚úì</span> CLEAN ‚Äî No flaws, no fade
                </button>
                
                <!-- Defect Type Buttons (V78: Simple hero buttons) -->
                <div class="text-label text-slate-500 font-bold mb-2">Or tap defect type to photo:</div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <button onclick="captureDefect('Stain', this)" class="btn-standard btn-secondary defect-type-btn flex flex-col items-center py-3">
                        <span class="text-2xl">üíß</span>
                        <span class="text-label font-bold">Stain</span>
                    </button>
                    <button onclick="captureDefect('Hole', this)" class="btn-standard btn-secondary defect-type-btn flex flex-col items-center py-3">
                        <span class="text-2xl">üï≥Ô∏è</span>
                        <span class="text-label font-bold">Hole</span>
                    </button>
                    <button onclick="captureDefect('Repair', this)" class="btn-standard btn-secondary defect-type-btn flex flex-col items-center py-3">
                        <span class="text-2xl">üßµ</span>
                        <span class="text-label font-bold">Repair</span>
                    </button>
                </div>
                <div id="defect-photos-thumbs" class="flex gap-2 flex-wrap"></div>
            </section>
            
            <!-- FADE LEVEL -->
            <section id="section-fade" class="section-card">
                <label class="section-label">
                    <span id="check-fade" class="check-circle">‚óã</span>
                    Fade Level
                </label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setFade('None', this)" class="btn-compact btn-tertiary fade-btn">None</button>
                    <button onclick="setFade('Light', this)" class="btn-compact btn-tertiary fade-btn">Light</button>
                    <button onclick="setFade('Sun Fade', this)" class="btn-compact btn-tertiary fade-btn">Sun Fade</button>
                    <button onclick="setFade('Heavy', this)" class="btn-compact btn-tertiary fade-btn">Heavy</button>
                </div>
            </section>
            
            <!-- MEASUREMENTS (V78: Vertical bullet list) -->
            <section id="section-measure" class="section-card">
                <label class="section-label">
                    <span id="check-measure" class="check-circle">‚óã</span>
                    üé§ Measurements
                </label>
                <div id="measure-hint" class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-3">
                    <div class="text-xs text-blue-700 font-bold mb-2">Say each + "inches":</div>
                    <ul class="text-xs text-blue-600 space-y-1 list-none">
                        <li>1. Shoulder to shoulder</li>
                        <li>2. Pit to pit chest</li>
                        <li>3. Waist</li>
                        <li>4. Bottom hem</li>
                        <li>5. Length</li>
                        <li>6. Neck to shoulder</li>
                        <li>7. Sleeve (shoulder to cuff)</li>
                        <li>8. Arm opening</li>
                    </ul>
                </div>
                <div id="record-section">
                    <button id="record-btn" onclick="toggleRecording()" 
                            class="w-full py-5 bg-red-500 rounded-2xl text-white font-bold text-lg flex flex-col items-center gap-1 shadow-lg active:scale-[0.98]">
                        <span class="text-2xl">üé§</span>
                        <span>TAP TO RECORD</span>
                    </button>
                </div>
                <div id="post-record-section" class="hidden">
                    <div class="bg-emerald-50 border-2 border-emerald-400 rounded-xl p-4 mb-3">
                        <div class="text-emerald-700 font-bold mb-1 flex items-center gap-2">
                            <span class="text-xl">‚úì</span> RECORDED
                        </div>
                        <div class="text-emerald-600 text-lg font-mono"><span id="recording-duration">0:00</span></div>
                    </div>
                    <button onclick="reRecord()" class="text-slate-500 text-sm underline min-h-[44px]">Re-record</button>
                </div>
            </section>
            
            <!-- WEIGHT -->
            <section id="section-weight" class="section-card">
                <label class="section-label">
                    <span id="check-weight" class="check-circle">‚óã</span>
                    ‚öñÔ∏è Weight
                </label>
                <div class="grid grid-cols-2 gap-2">
                    <select id="weight-lb" onchange="updateWeight()" class="form-select font-bold text-lg">
                        <option value="0" selected>0 lb</option>
                        <option value="1">1 lb</option><option value="2">2 lb</option><option value="3">3 lb</option><option value="4">4 lb</option><option value="5">5 lb</option>
                    </select>
                    <select id="weight-oz" onchange="updateWeight()" class="form-select font-bold text-lg">
                        <option value="0" selected>0 oz</option>
                        <option value="3">3 oz</option><option value="4">4 oz</option><option value="5">5 oz</option><option value="6">6 oz</option><option value="7">7 oz</option><option value="8">8 oz</option><option value="9">9 oz</option><option value="10">10 oz</option><option value="11">11 oz</option><option value="12">12 oz</option><option value="13">13 oz</option><option value="14">14 oz</option><option value="15">15 oz</option>
                    </select>
                </div>
                <div class="mt-2 text-slate-500 text-label">
                    ‚¨ÜÔ∏è <strong>Always round up</strong> ‚Äî 5.2 oz ‚Üí 6 oz, 7.8 oz ‚Üí 8 oz
                </div>
            </section>
            
            <button id="flag-btn" onclick="flagUnusual()" class="flag-btn w-full py-4 text-amber-800 font-bold flex items-center justify-center gap-2">
                ü§î FLAG AS UNUSUAL
            </button>
            
            <div class="flex gap-3">
                <button onclick="goToStep(2)" class="btn-large btn-secondary flex-1">‚Üê Back</button>
                <button onclick="goToStep(4)" class="btn-large btn-hero flex-[2] shadow-lg">Send ‚Üí</button>
            </div>
        </div>

        <!-- ========== STEP 4: SEND ========== -->
        <div id="step-4" class="step-container space-y-3">
            
            <div class="bg-emerald-500 text-white p-4 rounded-xl text-center font-bold shadow-lg">
                ‚ú® Almost done! Quick review
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <div id="card-tag" onclick="goToStep(1)" class="review-card card-yellow">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="icon-tag">‚ö†Ô∏è</span>
                        <span class="font-bold text-sm">TAG</span>
                    </div>
                    <div id="summary-tag" class="text-slate-600 text-label leading-relaxed"></div>
                </div>
                <div id="card-check" onclick="goToStep(2)" class="review-card card-yellow">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="icon-check">‚ö†Ô∏è</span>
                        <span class="font-bold text-sm">CHECK</span>
                    </div>
                    <div id="summary-check" class="text-slate-600 text-label leading-relaxed"></div>
                </div>
                <div id="card-snap" onclick="goToStep(3)" class="review-card card-yellow">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="icon-snap">‚ö†Ô∏è</span>
                        <span class="font-bold text-sm">SNAP</span>
                    </div>
                    <div id="summary-snap" class="text-slate-600 text-label leading-relaxed"></div>
                </div>
                <div id="card-weight" onclick="goToStep(3); setTimeout(() => document.getElementById('section-weight').scrollIntoView({behavior:'smooth',block:'center'}), 200);" class="review-card card-yellow">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="icon-weight">‚ö†Ô∏è</span>
                        <span class="font-bold text-sm">WEIGHT</span>
                    </div>
                    <div id="summary-weight" class="text-slate-600 text-label leading-relaxed"></div>
                </div>
            </div>
            
            <div id="flag-status" class="hidden bg-amber-100 border-2 border-amber-400 rounded-xl p-4 text-amber-800 font-bold text-center">
                üö© FLAGGED FOR REVIEW
            </div>
            
            <button onclick="submitData()" id="submit-btn" 
                    class="w-full py-5 bg-emerald-500 rounded-2xl text-white font-bold text-xl shadow-xl active:scale-[0.98] flex items-center justify-center gap-3">
                SUBMIT <span class="text-2xl">‚úì</span>
            </button>
            <button onclick="goToStep(3)" class="btn-large btn-secondary w-full">‚Üê Back</button>
        </div>

        </div>
    </main>

    <!-- DEFECT MODAL -->
    <div id="defect-modal" class="fixed inset-0 bg-black/80 hidden flex items-end justify-center p-4" style="z-index: var(--z-modal);" onclick="closeDefectModal(event)">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 pb-8 animate-slide-up" onclick="event.stopPropagation()">
            <div class="text-center mb-5">
                <p class="text-label text-slate-400 font-bold tracking-widest uppercase mb-1">WHAT TYPE OF DEFECT?</p>
                <h3 id="zone-label" class="text-lg font-black text-slate-800"></h3>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectDefectType('Stain')" class="defect-stain py-5 rounded-xl font-bold text-lg active:scale-95 shadow-md min-h-[60px]">STAIN</button>
                <button onclick="selectDefectType('Hole')" class="defect-hole py-5 rounded-xl font-bold text-lg active:scale-95 shadow-md min-h-[60px]">HOLE</button>
                <button onclick="selectDefectType('Repair')" class="defect-repair py-5 rounded-xl font-bold text-lg active:scale-95 shadow-md min-h-[60px]">REPAIR</button>
                <button onclick="selectDefectType('Other')" class="defect-other py-5 rounded-xl font-bold text-lg active:scale-95 shadow-md min-h-[60px]">OTHER</button>
            </div>
        </div>
    </div>

    <!-- CAMERA (V76: Added grid + stabilizer + DONE button) -->
    <div id="camera-overlay" class="hidden">
        <video id="cam-feed" autoplay playsinline></video>
        
        <!-- Photo Grid Overlay (Rule of Thirds) -->
        <div id="photo-grid" style="position:absolute;inset:0;pointer-events:none;">
            <div style="position:absolute;top:33.33%;left:0;right:0;height:1px;background:rgba(255,255,255,0.3)"></div>
            <div style="position:absolute;top:66.66%;left:0;right:0;height:1px;background:rgba(255,255,255,0.3)"></div>
            <div style="position:absolute;left:33.33%;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.3)"></div>
            <div style="position:absolute;left:66.66%;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.3)"></div>
            <!-- Center Crosshair -->
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;">
                <div style="position:absolute;top:50%;left:0;right:0;height:1px;background:rgba(255,255,255,0.5)"></div>
                <div style="position:absolute;left:50%;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.5)"></div>
            </div>
        </div>
        
        <!-- Stabilizer Indicator -->
        <div id="stabilizer-indicator" style="position:absolute;top:16px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.6);padding:6px 12px;border-radius:20px;">
            <div id="stabilizer-dot" style="width:12px;height:12px;border-radius:50%;background:#ef4444;transition:background 0.2s ease;"></div>
            <span id="stabilizer-text" style="color:white;font-size:12px;font-weight:700;">HOLD STEADY</span>
        </div>
        
        <div class="cam-controls">
            <div class="text-center mb-5">
                <span id="cam-mode-label" class="text-white font-bold text-base bg-black/60 px-5 py-2 rounded-full"></span>
                <span id="cam-count" class="ml-2 text-white bg-blue-600 px-3 py-2 rounded-full text-sm font-bold">0</span>
            </div>
            <div class="flex items-center justify-center gap-12">
                <button onclick="closeCamera()" class="text-white text-3xl w-14 h-14 flex items-center justify-center rounded-full bg-white/10 active:bg-white/20">‚úï</button>
                <button onclick="capturePhoto()" id="shutter-btn" class="shutter-btn"></button>
                <button onclick="finishPhotos()" class="text-white font-bold w-14 h-14 flex items-center justify-center rounded-full bg-green-600 active:bg-green-700 text-sm">DONE</button>
            </div>
        </div>
    </div>
    
    <!-- PHOTO PREVIEW MODAL (V77: Keep/Retake - Fixed display:none) -->
    <div id="photo-preview-modal" style="position:fixed;inset:0;z-index:65;background:black;display:none;flex-direction:column;">
        <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:16px;">
            <img id="preview-image" src="" alt="Preview" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;">
        </div>
        <div style="background:black;padding:24px;padding-bottom:max(24px, env(safe-area-inset-bottom));">
            <p style="text-align:center;color:#9ca3af;font-size:14px;margin-bottom:16px;"><span id="preview-mode-label" style="color:white;font-weight:700;">MAIN</span> PHOTO</p>
            <div style="display:flex;align-items:center;justify-content:center;gap:24px;">
                <button onclick="rejectPhoto()" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:80px;height:80px;border-radius:50%;background:#dc2626;color:white;font-weight:700;font-size:11px;border:none;">
                    <span style="font-size:24px;margin-bottom:4px;">‚úï</span>RETAKE
                </button>
                <button onclick="acceptPhoto()" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:80px;height:80px;border-radius:50%;background:#16a34a;color:white;font-weight:700;font-size:11px;border:none;">
                    <span style="font-size:24px;margin-bottom:4px;">‚úì</span>KEEP
                </button>
            </div>
        </div>
    </div>

    <canvas id="photo-canvas" class="hidden"></canvas>

    <script>
        // ============ CATEGORY CONFIG (V76: Removed Overalls/Jumpsuit) ============
        const categoryConfig = {
            tops: { heroes: ['T-Shirt', 'Sweatshirt', 'Hoodie'], others: ['Sweater', 'Button Shirt', 'Polo', 'Jersey', 'Tank Top', 'Cardigan', 'Blouse', 'Tunic'] },
            bottoms: { heroes: ['Jeans', 'Pants'], others: ['Shorts', 'Sweatpants'] },
            outer: { heroes: ['Jacket', 'Coat'], others: ['Vest'] }
        };
        const measureMap = { tops:["SHOULDER","PIT-PIT","WAIST","LENGTH","SLEEVE"], bottoms:["WAIST","INSEAM","RISE","LEG"], outer:["SHOULDER","PIT-PIT","LENGTH","SLEEVE"] };

        const SVG_SHORT_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/><rect x="69" y="139" width="140" height="141" fill="#1a1a1a"/><rect x="559" y="139" width="140" height="141" fill="#1a1a1a"/><rect class="zone-hit" data-zone="R-SLEEVE" data-side="front" x="69" y="139" width="140" height="141"/><rect class="zone-hit" data-zone="R-SHOULDER" data-side="front" x="209" y="140" width="140" height="70"/><rect class="zone-hit" data-zone="NECK" data-side="front" x="349" y="140" width="70" height="70"/><rect class="zone-hit" data-zone="L-SHOULDER" data-side="front" x="420" y="140" width="139" height="70"/><rect class="zone-hit" data-zone="L-SLEEVE" data-side="front" x="559" y="139" width="140" height="141"/><rect class="zone-hit" data-zone="R-PIT" data-side="front" x="209" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="R-CHEST" data-side="front" x="279" y="210" width="105" height="139"/><rect class="zone-hit" data-zone="L-CHEST" data-side="front" x="385" y="210" width="105" height="140"/><rect class="zone-hit" data-zone="L-PIT" data-side="front" x="489" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="R-MID" data-side="front" x="209" y="350" width="70" height="207"/><rect class="zone-hit" data-zone="CENTER" data-side="front" x="279" y="349" width="210" height="208"/><rect class="zone-hit" data-zone="L-MID" data-side="front" x="489" y="349" width="70" height="208"/><rect class="zone-hit" data-zone="R-HEM" data-side="front" x="209" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="C-HEM" data-side="front" x="279" y="557" width="210" height="70"/><rect class="zone-hit" data-zone="L-HEM" data-side="front" x="489" y="559" width="70" height="70"/></svg>`;
        const SVG_SHORT_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/><rect x="69" y="139" width="140" height="141" fill="#1a1a1a"/><rect x="559" y="139" width="140" height="141" fill="#1a1a1a"/><rect class="zone-hit" data-zone="L-SLEEVE" data-side="back" x="69" y="139" width="140" height="141"/><rect class="zone-hit" data-zone="L-SHOULDER" data-side="back" x="209" y="140" width="140" height="70"/><rect class="zone-hit" data-zone="NECK" data-side="back" x="349" y="140" width="70" height="70"/><rect class="zone-hit" data-zone="R-SHOULDER" data-side="back" x="420" y="140" width="139" height="70"/><rect class="zone-hit" data-zone="R-SLEEVE" data-side="back" x="559" y="139" width="140" height="141"/><rect class="zone-hit" data-zone="L-PIT" data-side="back" x="209" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="UPPER-BACK" data-side="back" x="279" y="210" width="210" height="140"/><rect class="zone-hit" data-zone="R-PIT" data-side="back" x="489" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="L-MID" data-side="back" x="209" y="350" width="70" height="207"/><rect class="zone-hit" data-zone="LOWER-BACK" data-side="back" x="279" y="349" width="210" height="208"/><rect class="zone-hit" data-zone="R-MID" data-side="back" x="489" y="349" width="70" height="208"/><rect class="zone-hit" data-zone="L-HEM" data-side="back" x="209" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="C-HEM" data-side="back" x="279" y="557" width="210" height="70"/><rect class="zone-hit" data-zone="R-HEM" data-side="back" x="489" y="559" width="70" height="70"/></svg>`;
        const SVG_LONG_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/><rect x="69" y="139" width="141" height="141" fill="#1a1a1a"/><rect x="69" y="279" width="71" height="350" fill="#1a1a1a"/><rect x="140" y="210" width="70" height="70" fill="#1a1a1a"/><rect x="558" y="139" width="141" height="141" fill="#1a1a1a"/><rect x="628" y="279" width="71" height="350" fill="#1a1a1a"/><rect x="558" y="210" width="71" height="70" fill="#1a1a1a"/><rect class="zone-hit" data-zone="R-UP-SLV" data-side="front" x="70" y="140" width="71" height="138"/><rect class="zone-hit" data-zone="R-SHOULDER" data-side="front" x="141" y="140" width="209" height="70"/><rect class="zone-hit" data-zone="NECK" data-side="front" x="349" y="140" width="70" height="70"/><rect class="zone-hit" data-zone="L-SHOULDER" data-side="front" x="420" y="140" width="208" height="70"/><rect class="zone-hit" data-zone="L-UP-SLV" data-side="front" x="628" y="139" width="70" height="141"/><polygon class="zone-hit" data-zone="R-PIT" data-side="front" points="141,210 279,210 279,348 209,348 209,280 141,280"/><rect class="zone-hit" data-zone="R-CHEST" data-side="front" x="279" y="210" width="105" height="139"/><rect class="zone-hit" data-zone="L-CHEST" data-side="front" x="385" y="210" width="105" height="140"/><polygon class="zone-hit" data-zone="L-PIT" data-side="front" points="489,210 489,349 560,349 560,280 629,280 629,210"/><rect class="zone-hit" data-zone="R-MID-SLV" data-side="front" x="70" y="280" width="70" height="278"/><rect class="zone-hit" data-zone="R-MID" data-side="front" x="209" y="350" width="70" height="207"/><rect class="zone-hit" data-zone="CENTER" data-side="front" x="279" y="349" width="210" height="208"/><rect class="zone-hit" data-zone="L-MID" data-side="front" x="489" y="349" width="70" height="208"/><rect class="zone-hit" data-zone="L-MID-SLV" data-side="front" x="628" y="280" width="70" height="278"/><rect class="zone-hit" data-zone="R-CUFF" data-side="front" x="69" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="R-HEM" data-side="front" x="209" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="C-HEM" data-side="front" x="279" y="557" width="210" height="70"/><rect class="zone-hit" data-zone="L-HEM" data-side="front" x="489" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="L-CUFF" data-side="front" x="628" y="558" width="70" height="70"/></svg>`;
        const SVG_LONG_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/><rect x="69" y="139" width="141" height="141" fill="#1a1a1a"/><rect x="69" y="279" width="71" height="350" fill="#1a1a1a"/><rect x="140" y="210" width="70" height="70" fill="#1a1a1a"/><rect x="558" y="139" width="141" height="141" fill="#1a1a1a"/><rect x="628" y="279" width="71" height="350" fill="#1a1a1a"/><rect x="558" y="210" width="71" height="70" fill="#1a1a1a"/><rect class="zone-hit" data-zone="L-UP-SLV" data-side="back" x="70" y="140" width="70" height="138"/><rect class="zone-hit" data-zone="L-SHOULDER" data-side="back" x="141" y="140" width="209" height="70"/><rect class="zone-hit" data-zone="NECK" data-side="back" x="349" y="140" width="70" height="70"/><rect class="zone-hit" data-zone="R-SHOULDER" data-side="back" x="420" y="140" width="209" height="70"/><rect class="zone-hit" data-zone="R-UP-SLV" data-side="back" x="628" y="139" width="70" height="140"/><polygon class="zone-hit" data-zone="L-PIT" data-side="back" points="141,210 279,210 279,349 209,349 209,280 141,280"/><rect class="zone-hit" data-zone="UPPER-BACK" data-side="back" x="279" y="210" width="210" height="140"/><polygon class="zone-hit" data-zone="R-PIT" data-side="back" points="489,210 489,349 560,349 560,280 629,280 629,210"/><rect class="zone-hit" data-zone="L-MID-SLV" data-side="back" x="70" y="279" width="70" height="280"/><rect class="zone-hit" data-zone="L-MID" data-side="back" x="209" y="350" width="70" height="207"/><rect class="zone-hit" data-zone="LOWER-BACK" data-side="back" x="279" y="349" width="210" height="208"/><rect class="zone-hit" data-zone="R-MID" data-side="back" x="489" y="349" width="70" height="208"/><rect class="zone-hit" data-zone="R-MID-SLV" data-side="back" x="629" y="280" width="70" height="278"/><rect class="zone-hit" data-zone="L-CUFF" data-side="back" x="70" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="L-HEM" data-side="back" x="209" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="C-HEM" data-side="back" x="279" y="557" width="210" height="70"/><rect class="zone-hit" data-zone="R-HEM" data-side="back" x="489" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="R-CUFF" data-side="back" x="628" y="559" width="70" height="70"/></svg>`;
        const SVG_SLEEVELESS_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/><rect class="zone-hit" data-zone="R-SHOULDER" data-side="front" x="209" y="140" width="140" height="70"/><rect class="zone-hit" data-zone="NECK" data-side="front" x="349" y="140" width="70" height="70"/><rect class="zone-hit" data-zone="L-SHOULDER" data-side="front" x="420" y="140" width="139" height="70"/><rect class="zone-hit" data-zone="R-PIT" data-side="front" x="209" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="R-CHEST" data-side="front" x="279" y="210" width="105" height="139"/><rect class="zone-hit" data-zone="L-CHEST" data-side="front" x="385" y="210" width="105" height="140"/><rect class="zone-hit" data-zone="L-PIT" data-side="front" x="489" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="R-MID" data-side="front" x="209" y="350" width="70" height="207"/><rect class="zone-hit" data-zone="CENTER" data-side="front" x="279" y="349" width="210" height="208"/><rect class="zone-hit" data-zone="L-MID" data-side="front" x="489" y="349" width="70" height="208"/><rect class="zone-hit" data-zone="R-HEM" data-side="front" x="209" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="C-HEM" data-side="front" x="279" y="557" width="210" height="70"/><rect class="zone-hit" data-zone="L-HEM" data-side="front" x="489" y="559" width="70" height="70"/></svg>`;
        const SVG_SLEEVELESS_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/><rect class="zone-hit" data-zone="L-SHOULDER" data-side="back" x="209" y="140" width="140" height="70"/><rect class="zone-hit" data-zone="NECK" data-side="back" x="349" y="140" width="70" height="70"/><rect class="zone-hit" data-zone="R-SHOULDER" data-side="back" x="420" y="140" width="139" height="70"/><rect class="zone-hit" data-zone="L-PIT" data-side="back" x="209" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="UPPER-BACK" data-side="back" x="279" y="210" width="210" height="140"/><rect class="zone-hit" data-zone="R-PIT" data-side="back" x="489" y="210" width="70" height="139"/><rect class="zone-hit" data-zone="L-MID" data-side="back" x="209" y="350" width="70" height="207"/><rect class="zone-hit" data-zone="LOWER-BACK" data-side="back" x="279" y="349" width="210" height="208"/><rect class="zone-hit" data-zone="R-MID" data-side="back" x="489" y="349" width="70" height="208"/><rect class="zone-hit" data-zone="L-HEM" data-side="back" x="209" y="559" width="70" height="70"/><rect class="zone-hit" data-zone="C-HEM" data-side="back" x="279" y="557" width="210" height="70"/><rect class="zone-hit" data-zone="R-HEM" data-side="back" x="489" y="559" width="70" height="70"/></svg>`;
        const SVG_PANTS_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="140" y="69" width="488" height="141" fill="#1a1a1a"/><rect x="140" y="209" width="210" height="488" fill="#1a1a1a"/><rect x="419" y="209" width="209" height="488" fill="#1a1a1a"/><rect x="347" y="209" width="75" height="72" fill="#1a1a1a"/><rect class="zone-hit" data-zone="R-WAIST" data-side="front" x="140" y="69" width="208" height="70"/><rect class="zone-hit" data-zone="C-WAIST" data-side="front" x="347" y="69" width="72" height="70"/><rect class="zone-hit" data-zone="L-WAIST" data-side="front" x="419" y="70" width="209" height="70"/><rect class="zone-hit" data-zone="R-HIP" data-side="front" x="140" y="140" width="208" height="70"/><rect class="zone-hit" data-zone="FLY" data-side="front" x="348" y="139" width="71" height="70"/><rect class="zone-hit" data-zone="L-HIP" data-side="front" x="419" y="140" width="209" height="70"/><rect class="zone-hit" data-zone="CROTCH" data-side="front" x="347" y="209" width="72" height="72"/><rect class="zone-hit" data-zone="R-THIGH" data-side="front" x="140" y="209" width="210" height="210"/><rect class="zone-hit" data-zone="L-THIGH" data-side="front" x="419" y="209" width="209" height="210"/><rect class="zone-hit" data-zone="R-KNEE" data-side="front" x="140" y="417" width="210" height="72"/><rect class="zone-hit" data-zone="L-KNEE" data-side="front" x="419" y="417" width="209" height="72"/><rect class="zone-hit" data-zone="R-SHIN" data-side="front" x="140" y="489" width="210" height="136"/><rect class="zone-hit" data-zone="L-SHIN" data-side="front" x="419" y="489" width="209" height="136"/><rect class="zone-hit" data-zone="R-OPENING" data-side="front" x="140" y="625" width="210" height="72"/><rect class="zone-hit" data-zone="L-OPENING" data-side="front" x="419" y="625" width="209" height="72"/></svg>`;
        const SVG_PANTS_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="140" y="69" width="488" height="141" fill="#1a1a1a"/><rect x="140" y="209" width="210" height="488" fill="#1a1a1a"/><rect x="419" y="209" width="209" height="488" fill="#1a1a1a"/><rect x="347" y="209" width="75" height="72" fill="#1a1a1a"/><rect class="zone-hit" data-zone="L-WAIST" data-side="back" x="140" y="69" width="208" height="70"/><rect class="zone-hit" data-zone="C-WAIST" data-side="back" x="347" y="69" width="72" height="70"/><rect class="zone-hit" data-zone="R-WAIST" data-side="back" x="419" y="70" width="209" height="70"/><rect class="zone-hit" data-zone="L-POCKET" data-side="back" x="140" y="140" width="140" height="70"/><rect class="zone-hit" data-zone="SEAT" data-side="back" x="281" y="140" width="208" height="72"/><rect class="zone-hit" data-zone="R-POCKET" data-side="back" x="489" y="140" width="139" height="70"/><rect class="zone-hit" data-zone="B-CROTCH" data-side="back" x="347" y="209" width="72" height="72"/><rect class="zone-hit" data-zone="L-HAM" data-side="back" x="140" y="210" width="209" height="210"/><rect class="zone-hit" data-zone="R-HAM" data-side="back" x="419" y="209" width="209" height="210"/><rect class="zone-hit" data-zone="L-B-KNEE" data-side="back" x="140" y="417" width="210" height="72"/><rect class="zone-hit" data-zone="R-B-KNEE" data-side="back" x="419" y="417" width="209" height="72"/><rect class="zone-hit" data-zone="L-CALF" data-side="back" x="140" y="489" width="210" height="136"/><rect class="zone-hit" data-zone="R-CALF" data-side="back" x="419" y="489" width="209" height="136"/><rect class="zone-hit" data-zone="L-OPENING" data-side="back" x="140" y="625" width="210" height="72"/><rect class="zone-hit" data-zone="R-OPENING" data-side="back" x="419" y="625" width="209" height="72"/></svg>`;
        const SVG_SHORTS_FRONT = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="140" y="69" width="488" height="141" fill="#1a1a1a"/><rect x="140" y="209" width="210" height="280" fill="#1a1a1a"/><rect x="419" y="209" width="209" height="280" fill="#1a1a1a"/><rect x="347" y="209" width="75" height="72" fill="#1a1a1a"/><rect class="zone-hit" data-zone="R-WAIST" data-side="front" x="140" y="69" width="208" height="70"/><rect class="zone-hit" data-zone="C-WAIST" data-side="front" x="347" y="69" width="72" height="70"/><rect class="zone-hit" data-zone="L-WAIST" data-side="front" x="419" y="70" width="209" height="70"/><rect class="zone-hit" data-zone="R-HIP" data-side="front" x="140" y="140" width="208" height="70"/><rect class="zone-hit" data-zone="FLY" data-side="front" x="348" y="139" width="71" height="70"/><rect class="zone-hit" data-zone="L-HIP" data-side="front" x="419" y="140" width="209" height="70"/><rect class="zone-hit" data-zone="CROTCH" data-side="front" x="347" y="209" width="72" height="72"/><rect class="zone-hit" data-zone="R-THIGH" data-side="front" x="140" y="209" width="210" height="210"/><rect class="zone-hit" data-zone="L-THIGH" data-side="front" x="419" y="209" width="209" height="210"/><rect class="zone-hit" data-zone="R-OPENING" data-side="front" x="140" y="417" width="210" height="72"/><rect class="zone-hit" data-zone="L-OPENING" data-side="front" x="419" y="417" width="209" height="72"/></svg>`;
        const SVG_SHORTS_BACK = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet"><rect x="140" y="69" width="488" height="141" fill="#1a1a1a"/><rect x="140" y="209" width="210" height="280" fill="#1a1a1a"/><rect x="419" y="209" width="209" height="280" fill="#1a1a1a"/><rect x="347" y="209" width="75" height="72" fill="#1a1a1a"/><rect class="zone-hit" data-zone="L-WAIST" data-side="back" x="140" y="69" width="208" height="70"/><rect class="zone-hit" data-zone="C-WAIST" data-side="back" x="347" y="69" width="72" height="70"/><rect class="zone-hit" data-zone="R-WAIST" data-side="back" x="419" y="70" width="209" height="70"/><rect class="zone-hit" data-zone="L-POCKET" data-side="back" x="140" y="140" width="140" height="70"/><rect class="zone-hit" data-zone="SEAT" data-side="back" x="281" y="140" width="208" height="72"/><rect class="zone-hit" data-zone="R-POCKET" data-side="back" x="489" y="140" width="139" height="70"/><rect class="zone-hit" data-zone="B-CROTCH" data-side="back" x="347" y="209" width="72" height="72"/><rect class="zone-hit" data-zone="L-HAM" data-side="back" x="140" y="210" width="209" height="210"/><rect class="zone-hit" data-zone="R-HAM" data-side="back" x="419" y="209" width="209" height="210"/><rect class="zone-hit" data-zone="L-OPENING" data-side="back" x="140" y="417" width="210" height="72"/><rect class="zone-hit" data-zone="R-OPENING" data-side="back" x="418" y="417" width="209" height="72"/></svg>`;

        const quickRewards = [
            { emoji:"‚ö°", text:"Lightning Fast!", sub:"Crushing it!" },
            { emoji:"üéØ", text:"Precision!", sub:"All fields complete" },
            { emoji:"üî•", text:"On Fire!", sub:"Keep it going" },
            { emoji:"üí™", text:"Strong Work!", sub:"Looking good" }
        ];

        // ============ STATE ============
        let currentStep = 1, pendingDefect = null, qrScanner = null, mediaRecorder = null, audioChunks = [], isRecording = false, recordingStart = null;
        let cameraStream = null, cameraMode = null, cameraSubType = null;
        let itemStartTime = null, timerInterval = null;
        let stats = { itemsToday: 0, totalTime: 0, streak: 1, lastDate: null, bestTime: null };
        let pendingPhoto = null;
        let isStable = false;
        let lastMotion = { x: 0, y: 0, z: 0 };

        const data = {
            superCategory: 'tops', category: '', sku: '',
            tagStatus: '', tagSize: '', gender: '',
            origin: 'usa', madeInCountry: 'USA',
            fabric: '', wash: '', colorPrimary: '', colorSecondary: '',
            pattern: '', printType: '', graphicCategory: '',
            sleeveType: '', sleeveStyle: '', thickness: '', construction: '',
            isCutoff: false, cutoffType: '', stitchType: '', // V78: New fields
            hasDefects: null, fadeLevel: '',
            flagged: false,
            mainPhotos: [], tagPhotos: [], defectPhotos: [],
            audioMeasure: null, audioDuration: 0,
            itemWeightLb: 0, itemWeightOz: 0, itemWeightTotalOz: 0,
            photographer: 'P02', timestamps: {}
        };

        const stepLabels = ['', 'Tag', 'Check', 'Snap', 'Send'];

        // ============ HAPTIC ============
        function haptic(type = 'light') {
            if (!navigator.vibrate) return;
            const patterns = { light: 10, medium: [10, 30, 10], success: [10, 50, 10, 50, 10], error: 100, celebration: [50, 100, 50, 100, 50] };
            navigator.vibrate(patterns[type] || 10);
        }

        // ============ CELEBRATION ============
        function celebrate(emoji, text, sub = '') {
            haptic('celebration');
            const el = document.getElementById('celebration');
            document.getElementById('celebration-emoji').textContent = emoji;
            document.getElementById('celebration-text').textContent = text;
            document.getElementById('celebration-sub').textContent = sub;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2500);
        }

        function maybeQuickReward() {
            if (Math.random() < 0.15) {
                const r = quickRewards[Math.floor(Math.random() * quickRewards.length)];
                setTimeout(() => celebrate(r.emoji, r.text, r.sub), 300);
            }
        }

        function scanFlash() {
            const el = document.getElementById('scan-flash');
            el.classList.add('flash');
            setTimeout(() => el.classList.remove('flash'), 350);
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => { 
            data.timestamps.start = new Date().toISOString();
            lucide.createIcons();
            loadStats();
            try {
                const savedPin = localStorage.getItem('vl_auth');
                const savedPhotographer = localStorage.getItem('vl_photographer');
                if (savedPin === APP_PIN) document.getElementById('login-screen').classList.add('hidden');
                if (savedPhotographer) { 
                    data.photographer = savedPhotographer; 
                    document.getElementById('photographer-select').value = savedPhotographer; 
                    document.getElementById('photographer-badge').innerText = savedPhotographer; 
                }
            } catch(e) {}
            updateStatsDisplay();
            applySmartDefaults();
            showMotivation();
        });

        function applySmartDefaults() {
            data.thickness = 'Standard';
            data.construction = 'Single';
            data.sleeveType = 'Short';
            data.sleeveStyle = 'Standard';
            data.pattern = 'Solid';
            data.hasDefects = false;
            data.fadeLevel = 'None';
            data.origin = 'usa';
            data.madeInCountry = 'USA';
        }

        function loadStats() {
            try {
                const saved = JSON.parse(localStorage.getItem('vl_stats_v78') || '{}');
                const today = new Date().toDateString();
                if (saved.lastDate === today) { stats = saved; }
                else {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    stats.streak = saved.lastDate === yesterday ? (saved.streak || 0) + 1 : 1;
                    stats.itemsToday = 0; stats.totalTime = 0; stats.lastDate = today;
                    stats.bestTime = saved.bestTime || null;
                }
            } catch(e) { stats = { itemsToday: 0, totalTime: 0, streak: 1, lastDate: new Date().toDateString(), bestTime: null }; }
        }

        function saveStats() { try { localStorage.setItem('vl_stats_v78', JSON.stringify(stats)); } catch(e) {} }

        function updateStatsDisplay() {
            document.getElementById('streak-count').textContent = stats.streak;
            document.getElementById('items-today').textContent = stats.itemsToday;
            document.getElementById('avg-time').textContent = stats.itemsToday > 0 ? formatTime(Math.round(stats.totalTime / stats.itemsToday)) : '--';
        }

        function showMotivation() {
            const banner = document.getElementById('motivation-banner');
            const milestones = [10, 25, 50, 75, 100];
            const next = milestones.find(m => m > stats.itemsToday);
            if (next && stats.itemsToday >= next - 3) {
                banner.textContent = `üéØ ${next - stats.itemsToday} more to hit ${next}!`;
                banner.classList.remove('hidden');
            }
        }

        // ============ TIMER ============
        function startTimer() {
            if (itemStartTime) return;
            itemStartTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.round((Date.now() - itemStartTime) / 1000);
                document.getElementById('current-timer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const elapsed = itemStartTime ? Math.round((Date.now() - itemStartTime) / 1000) : 0;
            itemStartTime = null;
            document.getElementById('current-timer').textContent = '0:00';
            return elapsed;
        }

        // ============ AUTH ============
        function checkPin() {
            if(document.getElementById('pin-input').value === APP_PIN) {
                haptic('success');
                try {
                    localStorage.setItem('vl_auth', APP_PIN);
                    const photographer = document.getElementById('photographer-select').value;
                    localStorage.setItem('vl_photographer', photographer);
                    data.photographer = photographer;
                    document.getElementById('photographer-badge').innerText = photographer;
                } catch(e) {}
                document.getElementById('login-screen').classList.add('hidden');
            } else {
                haptic('error');
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').classList.add('shake');
                document.getElementById('pin-input').style.borderColor = '#ef4444';
                setTimeout(() => { document.getElementById('pin-input').classList.remove('shake'); document.getElementById('pin-input').style.borderColor = ''; }, 500);
            }
        }

        function showPhotographerChange() {
            const newP = prompt(`Current: ${data.photographer}\nEnter code (P01, P02, P03):`, data.photographer);
            if (newP && ['P01','P02','P03'].includes(newP.toUpperCase())) {
                data.photographer = newP.toUpperCase();
                document.getElementById('photographer-badge').innerText = data.photographer;
                try { localStorage.setItem('vl_photographer', data.photographer); } catch(e) {}
                haptic('light');
            }
        }

        // ============ SECTION COMPLETION ============
        function completeSection(section) {
            const checkEl = document.getElementById(`check-${section}`);
            if (checkEl && !checkEl.classList.contains('complete')) {
                checkEl.innerHTML = '‚úì';
                checkEl.classList.add('complete', 'just-completed');
                haptic('medium');
                setTimeout(() => checkEl.classList.remove('just-completed'), 400);
            }
        }

        function updateAllChecks() {
            // V78: Construction check combines sleeve + stitch
            const needsStitch = data.category === 'T-Shirt' || data.category === 'Jersey';
            const constructionOk = data.superCategory === 'bottoms' || (
                !!data.sleeveType && 
                (data.sleeveType === 'Sleeveless' || !!data.sleeveStyle) &&
                (!needsStitch || !!data.stitchType)
            );
            
            const checks = {
                category: !!data.category,
                sku: !!data.sku,
                tag: !!data.tagStatus,
                fabric: !!data.fabric,
                color: !!data.colorPrimary,
                pattern: data.fabric === 'Denim' || !!data.pattern,
                construction: constructionOk,
                feel: !!data.thickness && !!data.construction,
                issues: data.hasDefects !== null,
                fade: !!data.fadeLevel,
                photos: data.mainPhotos.length > 0,
                measure: !!data.audioMeasure,
                weight: data.itemWeightTotalOz > 0
            };
            Object.entries(checks).forEach(([key, complete]) => {
                const el = document.getElementById(`check-${key}`);
                if (el) { el.innerHTML = complete ? '‚úì' : '‚óã'; el.classList.toggle('complete', complete); }
            });
            const photoCount = data.mainPhotos.length + data.tagPhotos.length + data.defectPhotos.length;
            document.getElementById('photo-count-badge').textContent = photoCount;
            const photoBtn = document.getElementById('add-photo-btn');
            if (currentStep === 3 && data.mainPhotos.length === 0) photoBtn.classList.add('needs-attention');
            else photoBtn.classList.remove('needs-attention');
        }

        function autoScroll(sectionId) {
            // V78: Auto-scroll disabled per user request
        }

        // ============ NAVIGATION ============
        function goToStep(step) {
            if(step === currentStep) return;
            haptic('light');
            
            // V76: Track timestamps for KPI
            if (currentStep === 1 && step > 1) data.timestamps.step1_complete = new Date().toISOString();
            if (currentStep === 2 && step > 2) data.timestamps.step2_complete = new Date().toISOString();
            if (currentStep === 3 && step > 3) data.timestamps.step3_complete = new Date().toISOString();
            
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
            updateProgressBar(step);
            document.getElementById('step-label').textContent = stepLabels[step];
            // V78: Show construction profile for tops and outer (not bottoms)
            if(step===2) { document.getElementById('section-construction').classList.toggle('hidden', data.superCategory === 'bottoms'); }
            if(step===3) { initDefectSection(); updateMeasureHint(); renderPhotoThumbs(); }
            if(step===4) { updateReviewCards(); }
            window.scrollTo({ top: 0, behavior: 'smooth' });
            updateAllChecks();
        }

        function updateProgressBar(step) {
            for(let i=1;i<=4;i++) { const d=document.getElementById(`dot-${i}`); d.classList.remove('completed','current','pending'); d.classList.add(i<step?'completed':i===step?'current':'pending'); }
            for(let i=1;i<=3;i++) { const l=document.getElementById(`line-${i}`); l.classList.remove('completed','pending'); l.classList.add(i<step?'completed':'pending'); }
        }

        // ============ STEP 1: TAG ============
        function setSuperCategory(cat, btn) {
            haptic('medium');
            data.superCategory = cat;
            document.querySelectorAll('.super-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); });
            btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary');
            
            const config = categoryConfig[cat];
            const heroDiv = document.getElementById('hero-cats');
            const otherDiv = document.getElementById('other-cats-grid');
            
            heroDiv.innerHTML = config.heroes.map((c, i) => 
                i === 0 ? `<button onclick="setCategory('${c}', this)" class="cat-hero cat-btn w-full py-4 mb-2 flex items-center justify-center gap-2"><span class="text-2xl">${getCatEmoji(c)}</span> ${c.toUpperCase()}</button>` : ''
            ).join('') + `<div class="grid grid-cols-2 gap-2">${config.heroes.slice(1).map(c => 
                `<button onclick="setCategory('${c}', this)" class="cat-secondary cat-btn py-3 flex items-center justify-center gap-1"><span>${getCatEmoji(c)}</span> ${c}</button>`
            ).join('')}</div>`;
            
            otherDiv.innerHTML = config.others.map(c => 
                `<button onclick="setCategory('${c}', this)" class="btn-compact btn-tertiary cat-btn">${c}</button>`
            ).join('');
            
            document.getElementById('sub-category-heroes').classList.remove('hidden');
            document.getElementById('other-cats').classList.remove('hidden');
            document.getElementById('other-cats-grid').classList.add('hidden');
            document.getElementById('other-cats-toggle').textContent = '+ Other types';
            completeSection('category');
        }

        function getCatEmoji(cat) {
            const emojis = { 'T-Shirt':'üëï', 'Sweatshirt':'üèãÔ∏è', 'Hoodie':'üéΩ', 'Sweater':'üß∂', 'Button Shirt':'üëî', 'Polo':'üèåÔ∏è', 'Jersey':'üèÄ', 'Tank Top':'ü©±', 'Cardigan':'üß•', 'Jeans':'üëñ', 'Pants':'üëñ', 'Shorts':'ü©≥', 'Sweatpants':'üèÉ', 'Jacket':'üß•', 'Coat':'üß•', 'Vest':'ü¶∫', 'Blouse':'üëö', 'Tunic':'üëó' };
            return emojis[cat] || 'üëï';
        }

        function toggleOtherCats() {
            const grid = document.getElementById('other-cats-grid');
            const toggle = document.getElementById('other-cats-toggle');
            if (grid.classList.contains('hidden')) { grid.classList.remove('hidden'); toggle.textContent = '‚àí Hide others'; }
            else { grid.classList.add('hidden'); toggle.textContent = '+ Other types'; }
        }

        function setCategory(cat, btn) {
            haptic('light');
            data.category = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // V78: Configure construction profile defaults based on category
            applyConstructionDefaults(cat);
            
            // V78: Update pattern hero buttons based on category
            updatePatternHeroes(cat);
            
            autoScroll('section-sku');
        }
        
        // V78: Apply construction profile defaults based on category
        function applyConstructionDefaults(cat) {
            // Reset all buttons to tertiary
            document.querySelectorAll('.sleeve-type-btn, .sleeve-style-btn, .stitch-btn').forEach(b => {
                b.classList.remove('btn-default', 'btn-hero', 'btn-secondary', 'selected', 'confirmed');
                b.classList.add('btn-tertiary');
            });
            
            // Define defaults by category
            const defaults = {
                'T-Shirt': { sleeveLength: 'Short', sleeveStyle: 'Standard', stitch: 'Single', showStitch: true },
                'Jersey': { sleeveLength: 'Short', sleeveStyle: 'Standard', stitch: 'Single', showStitch: true },
                'Sweatshirt': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Hoodie': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Button Shirt': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Polo': { sleeveLength: 'Short', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Sweater': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Cardigan': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Tank Top': { sleeveLength: 'Sleeveless', sleeveStyle: null, stitch: null, showStitch: false },
                'Vest': { sleeveLength: 'Sleeveless', sleeveStyle: null, stitch: null, showStitch: false },
                'Jacket': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Coat': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Blouse': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
                'Tunic': { sleeveLength: 'Long', sleeveStyle: 'Standard', stitch: null, showStitch: false },
            };
            
            const def = defaults[cat] || { sleeveLength: 'Short', sleeveStyle: 'Standard', stitch: null, showStitch: false };
            
            // Apply sleeve length default (light blue dashed = needs confirmation)
            const sleeveBtnMap = { 'Short': 'btn-sleeve-short', 'Long': 'btn-sleeve-long', '3/4': 'btn-sleeve-34', 'Sleeveless': 'btn-sleeve-none' };
            if (def.sleeveLength && sleeveBtnMap[def.sleeveLength]) {
                const sleeveBtn = document.getElementById(sleeveBtnMap[def.sleeveLength]);
                if (sleeveBtn) {
                    sleeveBtn.classList.remove('btn-tertiary');
                    sleeveBtn.classList.add('btn-default');
                }
            }
            
            // Apply sleeve style default
            const styleBtnMap = { 'Standard': 'btn-style-standard', 'Raglan': 'btn-style-raglan', 'Dolman': 'btn-style-dolman', 'Other': 'btn-style-other' };
            if (def.sleeveStyle && styleBtnMap[def.sleeveStyle]) {
                const styleBtn = document.getElementById(styleBtnMap[def.sleeveStyle]);
                if (styleBtn) {
                    styleBtn.classList.remove('btn-tertiary');
                    styleBtn.classList.add('btn-default');
                }
            }
            
            // Show/hide sleeve style section based on sleeveless
            const styleSection = document.getElementById('sleeve-style-section');
            if (styleSection) {
                styleSection.classList.toggle('hidden', def.sleeveLength === 'Sleeveless');
            }
            
            // Show/hide stitch section (only for T-Shirts and Jerseys)
            const stitchSection = document.getElementById('stitch-section');
            if (stitchSection) {
                stitchSection.classList.toggle('hidden', !def.showStitch);
            }
            
            // Apply stitch default
            if (def.stitch) {
                const stitchBtn = document.getElementById(def.stitch === 'Single' ? 'btn-stitch-single' : 'btn-stitch-double');
                if (stitchBtn) {
                    stitchBtn.classList.remove('btn-tertiary');
                    stitchBtn.classList.add('btn-default');
                }
            }
        }
        
        // V78: Update pattern hero buttons based on category
        function updatePatternHeroes(cat) {
            const heroContainer = document.getElementById('pattern-heroes');
            let heroHTML = '';
            
            if (cat === 'T-Shirt' || cat === 'Jersey') {
                // T-Shirts: Graphic is default (needs confirmation)
                heroHTML = `
                    <button onclick="setPattern('Graphic', this)" class="btn-standard btn-default pattern-btn">üé® Graphic</button>
                    <button onclick="setPattern('Solid', this)" class="btn-standard btn-tertiary pattern-btn">Solid</button>
                `;
            } else if (cat === 'Button Shirt') {
                // Button shirts: Solid is default
                heroHTML = `
                    <button onclick="setPattern('Solid', this)" class="btn-standard btn-default pattern-btn">Solid</button>
                    <button onclick="setPattern('Plaid', this)" class="btn-standard btn-tertiary pattern-btn">Plaid</button>
                `;
            } else if (cat === 'Sweatshirt' || cat === 'Hoodie') {
                // Sweatshirts/Hoodies: Solid is default
                heroHTML = `
                    <button onclick="setPattern('Solid', this)" class="btn-standard btn-default pattern-btn">Solid</button>
                    <button onclick="setPattern('Color Block', this)" class="btn-standard btn-tertiary pattern-btn">Color Block</button>
                `;
            } else if (cat === 'Jacket' || cat === 'Coat' || cat === 'Vest') {
                // Outerwear: Solid is default
                heroHTML = `
                    <button onclick="setPattern('Solid', this)" class="btn-standard btn-default pattern-btn">Solid</button>
                    <button onclick="setPattern('Camo', this)" class="btn-standard btn-tertiary pattern-btn">Camo</button>
                `;
            } else {
                // Default: Solid is default
                heroHTML = `
                    <button onclick="setPattern('Solid', this)" class="btn-standard btn-default pattern-btn">Solid</button>
                    <button onclick="setPattern('Graphic', this)" class="btn-standard btn-tertiary pattern-btn">üé® Graphic</button>
                `;
            }
            heroContainer.innerHTML = heroHTML;
        }

        function onSkuInput() { 
            data.sku = document.getElementById('sku-input').value;
            if (data.sku && !itemStartTime) { startTimer(); scanFlash(); haptic('success'); data.scanTime = new Date(); }
            if (data.sku) { completeSection('sku'); autoScroll('section-tag'); }
        }

        function toggleScanner() { const v = document.getElementById('scanner-view'); if(v.classList.contains('hidden')) { v.classList.remove('hidden'); startScanner(); } else { v.classList.add('hidden'); stopScanner(); } }
        function startScanner() { if(!qrScanner) qrScanner = new Html5Qrcode("reader"); qrScanner.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:100}}, t => { document.getElementById('sku-input').value = t; data.sku = t; startTimer(); scanFlash(); haptic('success'); data.scanTime = new Date(); toggleScanner(); completeSection('sku'); autoScroll('section-tag'); }, () => {}).catch(e => console.error(e)); }
        function stopScanner() { if(qrScanner?.isScanning) qrScanner.stop().catch(e => console.error(e)); }

        function setTagStatus(status, btn) {
            haptic('medium');
            data.tagStatus = status;
            document.querySelectorAll('.tag-status-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); });
            btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary');
            document.getElementById('tag-size-section').classList.toggle('hidden', status !== 'has');
            document.getElementById('origin-section').classList.remove('hidden');
            document.getElementById('tag-gender-section').classList.remove('hidden');
            completeSection('tag');
        }

        function setTagSize(size, btn) { haptic('light'); data.tagSize = size; document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); document.getElementById('tag-size-input').value = ''; }
        function clearSizeBtns() { document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); }
        function onCustomSizeInput() { data.tagSize = document.getElementById('tag-size-input').value; clearSizeBtns(); }

        function setOrigin(type, btn) {
            haptic('light');
            data.origin = type;
            document.querySelectorAll('.origin-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); });
            btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary');
            document.getElementById('country-select').classList.toggle('hidden', type === 'usa');
            data.madeInCountry = type === 'usa' ? 'USA' : '';
        }

        function setGender(g, btn) { haptic('light'); data.gender = g; document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }

        // ============ STEP 2: CHECK ============
        function setFabric(fabric, btn) {
            haptic('light');
            data.fabric = fabric;
            document.querySelectorAll('.fabric-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-secondary'); b.classList.add('btn-tertiary'); });
            if (btn) { btn.classList.add('selected','btn-secondary'); btn.classList.remove('btn-tertiary'); }
            document.getElementById('fabric-other-select').value = '';
            document.getElementById('fabric-custom').classList.add('hidden');
            // V76: Show wash section when Denim
            document.getElementById('wash-section').classList.toggle('hidden', fabric !== 'Denim');
            if (fabric !== 'Denim') data.wash = '';
            completeSection('fabric');
            autoScroll('section-color');
        }
        
        function onFabricOtherChange() {
            const val = document.getElementById('fabric-other-select').value;
            if (!val) return;
            haptic('light');
            data.fabric = val;
            document.querySelectorAll('.fabric-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-secondary'); b.classList.add('btn-tertiary'); });
            // Show custom blend builder
            document.getElementById('custom-blend-section').classList.toggle('hidden', val !== 'Custom');
            document.getElementById('wash-section').classList.add('hidden');
            data.wash = '';
            completeSection('fabric');
            autoScroll('section-color');
        }
        
        // V78: Custom blend builder functions
        function toggleThirdMaterial() {
            const row = document.getElementById('blend-row-3');
            const btn = document.getElementById('btn-add-mat-3');
            row.classList.toggle('hidden');
            btn.textContent = row.classList.contains('hidden') ? '+ Add 3rd material (tri-blend)' : '- Remove 3rd material';
            updateBlendPreview();
        }
        
        function updateBlendPreview() {
            const m1 = document.getElementById('blend-mat-1').value;
            const p1 = document.getElementById('blend-pct-1').value;
            const m2 = document.getElementById('blend-mat-2').value;
            const p2 = document.getElementById('blend-pct-2').value;
            const m3 = document.getElementById('blend-mat-3').value;
            const p3 = document.getElementById('blend-pct-3').value;
            
            let parts = [];
            let total = 0;
            if (m1 && p1) { parts.push(`${p1}% ${m1}`); total += parseInt(p1); }
            if (m2 && p2) { parts.push(`${p2}% ${m2}`); total += parseInt(p2); }
            if (m3 && p3 && !document.getElementById('blend-row-3').classList.contains('hidden')) { 
                parts.push(`${p3}% ${m3}`); total += parseInt(p3); 
            }
            
            const preview = document.getElementById('blend-preview');
            if (parts.length > 0) {
                const isValid = total === 100;
                preview.innerHTML = `<span class="text-sm font-bold text-slate-700">${parts.join(' / ')}</span>
                    <span class="block text-xs ${isValid ? 'text-green-600' : 'text-amber-600'}">${isValid ? '‚úì 100%' : `Total: ${total}% (should be 100%)`}</span>`;
                document.getElementById('fabric-custom').value = parts.join(' / ');
            } else {
                preview.innerHTML = '<span class="text-sm text-slate-400">Select materials above</span>';
                document.getElementById('fabric-custom').value = '';
            }
        }
        
        function setWash(wash, btn) {
            haptic('light');
            data.wash = wash;
            document.querySelectorAll('.wash-btn').forEach(b => { b.classList.remove('selected','btn-secondary'); b.classList.add('btn-tertiary'); });
            btn.classList.add('selected','btn-secondary'); btn.classList.remove('btn-tertiary');
        }
        
        function setColor(color, element) {
            haptic('light');
            data.colorPrimary = color;
            // V78: Handle both old color-swatch and new color-item
            document.querySelectorAll('.color-item').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.color-swatch').forEach(b => b.classList.remove('selected'));
            // Find the color-item parent if clicked on swatch directly
            const colorItem = element.classList.contains('color-item') ? element : element.closest('.color-item');
            if (colorItem) colorItem.classList.add('selected');
            else if (element.classList.contains('color-swatch')) element.classList.add('selected');
            document.getElementById('selected-color').textContent = color;
            completeSection('color');
        }
        
        function setSecondaryColor(color, btn) {
            haptic('light');
            data.colorSecondary = color;
            document.querySelectorAll('.color-swatch-sm').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        
        // V78: Secondary color from dropdown
        function setSecondaryColorFromDropdown() {
            const val = document.getElementById('secondary-color-select').value;
            if (val) {
                haptic('light');
                data.colorSecondary = val;
            }
        }
        
        function toggleSecondaryColor() {
            const sec = document.getElementById('secondary-color-section');
            const btn = document.getElementById('add-color-btn');
            sec.classList.toggle('hidden');
            btn.classList.add('hidden');
        }
        
        // V78: Toggle other patterns
        function toggleOtherPatterns() {
            const others = document.getElementById('pattern-others');
            const btn = document.getElementById('other-patterns-toggle');
            others.classList.toggle('hidden');
            btn.textContent = others.classList.contains('hidden') ? '+ Other patterns' : '- Hide other patterns';
        }

        function setPattern(pat, btn) { 
            haptic('light'); 
            data.pattern = pat; 
            document.querySelectorAll('.pattern-btn').forEach(b => { b.classList.remove('selected','btn-hero','confirmed'); b.classList.add('btn-tertiary'); }); 
            btn.classList.add('selected','btn-hero','confirmed'); btn.classList.remove('btn-tertiary');
            completeSection('pattern');
        }

        // V78: Updated setSleeveType with cutoff section for T-Shirts
        function setSleeveType(type, btn) { 
            haptic('light'); 
            data.sleeveType = type; 
            // Remove default/tertiary, add confirmed (solid blue)
            document.querySelectorAll('.sleeve-type-btn').forEach(b => { 
                b.classList.remove('selected','btn-secondary','btn-default','confirmed'); 
                b.classList.add('btn-tertiary'); 
            }); 
            btn.classList.add('selected','confirmed'); 
            btn.classList.remove('btn-tertiary','btn-default'); 
            
            // Show/hide sleeve style section
            const showStyle = type !== 'Sleeveless';
            document.getElementById('sleeve-style-section').classList.toggle('hidden', !showStyle);
            if (!showStyle) { data.sleeveStyle = 'N/A'; } 
            else if (data.sleeveStyle === 'N/A') { data.sleeveStyle = ''; }
            
            // V78: Show cutoff section for T-Shirt + Sleeveless
            const showCutoff = type === 'Sleeveless' && data.category === 'T-Shirt';
            document.getElementById('cutoff-section').classList.toggle('hidden', !showCutoff);
            if (!showCutoff) { data.isCutoff = false; data.cutoffType = ''; }
            
            checkConstructionComplete();
        }
        
        function setSleeveStyle(style, btn) {
            haptic('light');
            data.sleeveStyle = style;
            document.querySelectorAll('.sleeve-style-btn').forEach(b => { 
                b.classList.remove('selected','btn-secondary','btn-default','confirmed'); 
                b.classList.add('btn-tertiary'); 
            });
            btn.classList.add('selected','confirmed'); 
            btn.classList.remove('btn-tertiary','btn-default');
            checkConstructionComplete();
        }
        
        // V78: Cutoff type for sleeveless T-Shirts
        function setCutoffType(type, btn) {
            haptic('light');
            data.isCutoff = type === 'diy';
            data.cutoffType = type;
            document.querySelectorAll('.cutoff-btn').forEach(b => { b.classList.remove('selected','btn-hero','confirmed'); b.classList.add('btn-tertiary'); });
            btn.classList.add('selected','confirmed'); btn.classList.remove('btn-tertiary');
        }
        
        // V78: Stitch type for T-Shirts (single vs double)
        function setStitchType(type, btn) {
            haptic('light');
            data.stitchType = type;
            document.querySelectorAll('.stitch-btn').forEach(b => { 
                b.classList.remove('selected','btn-hero','btn-secondary','btn-default','confirmed'); 
                b.classList.add('btn-tertiary'); 
            });
            btn.classList.add('selected','confirmed'); 
            btn.classList.remove('btn-tertiary','btn-default');
            checkConstructionComplete();
        }
        
        // V78: Check if construction profile is complete
        function checkConstructionComplete() {
            const needsStitch = data.category === 'T-Shirt' || data.category === 'Jersey';
            const sleeveOk = !!data.sleeveType;
            const styleOk = data.sleeveType === 'Sleeveless' || !!data.sleeveStyle;
            const stitchOk = !needsStitch || !!data.stitchType;
            
            if (sleeveOk && styleOk && stitchOk) {
                completeSection('construction');
            }
        }
        
        function setThickness(t, btn) { haptic('light'); data.thickness = t; document.querySelectorAll('.thickness-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-secondary'); b.classList.add('btn-tertiary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-tertiary'); completeSection('feel'); }
        function setConstruction(c, btn) { haptic('light'); data.construction = c; document.querySelectorAll('.construction-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-secondary'); b.classList.add('btn-tertiary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-tertiary'); completeSection('feel'); }

        // ============ STEP 3: SNAP ============
        function setHasDefects(has, btn) { 
            haptic('medium'); 
            data.hasDefects = has;
            document.querySelectorAll('.defect-toggle-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary');
            completeSection('issues');
        }
        
        // V78: Simplified defect capture - opens camera directly
        function captureDefect(defectType, btn) {
            haptic('medium');
            data.hasDefects = true;
            // Mark the clean button as unselected
            document.querySelectorAll('.defect-toggle-btn').forEach(b => { 
                b.classList.remove('selected','btn-hero'); 
                b.classList.add('btn-secondary'); 
            });
            // Store the defect type and open camera
            pendingDefect = { type: defectType, zone: 'general', side: 'front' };
            cameraMode = 'defect';
            openCamera('defect');
            completeSection('issues');
        }

        function setFade(level, btn) { 
            haptic('light'); 
            data.fadeLevel = level; 
            document.querySelectorAll('.fade-btn').forEach(b => { b.classList.remove('selected','btn-secondary'); b.classList.add('btn-tertiary'); }); 
            btn.classList.add('selected','btn-secondary'); btn.classList.remove('btn-tertiary'); 
            completeSection('fade'); 
        }
        
        function flagUnusual() { haptic('medium'); data.flagged = true; const btn = document.getElementById('flag-btn'); btn.classList.add('flagged'); btn.innerHTML = 'üö© FLAGGED'; }

        // V78: Simplified - no body map needed
        function initDefectSection() {
            // No-op in V78 - defect mapping removed
        }

        function closeDefectModal(e) { if(!e || e.target === e.currentTarget) { document.getElementById('defect-modal').classList.add('hidden'); pendingDefect = null; } }

        function selectDefectType(type) {
            haptic('medium');
            if(pendingDefect) {
                pendingDefect.type = type;
                document.getElementById('defect-modal').classList.add('hidden');
                cameraMode = 'defect';
                openCameraOverlay(`DEFECT: ${type}`);
            }
        }

        // V78: Simplified defect photo display
        function renderDefectMarkers() {
            // Just render defect photo thumbnails in the defect-photos-thumbs container
            const container = document.getElementById('defect-photos-thumbs');
            if (!container) return;
            container.innerHTML = data.defectPhotos.map((p, i) => 
                `<div class="relative">
                    <img src="${p.dataUrl}" class="photo-thumb" onclick="if(confirm('Delete?')){data.defectPhotos.splice(${i},1);renderDefectMarkers();haptic('light');}">
                    <span class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">${p.defectMeta?.type?.[0] || '?'}</span>
                </div>`
            ).join('');
        }

        function renderPhotoThumbs() {
            // Main photos
            const mainContainer = document.getElementById('main-photos-thumbs');
            if(mainContainer) {
                mainContainer.innerHTML = data.mainPhotos.map((p, i) => `<img src="${p.dataUrl}" class="photo-thumb" onclick="if(confirm('Delete?')){data.mainPhotos.splice(${i},1);renderPhotoThumbs();haptic('light');}">`).join('');
            }
            // Defect photos (V78)
            renderDefectMarkers();
            updateAllChecks();
        }

        function updateMeasureHint() {
            // V78: Measurement hints are now static in HTML
        }

        function updateWeight() {
            data.itemWeightLb = +document.getElementById('weight-lb').value||0;
            data.itemWeightOz = +document.getElementById('weight-oz').value||0;
            data.itemWeightTotalOz = data.itemWeightLb*16 + data.itemWeightOz;
            if (data.itemWeightTotalOz > 0) completeSection('weight');
            haptic('light');
        }

        // ============ CAMERA (V76: Grid, Stabilizer, Preview Modal) ============
        async function openCamera(mode, subType = null) {
            cameraMode = mode; cameraSubType = subType;
            let label = mode.toUpperCase();
            if(mode === 'tag') {
                if (subType === 'neck') label = 'NECK TAG';
                else if (subType === 'care') label = 'CARE LABEL';
                else if (subType === 'missing-area') label = 'TAG AREA';
            }
            if(mode === 'defect' && pendingDefect) label = `DEFECT: ${pendingDefect.type}`;
            openCameraOverlay(label);
        }

        async function openCameraOverlay(label) {
            document.getElementById('cam-mode-label').textContent = label;
            const count = cameraMode === 'main' ? data.mainPhotos.length : cameraMode === 'tag' ? data.tagPhotos.length : data.defectPhotos.length;
            document.getElementById('cam-count').textContent = count;
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } });
                document.getElementById('cam-feed').srcObject = cameraStream;
                document.getElementById('camera-overlay').classList.remove('hidden');
                startStabilizer();
            } catch(e) { alert('Camera error: ' + e.message); }
        }

        function closeCamera() {
            if(cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
            document.getElementById('camera-overlay').classList.add('hidden');
            stopStabilizer();
            pendingDefect = null;
            renderPhotoThumbs();
        }

        function finishPhotos() { closeCamera(); }

        // Stabilizer (V76)
        function startStabilizer() {
            isStable = false;
            updateStabilizerUI(false);
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleMotion);
            } else {
                isStable = true;
                updateStabilizerUI(true);
            }
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;
            const dx = Math.abs((acc.x || 0) - lastMotion.x);
            const dy = Math.abs((acc.y || 0) - lastMotion.y);
            const dz = Math.abs((acc.z || 0) - lastMotion.z);
            const totalMovement = dx + dy + dz;
            lastMotion = { x: acc.x || 0, y: acc.y || 0, z: acc.z || 0 };
            isStable = totalMovement < 0.5;
            updateStabilizerUI(isStable);
        }

        function stopStabilizer() {
            window.removeEventListener('devicemotion', handleMotion);
            isStable = false;
        }

        function updateStabilizerUI(stable) {
            const dot = document.getElementById('stabilizer-dot');
            const text = document.getElementById('stabilizer-text');
            if (dot) dot.style.background = stable ? '#22c55e' : '#ef4444';
            if (text) text.textContent = stable ? 'STABLE ‚úì' : 'HOLD STEADY';
        }

        // Photo capture with preview (V76)
        function capturePhoto() {
            if (!isStable && navigator.vibrate) navigator.vibrate(100);
            haptic('light');
            const video = document.getElementById('cam-feed');
            const canvas = document.getElementById('photo-canvas');
            const size = Math.min(video.videoWidth, video.videoHeight);
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(video, (video.videoWidth - size) / 2, (video.videoHeight - size) / 2, size, size, 0, 0, size, size);
            
            canvas.toBlob(blob => {
                pendingPhoto = { blob, timestamp: new Date().toISOString() };
                // Show preview modal
                document.getElementById('preview-image').src = URL.createObjectURL(blob);
                let modeLabel = cameraMode.toUpperCase();
                if (cameraMode === 'tag' && cameraSubType) {
                    if (cameraSubType === 'neck') modeLabel = 'NECK TAG';
                    else if (cameraSubType === 'care') modeLabel = 'CARE LABEL';
                    else if (cameraSubType === 'missing-area') modeLabel = 'TAG AREA';
                }
                if (cameraMode === 'defect' && pendingDefect) modeLabel = `DEFECT: ${pendingDefect.type}`;
                document.getElementById('preview-mode-label').textContent = modeLabel;
                document.getElementById('photo-preview-modal').style.display = 'flex';
            }, 'image/jpeg', 0.92);
        }

        function acceptPhoto() {
            if (!pendingPhoto) return;
            if (cameraMode === 'main') {
                if (data.mainPhotos.length === 0) data.timestamps.first_photo = new Date().toISOString();
                data.mainPhotos.push(pendingPhoto);
                completeSection('photos');
            } else if (cameraMode === 'tag') {
                pendingPhoto.tagType = cameraSubType;
                data.tagPhotos.push(pendingPhoto);
            } else if (cameraMode === 'defect' && pendingDefect) {
                pendingPhoto.defectMeta = { ...pendingDefect };
                data.defectPhotos.push(pendingPhoto);
            }
            document.getElementById('cam-count').textContent = cameraMode === 'main' ? data.mainPhotos.length : cameraMode === 'tag' ? data.tagPhotos.length : data.defectPhotos.length;
            pendingPhoto = null;
            document.getElementById('photo-preview-modal').style.display = 'none';
            haptic('success');
            maybeQuickReward();
            // Auto-close for single-shot modes
            if (cameraMode === 'defect') { closeCamera(); renderDefectMarkers(); }
            if (cameraMode === 'tag' && cameraSubType === 'missing-area') closeCamera();
            updateAllChecks();
        }

        function rejectPhoto() {
            pendingPhoto = null;
            document.getElementById('photo-preview-modal').style.display = 'none';
            // Camera stays open for retake
        }

        // ============ AUDIO ============
        async function toggleRecording() {
            if(!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        data.audioMeasure = new Blob(audioChunks, { type: 'audio/webm' });
                        data.audioDuration = Math.round((Date.now() - recordingStart) / 1000);
                        document.getElementById('record-section').classList.add('hidden');
                        document.getElementById('post-record-section').classList.remove('hidden');
                        document.getElementById('recording-duration').textContent = formatTime(data.audioDuration);
                        stream.getTracks().forEach(t => t.stop());
                        completeSection('measure');
                        haptic('success');
                    };
                    mediaRecorder.start();
                    recordingStart = Date.now();
                    isRecording = true;
                    haptic('medium');
                    document.getElementById('record-btn').classList.add('recording');
                    document.getElementById('record-btn').innerHTML = '<span class="text-2xl">‚èπÔ∏è</span><span>TAP TO STOP</span><span id="rec-timer" class="text-lg font-mono">0:00</span>';
                    updateRecTimer();
                } catch(e) { alert('Mic error: ' + e.message); }
            } else { mediaRecorder.stop(); isRecording = false; }
        }

        function updateRecTimer() { if(!isRecording) return; const t = document.getElementById('rec-timer'); if(t) t.textContent = formatTime(Math.round((Date.now()-recordingStart)/1000)); setTimeout(updateRecTimer, 1000); }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function reRecord() { data.audioMeasure = null; data.audioDuration = 0; document.getElementById('record-section').classList.remove('hidden'); document.getElementById('post-record-section').classList.add('hidden'); document.getElementById('record-btn').classList.remove('recording'); document.getElementById('record-btn').innerHTML = '<span class="text-2xl">üé§</span><span>TAP TO RECORD</span>'; haptic('light'); document.getElementById('check-measure').classList.remove('complete'); document.getElementById('check-measure').innerHTML = '‚óã'; }

        // ============ STEP 4: SEND ============
        function updateReviewCards() {
            document.getElementById('summary-tag').innerHTML = `${data.category||'?'} ‚Ä¢ ${data.sku||'?'}<br>${data.tagSize||''} ${data.origin==='usa'?'üá∫üá∏':''} ${data.gender||''}`;
            document.getElementById('summary-check').innerHTML = `${data.fabric||'?'}<br>${data.colorPrimary||''} ‚Ä¢ ${data.pattern||''}`;
            const pc = data.mainPhotos.length + data.tagPhotos.length + data.defectPhotos.length;
            document.getElementById('summary-snap').innerHTML = `${pc} photo(s)<br>${data.audioMeasure?'Audio: '+formatTime(data.audioDuration):'No audio'}`;
            document.getElementById('summary-weight').innerHTML = data.itemWeightTotalOz > 0 ? `${data.itemWeightLb} lb ${data.itemWeightOz} oz` : 'No weight';
            
            setCardStatus('tag', !!data.category && !!data.sku && !!data.tagStatus);
            setCardStatus('check', !!data.fabric && !!data.colorPrimary && !!data.pattern);
            setCardStatus('snap', !!data.audioMeasure && data.mainPhotos.length > 0);
            setCardStatus('weight', data.itemWeightTotalOz > 0);
            if(data.flagged) document.getElementById('flag-status').classList.remove('hidden');
        }

        function setCardStatus(name, ok) { 
            const card = document.getElementById(`card-${name}`); 
            const icon = document.getElementById(`icon-${name}`); 
            card.classList.remove('card-green','card-yellow'); 
            card.classList.add(ok?'card-green':'card-yellow'); 
            icon.textContent = ok?'‚úÖ':'‚ö†Ô∏è'; 
        }

        // ============ SUBMIT ============
        async function submitData() {
            const sku = data.sku;
            if(!sku) { haptic('error'); return alert("Enter SKU"); }
            if(data.mainPhotos.length === 0) { haptic('error'); return alert("Add photo"); }
            if(data.itemWeightTotalOz === 0) { haptic('error'); return alert("Enter weight"); }
            if(!data.fabric) { haptic('error'); return alert("Select fabric"); }
            if(!data.colorPrimary) { haptic('error'); return alert("Select color"); }
            
            const itemTime = stopTimer();
            stats.itemsToday++;
            stats.totalTime += itemTime;
            if (!stats.bestTime || itemTime < stats.bestTime) stats.bestTime = itemTime;
            saveStats();
            updateStatsDisplay();
            
            if (stats.itemsToday === 10) celebrate('üîü', 'Double Digits!', '10 items');
            else if (stats.itemsToday === 25) celebrate('üí™', 'Quarter Century!', '25 items');
            else if (stats.itemsToday === 50) celebrate('üî•', 'FIFTY!', 'Half century');
            else if (stats.itemsToday === 100) celebrate('üèÜ', 'CENTURION!', '100 items!');
            else if (itemTime === stats.bestTime && stats.itemsToday > 3) celebrate('‚ö°', 'NEW RECORD!', formatTime(itemTime));
            else maybeQuickReward();
            
            const modal = document.getElementById('upload-modal');
            modal.classList.remove('hidden');
            
            const fd = new FormData();
            fd.append('sku', sku);
            fd.append('auth_pin', APP_PIN);
            fd.append('photographer', data.photographer);
            fd.append('super_category', data.superCategory);
            fd.append('category', data.category);
            fd.append('gender', data.gender);
            fd.append('tag_status', data.tagStatus);
            fd.append('tag_size', data.tagSize);
            fd.append('origin', data.origin);
            fd.append('made_in_country', data.madeInCountry);
            fd.append('fabric', data.fabric === 'Custom Blend' ? document.getElementById('fabric-custom').value : data.fabric);
            fd.append('thickness', data.thickness);
            fd.append('construction', data.construction);
            fd.append('color_primary', data.colorPrimary);
            fd.append('color_secondary', data.colorSecondary);
            fd.append('pattern', data.pattern);
            fd.append('print_type', data.printType);
            fd.append('graphic_category', data.graphicCategory);
            fd.append('sleeve_type', data.sleeveType);
            fd.append('sleeve_style', data.sleeveStyle);
            fd.append('is_cutoff', data.isCutoff); // V78
            fd.append('cutoff_type', data.cutoffType); // V78
            fd.append('stitch_type', data.stitchType); // V78
            fd.append('wash', data.wash || '');
            fd.append('has_defects', data.hasDefects);
            fd.append('fade_level', data.fadeLevel);
            fd.append('flagged', data.flagged);
            fd.append('item_weight_lb', data.itemWeightLb);
            fd.append('item_weight_oz', data.itemWeightOz);
            fd.append('item_weight_total_oz', data.itemWeightTotalOz);
            fd.append('item_time_sec', itemTime);
            fd.append('kpi_timestamps_json', JSON.stringify(data.timestamps));
            fd.append('photo_count_main', data.mainPhotos.length);
            fd.append('photo_count_tag', data.tagPhotos.length);
            fd.append('photo_count_defect', data.defectPhotos.length);
            
            const defectsMetadata = data.defectPhotos.map((p, i) => ({ index: i+1, type: p.defectMeta.type, zone: p.defectMeta.zone, side: p.defectMeta.side }));
            fd.append('defect_map_json', JSON.stringify(defectsMetadata));
            
            data.mainPhotos.forEach((p, i) => fd.append(`main_photo_${i+1}`, p.blob, `${sku}_main_${i+1}.jpg`));
            data.tagPhotos.forEach((p, i) => fd.append(`tag_photo_${i+1}`, p.blob, `${sku}_tag_${i+1}.jpg`));
            data.defectPhotos.forEach((p, i) => fd.append(`defect_photo_${i+1}`, p.blob, `${sku}_defect_${i+1}.jpg`));
            if(data.audioMeasure) fd.append('audio_measure', data.audioMeasure, `${sku}_measure.webm`);
            
            const xhr = new XMLHttpRequest();
            xhr.open("POST", N8N_WEBHOOK_URL, true);
            xhr.upload.onprogress = e => { if(e.lengthComputable) { const pct = Math.round((e.loaded/e.total)*100); document.getElementById('upload-progress-bar').style.width = pct+'%'; document.getElementById('upload-status').textContent = pct+'%'; } };
            xhr.onload = () => { 
                if(xhr.status >= 200 && xhr.status < 300) { 
                    document.getElementById('upload-progress-bar').style.backgroundColor = "#22c55e";
                    document.getElementById('upload-status').textContent = '‚úì Done!';
                    haptic('celebration');
                    setTimeout(() => location.reload(), 1000); 
                } else { alert("Error: " + xhr.status); modal.classList.add('hidden'); } 
            };
            xhr.onerror = () => { alert("Network Error"); modal.classList.add('hidden'); };
            xhr.send(fd);
        }
    </script>
</body>
</html>

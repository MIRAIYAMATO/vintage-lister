<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VintageLister v99.15 - Desktop Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --color-primary: #3b82f6; --color-primary-dark: #2563eb; --color-primary-light: #dbeafe; --color-success: #22c55e; --color-warning: #f59e0b; --color-error: #ef4444; --color-surface: #ffffff; --color-background: #f1f5f9; --color-text: #1e293b; --color-text-muted: #64748b; --color-border: #e2e8f0; }
        * { box-sizing: border-box; }
        html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        
        /* PIN LOCK SCREEN */
        .pin-screen { position: fixed; inset: 0; z-index: 1000; background: linear-gradient(135deg, #1e293b, #0f172a); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-screen.hidden { display: none; }
        .pin-box { background: white; border-radius: 20px; padding: 32px; width: 340px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .pin-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .pin-subtitle { color: var(--color-text-muted); font-size: 14px; margin-bottom: 20px; }
        .pin-input { width: 100%; padding: 16px; font-size: 32px; text-align: center; letter-spacing: 12px; border: 2px solid var(--color-border); border-radius: 12px; font-family: monospace; margin-bottom: 16px; }
        .pin-input:focus { outline: none; border-color: var(--color-primary); }
        .pin-input.shake { animation: shake 0.3s; border-color: var(--color-error); }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        .photographer-select { width: 100%; padding: 12px; border: 2px solid var(--color-border); border-radius: 10px; font-size: 14px; margin-bottom: 20px; }
        .pin-btn { width: 100%; padding: 16px; background: var(--color-primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .pin-btn:hover { background: var(--color-primary-dark); }
        .pin-version { color: #475569; font-size: 12px; margin-top: 16px; }
        
        .desktop-layout { display: grid; grid-template-columns: 420px 1fr 280px; height: 100vh; }
        .form-panel { background: var(--color-surface); display: flex; flex-direction: column; overflow: hidden; }
        .camera-panel { background: #000; display: flex; flex-direction: column; }
        .photos-panel { background: var(--color-background); overflow-y: auto; padding: 16px; border-left: 1px solid var(--color-border); }
        
        /* FLOATING TIMER */
        .floating-timer { position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        .timer-main { font-size: 28px; font-weight: 800; font-family: monospace; }
        .timer-stats { text-align: right; font-size: 11px; opacity: 0.9; }
        .timer-label { font-size: 10px; opacity: 0.7; }
        .photographer-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .version-badge { background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; font-family: monospace; }
        
        /* PROGRESS BAR */
        .progress-bar { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 12px 16px; background: var(--color-background); border-bottom: 1px solid var(--color-border); flex-wrap: wrap; }
        .progress-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--color-border); cursor: pointer; transition: all 0.2s; }
        .progress-dot.active { background: var(--color-primary); transform: scale(1.3); }
        .progress-dot.complete { background: var(--color-success); }
        .progress-label { font-size: 11px; color: var(--color-text-muted); font-weight: 600; margin-left: 8px; }
        .category-badge { font-size: 11px; color: var(--color-primary); font-weight: 700; text-transform: uppercase; margin-left: 4px; }
        .sku-badge { font-size: 10px; background: var(--color-success); color: white; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-family: monospace; display: none; }
        .sku-badge.visible { display: inline-block; }
        
        /* STEP CONTAINER */
        .step-area { flex: 1; overflow-y: auto; padding: 16px; }
        .step-container { display: none; }
        .step-container.active { display: block; }
        
        .section-card { background: var(--color-background); border: 1px solid var(--color-border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .section-label { font-size: 12px; font-weight: 700; color: var(--color-text); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .check-circle { width: 20px; height: 20px; border-radius: 50%; background: var(--color-border); color: #999; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .check-circle.complete { background: var(--color-success); color: white; }
        
        .btn { padding: 10px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: 2px solid transparent; transition: all 0.1s; text-align: center; }
        .btn:active { transform: scale(0.97); }
        .btn-tertiary { background: white; color: var(--color-text-muted); border: 1px solid var(--color-border); }
        .btn-tertiary:hover { background: var(--color-background); }
        .btn-tertiary.selected { border: 2px solid var(--color-primary) !important; background: var(--color-primary) !important; color: white !important; }
        /* btn-default = light blue with dashed border (suggested/default option) */
        .btn-default { background: #e0f2fe !important; color: #0369a1 !important; border: 2px dashed #7dd3fc !important; }
        .btn-default:hover { background: #bae6fd !important; }
        .btn-default.selected { border: 2px solid var(--color-primary) !important; background: var(--color-primary) !important; color: white !important; }
        /* btn-hero = solid blue (confirmed selection) */
        .btn-hero { background: var(--color-primary); color: white !important; border: 2px solid var(--color-primary-dark) !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-hero:hover { background: var(--color-primary-dark); }
        .btn-hero:active { transform: scale(0.98); }
        .btn-hero.selected { background: var(--color-primary-dark); box-shadow: 0 0 0 3px rgba(59,130,246,0.3); }
        /* btn-secondary = white with gray border (other options) */
        .btn-secondary { background: white; color: var(--color-text); border: 2px solid var(--color-border); }
        .btn-secondary:hover { background: var(--color-background); }
        .btn-secondary:active { transform: scale(0.98); }
        .btn-secondary.selected { border-color: var(--color-primary); background: #dbeafe; }
        .btn-grid { display: grid; gap: 8px; }
        .btn-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .btn-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .btn-grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        .form-input, .form-select { width: 100%; padding: 10px 12px; border: 2px solid var(--color-border); border-radius: 8px; font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); }
        
        .sub-label { font-size: 11px; color: var(--color-text-muted); font-weight: 600; margin: 10px 0 8px 0; }
        .nested-section { background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px; padding: 12px; margin-top: 10px; }
        .nested-amber { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); }
        
        /* Super Category */
        .super-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 16px 12px; font-size: 11px; font-weight: 700; }
        .super-btn .emoji { font-size: 24px; }
        .super-btn.selected { background: var(--color-primary) !important; color: white !important; border-color: var(--color-primary) !important; }
        
        /* Category buttons */
        .cat-hero { padding: 16px; font-size: 15px; font-weight: 700; border-radius: 8px; border: 2px solid var(--color-border); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 8px; background: white; color: var(--color-text); transition: all 0.15s; }
        .cat-hero:hover { background: var(--color-background); border-color: var(--color-primary); }
        .cat-hero.cat-default { background: #e0f2fe; color: #0369a1; border: 2px dashed #7dd3fc; }
        .cat-hero.cat-default:hover { background: #bae6fd; }
        .cat-hero.selected { background: var(--color-primary) !important; color: white !important; border: 2px solid var(--color-primary) !important; box-shadow: 0 0 0 4px rgba(59,130,246,0.3); }
        .cat-secondary { background: white; color: var(--color-text); border: 2px solid var(--color-border); padding: 12px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.15s; }
        .cat-secondary:hover { background: var(--color-background); border-color: var(--color-primary); }
        .cat-secondary.selected { border-color: var(--color-primary) !important; background: var(--color-primary) !important; color: white !important; box-shadow: 0 0 0 3px rgba(59,130,246,0.3); }
        .cat-other { background: white; color: var(--color-text-muted); border: 1px solid var(--color-border); padding: 8px; font-size: 11px; font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.15s; }
        .cat-other:hover { border-color: var(--color-primary); color: var(--color-text); }
        .cat-other.selected { border-color: var(--color-primary); background: var(--color-primary); color: white; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
        
        /* Color grid */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        /* V97 style: color-item with label below */
        .color-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 4px; border-radius: 10px; transition: all 0.15s ease; border: 3px solid transparent; }
        .color-item:hover { transform: scale(1.02); }
        .color-item:active { transform: scale(0.95); }
        .color-item span { font-size: 9px; color: #64748b; margin-top: 4px; text-align: center; line-height: 1.1; }
        .color-item.selected { border-color: var(--color-primary); background: #dbeafe; }
        .color-item.selected span { color: var(--color-primary); font-weight: 700; }
        .color-swatch { width: 100%; aspect-ratio: 1; min-height: 40px; border-radius: 8px; border: 2px solid transparent; transition: all 0.15s ease; }
        
        /* Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
        .card { background: white; border: 2px solid var(--color-border); border-radius: 8px; padding: 12px; cursor: pointer; position: relative; }
        .card:hover { background: var(--color-background); }
        .card.selected { border-color: var(--color-primary); background: var(--color-primary); }
        .card.selected .card-name { color: white !important; }
        .card.selected .card-desc { color: rgba(255,255,255,0.9) !important; }
        .card.priority-1 { grid-column: span 2; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px dashed var(--color-primary); }
        .card.priority-1.selected { border-style: solid; background: var(--color-primary); }
        .card.dimmed { opacity: 0.3; pointer-events: none; }
        .card-name { font-size: 13px; font-weight: 700; color: var(--color-text); }
        .card-desc { font-size: 10px; color: var(--color-text-muted); margin-top: 2px; }
        .card-help { position: absolute; top: 6px; right: 6px; width: 18px; height: 18px; border-radius: 50%; background: rgba(59,130,246,0.1); color: var(--color-primary); font-size: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .card.selected .card-help { background: rgba(255,255,255,0.2); color: white; }
        /* Reference Modal (Visual Search) */
        .ref-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
        .ref-modal-overlay.visible { opacity: 1; visibility: visible; }
        .ref-modal { background: white; border-radius: 16px; padding: 24px; max-width: 340px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); transform: scale(0.9); transition: transform 0.2s ease; text-align: center; }
        .ref-modal-overlay.visible .ref-modal { transform: scale(1); }
        .ref-modal-title { font-size: 20px; font-weight: 700; color: var(--color-text); margin-bottom: 8px; }
        .ref-modal-desc { font-size: 14px; color: var(--color-text-muted); line-height: 1.5; margin-bottom: 20px; }
        .ref-modal-link { display: block; width: 100%; padding: 14px; background: var(--color-primary); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; text-decoration: none; margin-bottom: 12px; }
        .ref-modal-link:hover { background: var(--color-primary-dark); }
        .ref-modal-close { width: 100%; padding: 12px; background: #f1f5f9; color: var(--color-text-muted); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        
        /* Help panel */
        .help-btn { width: 100%; padding: 10px; background: #fef3c7; border: 2px dashed #f59e0b; border-radius: 8px; font-size: 12px; font-weight: 600; color: #92400e; cursor: pointer; }
        .help-panel { background: #fffbeb; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 10px; }
        .help-panel.hidden { display: none; }
        .filter-row { display: flex; gap: 6px; margin-bottom: 8px; }
        .filter-btn { flex: 1; padding: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: white; border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text-muted); cursor: pointer; }
        .filter-btn.active { background: var(--color-primary); border-color: var(--color-primary); color: white; }
        .help-text { background: #fef3c7; border-radius: 6px; padding: 8px 10px; font-size: 11px; color: #92400e; margin-top: 8px; }
        .help-text.hidden { display: none; }
        
        .tag-warning { background: #fef2f2; border: 2px solid #fca5a5; border-radius: 8px; padding: 10px; font-size: 11px; font-weight: 600; color: #b91c1c; text-align: center; margin-bottom: 10px; }
        .tag-warning.hidden { display: none; }
        
        /* Defect buttons with emoji */
        .defect-card { display: flex; flex-direction: column; align-items: center; padding: 12px 8px; gap: 4px; }
        .defect-card .emoji { font-size: 24px; }
        .defect-card .label { font-size: 10px; font-weight: 700; }
        
        /* Navigation */
        .nav-buttons { display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--color-border); }
        .nav-btn { flex: 1; padding: 14px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; border: none; }
        .nav-btn-back { background: white; color: var(--color-text); border: 2px solid var(--color-border); }
        .nav-btn-next { background: var(--color-primary); color: white; flex: 2; }
        .nav-btn-next:hover { background: var(--color-primary-dark); }
        
        /* Camera */
        .camera-header { background: #111; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; border-bottom: 1px solid #333; }
        .camera-select { background: #222; border: 1px solid #444; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; flex: 1; max-width: 220px; }
        .camera-status { font-size: 11px; font-weight: 700; color: #555; }
        .camera-status.live { color: #22c55e; }
        .camera-status.live::before { content: '‚óè'; margin-right: 6px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .camera-view { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; background: #000; }
        .camera-view-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .camera-view video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            transition: opacity 0.15s ease;
        }
        .camera-view video.switching { opacity: 0.3; }
        .camera-placeholder { color: #444; text-align: center; position: absolute; z-index: 1; }
        .camera-placeholder-icon { font-size: 48px; margin-bottom: 12px; }
        .camera-overlay { position: absolute; inset: 0; pointer-events: none; display: none; }
        /* Stabilizer indicator */
        .stabilizer-indicator { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.7); padding: 6px 14px; border-radius: 20px; z-index: 10; }
        .stabilizer-dot { width: 14px; height: 14px; border-radius: 50%; background: #ef4444; transition: background 0.2s ease; }
        .stabilizer-dot.stable { background: #22c55e; animation: pulse-green 1s ease-in-out infinite; }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6); } 50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); } }
        .stabilizer-text { color: white; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; }
        .camera-grid { position: absolute; top: 10%; left: 10%; right: 10%; bottom: 10%; border: 2px dashed rgba(255,255,255,0.3); }
        .camera-footer { background: #111; padding: 16px; display: flex; justify-content: center; align-items: center; gap: 16px; border-top: 1px solid #333; }
        .shutter-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid #333; cursor: pointer; }
        .shutter-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .shutter-btn:active { transform: scale(0.95); background: #ddd; }
        .shutter-btn.flash { animation: btnflash 0.15s; }
        @keyframes btnflash { 0%{background:white} 50%{background:var(--color-primary)} 100%{background:white} }
        .shutter-hint { color: #555; font-size: 11px; text-align: center; }
        .shutter-hint kbd { background: #333; padding: 3px 6px; border-radius: 4px; font-family: monospace; color: #aaa; }
        .mode-btn { padding: 10px 16px; background: #222; border: 2px solid #333; color: #666; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; line-height: 1.3; min-width: 80px; }
        .mode-btn.active { background: var(--color-primary); border-color: var(--color-primary); color: white; }
        .mode-btn.mode-btn-sku { background: #1a1a2e; border-color: #16a34a; }
        .mode-btn.mode-btn-sku.active { background: #16a34a; border-color: #16a34a; color: white; }
        .mode-btn small { display: block; }
        
        /* Photos panel */
        .photos-header { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .photo-count { background: var(--color-primary-light); color: var(--color-primary-dark); padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .photo-section { margin-bottom: 16px; }
        .photo-section-title { font-size: 10px; font-weight: 700; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .photo-thumb { aspect-ratio: 1; border-radius: 6px; overflow: hidden; background: white; border: 2px solid var(--color-border); position: relative; cursor: pointer; transition: transform 0.1s, border-color 0.1s; }
        .photo-thumb:hover { transform: scale(1.02); border-color: var(--color-primary); }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb-delete { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center; opacity: 0; }
        .photo-thumb:hover .photo-thumb-delete { opacity: 1; }
        .photo-thumb-empty { display: flex; align-items: center; justify-content: center; color: var(--color-border); font-size: 18px; cursor: pointer; }
        .stats-section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--color-border); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: 800; }
        .stat-label { font-size: 9px; color: var(--color-text-muted); text-transform: uppercase; }
        
        .reset-btn { padding: 6px 12px; background: var(--color-error); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; }
        .submit-btn { width: 100%; padding: 16px; background: var(--color-success); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; }
        .submit-btn:disabled { background: var(--color-border); cursor: not-allowed; }
        
        .flash-overlay { position: fixed; inset: 0; background: white; z-index: 500; opacity: 0; pointer-events: none; }
        .flash-overlay.flash { opacity: 1; }
        .hidden { display: none !important; }
        .recording { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.7} }
        
        /* Photo Preview Modal */
        .preview-modal { position: fixed; inset: 0; z-index: 600; background: rgba(0,0,0,0.95); display: none; flex-direction: column; }
        .preview-modal.active { display: flex; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #111; }
        .preview-title { color: white; font-size: 14px; font-weight: 700; }
        .preview-badge { background: var(--color-primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .preview-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 8px; }
        .preview-close:hover { color: #f87171; }
        .preview-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; overflow: hidden; }
        .preview-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .preview-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: white; font-size: 32px; padding: 16px 12px; cursor: pointer; border-radius: 8px; }
        .preview-nav:hover { background: rgba(255,255,255,0.2); }
        .preview-nav.prev { left: 20px; }
        .preview-nav.next { right: 20px; }
        .preview-nav:disabled { opacity: 0.3; cursor: not-allowed; }
        .preview-footer { display: flex; justify-content: center; gap: 12px; padding: 16px; background: #111; }
        .preview-btn { padding: 12px 24px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; }
        .preview-btn-delete { background: #ef4444; color: white; }
        .preview-btn-delete:hover { background: #dc2626; }
        .preview-btn-close { background: #374151; color: white; }
        .preview-btn-close:hover { background: #4b5563; }
        .preview-counter { color: #9ca3af; font-size: 12px; position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); }
        
        /* SKU with scan button */
        .sku-row { display: flex; gap: 8px; }
        .sku-row input { flex: 1; }
        .scan-btn { background: #1e293b; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-size: 18px; cursor: pointer; }
        .scan-btn:hover { background: #334155; }
        
        /* Review cards */
        .review-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
        .review-card { border-radius: 10px; padding: 14px; cursor: pointer; transition: transform 0.1s; }
        .review-card:hover { transform: scale(0.98); }
        .review-card:active { transform: scale(0.96); }
        .card-green { border-left: 4px solid var(--color-success); background: #f0fdf4; }
        .card-yellow { border-left: 4px solid var(--color-warning); background: #fffbeb; }
        .review-card-header { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
        .review-card-header .icon { font-size: 16px; }
        .review-card-header .title { font-size: 12px; font-weight: 700; color: var(--color-text); }
        .review-card-summary { font-size: 11px; color: var(--color-text-muted); line-height: 1.4; }
        .review-banner { background: var(--color-success); color: white; padding: 14px; border-radius: 10px; text-align: center; font-weight: 700; margin-bottom: 12px; }
        .flag-banner { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 12px; border-radius: 10px; text-align: center; font-weight: 700; margin-bottom: 12px; }
        .flag-unusual-btn { width:100%; padding:14px; background:linear-gradient(135deg,#fffbeb,#fef3c7); border:2px dashed #f59e0b; border-radius:10px; font-weight:700; color:#92400e; cursor:pointer; margin-bottom:12px; text-align:center; transition:all 0.2s; }
        .flag-unusual-btn:hover { background:linear-gradient(135deg,#fef3c7,#fde68a); }
        .flag-unusual-btn.flagged { background:linear-gradient(135deg,#fde68a,#fbbf24); border-style:solid; border-color:#d97706; }
        .elastic-section { background:#f0fdf4; border:1px solid #86efac; border-radius:10px; padding:12px; margin-top:10px; }
    </style>
</head>
<body>
    <!-- Reference Modal (Visual Search) -->
    <div id="ref-modal-overlay" class="ref-modal-overlay" onclick="closeRefModal()">
        <div class="ref-modal" onclick="event.stopPropagation()">
            <div class="ref-modal-title" id="ref-modal-title">Fabric Name</div>
            <div class="ref-modal-desc" id="ref-modal-desc">Description</div>
            <a id="ref-modal-link" class="ref-modal-link" href="#" target="_blank">üîç See Examples on Google</a>
            <button class="ref-modal-close" onclick="closeRefModal()">Close</button>
        </div>
    </div>
    
    <!-- PIN LOCK SCREEN -->
    <div id="pin-screen" class="pin-screen">
        <div class="pin-box">
            <div class="pin-title">VintageLister</div>
            <div class="pin-subtitle">Enter Warehouse PIN</div>
            <input type="tel" id="pin-input" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="off">
            <div class="sub-label">Photographer</div>
            <select id="photographer-select" class="photographer-select">
                <option value="P01">P01 ‚Äì Jeff Koga</option>
                <option value="P02" selected>P02 ‚Äì Elaine Donato</option>
                <option value="P03">P03 ‚Äì Kobe Gaza</option>
            </select>
            <button onclick="checkPin()" class="pin-btn">START LISTING ‚Üí</button>
        </div>
        <div class="pin-version">v99.15 Desktop Station</div>
    </div>
    
    <div class="flash-overlay" id="flash-overlay"></div>
    
    <!-- PHOTO PREVIEW MODAL -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-header">
            <span class="preview-title">Photo Preview</span>
            <span class="preview-badge" id="preview-type">MAIN</span>
            <button class="preview-close" onclick="closePreview()">√ó</button>
        </div>
        <div class="preview-body">
            <button class="preview-nav prev" id="preview-prev" onclick="navigatePreview(-1)">‚Äπ</button>
            <img id="preview-image" class="preview-image" src="" alt="Preview">
            <button class="preview-nav next" id="preview-next" onclick="navigatePreview(1)">‚Ä∫</button>
            <div class="preview-counter" id="preview-counter">1 / 1</div>
        </div>
        <div class="preview-footer">
            <button class="preview-btn preview-btn-delete" onclick="deleteFromPreview()">üóëÔ∏è Delete Photo</button>
            <button class="preview-btn preview-btn-close" onclick="closePreview()">Close</button>
        </div>
    </div>
    
    <div class="desktop-layout">
        <!-- LEFT: Form Panel -->
        <div class="form-panel">
            <div class="floating-timer">
                <div>
                    <div class="timer-label">CURRENT ITEM</div>
                    <div class="timer-main" id="timer-current">0:00</div>
                </div>
                <div class="timer-stats">
                    <div>Avg: <strong id="timer-avg">--</strong></div>
                    <div>Last: <strong id="timer-last">--</strong></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span id="photographer-badge" class="photographer-badge" onclick="showPinScreen()">P02</span>
                    <span class="version-badge">v99.15</span>
                    <button class="reset-btn" onclick="resetForm()" style="margin-left:4px;">‚Üª</button>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-dot active" id="dot-1" onclick="goToStep(1)"></div>
                <div class="progress-dot" id="dot-2" onclick="goToStep(2)"></div>
                <div class="progress-dot" id="dot-3" onclick="goToStep(3)"></div>
                <div class="progress-dot" id="dot-4" onclick="goToStep(4)"></div>
                <span class="progress-label" id="step-label">Step 1: Tag</span>
                <span class="category-badge" id="category-label"></span>
                <span class="sku-badge" id="sku-badge"></span>
            </div>
            
            <div class="step-area">
                <!-- STEP 1: TAG -->
                <div id="step-1" class="step-container active">
                    <div class="section-card">
                        <div class="section-label"><span id="check-category" class="check-circle">‚óã</span> What is it?</div>
                        <div class="btn-grid btn-grid-3" style="margin-bottom:12px;">
                            <button onclick="setSuperCategory('tops', this)" class="btn btn-hero super-btn selected"><span class="emoji">üëï</span>TOPS</button>
                            <button onclick="setSuperCategory('bottoms', this)" class="btn btn-secondary super-btn"><span class="emoji">üëñ</span>BOTTOMS</button>
                            <button onclick="setSuperCategory('outer', this)" class="btn btn-secondary super-btn"><span class="emoji">üß•</span>OUTER</button>
                        </div>
                        <div id="sub-categories"></div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-tag" class="check-circle">‚óã</span> Tag Info</div>
                        <button onclick="setTagStatus('has', this)" class="btn btn-default tag-btn" style="width:100%;margin-bottom:8px;">‚úì TAG READABLE</button>
                        <div class="btn-grid btn-grid-2">
                            <button onclick="setTagStatus('worn', this)" class="btn btn-secondary tag-btn">üëÄ Worn/Faded</button>
                            <button onclick="setTagStatus('none', this)" class="btn btn-secondary tag-btn">‚úÇÔ∏è Missing/Cut</button>
                        </div>
                        
                        <!-- Tag Location Help -->
                        <button id="tag-help-btn" onclick="toggleTagLocationHelp()" class="help-btn" style="margin-top:8px;">üîç Need help finding the tag?</button>
                        <div id="tag-location-panel" class="help-panel hidden" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#f59e0b;">
                            <div id="tag-location-content"></div>
                        </div>
                        
                        <div id="tag-details" class="hidden nested-section">
                            <div class="sub-label">Tag Size (What Tag Reads)</div>
                            <div class="btn-grid" style="grid-template-columns: repeat(6, 1fr); margin-bottom:8px;">
                                <button onclick="setSize('XS', this)" class="btn btn-secondary size-btn">XS</button>
                                <button onclick="setSize('S', this)" class="btn btn-secondary size-btn">S</button>
                                <button onclick="setSize('M', this)" class="btn btn-secondary size-btn">M</button>
                                <button onclick="setSize('L', this)" class="btn btn-secondary size-btn">L</button>
                                <button onclick="setSize('XL', this)" class="btn btn-secondary size-btn">XL</button>
                                <button onclick="setSize('XXL', this)" class="btn btn-secondary size-btn">XXL</button>
                            </div>
                            <input type="text" id="tag-size-input" placeholder="Or Type (e.g. 42R, OS, 32x30)" onfocus="clearSizeBtns()" oninput="onSizeInput(this)" class="form-input text-sm text-center" style="margin-bottom:8px;">
                            <div class="sub-label">Origin</div>
                            <div class="btn-grid btn-grid-2" style="margin-bottom:8px;">
                                <button onclick="setOrigin('usa', this)" class="btn btn-default origin-btn"><img src="https://flagcdn.com/w20/us.png" width="20" height="15" alt="US" style="vertical-align:middle;margin-right:4px;">USA MADE</button>
                                <button onclick="setOrigin('import', this)" class="btn btn-secondary origin-btn">üåç Import</button>
                            </div>
                            <div id="country-section" class="hidden">
                                <div class="btn-grid btn-grid-3" style="margin-bottom:6px;">
                                    <button onclick="setCountry('Mexico', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/mx.png" width="20" height="15" alt="MX" style="vertical-align:middle;margin-right:4px;">Mexico</button>
                                    <button onclick="setCountry('Honduras', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/hn.png" width="20" height="15" alt="HN" style="vertical-align:middle;margin-right:4px;">Honduras</button>
                                    <button onclick="setCountry('China', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/cn.png" width="20" height="15" alt="CN" style="vertical-align:middle;margin-right:4px;">China</button>
                                </div>
                                <div class="btn-grid btn-grid-3" style="margin-bottom:6px;">
                                    <button onclick="setCountry('Korea', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/kr.png" width="20" height="15" alt="KR" style="vertical-align:middle;margin-right:4px;">Korea</button>
                                    <button onclick="setCountry('Taiwan', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/tw.png" width="20" height="15" alt="TW" style="vertical-align:middle;margin-right:4px;">Taiwan</button>
                                    <button onclick="setCountry('Philippines', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/ph.png" width="20" height="15" alt="PH" style="vertical-align:middle;margin-right:4px;">Philippines</button>
                                </div>
                                <div class="btn-grid btn-grid-3" style="margin-bottom:6px;">
                                    <button onclick="setCountry('Vietnam', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/vn.png" width="20" height="15" alt="VN" style="vertical-align:middle;margin-right:4px;">Vietnam</button>
                                    <button onclick="setCountry('Bangladesh', this)" class="btn btn-secondary country-btn"><img src="https://flagcdn.com/w20/bd.png" width="20" height="15" alt="BD" style="vertical-align:middle;margin-right:4px;">Bangladesh</button>
                                    <button onclick="setCountry('Other', this)" class="btn btn-secondary country-btn">Other...</button>
                                </div>
                                <input type="text" id="country-other-input" placeholder="Type country name..." class="form-input hidden" style="font-size:12px;" oninput="onCountryOtherInput()">
                            </div>
                            <div class="sub-label">Gender on Tag</div>
                            <div class="btn-grid btn-grid-4" style="margin-bottom:6px;">
                                <button onclick="setGender('Men', this)" class="btn btn-secondary gender-btn">Men's</button>
                                <button onclick="setGender('Women', this)" class="btn btn-secondary gender-btn">Women's</button>
                                <button onclick="setGender('Unisex', this)" class="btn btn-secondary gender-btn">Unisex</button>
                                <button onclick="setGender('None', this)" class="btn btn-secondary gender-btn">None</button>
                            </div>
                            <div class="btn-grid btn-grid-3">
                                <button onclick="setGender('Boys', this)" class="btn btn-secondary gender-btn">Boys</button>
                                <button onclick="setGender('Girls', this)" class="btn btn-secondary gender-btn">Girls</button>
                                <button onclick="setGender('Kids Unisex', this)" class="btn btn-secondary gender-btn">Kids Unisex</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button onclick="goToStep(2)" class="nav-btn nav-btn-next">Next: Check ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 2: CHECK -->
                <div id="step-2" class="step-container">
                    <div class="section-card">
                        <div class="section-label"><span id="check-color" class="check-circle">‚óã</span> Color(s)</div>
                        <div class="sub-label" style="margin-bottom:8px;">Tap all that apply</div>
                        <div class="color-grid">
                            <div class="color-item" onclick="toggleColor('White', this)"><div class="color-swatch" style="background:#ffffff;border:1px solid #ddd;"></div><span>White</span></div>
                            <div class="color-item" onclick="toggleColor('Cream', this)"><div class="color-swatch" style="background:#fffdd0;border:1px solid #ddd;"></div><span>Cream</span></div>
                            <div class="color-item" onclick="toggleColor('Tan', this)"><div class="color-swatch" style="background:#d2b48c;"></div><span>Tan</span></div>
                            <div class="color-item" onclick="toggleColor('Gray', this)"><div class="color-swatch" style="background:#6b7280;"></div><span>Gray</span></div>
                            <div class="color-item" onclick="toggleColor('Black', this)"><div class="color-swatch" style="background:#1a1a1a;"></div><span>Black</span></div>
                            
                            <div class="color-item" onclick="toggleColor('Red', this)"><div class="color-swatch" style="background:#dc2626;"></div><span>Red</span></div>
                            <div class="color-item" onclick="toggleColor('Orange', this)"><div class="color-swatch" style="background:#ea580c;"></div><span>Orange</span></div>
                            <div class="color-item" onclick="toggleColor('Yellow', this)"><div class="color-swatch" style="background:#facc15;"></div><span>Yellow</span></div>
                            <div class="color-item" onclick="toggleColor('Green', this)"><div class="color-swatch" style="background:#16a34a;"></div><span>Green</span></div>
                            <div class="color-item" onclick="toggleColor('Blue', this)"><div class="color-swatch" style="background:#2563eb;"></div><span>Blue</span></div>
                            
                            <div class="color-item" onclick="toggleColor('Navy', this)"><div class="color-swatch" style="background:#1e3a5f;"></div><span>Navy</span></div>
                            <div class="color-item" onclick="toggleColor('Purple', this)"><div class="color-swatch" style="background:#7c3aed;"></div><span>Purple</span></div>
                            <div class="color-item" onclick="toggleColor('Pink', this)"><div class="color-swatch" style="background:#ec4899;"></div><span>Pink</span></div>
                            <div class="color-item" onclick="toggleColor('Brown', this)"><div class="color-swatch" style="background:#78350f;"></div><span>Brown</span></div>
                            <div class="color-item" onclick="toggleColor('Multi', this)"><div class="color-swatch" style="background:linear-gradient(135deg,#ef4444,#f97316,#facc15,#22c55e,#3b82f6,#8b5cf6);"></div><span>Multi</span></div>
                        </div>
                    </div>
                    
                    <!-- FADE -->
                    <div class="section-card">
                        <div class="section-label"><span id="check-fade" class="check-circle">‚óã</span> Fade Level</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="setFade('None', this)" class="btn btn-default fade-btn">None</button>
                            <button onclick="setFade('Light', this)" class="btn btn-secondary fade-btn">Light</button>
                            <button onclick="setFade('Heavy', this)" class="btn btn-secondary fade-btn">Heavy</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-pattern" class="check-circle">‚óã</span> Pattern</div>
                        <!-- Pattern cards grid (rendered dynamically) -->
                        <div id="pattern-cards-grid" class="cards-grid"></div>
                        
                        <!-- Other patterns toggle -->
                        <button onclick="toggleOtherPatterns()" id="other-patterns-toggle" class="sub-label" style="cursor:pointer; color:var(--color-primary);">+ More patterns</button>
                        <div id="pattern-others" class="hidden">
                            <div id="pattern-cards-others" class="cards-grid" style="margin-top:8px;"></div>
                        </div>
                        
                        <!-- Pattern Help Button -->
                        <button id="pattern-help-btn" onclick="togglePatternHelp()" class="help-btn" style="margin-top:8px;">ü§î Still not sure? Answer questions</button>
                        <div id="pattern-help-panel" class="help-panel hidden">
                            <div class="sub-label" style="color:#92400e;">Look at the lines:</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="togglePatternFilter('lines','none',this)" class="filter-btn pattern-filter">No lines</button>
                                <button onclick="togglePatternFilter('lines','stripes',this)" class="filter-btn pattern-filter">Stripes (parallel)</button>
                                <button onclick="togglePatternFilter('lines','grid',this)" class="filter-btn pattern-filter">Grid (crossing)</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">What shapes do you see?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="togglePatternFilter('shapes','none',this)" class="filter-btn pattern-filter">None/Color only</button>
                                <button onclick="togglePatternFilter('shapes','dots',this)" class="filter-btn pattern-filter">Dots/Circles</button>
                                <button onclick="togglePatternFilter('shapes','curved',this)" class="filter-btn pattern-filter">Curved/Flowers</button>
                                <button onclick="togglePatternFilter('shapes','geometric',this)" class="filter-btn pattern-filter">Geometric</button>
                                <button onclick="togglePatternFilter('shapes','blobs',this)" class="filter-btn pattern-filter">Irregular/Random</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">How is it made?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="togglePatternFilter('method','woven',this)" class="filter-btn pattern-filter">Part of fabric</button>
                                <button onclick="togglePatternFilter('method','printed',this)" class="filter-btn pattern-filter">Printed on top</button>
                                <button onclick="togglePatternFilter('method','stitched',this)" class="filter-btn pattern-filter">Stitched/Sewn on</button>
                            </div>
                            <div id="pattern-helper" class="help-text hidden"></div>
                        </div>
                        
                        <!-- Print Type (shows when Graphic selected) -->
                        <div id="print-type-section" class="hidden nested-section" style="margin-top:10px; background:rgba(99,102,241,0.1); border-color:rgba(99,102,241,0.3);">
                            <div class="sub-label" style="color:#4338ca; margin-top:0;">Print Type</div>
                            <div class="btn-grid" style="grid-template-columns: repeat(5, 1fr); gap:4px; margin-bottom:4px;">
                                <button onclick="setPrintType('Screen', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Screen</button>
                                <button onclick="setPrintType('Heat', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Heat</button>
                                <button onclick="setPrintType('Puff', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Puff</button>
                                <button onclick="setPrintType('DTG', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">DTG</button>
                                <button onclick="setPrintType('AOP', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">AOP</button>
                            </div>
                            <div class="btn-grid btn-grid-4" style="gap:4px;">
                                <button onclick="setPrintType('Patch', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Patch</button>
                                <button onclick="setPrintType('Painted', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Painted</button>
                                <button onclick="setPrintType('Emb', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Emb</button>
                                <button onclick="setPrintType('Other', this)" class="btn btn-secondary print-btn" style="padding:8px 4px; font-size:10px;">Other</button>
                            </div>
                        </div>
                        
                        <!-- Graphic Category (shows when Graphic selected) -->
                        <div id="graphic-category-section" class="hidden nested-section" style="margin-top:8px; background:rgba(99,102,241,0.05); border-color:rgba(99,102,241,0.2);">
                            <div class="sub-label" style="color:#4338ca; margin-top:0;">Graphic Category</div>
                            <div class="btn-grid btn-grid-4" style="gap:4px; margin-bottom:4px;">
                                <button onclick="setGraphicCategory('Band', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üé∏ Band</button>
                                <button onclick="setGraphicCategory('Movie/TV', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üé¨ Movie/TV</button>
                                <button onclick="setGraphicCategory('Sports', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üèà Sports</button>
                                <button onclick="setGraphicCategory('Brand', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">‚Ñ¢Ô∏è Brand</button>
                            </div>
                            <div class="btn-grid btn-grid-4" style="gap:4px;">
                                <button onclick="setGraphicCategory('Art', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üé® Art</button>
                                <button onclick="setGraphicCategory('Tourist', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üó∫Ô∏è Tourist</button>
                                <button onclick="setGraphicCategory('Humor', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">üòÇ Humor</button>
                                <button onclick="setGraphicCategory('Other', this)" class="btn btn-secondary graphic-cat-btn" style="padding:8px 4px; font-size:10px;">Other</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-fabric-type" class="check-circle">‚óã</span> Fabric Type</div>
                        <div id="fabric-cards-grid" class="cards-grid"></div>
                        <!-- Other Fabric Types dropdown (eBay fabric types from PDF) -->
                        <select id="fabric-other-select" onchange="onFabricOtherChange()" class="form-select" style="margin-top:8px; font-size:12px;">
                            <option value="" selected>Other fabric types...</option>
                            <option value="Velvet">Velvet (plush, soft)</option>
                            <option value="Shearling">Shearling (wool/fur lined)</option>
                            <option value="Felt">Felt (pressed wool)</option>
                            <option value="Taffeta">Taffeta (crisp, shiny)</option>
                            <option value="Moleskin">Moleskin (soft brushed)</option>
                            <option value="Ponte">Ponte (stretchy dress)</option>
                            <option value="Lace">Lace (openwork)</option>
                            <option value="Georgette">Georgette (sheer crepe)</option>
                            <option value="Crepe">Crepe (textured, crinkly)</option>
                            <option value="Chiffon">Chiffon (sheer, flowy)</option>
                            <option value="Satin">Satin (shiny, smooth)</option>
                            <option value="Gauze">Gauze (lightweight, airy)</option>
                            <option value="Corduroy">Corduroy (vertical ridges)</option>
                            <option value="Softshell">Softshell (tech outdoor)</option>
                            <option value="Cannot Determine">Cannot Determine</option>
                            <option value="Custom">Custom (type below)...</option>
                        </select>
                        <input type="text" id="fabric-custom-input" placeholder="Type custom fabric type..." class="form-input hidden" style="margin-top:6px; font-size:12px;" oninput="onFabricCustomInput()">
                        <!-- Denim Wash (shows when denim selected) -->
                        <div id="wash-section" class="hidden nested-section" style="margin-top:10px;">
                            <div class="sub-label" style="color:#0369a1;">Denim Wash</div>
                            <div class="btn-grid btn-grid-4">
                                <button onclick="setWash('Light', this)" class="btn btn-secondary wash-btn">Light</button>
                                <button onclick="setWash('Medium', this)" class="btn btn-secondary wash-btn">Medium</button>
                                <button onclick="setWash('Dark', this)" class="btn btn-default wash-btn">Dark</button>
                                <button onclick="setWash('Raw', this)" class="btn btn-secondary wash-btn">Raw</button>
                                <button onclick="setWash('Acid', this)" class="btn btn-secondary wash-btn">Acid</button>
                                <button onclick="setWash('Stone', this)" class="btn btn-secondary wash-btn">Stone</button>
                                <button onclick="setWash('Rinse', this)" class="btn btn-secondary wash-btn">Rinse</button>
                                <button onclick="setWash('Black', this)" class="btn btn-secondary wash-btn">Black</button>
                            </div>
                        </div>
                        <button id="fabric-help-btn" onclick="toggleFabricHelp()" class="help-btn" style="margin-top:8px;">ü§î Not Sure?</button>
                        <div id="fabric-help-panel" class="help-panel hidden">
                            <div class="sub-label" style="color:#92400e;">How does it feel?</div>
                            <div class="filter-row">
                                <button onclick="toggleFabricFilter('stretch','none',this)" class="filter-btn fabric-filter">Rigid</button>
                                <button onclick="toggleFabricFilter('stretch','high',this)" class="filter-btn fabric-filter">Stretchy</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">Surface look/feel?</div>
                            <div class="filter-row">
                                <button onclick="toggleFabricFilter('surface','smooth',this)" class="filter-btn fabric-filter">Smooth</button>
                                <button onclick="toggleFabricFilter('surface','diagonal',this)" class="filter-btn fabric-filter">Diagonal lines</button>
                                <button onclick="toggleFabricFilter('surface','ridged',this)" class="filter-btn fabric-filter">Ridges</button>
                                <button onclick="toggleFabricFilter('surface','rough',this)" class="filter-btn fabric-filter">Rough/Textured</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">Inside texture?</div>
                            <div class="filter-row">
                                <button onclick="toggleFabricFilter('interior','smooth',this)" class="filter-btn fabric-filter">Smooth</button>
                                <button onclick="toggleFabricFilter('interior','fuzzy',this)" class="filter-btn fabric-filter">Fuzzy/Soft</button>
                                <button onclick="toggleFabricFilter('interior','loops',this)" class="filter-btn fabric-filter">Tiny Loops</button>
                            </div>
                            <div id="fabric-helper" class="help-text hidden"></div>
                        </div>
                        <!-- TAG CUT MODE: Expanded trait section (shows when tag missing/cut) -->
                        <div id="fabric-tag-cut-section" class="hidden" style="background:#fef2f2; border:2px solid #fca5a5; border-radius:10px; padding:12px; margin-top:10px;">
                            <div style="font-size:12px; font-weight:700; color:#b91c1c; margin-bottom:8px;">‚ö†Ô∏è NO TAG - Answer these questions (mandatory)</div>
                            <div class="sub-label" style="color:#991b1b;">How does it feel?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleFabricFilter('stretch','none',this)" class="filter-btn fabric-filter tagcut-btn">Rigid</button>
                                <button onclick="toggleFabricFilter('stretch','high',this)" class="filter-btn fabric-filter tagcut-btn">Stretchy</button>
                            </div>
                            <div class="sub-label" style="color:#991b1b;">Surface look/feel?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleFabricFilter('surface','smooth',this)" class="filter-btn fabric-filter tagcut-btn">Smooth</button>
                                <button onclick="toggleFabricFilter('surface','diagonal',this)" class="filter-btn fabric-filter tagcut-btn">Diagonal</button>
                                <button onclick="toggleFabricFilter('surface','ridged',this)" class="filter-btn fabric-filter tagcut-btn">Ridges</button>
                                <button onclick="toggleFabricFilter('surface','rough',this)" class="filter-btn fabric-filter tagcut-btn">Rough</button>
                            </div>
                            <div class="sub-label" style="color:#991b1b;">Inside texture?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleFabricFilter('interior','smooth',this)" class="filter-btn fabric-filter tagcut-btn">Smooth</button>
                                <button onclick="toggleFabricFilter('interior','fuzzy',this)" class="filter-btn fabric-filter tagcut-btn">Fuzzy</button>
                                <button onclick="toggleFabricFilter('interior','loops',this)" class="filter-btn fabric-filter tagcut-btn">Loops</button>
                            </div>
                            <div id="fabric-helper-tagcut" class="help-text"></div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-material" class="check-circle">‚óã</span> Material</div>
                        <div id="material-tag-warning" class="tag-warning hidden">‚ö†Ô∏è No readable tag ‚Äî use touch tests</div>
                        <div id="material-cards-grid" class="cards-grid"></div>
                        <!-- Other Materials dropdown -->
                        <select id="material-other-select" onchange="onMaterialOtherChange()" class="form-select" style="margin-top:8px; font-size:12px;">
                            <option value="" selected>Other materials...</option>
                            <option value="Mohair">Mohair (fuzzy, luxe)</option>
                            <option value="Alpaca">Alpaca (soft, warm)</option>
                            <option value="Cashmere">Cashmere (luxury)</option>
                            <option value="Linen">Linen (breathable)</option>
                            <option value="Silk">Silk (shiny, luxe)</option>
                            <option value="Fur">Fur (real or faux)</option>
                            <option value="Canvas">Canvas (heavy cotton)</option>
                            <option value="Leather">Leather (real)</option>
                            <option value="Cannot Determine">Cannot Determine</option>
                            <option value="Custom">Custom (type below)...</option>
                        </select>
                        <input type="text" id="material-custom-input" placeholder="Type custom material..." class="form-input hidden" style="margin-top:6px; font-size:12px;" oninput="onMaterialCustomInput()">
                        <button id="material-help-btn" onclick="toggleMaterialHelp()" class="help-btn">ü§î Not Sure?</button>
                        <div id="material-help-panel" class="help-panel hidden">
                            <div class="sub-label" style="color:#92400e;">Temperature?</div>
                            <div class="filter-row">
                                <button onclick="toggleMaterialFilter('temp','cool',this)" class="filter-btn material-filter">Cool</button>
                                <button onclick="toggleMaterialFilter('temp','warm',this)" class="filter-btn material-filter">Warm</button>
                            </div>
                            <div class="sub-label" style="color:#92400e;">Shine?</div>
                            <div class="filter-row">
                                <button onclick="toggleMaterialFilter('shine','matte',this)" class="filter-btn material-filter">Matte</button>
                                <button onclick="toggleMaterialFilter('shine','sheen',this)" class="filter-btn material-filter">Sheen</button>
                            </div>
                            <div id="material-helper" class="help-text hidden"></div>
                        </div>
                        <!-- TAG CUT MODE: Expanded material trait section (shows when tag missing/cut) -->
                        <div id="material-tag-cut-section" class="hidden" style="background:#fef2f2; border:2px solid #fca5a5; border-radius:10px; padding:12px; margin-top:10px;">
                            <div style="font-size:12px; font-weight:700; color:#b91c1c; margin-bottom:8px;">‚ö†Ô∏è NO TAG - Answer these questions (mandatory)</div>
                            <div class="sub-label" style="color:#991b1b;">Touch it - Temperature?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleMaterialFilter('temp','cool',this)" class="filter-btn material-filter tagcut-btn">Cool (natural fibers)</button>
                                <button onclick="toggleMaterialFilter('temp','warm',this)" class="filter-btn material-filter tagcut-btn">Warm (synthetics)</button>
                            </div>
                            <div class="sub-label" style="color:#991b1b;">Look at it - Shine?</div>
                            <div class="filter-row" style="margin-bottom:8px;">
                                <button onclick="toggleMaterialFilter('shine','matte',this)" class="filter-btn material-filter tagcut-btn">Matte (no shine)</button>
                                <button onclick="toggleMaterialFilter('shine','sheen',this)" class="filter-btn material-filter tagcut-btn">Sheen (some shine)</button>
                            </div>
                            <div id="material-helper-tagcut" class="help-text"></div>
                        </div>
                    </div>
                    
                    <div class="section-card" id="construction-section">
                        <div class="section-label"><span id="check-construction" class="check-circle">‚óã</span> Construction</div>
                        <div class="sub-label">Sleeve Length</div>
                        <div class="btn-grid btn-grid-4" style="margin-bottom:10px;">
                            <button onclick="setSleeve('Short', this)" class="btn btn-default sleeve-btn">Short</button>
                            <button onclick="setSleeve('Long', this)" class="btn btn-secondary sleeve-btn">Long</button>
                            <button onclick="setSleeve('3/4', this)" class="btn btn-secondary sleeve-btn">3/4</button>
                            <button onclick="setSleeve('None', this)" class="btn btn-secondary sleeve-btn">None</button>
                        </div>
                        <div id="sleeve-style-section">
                            <div class="sub-label">Sleeve Style</div>
                            <div class="btn-grid btn-grid-3" style="margin-bottom:10px;">
                                <button onclick="setSleeveStyle('Standard', this)" class="btn btn-default style-btn">Standard</button>
                                <button onclick="setSleeveStyle('Raglan', this)" class="btn btn-secondary style-btn">Raglan</button>
                                <button onclick="setSleeveStyle('Dolman', this)" class="btn btn-secondary style-btn">Dolman</button>
                            </div>
                            <!-- Raglan/Dolman Measurement Notice -->
                            <div id="sleeve-measurement-notice" class="hidden" style="background:#fef3c7; border:1px solid #f59e0b; border-radius:10px; padding:10px; margin-bottom:10px;">
                                <div style="display:flex; align-items:flex-start; gap:8px;">
                                    <span style="font-size:18px;">üìè</span>
                                    <div>
                                        <div style="font-size:11px; font-weight:700; color:#92400e;">Special Sleeve Measurement</div>
                                        <div style="font-size:10px; color:#b45309; margin-top:4px;">
                                            <strong>No shoulder seam exists!</strong><br>
                                            Measure: <strong>Center of neck ‚Üí Cuff</strong><br>
                                            (Not shoulder to cuff)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Cutoff Section (shows when Sleeve = None on T-Shirts) -->
                        <div id="cutoff-section" class="hidden nested-section nested-amber" style="margin-bottom:10px;">
                            <div class="sub-label" style="color:#92400e; margin-top:0;">üî™ Cut-off / Muscle Tee?</div>
                            <div class="btn-grid btn-grid-2" style="margin-bottom:8px;">
                                <button onclick="setCutoff('diy', this)" class="btn btn-secondary cutoff-btn" style="display:flex; flex-direction:column; align-items:center; padding:12px 8px;">
                                    <span style="font-size:20px;">‚úÇÔ∏è</span>
                                    <span style="font-size:11px; font-weight:700;">DIY Cut-off</span>
                                    <span style="font-size:9px; color:#666;">Sleeves removed</span>
                                </button>
                                <button onclick="setCutoff('manufactured', this)" class="btn btn-secondary cutoff-btn" style="display:flex; flex-direction:column; align-items:center; padding:12px 8px;">
                                    <span style="font-size:20px;">üè≠</span>
                                    <span style="font-size:11px; font-weight:700;">Manufactured</span>
                                    <span style="font-size:9px; color:#666;">Made sleeveless</span>
                                </button>
                            </div>
                            <div style="font-size:10px; color:#92400e;">üí° This stays categorized as T-Shirt for searchability</div>
                        </div>
                        <div id="stitch-section">
                            <div class="sub-label">Stitch Type</div>
                            <div class="btn-grid btn-grid-2">
                                <button onclick="setStitch('Single', this)" class="btn btn-secondary stitch-btn">Single Stitch</button>
                                <button onclick="setStitch('Double', this)" class="btn btn-default stitch-btn">Double Stitch</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-feel" class="check-circle">‚óã</span> Feel</div>
                        <div class="sub-label">Thickness</div>
                        <div class="btn-grid btn-grid-4" style="margin-bottom:10px;">
                            <button onclick="setThickness('Paper', this)" class="btn btn-secondary thickness-btn">Paper</button>
                            <button onclick="setThickness('Light', this)" class="btn btn-secondary thickness-btn">Light</button>
                            <button onclick="setThickness('Standard', this)" class="btn btn-default thickness-btn">Standard</button>
                            <button onclick="setThickness('Heavy', this)" class="btn btn-secondary thickness-btn">Heavy</button>
                        </div>
                        <div class="sub-label">Layers</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="setLayers('Single', this)" class="btn btn-default layers-btn">Single</button>
                            <button onclick="setLayers('Reversible', this)" class="btn btn-secondary layers-btn">Reversible</button>
                            <button onclick="setLayers('Lined', this)" class="btn btn-secondary layers-btn">Lined</button>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button onclick="goToStep(1)" class="nav-btn nav-btn-back">‚Üê Back</button>
                        <button onclick="goToStep(3)" class="nav-btn nav-btn-next">Next: Snap ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 3: SNAP & SEND -->
                <div id="step-3" class="step-container">
                    <div class="section-card">
                        <div class="section-label"><span id="check-condition" class="check-circle">‚óã</span> Any Issues?</div>
                        <button onclick="setClean(this)" id="btn-clean" class="btn btn-default" style="width:100%;margin-bottom:10px;padding:14px;">‚úì No Defects</button>
                        <div class="sub-label">Or tap defect type:</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="toggleDefect('Stain', this)" class="btn btn-secondary defect-type-btn defect-card"><span class="emoji">üíß</span><span class="label">Stain</span></button>
                            <button onclick="toggleDefect('Hole', this)" class="btn btn-secondary defect-type-btn defect-card"><span class="emoji">üï≥Ô∏è</span><span class="label">Hole</span></button>
                            <button onclick="toggleDefect('Repair', this)" class="btn btn-secondary defect-type-btn defect-card"><span class="emoji">üßµ</span><span class="label">Repair</span></button>
                        </div>
                    </div>
                    
                    <!-- ELASTIC CHECK (shows for Sweatpants) -->
                    <div id="elastic-section" class="section-card hidden">
                        <div class="section-label">ü©≤ Elastic Check</div>
                        <div class="btn-grid btn-grid-3">
                            <button onclick="setElastic('Solid', this)" class="btn btn-secondary elastic-btn" style="display:flex;flex-direction:column;align-items:center;padding:12px;">
                                <span style="font-size:18px;">üü¢</span>
                                <span style="font-size:11px;font-weight:700;">SOLID</span>
                                <span style="font-size:9px;color:#666;">(springy)</span>
                            </button>
                            <button onclick="setElastic('Crunchy', this)" class="btn btn-secondary elastic-btn" style="display:flex;flex-direction:column;align-items:center;padding:12px;">
                                <span style="font-size:18px;">üü°</span>
                                <span style="font-size:11px;font-weight:700;">CRUNCHY</span>
                                <span style="font-size:9px;color:#666;">(worn)</span>
                            </button>
                            <button onclick="setElastic('None', this)" class="btn btn-secondary elastic-btn" style="display:flex;flex-direction:column;align-items:center;padding:12px;">
                                <span style="font-size:18px;">‚¨ú</span>
                                <span style="font-size:11px;font-weight:700;">NO ELASTIC</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-weight" class="check-circle">‚óã</span> ‚öñÔ∏è Weight</div>
                        <div class="btn-grid btn-grid-2">
                            <select id="weight-lb" onchange="updateWeight()" class="form-select" style="font-size:16px;font-weight:700;">
                                <option value="0" selected>0 lb</option>
                                <option value="1">1 lb</option>
                                <option value="2">2 lb</option>
                                <option value="3">3 lb</option>
                                <option value="4">4 lb</option>
                                <option value="5">5 lb</option>
                            </select>
                            <select id="weight-oz" onchange="updateWeight()" class="form-select" style="font-size:16px;font-weight:700;">
                                <option value="0" selected>0 oz</option>
                                <option value="3">3 oz</option>
                                <option value="4">4 oz</option>
                                <option value="5">5 oz</option>
                                <option value="6">6 oz</option>
                                <option value="7">7 oz</option>
                                <option value="8">8 oz</option>
                                <option value="9">9 oz</option>
                                <option value="10">10 oz</option>
                                <option value="11">11 oz</option>
                                <option value="12">12 oz</option>
                                <option value="13">13 oz</option>
                                <option value="14">14 oz</option>
                                <option value="15">15 oz</option>
                            </select>
                        </div>
                        <div style="margin-top:8px;font-size:11px;color:var(--color-text-muted);">‚¨ÜÔ∏è <strong>Always round up</strong></div>
                    </div>
                    
                    <!-- AUDIO MEASUREMENTS -->
                    <div class="section-card">
                        <div class="section-label"><span id="check-audio" class="check-circle">‚óã</span> üé§ Measurements</div>
                        <!-- Category-specific measurement hints -->
                        <div id="measure-hint-tops" class="nested-section" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Shoulder to shoulder<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br>6. Sleeve (shoulder to cuff)</div>
                        </div>
                        <div id="measure-hint-button-shirt" class="nested-section hidden" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div style="font-size:10px;color:#3b82f6;line-height:1.6;">1. <strong>Neck circumference</strong> (collar button to button)<br>2. Shoulder to shoulder<br>3. Pit to pit chest<br>4. Waist<br>5. Length<br>6. Sleeve (shoulder to cuff)</div>
                        </div>
                        <div id="measure-hint-bottoms" class="nested-section hidden" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Waist (flat across)<br>2. Rise (crotch to top)<br>3. Inseam (crotch to hem)<br>4. Thigh (at crotch)<br>5. Leg opening<br>6. Total length (waist to hem)</div>
                        </div>
                        <div id="measure-hint-outer" class="nested-section hidden" style="margin-bottom:10px;background:#eff6ff;border-color:#bfdbfe;">
                            <div style="font-size:11px;font-weight:700;color:#1e40af;margin-bottom:6px;">Say each + "inches":</div>
                            <div style="font-size:10px;color:#3b82f6;line-height:1.6;">1. Shoulder to shoulder<br>2. Pit to pit chest<br>3. Waist<br>4. Bottom hem<br>5. Length (back of collar to hem)<br>6. Sleeve (shoulder to cuff)</div>
                        </div>
                        <div id="record-section">
                            <button id="record-btn" onclick="toggleRecording()" class="btn btn-hero" style="width:100%;background:#ef4444;padding:16px;display:flex;flex-direction:column;align-items:center;gap:4px;">
                                <span style="font-size:24px;">üé§</span>
                                <span>TAP TO RECORD</span>
                            </button>
                        </div>
                        <div id="post-record-section" class="hidden">
                            <div class="nested-section" style="background:#f0fdf4;border-color:#86efac;text-align:center;margin-bottom:8px;">
                                <div style="color:#16a34a;font-weight:700;font-size:14px;">‚úì RECORDED</div>
                                <div style="color:#22c55e;font-family:monospace;font-size:18px;" id="recording-duration">0:00</div>
                            </div>
                            <button onclick="reRecord()" style="width:100%;padding:8px;background:none;border:none;color:var(--color-text-muted);font-size:12px;text-decoration:underline;cursor:pointer;">Re-record</button>
                        </div>
                    </div>
                    
                    <div class="section-card">
                        <div class="section-label"><span id="check-sku" class="check-circle">‚óã</span> SKU</div>
                        <div class="sku-row">
                            <input type="text" id="sku-input" class="form-input" placeholder="Scan or type SKU..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" oninput="onSkuInput()" onkeydown="handleSkuKeydown(event)" style="font-size:18px;font-family:monospace;">
                            <button onclick="activateSkuScan()" class="scan-btn" title="Scan with C922X camera">üì∑</button>
                        </div>
                        <div id="sku-status" style="font-size:10px;color:var(--color-text-muted);margin-top:4px;"></div>
                        <div id="sku-camera-status" style="font-size:10px;color:#16a34a;margin-top:4px;display:none;">üì∑ C922X active - scan barcode now</div>
                    </div>
                    
                    <!-- FLAG AS UNUSUAL -->
                    <button id="flag-btn" onclick="toggleFlagUnusual()" class="flag-unusual-btn">
                        <div style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;">
                            <span>ü§î</span>
                            <span>FLAG AS UNUSUAL</span>
                        </div>
                        <div style="font-size:10px;font-weight:normal;margin-top:4px;opacity:0.8;">
                            Brand you don't recognize ‚Ä¢ Special construction ‚Ä¢ Gut feeling
                        </div>
                    </button>
                    
                    <div class="nav-buttons">
                        <button onclick="goToStep(2)" class="nav-btn nav-btn-back">‚Üê Back</button>
                        <button onclick="goToStep(4)" class="nav-btn nav-btn-next" style="flex:2;">Next: Review ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 4: REVIEW -->
                <div id="step-4" class="step-container">
                    <div class="review-banner">‚ú® Almost done! Quick review</div>
                    
                    <div class="review-grid">
                        <div id="card-tag" onclick="goToStep(1)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-tag">‚ö†Ô∏è</span>
                                <span class="title">TAG</span>
                            </div>
                            <div class="review-card-summary" id="summary-tag">--</div>
                        </div>
                        <div id="card-check" onclick="goToStep(2)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-check">‚ö†Ô∏è</span>
                                <span class="title">CHECK</span>
                            </div>
                            <div class="review-card-summary" id="summary-check">--</div>
                        </div>
                        <div id="card-snap" onclick="goToStep(3)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-snap">‚ö†Ô∏è</span>
                                <span class="title">SNAP</span>
                            </div>
                            <div class="review-card-summary" id="summary-snap">--</div>
                        </div>
                        <div id="card-weight" onclick="goToStep(3)" class="review-card card-yellow">
                            <div class="review-card-header">
                                <span class="icon" id="icon-weight">‚ö†Ô∏è</span>
                                <span class="title">WEIGHT</span>
                            </div>
                            <div class="review-card-summary" id="summary-weight">--</div>
                        </div>
                    </div>
                    
                    <div id="flag-status" class="flag-banner hidden">üö© FLAGGED FOR REVIEW</div>
                    
                    <button id="submit-btn" class="submit-btn" onclick="submitItem()" disabled>SUBMIT ‚úì</button>
                    
                    <div class="nav-buttons" style="border-top:none;padding-top:8px;">
                        <button onclick="goToStep(3)" class="nav-btn nav-btn-back" style="flex:1;">‚Üê Back</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CENTER: Camera -->
        <div class="camera-panel">
            <div class="camera-header">
                <select id="camera-select" class="camera-select" onchange="switchCamera(this.value)"><option value="">Select Camera...</option></select>
                <span id="camera-indicator" style="background:#3b82f6;color:white;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;">üì¶ BRIO</span>
                <span id="camera-resolution" style="color:#6b7280;font-size:10px;font-family:monospace;">--</span>
                <button onclick="forceMaxResolution()" style="background:#16a34a;color:white;padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;border:none;cursor:pointer;" title="Click to force maximum resolution">FULL RES</button>
                <div id="camera-status" class="camera-status">No camera</div>
            </div>
            <div class="camera-view">
                <div class="camera-view-container">
                    <div class="camera-placeholder" id="camera-placeholder">
                        <div class="camera-placeholder-icon">üì∑</div>
                        <div>Select a camera to begin</div>
                        <div style="font-size:11px;margin-top:6px;color:#555;">Logitech Brio 4K recommended</div>
                    </div>
                    <video id="camera-video" autoplay playsinline style="display:none;"></video>
                    <div class="camera-overlay" id="camera-overlay">
                        <div class="camera-grid"></div>
                        <!-- Stabilizer Indicator -->
                        <div class="stabilizer-indicator" id="stabilizer-indicator">
                            <div class="stabilizer-dot" id="stabilizer-dot"></div>
                            <span class="stabilizer-text" id="stabilizer-text">HOLD STEADY</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="camera-footer">
                <button class="mode-btn active" id="mode-main" onclick="setPhotoMode('main')">üì¶ Main<br><small style="font-size:9px;opacity:0.7;">Brio</small></button>
                <button class="mode-btn" id="mode-tag" onclick="setPhotoMode('tag')">üè∑Ô∏è Tag<br><small style="font-size:9px;opacity:0.7;">C922X</small></button>
                <div style="text-align:center;">
                    <button class="shutter-btn" id="shutter-btn" onclick="capturePhoto()"></button>
                    <div class="shutter-hint">Press <kbd>SPACE</kbd> or foot pedal</div>
                </div>
                <button class="mode-btn" id="mode-defect" onclick="setPhotoMode('defect')">‚ö†Ô∏è Defects<br><small style="font-size:9px;opacity:0.7;">C922X</small></button>
                <button class="mode-btn mode-btn-sku" id="mode-sku" onclick="setPhotoMode('sku')">üì∑ SKU<br><small style="font-size:9px;opacity:0.7;">C922X</small></button>
            </div>
        </div>
        
        <!-- RIGHT: Photos -->
        <div class="photos-panel">
            <div class="photos-header"><span>Photos</span><span class="photo-count" id="photo-count">0</span></div>
            <div style="font-size:9px;color:var(--color-text-muted);margin-bottom:12px;">Double-click to preview</div>
            <div class="photo-section">
                <div class="photo-section-title"><span>Main Photos</span><span id="main-count">0</span></div>
                <div class="photo-grid" id="main-photos-grid"><div class="photo-thumb photo-thumb-empty" onclick="setPhotoMode('main')">+</div></div>
            </div>
            <div class="photo-section">
                <div class="photo-section-title"><span>Tag Photos</span><span id="tag-count">0</span></div>
                <div class="photo-grid" id="tag-photos-grid"><div class="photo-thumb photo-thumb-empty" onclick="setPhotoMode('tag')">+</div></div>
            </div>
            <div class="photo-section">
                <div class="photo-section-title"><span>Defect Photos</span><span id="defect-count">0</span></div>
                <div class="photo-grid" id="defect-photos-grid"><div class="photo-thumb photo-thumb-empty" onclick="setPhotoMode('defect')">+</div></div>
            </div>
            <div class="stats-section">
                <div style="font-size:10px;color:var(--color-text-muted);font-weight:700;margin-bottom:8px;">Today's Stats</div>
                <div class="stats-grid">
                    <div><div class="stat-value" style="color:var(--color-primary)" id="stat-today">0</div><div class="stat-label">Today</div></div>
                    <div><div class="stat-value" style="color:var(--color-success)" id="stat-week">0</div><div class="stat-label">Week</div></div>
                    <div><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total</div></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const APP_PIN = "1234";
        const N8N_WEBHOOK_URL = "https://jeffkoga.app.n8n.cloud/webhook/0845a6d3-be69-4b68-aba7-28f55112678c";
        let data = { superCategory:'tops', category:'', tagStatus:'', tagSize:'', origin:'', country:'', gender:'', colors:[], fade:'', pattern:'', patternTraits:{lines:'',shapes:'',method:''}, printType:'', graphicCategory:'', fabricType:'', fabricTraits:{stretch:'',surface:'',interior:''}, wash:'', material:'', materialTraits:{temp:'',shine:''}, sleeveLength:'', sleeveStyle:'', cutoffType:'', stitch:'', thickness:'', layers:'', hasDefects:null, defectTypes:[], weightLb:0, weightOz:0, sku:'', photographer:'P02', audioMeasure:null, audioDuration:0, mainPhotos:[], tagPhotos:[], defectPhotos:[], flagged:false, elasticCheck:'' };
        let stats = { today:0, week:0, total:0 }, currentStep = 1, photoMode = 'main', currentStream = null;
        let fabricFilters = { stretch:null, surface:null, interior:null }, materialFilters = { temp:null, shine:null }, patternFilters = { lines:null, shapes:null, method:null };
        let tagCutMode = false; // When true, fabric selection disabled, traits mandatory
        let timerStart = null, timerInterval = null, itemTimes = [];
        let mediaRecorder = null, audioChunks = [], recordingStart = null, recordingInterval = null;
        let mainCameraId = null, secondaryCameraId = null, activeCameraId = null;
        let barcodeDetector = null, barcodeScanInterval = null;
        // Stabilizer variables
        let stabilizerInterval = null, stabilizerCanvas = null, stabilizerCtx = null;
        let previousFrame = null, stableFrameCount = 0, isStable = false;
        const STABILITY_THRESHOLD = 8; // Lower = more sensitive
        const FRAMES_NEEDED = 3; // Frames needed to be "stable"
        let previewMode = null, previewIndex = 0;

        const categoryConfig = {
            tops: { heroes: ['T-Shirt', 'Sweatshirt', 'Hoodie'], others: ['Sweater', 'Button Shirt', 'Polo', 'Jersey', 'Tank Top', 'Cardigan', 'Blouse', 'Tunic'] },
            bottoms: { heroes: ['Jeans', 'Pants'], others: ['Shorts', 'Sweatpants'] },
            outer: { heroes: ['Jacket', 'Coat'], others: ['Vest'] }
        };
        const catEmojis = { 'T-Shirt':'üëï', 'Sweatshirt':'üèãÔ∏è', 'Hoodie':'üß•', 'Sweater':'üß∂', 'Button Shirt':'üëî', 'Polo':'üèåÔ∏è', 'Jersey':'üèÄ', 'Tank Top':'ü©±', 'Cardigan':'üß•', 'Jeans':'üëñ', 'Pants':'üëñ', 'Shorts':'ü©≥', 'Sweatpants':'üèÉ', 'Jacket':'üß•', 'Coat':'üß•', 'Vest':'ü¶∫', 'Blouse':'üëö', 'Tunic':'üëó' };
        
        // V99.15: fabricDB with full traits (stretch, surface, interior)
        // surface: smooth, ridged, diagonal, rough/textured
        const fabricDB = {
            // TOPS
            "T-Shirt": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Standard tee. Stretchy, smooth both sides." },
                { name:"Jersey", priority:1, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Same as Knit. eBay uses this term." },
                { name:"Rayon", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Silky, drapey. 80s/90s soft tees." },
                { name:"Woven", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Rigid like dress shirt. Rare for tees." },
                { name:"Mesh", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"See-through with tiny holes. Athletic." }
            ],
            "Sweatshirt": [
                { name:"Fleece", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside, smooth outside. 90% of sweats." },
                { name:"French Terry", priority:2, traits:{stretch:"high",surface:"smooth",interior:"loops"}, desc:"Tiny loops inside. Lighter, summer weight." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Sweater-like. Smooth both sides." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin like a thick t-shirt." }
            ],
            "Hoodie": [
                { name:"Fleece", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside, smooth outside. Most common." },
                { name:"French Terry", priority:2, traits:{stretch:"high",surface:"smooth",interior:"loops"}, desc:"Tiny loops inside. Lighter weight." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Sweater-like hoodie." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin, lightweight hoodie." }
            ],
            "Sweater": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Standard sweater. Stretchy yarn loops visible." },
                { name:"Crochet", priority:2, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Open holes, handmade look." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin, lightweight sweater." }
            ],
            "Cardigan": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Standard cardigan with buttons/open front." },
                { name:"Crochet", priority:2, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Open holes, handmade look." },
                { name:"Jersey", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Thin, lightweight." }
            ],
            "Button Shirt": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Dress shirt fabric. Rigid, no stretch." },
                { name:"Poplin", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Crisp dress shirt. Fine weave." },
                { name:"Chambray", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Looks like light denim but softer." },
                { name:"Denim", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean material. Western/work shirt." },
                { name:"Flannel", priority:2, traits:{stretch:"none",surface:"smooth",interior:"fuzzy"}, desc:"Soft, fuzzy inside. Often plaid." },
                { name:"Corduroy", priority:3, traits:{stretch:"none",surface:"ridged",interior:"smooth"}, desc:"Vertical ridges you can feel & see." }
            ],
            "Polo": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Standard polo. Stretchy with textured surface." },
                { name:"Jersey", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"T-shirt-like polo. Smoother." },
                { name:"Woven", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Dress polo. Rigid like button shirt." }
            ],
            "Tank Top": [
                { name:"Jersey", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Standard tank. Soft & stretchy." },
                { name:"Knit", priority:1, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Same as Jersey." },
                { name:"Rayon", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Silky, drapey feel." },
                { name:"Mesh", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"See-through athletic. Tiny holes." }
            ],
            "Blouse": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Standard blouse. Rigid fabric." },
                { name:"Chiffon", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Sheer, flowy. You can see through it." },
                { name:"Satin", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Shiny, silky smooth." },
                { name:"Crepe", priority:2, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Slightly bumpy/crinkly texture." },
                { name:"Lace", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Decorative with pattern holes." },
                { name:"Georgette", priority:3, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Sheer crepe. Slightly rough feel." }
            ],
            "Tunic": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Standard tunic fabric." },
                { name:"Rayon", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Drapey, soft, silky feel." },
                { name:"Knit", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy tunic." },
                { name:"Crepe", priority:3, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Slightly bumpy texture." },
                { name:"Gauze", priority:3, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Very lightweight, airy, breathable." }
            ],
            "Jersey": [
                { name:"Mesh", priority:1, default:true, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Tiny holes. Most sports jerseys." },
                { name:"Jersey", priority:2, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Smooth. Baseball/hockey style." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Heavier, vintage style." }
            ],
            // BOTTOMS
            "Jeans": [
                { name:"Denim", priority:1, default:true, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Standard jean material. Diagonal weave." },
                { name:"Selvage", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Premium. Red/white line on inside cuff edge." }
            ],
            "Pants": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Dress pants. Smooth, rigid." },
                { name:"Twill", priority:1, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Chinos, khakis. Diagonal weave pattern." },
                { name:"Corduroy", priority:2, traits:{stretch:"none",surface:"ridged",interior:"smooth"}, desc:"Vertical ridges you can feel & see." },
                { name:"Canvas", priority:2, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Heavy, thick. Carhartt/workwear." },
                { name:"Moleskin", priority:3, traits:{stretch:"none",surface:"smooth",interior:"fuzzy"}, desc:"Soft, brushed cotton. Fuzzy feel." },
                { name:"Ponte", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy dress pant. Thick legging-like." }
            ],
            "Shorts": [
                { name:"Woven", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Standard shorts. No stretch." },
                { name:"Twill", priority:1, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Cotton shorts. Diagonal weave." },
                { name:"Canvas", priority:2, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Heavy, thick cotton." },
                { name:"Denim", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean shorts, cutoffs." },
                { name:"Mesh", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Athletic shorts. See-through holes." }
            ],
            "Sweatpants": [
                { name:"Fleece", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside. Standard sweats." },
                { name:"French Terry", priority:2, traits:{stretch:"high",surface:"smooth",interior:"loops"}, desc:"Tiny loops inside. Lighter." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Smooth both sides. Jogger style." }
            ],
            // OUTER
            "Jacket": [
                { name:"Canvas", priority:1, default:true, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Heavy cotton. Work jacket, Carhartt." },
                { name:"Nylon", priority:1, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Shiny, crinkly. Windbreaker, coach jacket." },
                { name:"Denim", priority:1, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean jacket material." },
                { name:"Twill", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Harrington, Dickies style." },
                { name:"Corduroy", priority:2, traits:{stretch:"none",surface:"ridged",interior:"smooth"}, desc:"Vertical ridges." },
                { name:"Softshell", priority:3, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy outdoor tech jacket." }
            ],
            "Coat": [
                { name:"Tweed", priority:1, default:true, traits:{stretch:"none",surface:"rough",interior:"smooth"}, desc:"Rough, speckled wool blend. Classic." },
                { name:"Woven", priority:1, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Wool dress coat. Smooth." },
                { name:"Velvet", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Soft, plush. Luxe look." },
                { name:"Shearling", priority:3, traits:{stretch:"none",surface:"smooth",interior:"fuzzy"}, desc:"Wool/fur lined inside." },
                { name:"Felt", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Pressed wool. Stiff." },
                { name:"Taffeta", priority:3, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Crisp, shiny. Formal." }
            ],
            "Vest": [
                { name:"Nylon", priority:1, default:true, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Puffer vest. Shiny, crinkly." },
                { name:"Fleece", priority:2, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Soft, fuzzy. Patagonia style." },
                { name:"Denim", priority:2, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean vest material." },
                { name:"Knit", priority:3, traits:{stretch:"high",surface:"rough",interior:"smooth"}, desc:"Sweater vest." }
            ],
            "default": [
                { name:"Knit", priority:1, default:true, traits:{stretch:"high",surface:"smooth",interior:"smooth"}, desc:"Stretchy, like t-shirt material." },
                { name:"Woven", priority:2, traits:{stretch:"none",surface:"smooth",interior:"smooth"}, desc:"Rigid, no stretch. Like dress shirt." },
                { name:"Fleece", priority:2, traits:{stretch:"high",surface:"smooth",interior:"fuzzy"}, desc:"Fuzzy inside." },
                { name:"Denim", priority:3, traits:{stretch:"none",surface:"diagonal",interior:"smooth"}, desc:"Jean material." }
            ]
        };
        // V99.9: materialDB from eBay official materials (per PDF)
        const materialDB = {
            // TOPS
            "T-Shirt": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Cool, soft." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic. Slight sheen." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Silky, drapey." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic, athletic." },
                { name:"Acrylic", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic wool-like." }
            ],
            "Sweatshirt": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Most common." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Acrylic", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Rare, warm." }
            ],
            "Hoodie": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Most common." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Tech fleece." },
                { name:"Acrylic", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." }
            ],
            "Sweater": [
                { name:"Wool", priority:1, default:true, traits:{temp:"warm",shine:"matte"}, desc:"Classic. Warm." },
                { name:"Acrylic", priority:1, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic wool." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Lightweight." },
                { name:"Cashmere", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Luxury. Ultra soft." },
                { name:"Mohair", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Fuzzy, luxe." },
                { name:"Alpaca", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Soft, warm." }
            ],
            "Cardigan": [
                { name:"Wool", priority:1, default:true, traits:{temp:"warm",shine:"matte"}, desc:"Classic cardigan." },
                { name:"Acrylic", priority:1, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic wool." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Lightweight." },
                { name:"Cashmere", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Luxury." },
                { name:"Mohair", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Fuzzy." },
                { name:"Alpaca", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Soft, warm." }
            ],
            "Button Shirt": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural. Crisp." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Wrinkle-free." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Silky, drapey." },
                { name:"Linen", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Cool, wrinkles." },
                { name:"Silk", priority:3, traits:{temp:"cool",shine:"sheen"}, desc:"Luxury. Shiny." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Disco era." }
            ],
            "Polo": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Classic polo." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Acrylic", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." }
            ],
            "Tank Top": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Classic tank." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Silky." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." }
            ],
            "Blouse": [
                { name:"Polyester", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Most common vintage." },
                { name:"Rayon", priority:1, traits:{temp:"cool",shine:"sheen"}, desc:"Silky, drapey." },
                { name:"Silk", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Luxury." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Natural." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"70s-80s." }
            ],
            "Tunic": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Drapey." },
                { name:"Linen", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Breathable." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Warm." }
            ],
            "Jersey": [
                { name:"Polyester", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Most athletic." },
                { name:"Nylon", priority:1, traits:{temp:"warm",shine:"sheen"}, desc:"Mesh jerseys." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Vintage baseball." },
                { name:"Rayon", priority:3, traits:{temp:"cool",shine:"sheen"}, desc:"Old school." }
            ],
            // BOTTOMS
            "Jeans": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"100% denim." },
                { name:"Polyester", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Rare blend." }
            ],
            "Pants": [
                { name:"Polyester", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Dress pants." },
                { name:"Cotton", priority:1, traits:{temp:"cool",shine:"matte"}, desc:"Chinos." },
                { name:"Wool", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Dress wool." },
                { name:"Rayon", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Drapey." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Canvas", priority:3, traits:{temp:"cool",shine:"matte"}, desc:"Workwear." }
            ],
            "Shorts": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Cotton shorts." },
                { name:"Nylon", priority:1, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic/swim." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Canvas", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Heavy duty." },
                { name:"Rayon", priority:3, traits:{temp:"cool",shine:"sheen"}, desc:"Drapey." }
            ],
            "Sweatpants": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Classic sweats." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Acrylic", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Synthetic." }
            ],
            // OUTER
            "Jacket": [
                { name:"Nylon", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Windbreaker." },
                { name:"Polyester", priority:1, traits:{temp:"warm",shine:"sheen"}, desc:"Athletic." },
                { name:"Canvas", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Work jacket." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Denim/canvas." },
                { name:"Leather", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Moto, bomber." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Varsity." }
            ],
            "Coat": [
                { name:"Wool", priority:1, default:true, traits:{temp:"warm",shine:"matte"}, desc:"Dress coat." },
                { name:"Leather", priority:2, traits:{temp:"cool",shine:"sheen"}, desc:"Trench, long." },
                { name:"Nylon", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Puffer." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Down fill." },
                { name:"Cashmere", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Luxury." },
                { name:"Fur", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Real/faux fur." }
            ],
            "Vest": [
                { name:"Nylon", priority:1, default:true, traits:{temp:"warm",shine:"sheen"}, desc:"Puffer." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Fleece." },
                { name:"Cotton", priority:2, traits:{temp:"cool",shine:"matte"}, desc:"Denim." },
                { name:"Wool", priority:3, traits:{temp:"warm",shine:"matte"}, desc:"Sweater vest." }
            ],
            "default": [
                { name:"Cotton", priority:1, default:true, traits:{temp:"cool",shine:"matte"}, desc:"Natural fiber." },
                { name:"Polyester", priority:2, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic." },
                { name:"Wool", priority:2, traits:{temp:"warm",shine:"matte"}, desc:"Warm, natural." },
                { name:"Nylon", priority:3, traits:{temp:"warm",shine:"sheen"}, desc:"Synthetic." }
            ]
        };

        // V99.15: patternDB with traits for dynamic pattern identification
        // lines: none, stripes, grid (crossing lines)
        // shapes: none, dots, curved (flowers/paisley), geometric, blobs (irregular)
        // method: woven (part of fabric), printed (on surface), stitched (embroidered)
        const patternDB = [
            { name:"Solid", priority:1, default:true, traits:{lines:"none",shapes:"none",method:"woven"}, desc:"One color only. No pattern.", examples:"Plain tee, blank shirt" },
            { name:"Graphic", priority:1, traits:{lines:"none",shapes:"any",method:"printed"}, desc:"Image/text printed on fabric.", examples:"Band tee, logo shirt, artwork" },
            { name:"Striped", priority:2, traits:{lines:"stripes",shapes:"none",method:"woven"}, desc:"Parallel lines in one direction.", examples:"Sailor stripe, pinstripe, rugby stripe" },
            { name:"Color Block", priority:2, traits:{lines:"none",shapes:"geometric",method:"woven"}, desc:"Large solid color sections sewn together.", examples:"90s windbreaker, panel tee" },
            { name:"Plaid", priority:2, traits:{lines:"grid",shapes:"none",method:"woven"}, desc:"Crossing horizontal + vertical lines.", examples:"Flannel, tartan, buffalo check, gingham" },
            { name:"Tie Dye", priority:2, traits:{lines:"none",shapes:"curved",method:"printed"}, desc:"Swirly, spiral, or burst patterns.", examples:"Spiral tie dye, crinkle, bull's eye" },
            { name:"Camo", priority:3, traits:{lines:"none",shapes:"blobs",method:"printed"}, desc:"Irregular organic blob shapes.", examples:"Military camo, woodland, digital camo" },
            { name:"Embroidered", priority:3, traits:{lines:"none",shapes:"any",method:"stitched"}, desc:"Design stitched onto fabric.", examples:"Logo embroidery, patches, monogram" },
            { name:"Polka Dot", priority:3, traits:{lines:"none",shapes:"dots",method:"printed"}, desc:"Repeated circles/dots pattern.", examples:"Small dots, large dots, scattered dots" },
            { name:"Paisley", priority:3, traits:{lines:"none",shapes:"curved",method:"printed"}, desc:"Curved teardrop/kidney shapes.", examples:"Bandana pattern, western shirts" },
            { name:"Floral", priority:3, traits:{lines:"none",shapes:"curved",method:"printed"}, desc:"Flower and plant designs.", examples:"Hawaiian shirt, rose pattern, vintage blouse" },
            { name:"Animal", priority:3, traits:{lines:"none",shapes:"blobs",method:"printed"}, desc:"Animal print or animal images.", examples:"Leopard, zebra, snake, tiger print" },
            { name:"Geometric", priority:3, traits:{lines:"none",shapes:"geometric",method:"printed"}, desc:"Triangles, squares, abstract shapes.", examples:"80s geometric, aztec, chevron, argyle" },
            { name:"Checkered", priority:3, traits:{lines:"grid",shapes:"none",method:"woven"}, desc:"Simple two-color grid pattern.", examples:"Checkerboard, racing flag pattern" },
            { name:"Houndstooth", priority:3, traits:{lines:"grid",shapes:"geometric",method:"woven"}, desc:"Broken checks with pointed corners.", examples:"Classic houndstooth, oversized tooth" },
            { name:"Herringbone", priority:3, traits:{lines:"stripes",shapes:"geometric",method:"woven"}, desc:"V-shaped zigzag weave pattern.", examples:"Suit fabric, tweed pattern" },
            { name:"Abstract", priority:3, traits:{lines:"none",shapes:"blobs",method:"printed"}, desc:"Random artistic shapes/splashes.", examples:"Paint splatter, 80s abstract, modern art" },
            { name:"Other", priority:4, traits:{lines:"any",shapes:"any",method:"any"}, desc:"Pattern doesn't fit above options.", examples:"Unique, custom, rare patterns" }
        ];

        // V99.15: Tag Location Database - Where to find tags by category
        const tagLocationDB = {
            // TOPS
            "T-Shirt": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Hip/waist area on the left side - common on Y2K and modern tees", icon: "üìç" },
                    { location: "Bottom hem", desc: "Inside the bottom hem, usually left side", icon: "üìç" }
                ],
                tips: "Vintage tees (pre-90s) usually ONLY have neck tags. Modern/Y2K may have style codes on side seams."
            },
            "Polo": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left or right side seam", desc: "Hip/waist area - very common on polos!", icon: "‚≠ê" },
                    { location: "Bottom hem placket", desc: "Inside where the side slit is", icon: "üìç" }
                ],
                tips: "ALWAYS check both side seams on polos! Many brands put size/style tags there instead of the neck."
            },
            "Button Shirt": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Inside yoke", desc: "Below the collar seam, inside the back", icon: "üìç" },
                    { location: "Bottom front placket", desc: "Inside bottom of the button strip", icon: "üìç" },
                    { location: "Side seam", desc: "Hip area, left or right side", icon: "üìç" }
                ],
                tips: "Western shirts often have multiple small tags. Dress shirts may have tags at the bottom placket."
            },
            "Sweatshirt": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Hip/waist area", icon: "üìç" },
                    { location: "Inside bottom hem", desc: "Near the ribbing", icon: "üìç" }
                ],
                tips: "Champion reverse weave often has tags on the side seam. Russell Athletic uses neck tags."
            },
            "Hoodie": {
                primary: { location: "Back of neck", desc: "Inside below the hood attachment", icon: "üëî" },
                secondary: [
                    { location: "Inside kangaroo pocket", desc: "Check inside the front pouch pocket!", icon: "‚≠ê" },
                    { location: "Left side seam", desc: "Hip/waist area", icon: "üìç" }
                ],
                tips: "Some brands hide tags inside the kangaroo pocket to keep them from showing."
            },
            "Sweater": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Near the bottom hem", icon: "üìç" },
                    { location: "Inside bottom hem", desc: "Folded into the ribbing", icon: "üìç" }
                ],
                tips: "High-end sweaters may have very small woven tags. Check carefully at the neck seam."
            },
            "Cardigan": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Inside front facing", desc: "Behind the button placket", icon: "üìç" },
                    { location: "Side seam", desc: "Near bottom hem", icon: "üìç" }
                ],
                tips: "Button-front cardigans sometimes have tags inside the front facing."
            },
            "Tank Top": {
                primary: { location: "Back of neck", desc: "Inside center back, below the strap", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Under the arm area", icon: "üìç" }
                ],
                tips: "Tank tops often have smaller tags. May be printed directly on the fabric (tagless)."
            },
            "Long Sleeve": {
                primary: { location: "Back of neck", desc: "Inside the collar, center back", icon: "üëî" },
                secondary: [
                    { location: "Left side seam", desc: "Hip/waist area", icon: "üìç" },
                    { location: "Cuff area", desc: "Inside the sleeve cuff (rare)", icon: "üìç" }
                ],
                tips: "Thermal/waffle knits may have tags at the side seam instead of neck."
            },
            // BOTTOMS
            "Jeans": {
                primary: { location: "Back waistband", desc: "Inside center back, below the leather patch", icon: "üëñ" },
                secondary: [
                    { location: "Inner thigh/inseam", desc: "LEVI'S style - check where legs meet!", icon: "‚≠ê" },
                    { location: "Front waistband", desc: "WRANGLER style - opposite side of zipper fly", icon: "‚≠ê" },
                    { location: "Inside front pocket", desc: "Hidden in the right front pocket", icon: "üìç" },
                    { location: "Coin pocket", desc: "Inside the small watch pocket", icon: "üìç" }
                ],
                tips: "LEVI'S: Check inner thigh! WRANGLER: Check front waistband! Lee/others: Usually back waistband."
            },
            "Pants": {
                primary: { location: "Back waistband", desc: "Inside center back", icon: "üëñ" },
                secondary: [
                    { location: "Inside back pocket", desc: "DISCO/POLYESTER pants often here!", icon: "‚≠ê" },
                    { location: "Front waistband", desc: "Near the button/clasp", icon: "üìç" },
                    { location: "Inside front pocket", desc: "Hidden in the pocket bag", icon: "üìç" }
                ],
                tips: "Vintage polyester/disco pants often have tags in back pockets. Dress pants check all pockets!"
            },
            "Shorts": {
                primary: { location: "Back waistband", desc: "Inside center back", icon: "üëñ" },
                secondary: [
                    { location: "Inside pocket", desc: "Front or back pocket", icon: "üìç" },
                    { location: "Inner thigh", desc: "Side seam near crotch", icon: "üìç" }
                ],
                tips: "Athletic shorts may have tags on the inner liner. Swim trunks check the mesh liner."
            },
            "Sweatpants": {
                primary: { location: "Back waistband", desc: "Inside center back", icon: "üëñ" },
                secondary: [
                    { location: "Inside pocket", desc: "Hidden in the pocket", icon: "üìç" },
                    { location: "Left side seam", desc: "Near the hip", icon: "üìç" }
                ],
                tips: "Champion and Nike often have side seam tags. Check inside any pockets too."
            },
            // OUTER
            "Jacket": {
                primary: { location: "Inside left chest", desc: "Interior left breast area, sewn to lining", icon: "üß•" },
                secondary: [
                    { location: "Inside front pocket", desc: "Hidden inside a front pocket!", icon: "‚≠ê" },
                    { location: "Inside chest pocket", desc: "Interior breast pocket", icon: "‚≠ê" },
                    { location: "Back of neck", desc: "Inside collar area", icon: "üìç" },
                    { location: "Inside hem", desc: "Bottom interior edge", icon: "üìç" }
                ],
                tips: "Windbreakers/track jackets: check inside pockets! Denim jackets: usually inside left chest or neck."
            },
            "Coat": {
                primary: { location: "Inside left chest", desc: "Interior left breast area", icon: "üß•" },
                secondary: [
                    { location: "Inside pocket", desc: "Interior breast pocket or side pocket", icon: "‚≠ê" },
                    { location: "Back of neck", desc: "Inside the collar", icon: "üìç" },
                    { location: "Inside hem", desc: "Bottom interior, sometimes near vent", icon: "üìç" }
                ],
                tips: "Luxury coats may have multiple tags in different locations. Check ALL interior pockets."
            },
            "Vest": {
                primary: { location: "Inside left chest", desc: "Interior left breast area", icon: "üß•" },
                secondary: [
                    { location: "Inside pocket", desc: "Interior pocket", icon: "üìç" },
                    { location: "Back of neck", desc: "Inside at the back neckline", icon: "üìç" }
                ],
                tips: "Puffer vests often have tags inside pockets. Suit vests check interior left chest."
            },
            "default": {
                primary: { location: "Back of neck OR back waistband", desc: "Standard tag locations", icon: "üè∑Ô∏è" },
                secondary: [
                    { location: "Side seam", desc: "Left or right side at hip level", icon: "üìç" },
                    { location: "Inside pocket", desc: "Check all pockets!", icon: "üìç" }
                ],
                tips: "When in doubt: neck area for tops, waistband for bottoms, interior chest for outerwear."
            }
        };

        // Debug: Check camera capabilities (call from browser console)
        window.checkCameraCapabilities = async function() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            
            for(const device of videoDevices) {
                console.log(`\nüì∑ ${device.label}`);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: device.deviceId } }
                    });
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    console.log('  Width range:', capabilities.width?.min, '-', capabilities.width?.max);
                    console.log('  Height range:', capabilities.height?.min, '-', capabilities.height?.max);
                    if(capabilities.width?.max >= 3840) console.log('    ‚úÖ 4K (3840x2160)');
                    if(capabilities.width?.max >= 1920) console.log('    ‚úÖ 1080p (1920x1080)');
                    if(capabilities.width?.max >= 1280) console.log('    ‚úÖ 720p (1280x720)');
                    stream.getTracks().forEach(t => t.stop());
                } catch(e) {
                    console.log('  Error:', e.message);
                }
            }
            console.log('\nüí° If 4K is not showing, try: Camera settings app ‚Üí set to 4K');
        };
        
        document.addEventListener('DOMContentLoaded', () => { 
            checkAuth(); loadStats(); enumerateCameras(); renderSubCategories('tops'); renderFabricCards(); renderMaterialCards(); renderPatternCards(); updateValidation(); 
            document.addEventListener('keydown', (e) => { if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && !document.getElementById('preview-modal').classList.contains('active')) { e.preventDefault(); capturePhoto(); } }); 
            document.getElementById('pin-input').addEventListener('keydown', (e) => { if(e.key==='Enter') checkPin(); });
        });
        
        function checkAuth() { try { if(localStorage.getItem('vl_auth')===APP_PIN){ document.getElementById('pin-screen').classList.add('hidden'); data.photographer=localStorage.getItem('vl_photographer')||'P02'; document.getElementById('photographer-badge').textContent=data.photographer; startTimer(); } } catch(e){} }
        function checkPin() { if(document.getElementById('pin-input').value===APP_PIN){ try{ localStorage.setItem('vl_auth',APP_PIN); data.photographer=document.getElementById('photographer-select').value; localStorage.setItem('vl_photographer',data.photographer); document.getElementById('photographer-badge').textContent=data.photographer; }catch(e){} document.getElementById('pin-screen').classList.add('hidden'); startTimer(); } else { document.getElementById('pin-input').value=''; document.getElementById('pin-input').classList.add('shake'); setTimeout(()=>document.getElementById('pin-input').classList.remove('shake'),300); } }
        function showPinScreen() { document.getElementById('pin-screen').classList.remove('hidden'); document.getElementById('pin-input').value=''; document.getElementById('pin-input').focus(); }
        
        function goToStep(step) { currentStep = step; document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active')); document.getElementById(`step-${step}`).classList.add('active'); document.querySelectorAll('.progress-dot').forEach((d,i) => { d.classList.remove('active'); if(i+1 < step) d.classList.add('complete'); else d.classList.remove('complete'); if(i+1 === step) d.classList.add('active'); }); const labels = {1:'Step 1: Tag', 2:'Step 2: Check', 3:'Step 3: Snap', 4:'Step 4: Review'}; document.getElementById('step-label').textContent = labels[step] || ''; if(step===4) updateReviewCards(); }
        
        function updateReviewCards() {
            document.getElementById('summary-tag').innerHTML = `${data.category||'?'} ‚Ä¢ ${data.tagSize||'?'}<br>${data.origin==='usa'?'<img src="https://flagcdn.com/w16/us.png" style="vertical-align:middle;"> USA':data.country||''} ‚Ä¢ ${data.gender||''}`;
            document.getElementById('summary-check').innerHTML = `${data.fabricType||'?'} / ${data.material||'?'}<br>${(data.colors||[]).slice(0,3).join(', ')||'?'} ‚Ä¢ ${data.pattern||'?'}`;
            const pc = data.mainPhotos.length + data.tagPhotos.length + data.defectPhotos.length;
            document.getElementById('summary-snap').innerHTML = `${pc} photo(s)<br>${data.audioMeasure?'Audio: '+formatTime(data.audioDuration):'No audio'}`;
            document.getElementById('summary-weight').innerHTML = (data.weightLb>0||data.weightOz>0) ? `${data.weightLb} lb ${data.weightOz} oz<br>SKU: ${data.sku||'?'}` : 'No weight';
            
            setCardStatus('tag', !!data.category && !!data.tagStatus);
            setCardStatus('check', !!data.fabricType && data.colors.length>0 && !!data.pattern && !!data.material);
            setCardStatus('snap', data.mainPhotos.length>0 && !!data.audioMeasure);
            setCardStatus('weight', (data.weightLb>0 || data.weightOz>0) && !!data.sku);
        }
        function setCardStatus(name, ok) { const card = document.getElementById(`card-${name}`); const icon = document.getElementById(`icon-${name}`); card.classList.remove('card-green','card-yellow'); card.classList.add(ok?'card-green':'card-yellow'); icon.textContent = ok?'‚úÖ':'‚ö†Ô∏è'; }
        
        function startTimer() { timerStart = Date.now(); if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(updateTimerDisplay, 1000); updateTimerDisplay(); }
        function updateTimerDisplay() { if (!timerStart) return; const elapsed = Math.floor((Date.now() - timerStart) / 1000); document.getElementById('timer-current').textContent = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`; }
        function recordItemTime() { if (!timerStart) return; const elapsed = Math.floor((Date.now() - timerStart) / 1000); itemTimes.push(elapsed); document.getElementById('timer-last').textContent = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`; const avg = Math.floor(itemTimes.reduce((a,b)=>a+b,0)/itemTimes.length); document.getElementById('timer-avg').textContent = `${Math.floor(avg/60)}:${(avg%60).toString().padStart(2,'0')}`; startTimer(); }
        
        async function enumerateCameras() { 
            try { 
                // IMPORTANT: Request permission with HIGH resolution to avoid Chrome caching low res
                console.log('üì∑ Requesting camera permission with high resolution hint...');
                const permStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 3840 }, 
                        height: { ideal: 2160 } 
                    }
                }); 
                // Stop permission stream immediately
                permStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 300));
                
                const devices = await navigator.mediaDevices.enumerateDevices(); 
                const videoDevices = devices.filter(d=>d.kind==='videoinput'); 
                const select = document.getElementById('camera-select'); 
                select.innerHTML = '<option value="">Select Camera...</option>'; 
                
                console.log(`üì∑ Found ${videoDevices.length} cameras:`);
                
                videoDevices.forEach((device,i)=>{ 
                    const option = document.createElement('option'); 
                    option.value = device.deviceId; 
                    option.textContent = device.label || `Camera ${i+1}`; 
                    select.appendChild(option);
                    
                    console.log(`  ${i+1}. ${device.label} (${device.deviceId.slice(0,8)}...)`);
                    
                    // Auto-detect cameras by name
                    const label = device.label.toLowerCase();
                    if(label.includes('brio')) {
                        mainCameraId = device.deviceId;
                        console.log('  ‚Üí Set as MAIN camera (Brio 4K)');
                    }
                    if(label.includes('c922') || label.includes('922')) {
                        secondaryCameraId = device.deviceId;
                        console.log('  ‚Üí Set as SECONDARY camera (C922X)');
                    }
                });
                
                // Start with main camera if detected
                if(mainCameraId) {
                    select.value = mainCameraId;
                    // For BRIO, use aggressive max resolution
                    await switchCameraMaxRes(mainCameraId);
                } else if(videoDevices.length > 0) {
                    // Fallback to first camera
                    mainCameraId = videoDevices[0].deviceId;
                    select.value = mainCameraId;
                    switchCamera(mainCameraId);
                }
                
                updateCameraIndicator();
            } catch(err){ console.error('Camera error:', err); } 
        }
        
        // V99.15: Aggressive max resolution switch for BRIO
        async function switchCameraMaxRes(deviceId) {
            if(!deviceId) return;
            
            console.log('üì∑ switchCameraMaxRes: Forcing 4K...');
            const video = document.getElementById('camera-video');
            video.classList.add('switching');
            
            // Stop everything first
            stopStabilizer();
            if(currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            
            // Longer delay for camera to fully release
            await new Promise(r => setTimeout(r, 500));
            
            // Try 4K first, then fall back
            const resolutions = [
                { w: 3840, h: 2160, name: '4K' },
                { w: 2560, h: 1440, name: '1440p' },
                { w: 1920, h: 1080, name: '1080p' },
                { w: 1280, h: 720, name: '720p' }
            ];
            
            for(const res of resolutions) {
                try {
                    console.log(`üì∑ Trying ${res.name} (${res.w}x${res.h})...`);
                    
                    // Use EXACT constraint - this forces the resolution or fails
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: { exact: deviceId },
                            width: { exact: res.w },
                            height: { exact: res.h }
                        }
                    });
                    
                    const track = currentStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    console.log(`‚úÖ Got ${settings.width}x${settings.height}`);
                    
                    video.srcObject = currentStream;
                    video.style.display = 'block';
                    document.getElementById('camera-placeholder').style.display = 'none';
                    document.getElementById('camera-overlay').style.display = 'block';
                    document.getElementById('camera-status').textContent = 'LIVE';
                    document.getElementById('camera-status').classList.add('live');
                    activeCameraId = deviceId;
                    document.getElementById('camera-select').value = deviceId;
                    
                    video.onloadedmetadata = () => {
                        const w = video.videoWidth;
                        const h = video.videoHeight;
                        console.log(`üì∑ Video ready: ${w}x${h}`);
                        document.getElementById('camera-resolution').textContent = `${w}√ó${h}`;
                        
                        const resEl = document.getElementById('camera-resolution');
                        if(w >= 3800) {
                            resEl.style.color = '#22c55e';
                        } else if(w >= 1900) {
                            resEl.style.color = '#3b82f6';
                        } else if(w >= 1200) {
                            resEl.style.color = '#f59e0b';
                        } else {
                            resEl.style.color = '#ef4444';
                        }
                        
                        video.classList.remove('switching');
                        setTimeout(() => startStabilizer(), 200);
                    };
                    
                    updateCameraIndicator();
                    return; // Success!
                    
                } catch(err) {
                    console.log(`‚ùå ${res.name} failed: ${err.message}`);
                    if(currentStream) {
                        currentStream.getTracks().forEach(t => t.stop());
                        currentStream = null;
                    }
                    await new Promise(r => setTimeout(r, 200));
                }
            }
            
            // All exact resolutions failed - fall back to ideal constraints
            console.log('‚ö†Ô∏è Exact constraints failed, trying ideal...');
            await switchCamera(deviceId);
        }
        
        // Force maximum resolution by restarting camera with strict constraints
        async function forceMaxResolution() {
            if(!activeCameraId) {
                alert('No camera active. Select a camera first.');
                return;
            }
            
            console.log('üîÑ FULL RES: Forcing maximum resolution...');
            document.getElementById('camera-resolution').textContent = 'Switching...';
            document.getElementById('camera-resolution').style.color = '#f59e0b';
            
            const video = document.getElementById('camera-video');
            
            // Stop current stream completely
            if(currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            
            // Wait for camera to fully release
            await new Promise(r => setTimeout(r, 500));
            
            // Get max capabilities
            let maxWidth = 1920, maxHeight = 1080;
            try {
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: activeCameraId } }
                });
                const track = tempStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if(capabilities.width?.max) maxWidth = capabilities.width.max;
                if(capabilities.height?.max) maxHeight = capabilities.height.max;
                
                console.log(`üì∑ FULL RES: Max capability: ${maxWidth}x${maxHeight}`);
                tempStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 300));
            } catch(e) {
                console.log('üì∑ FULL RES: Could not get capabilities, trying defaults');
            }
            
            // Now request EXACT max resolution
            try {
                const constraints = {
                    video: {
                        deviceId: { exact: activeCameraId },
                        width: { ideal: maxWidth, min: Math.min(maxWidth, 1920) },
                        height: { ideal: maxHeight, min: Math.min(maxHeight, 1080) }
                    }
                };
                
                console.log(`üì∑ FULL RES: Requesting ${maxWidth}x${maxHeight}...`);
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = currentStream;
                video.style.display = 'block';
                document.getElementById('camera-placeholder').style.display = 'none';
                document.getElementById('camera-overlay').style.display = 'block';
                document.getElementById('camera-status').textContent = 'LIVE';
                document.getElementById('camera-status').classList.add('live');
                
                video.onloadedmetadata = () => {
                    const actualW = video.videoWidth;
                    const actualH = video.videoHeight;
                    console.log(`‚úÖ FULL RES: Got ${actualW}x${actualH}`);
                    document.getElementById('camera-resolution').textContent = `${actualW}√ó${actualH}`;
                    
                    if(actualW >= 3800) {
                        document.getElementById('camera-resolution').style.color = '#22c55e';
                        alert(`‚úÖ 4K Resolution Active!\n${actualW}√ó${actualH}\n\nPhotos will capture at full 4K for AI processing.`);
                    } else if(actualW >= 1900) {
                        document.getElementById('camera-resolution').style.color = '#3b82f6';
                        alert(`üì∑ 1080p Resolution Active\n${actualW}√ó${actualH}\n\nCamera max capability: ${maxWidth}√ó${maxHeight}\n\nIf you expected higher, check:\n‚Ä¢ USB 3.0 port (blue inside)\n‚Ä¢ Logitech Camera Settings app\n‚Ä¢ Close other apps using camera`);
                    } else {
                        document.getElementById('camera-resolution').style.color = '#ef4444';
                        alert(`‚ö†Ô∏è Low Resolution: ${actualW}√ó${actualH}\n\nTroubleshooting:\n‚Ä¢ Use USB 3.0 port\n‚Ä¢ Check Logitech Camera Settings app\n‚Ä¢ Restart browser`);
                    }
                };
                
            } catch(err) {
                console.error('üì∑ FULL RES: Failed:', err);
                alert(`Could not set ${maxWidth}√ó${maxHeight}.\n\nError: ${err.message}\n\nTry:\n‚Ä¢ Restart browser\n‚Ä¢ Check USB connection\n‚Ä¢ Use Logitech Camera Settings app`);
                // Fall back to normal switch
                switchCamera(activeCameraId);
            }
        }
        
        async function switchCamera(deviceId) { 
            if(!deviceId) {
                console.error('‚ùå switchCamera called with no deviceId');
                return; 
            }
            
            console.log(`üì∑ Switching to camera: ${deviceId.slice(0,8)}...`);
            
            const video = document.getElementById('camera-video');
            
            // Add switching class for smooth transition
            video.classList.add('switching');
            
            // Stop stabilizer first
            stopStabilizer();
            
            // Stop current stream first
            if(currentStream) {
                console.log('üì∑ Stopping current stream...');
                currentStream.getTracks().forEach(t=>t.stop()); 
                currentStream = null;
            }
            
            // Small delay to let camera release
            await new Promise(r => setTimeout(r, 200));
            
            // STEP 1: Get camera capabilities first
            let maxWidth = 1920, maxHeight = 1080;
            try {
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: deviceId } }
                });
                const track = tempStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if(capabilities.width?.max) maxWidth = capabilities.width.max;
                if(capabilities.height?.max) maxHeight = capabilities.height.max;
                
                console.log(`üì∑ Camera capabilities: max ${maxWidth}x${maxHeight}`);
                tempStream.getTracks().forEach(t => t.stop());
                await new Promise(r => setTimeout(r, 100));
            } catch(e) {
                console.log('üì∑ Could not get capabilities, using defaults');
            }
            
            // STEP 2: Request the MAXIMUM resolution with exact/min constraints
            const isBrio = deviceId === mainCameraId;
            let success = false;
            
            // Try exact max resolution first, then fall back
            const resolutions = [];
            
            if(maxWidth >= 3840) {
                resolutions.push({ width: 3840, height: 2160, name: '4K' });
            }
            if(maxWidth >= 1920) {
                resolutions.push({ width: 1920, height: 1080, name: '1080p' });
            }
            resolutions.push({ width: 1280, height: 720, name: '720p' });
            resolutions.push({ width: 640, height: 480, name: '480p' });
            
            for(const res of resolutions) {
                try {
                    console.log(`üì∑ Requesting ${res.name} (${res.width}x${res.height}) with min constraint...`);
                    
                    // Use 'min' to FORCE at least this resolution, 'ideal' for target
                    const constraints = {
                        video: {
                            deviceId: { exact: deviceId },
                            width: { min: res.width, ideal: res.width },
                            height: { min: res.height, ideal: res.height }
                        }
                    };
                    
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Verify we got what we asked for
                    const track = currentStream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    console.log(`‚úÖ Got stream: ${settings.width}x${settings.height}`);
                    
                    // Check if resolution is acceptable
                    if(settings.width < res.width * 0.9) {
                        console.log(`‚ö†Ô∏è Resolution too low (${settings.width} < ${res.width}), trying next...`);
                        currentStream.getTracks().forEach(t => t.stop());
                        currentStream = null;
                        continue;
                    }
                    
                    video.srcObject = currentStream; 
                    video.style.display = 'block'; 
                    document.getElementById('camera-placeholder').style.display = 'none'; 
                    document.getElementById('camera-overlay').style.display = 'block'; 
                    document.getElementById('camera-status').textContent = 'LIVE'; 
                    document.getElementById('camera-status').classList.add('live'); 
                    activeCameraId = deviceId;
                    document.getElementById('camera-select').value = deviceId;
                    
                    video.onloadedmetadata = () => {
                        console.log(`üì∑ Video element ready: ${video.videoWidth}x${video.videoHeight}`);
                        document.getElementById('camera-resolution').textContent = `${video.videoWidth}√ó${video.videoHeight}`;
                        
                        // Color code resolution
                        const resEl = document.getElementById('camera-resolution');
                        if(video.videoWidth >= 3800) {
                            resEl.style.color = '#22c55e'; // Green for 4K
                        } else if(video.videoWidth >= 1900) {
                            resEl.style.color = '#3b82f6'; // Blue for 1080p
                        } else if(video.videoWidth >= 1200) {
                            resEl.style.color = '#f59e0b'; // Orange for 720p
                        } else {
                            resEl.style.color = '#ef4444'; // Red for low res
                        }
                        
                        setTimeout(() => video.classList.remove('switching'), 50);
                        
                        // Start stabilizer after video is ready
                        stopStabilizer();
                        setTimeout(() => startStabilizer(), 200);
                    };
                    
                    updateCameraIndicator();
                    success = true;
                    break;
                    
                } catch(err) {
                    console.log(`‚ùå ${res.name} failed:`, err.message);
                }
            }
            
            if(!success) {
                // Last resort: let browser pick any resolution
                console.log('üì∑ Fallback: letting browser choose resolution...');
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: deviceId } }
                    });
                    video.srcObject = currentStream;
                    video.style.display = 'block';
                    document.getElementById('camera-placeholder').style.display = 'none';
                    document.getElementById('camera-overlay').style.display = 'block';
                    document.getElementById('camera-status').textContent = 'LIVE';
                    document.getElementById('camera-status').classList.add('live');
                    activeCameraId = deviceId;
                    document.getElementById('camera-select').value = deviceId;
                    
                    video.onloadedmetadata = () => {
                        console.log(`‚ö†Ô∏è Fallback resolution: ${video.videoWidth}x${video.videoHeight}`);
                        document.getElementById('camera-resolution').textContent = `${video.videoWidth}√ó${video.videoHeight}`;
                        document.getElementById('camera-resolution').style.color = '#ef4444';
                        video.classList.remove('switching');
                        
                        // Start stabilizer after video is ready
                        stopStabilizer();
                        setTimeout(() => startStabilizer(), 200);
                    };
                    updateCameraIndicator();
                    success = true;
                } catch(err2) {
                    console.error('‚ùå All camera attempts failed:', err2);
                    alert('Failed to switch camera: ' + err2.message);
                    video.classList.remove('switching');
                }
            }
            
            console.log(`üì∑ Camera switch ${success ? 'SUCCESS' : 'FAILED'}, activeCameraId: ${activeCameraId?.slice(0,8)}...`);
        }
        
        function setPhotoMode(mode) { 
            console.log(`üì∑ setPhotoMode: ${mode}`);
            console.log(`   mainCameraId: ${mainCameraId?.slice(0,8) || 'null'}`);
            console.log(`   secondaryCameraId: ${secondaryCameraId?.slice(0,8) || 'null'}`);
            console.log(`   activeCameraId: ${activeCameraId?.slice(0,8) || 'null'}`);
            
            // Stop barcode scanning if leaving SKU mode
            if(photoMode === 'sku' && mode !== 'sku') {
                stopBarcodeScanning();
            }
            
            photoMode = mode; 
            document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); 
            document.getElementById(`mode-${mode}`).classList.add('active'); 
            
            // Auto-switch cameras based on mode
            if(mode === 'main') {
                if(mainCameraId && activeCameraId !== mainCameraId) {
                    console.log('üì∑ Switching to MAIN camera (BRIO) with max res...');
                    switchCameraMaxRes(mainCameraId);
                } else {
                    console.log('üì∑ Already on MAIN camera or mainCameraId not set');
                }
            } else if(mode === 'tag' || mode === 'defect' || mode === 'sku') {
                if(secondaryCameraId && activeCameraId !== secondaryCameraId) {
                    console.log('üì∑ Switching to SECONDARY camera (C922X)...');
                    switchCamera(secondaryCameraId);
                } else if(!secondaryCameraId) {
                    console.warn('‚ö†Ô∏è No secondary camera detected - using current camera');
                    // If no secondary, stay on current but still update indicator
                } else {
                    console.log('üì∑ Already on SECONDARY camera');
                }
            }
            
            // If SKU mode, focus the SKU input AND start camera barcode scanning
            if(mode === 'sku') {
                // Go to step 3 where SKU input is
                goToStep(3);
                
                // Focus SKU input with multiple attempts to ensure it works
                const focusSkuInput = () => {
                    const skuInput = document.getElementById('sku-input');
                    if(skuInput) {
                        skuInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        skuInput.value = ''; // Clear for fresh scan
                        skuInput.focus();
                        skuInput.select();
                        console.log('üì∑ SKU mode: Input focused, ready for scan');
                    }
                };
                
                // Try focusing multiple times to ensure it works
                setTimeout(focusSkuInput, 100);
                setTimeout(focusSkuInput, 300);
                setTimeout(focusSkuInput, 500);
                
                // Start camera-based barcode scanning after camera switches
                setTimeout(() => {
                    startBarcodeScanning();
                }, 800);
            }
            
            updateCameraIndicator();
        }
        
        function updateCameraIndicator() {
            const indicator = document.getElementById('camera-indicator');
            if(!indicator) return;
            if(activeCameraId === mainCameraId) {
                indicator.textContent = 'üì¶ BRIO (Main)';
                indicator.style.background = '#3b82f6';
            } else if(activeCameraId === secondaryCameraId) {
                if(photoMode === 'sku') {
                    indicator.textContent = 'üì∑ C922X (SKU Scan)';
                    indicator.style.background = '#16a34a';
                } else {
                    indicator.textContent = 'üè∑Ô∏è C922X (Tag/Defect)';
                    indicator.style.background = '#f59e0b';
                }
            } else {
                indicator.textContent = 'Camera';
                indicator.style.background = '#64748b';
            }
        }
        function capturePhoto() { 
            const video = document.getElementById('camera-video'); 
            if(!video.srcObject) return; 
            
            // Warn if not stable but still allow capture
            if(!isStable && navigator.vibrate) navigator.vibrate(100);
            
            // Check resolution before capture
            if(video.videoWidth < 1280) {
                console.error(`‚ö†Ô∏è LOW RESOLUTION CAPTURE: ${video.videoWidth}x${video.videoHeight}`);
                alert(`Warning: Capturing at low resolution (${video.videoWidth}x${video.videoHeight}). Check camera settings.`);
            }
            
            // Flash effect
            document.getElementById('flash-overlay').classList.add('flash'); 
            setTimeout(()=>document.getElementById('flash-overlay').classList.remove('flash'),100); 
            
            // Capture at FULL native resolution - NO DOWNSCALING
            const canvas = document.createElement('canvas'); 
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight; 
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(video, 0, 0); 
            
            // Maximum JPEG quality (0.95) for best detail preservation
            // Full 4K = ~3840x2160, perfect for AI cropping in backend
            canvas.toBlob(blob => { 
                const photo = { 
                    blob, 
                    url: URL.createObjectURL(blob), 
                    width: canvas.width, 
                    height: canvas.height 
                }; 
                if(photoMode === 'main') data.mainPhotos.push(photo); 
                else if(photoMode === 'tag') data.tagPhotos.push(photo); 
                else if(photoMode === 'sku') { /* SKU mode doesn't save photos */ }
                else data.defectPhotos.push(photo); 
                
                const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
                console.log(`üì∏ ${photoMode.toUpperCase()}: ${canvas.width}√ó${canvas.height} | ${sizeMB}MB | FULL RESOLUTION`);
                
                updatePhotoGrids(); 
                updateValidation(); 
            }, 'image/jpeg', 0.95); 
        }
        
        // ============ STABILIZER FUNCTIONS ============
        function startStabilizer() {
            const video = document.getElementById('camera-video');
            if(!video || !video.srcObject) return;
            
            // Create small canvas for frame comparison (very lightweight)
            stabilizerCanvas = document.createElement('canvas');
            stabilizerCanvas.width = 64;
            stabilizerCanvas.height = 64;
            stabilizerCtx = stabilizerCanvas.getContext('2d', { willReadFrequently: true });
            
            previousFrame = null;
            stableFrameCount = 0;
            isStable = false;
            updateStabilizerUI(false);
            
            // Check frames 10x per second
            stabilizerInterval = setInterval(() => {
                checkStability(video);
            }, 100);
            
            console.log('üì∑ Stabilizer started');
        }
        
        function checkStability(video) {
            if(!video.videoWidth || !stabilizerCtx) return;
            
            // Draw scaled-down frame
            stabilizerCtx.drawImage(video, 0, 0, 64, 64);
            const currentFrame = stabilizerCtx.getImageData(0, 0, 64, 64).data;
            
            if(previousFrame) {
                const diff = calculateFrameDifference(previousFrame, currentFrame);
                
                if(diff < STABILITY_THRESHOLD) {
                    stableFrameCount++;
                    if(stableFrameCount >= FRAMES_NEEDED && !isStable) {
                        isStable = true;
                        updateStabilizerUI(true);
                    }
                } else {
                    stableFrameCount = 0;
                    if(isStable) {
                        isStable = false;
                        updateStabilizerUI(false);
                    }
                }
            }
            
            previousFrame = currentFrame;
        }
        
        function calculateFrameDifference(prev, curr) {
            let diff = 0;
            const sampleStep = 4; // Sample every 4th pixel for speed
            for(let i = 0; i < prev.length; i += 4 * sampleStep) {
                diff += Math.abs(prev[i] - curr[i]);     // R
                diff += Math.abs(prev[i+1] - curr[i+1]); // G
                diff += Math.abs(prev[i+2] - curr[i+2]); // B
            }
            return diff / (prev.length / sampleStep / 4) / 3; // Average per sampled pixel
        }
        
        function updateStabilizerUI(stable) {
            const dot = document.getElementById('stabilizer-dot');
            const text = document.getElementById('stabilizer-text');
            if(!dot || !text) return;
            
            if(stable) {
                dot.classList.add('stable');
                text.textContent = 'STABLE ‚úì';
                text.style.color = '#22c55e';
            } else {
                dot.classList.remove('stable');
                text.textContent = 'HOLD STEADY';
                text.style.color = 'white';
            }
        }
        
        function stopStabilizer() {
            if(stabilizerInterval) {
                clearInterval(stabilizerInterval);
                stabilizerInterval = null;
            }
            previousFrame = null;
            stableFrameCount = 0;
            isStable = false;
            console.log('üì∑ Stabilizer stopped');
        }
        
        function updatePhotoGrids() { 
            const renderGrid = (photos, gridId, mode) => { 
                document.getElementById(gridId).innerHTML = photos.map((p,i) => 
                    `<div class="photo-thumb" ondblclick="openPreview('${mode}',${i})" title="Double-click to preview">
                        <img src="${p.url}">
                        <button class="photo-thumb-delete" onclick="event.stopPropagation();deletePhoto('${mode}',${i})">√ó</button>
                    </div>`
                ).join('') + `<div class="photo-thumb photo-thumb-empty" onclick="setPhotoMode('${mode}')">+</div>`; 
            }; 
            renderGrid(data.mainPhotos,'main-photos-grid','main'); 
            renderGrid(data.tagPhotos,'tag-photos-grid','tag'); 
            renderGrid(data.defectPhotos,'defect-photos-grid','defect'); 
            document.getElementById('main-count').textContent = data.mainPhotos.length; 
            document.getElementById('tag-count').textContent = data.tagPhotos.length; 
            document.getElementById('defect-count').textContent = data.defectPhotos.length; 
            document.getElementById('photo-count').textContent = data.mainPhotos.length+data.tagPhotos.length+data.defectPhotos.length; 
        }
        function deletePhoto(mode,index) { if(mode==='main'){URL.revokeObjectURL(data.mainPhotos[index].url);data.mainPhotos.splice(index,1);} else if(mode==='tag'){URL.revokeObjectURL(data.tagPhotos[index].url);data.tagPhotos.splice(index,1);} else{URL.revokeObjectURL(data.defectPhotos[index].url);data.defectPhotos.splice(index,1);} updatePhotoGrids(); updateValidation(); }
        
        // Photo Preview Functions
        function openPreview(mode, index) {
            previewMode = mode;
            previewIndex = index;
            const photos = mode === 'main' ? data.mainPhotos : mode === 'tag' ? data.tagPhotos : data.defectPhotos;
            if(photos.length === 0) return;
            
            const photo = photos[index];
            document.getElementById('preview-image').src = photo.url;
            const is4K = photo.width >= 3800;
            const resLabel = photo.width ? `${photo.width}√ó${photo.height}${is4K ? ' 4K' : ''}` : '';
            document.getElementById('preview-type').textContent = mode.toUpperCase() + (resLabel ? ` ‚Ä¢ ${resLabel}` : '');
            document.getElementById('preview-type').style.background = mode === 'main' ? '#3b82f6' : mode === 'tag' ? '#f59e0b' : '#ef4444';
            updatePreviewNav();
            document.getElementById('preview-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
            document.body.style.overflow = '';
            previewMode = null;
            previewIndex = 0;
        }
        
        function navigatePreview(dir) {
            const photos = previewMode === 'main' ? data.mainPhotos : previewMode === 'tag' ? data.tagPhotos : data.defectPhotos;
            previewIndex += dir;
            if(previewIndex < 0) previewIndex = 0;
            if(previewIndex >= photos.length) previewIndex = photos.length - 1;
            const photo = photos[previewIndex];
            document.getElementById('preview-image').src = photo.url;
            const is4K = photo.width >= 3800;
            const resLabel = photo.width ? `${photo.width}√ó${photo.height}${is4K ? ' 4K' : ''}` : '';
            document.getElementById('preview-type').textContent = previewMode.toUpperCase() + (resLabel ? ` ‚Ä¢ ${resLabel}` : '');
            updatePreviewNav();
        }
        
        function updatePreviewNav() {
            const photos = previewMode === 'main' ? data.mainPhotos : previewMode === 'tag' ? data.tagPhotos : data.defectPhotos;
            document.getElementById('preview-prev').disabled = previewIndex <= 0;
            document.getElementById('preview-next').disabled = previewIndex >= photos.length - 1;
            document.getElementById('preview-counter').textContent = `${previewIndex + 1} / ${photos.length}`;
        }
        
        function deleteFromPreview() {
            if(!previewMode) return;
            deletePhoto(previewMode, previewIndex);
            const photos = previewMode === 'main' ? data.mainPhotos : previewMode === 'tag' ? data.tagPhotos : data.defectPhotos;
            if(photos.length === 0) {
                closePreview();
                return;
            }
            if(previewIndex >= photos.length) previewIndex = photos.length - 1;
            const photo = photos[previewIndex];
            document.getElementById('preview-image').src = photo.url;
            const is4K = photo.width >= 3800;
            const resLabel = photo.width ? `${photo.width}√ó${photo.height}${is4K ? ' 4K' : ''}` : '';
            document.getElementById('preview-type').textContent = previewMode.toUpperCase() + (resLabel ? ` ‚Ä¢ ${resLabel}` : '');
            updatePreviewNav();
        }
        
        // Keyboard navigation for preview
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('preview-modal').classList.contains('active')) {
                if(e.key === 'Escape') closePreview();
                if(e.key === 'ArrowLeft') navigatePreview(-1);
                if(e.key === 'ArrowRight') navigatePreview(1);
                if(e.key === 'Delete' || e.key === 'Backspace') deleteFromPreview();
            }
        });
        
        function setSuperCategory(cat, btn) { data.superCategory = cat; data.category = ''; document.querySelectorAll('.super-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); renderSubCategories(cat); updateValidation(); }
        function renderSubCategories(superCat) { 
            const config = categoryConfig[superCat]; 
            const container = document.getElementById('sub-categories'); 
            // Only show default style on hero if no category is selected
            const heroClass = data.category ? 'cat-hero cat-btn' : 'cat-hero cat-btn cat-default';
            container.innerHTML = `<button onclick="setCategory('${config.heroes[0]}', this)" class="${heroClass}"><span style="font-size:20px;">${catEmojis[config.heroes[0]]||'üëï'}</span> ${config.heroes[0].toUpperCase()}</button><div class="btn-grid btn-grid-2" style="margin-bottom:8px;">${config.heroes.slice(1).map(c=>`<button onclick="setCategory('${c}', this)" class="cat-secondary cat-btn"><span>${catEmojis[c]||'üëï'}</span> ${c}</button>`).join('')}</div><div class="btn-grid btn-grid-4">${config.others.map(c=>`<button onclick="setCategory('${c}', this)" class="cat-other cat-btn">${c}</button>`).join('')}</div>`; 
        }
        function setCategory(cat, btn) { 
            data.category = cat; 
            // Remove selected AND default from ALL category buttons
            document.querySelectorAll('.cat-btn').forEach(b => { 
                b.classList.remove('selected'); 
                b.classList.remove('cat-default'); 
            }); 
            // Add selected to clicked button
            btn.classList.add('selected'); 
            document.getElementById('category-label').textContent = '‚Äî ' + cat.toUpperCase(); 
            // Show elastic check for Sweatpants
            const elasticSection = document.getElementById('elastic-section');
            if(elasticSection) elasticSection.classList.toggle('hidden', cat !== 'Sweatpants');
            // Update measurement hints based on category
            updateMeasurementHints(cat);
            // Update tag location help if panel is open
            if(!document.getElementById('tag-location-panel').classList.contains('hidden')) {
                updateTagLocationHelp();
            }
            renderFabricCards(); 
            renderMaterialCards(); 
            updateValidation(); 
        }
        
        function updateMeasurementHints(cat) {
            // Hide all measurement hints first
            document.getElementById('measure-hint-tops').classList.add('hidden');
            document.getElementById('measure-hint-button-shirt').classList.add('hidden');
            document.getElementById('measure-hint-bottoms').classList.add('hidden');
            document.getElementById('measure-hint-outer').classList.add('hidden');
            
            // Show appropriate hint based on category
            if(cat === 'Button Shirt') {
                document.getElementById('measure-hint-button-shirt').classList.remove('hidden');
            } else if(['Jeans','Pants','Shorts','Sweatpants'].includes(cat)) {
                document.getElementById('measure-hint-bottoms').classList.remove('hidden');
            } else if(['Jacket','Coat','Vest'].includes(cat)) {
                document.getElementById('measure-hint-outer').classList.remove('hidden');
            } else {
                document.getElementById('measure-hint-tops').classList.remove('hidden');
            }
        }
        
        function setTagStatus(status, btn) { 
            data.tagStatus = status; 
            document.querySelectorAll('.tag-btn').forEach(b => { 
                b.classList.remove('selected','btn-hero','btn-default'); 
                b.classList.add('btn-secondary'); 
            }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            document.getElementById('tag-details').classList.toggle('hidden', status !== 'has'); 
            document.getElementById('material-tag-warning').classList.toggle('hidden', status === 'has'); 
            
            // TAG CUT MODE: When tag is missing/cut, traits become mandatory, selections disabled
            tagCutMode = (status === 'cut' || status === 'missing');
            
            // Fabric tag cut section
            const fabricTagCutSection = document.getElementById('fabric-tag-cut-section');
            const fabricHelpBtn = document.getElementById('fabric-help-btn');
            const fabricHelpPanel = document.getElementById('fabric-help-panel');
            
            if(fabricTagCutSection) {
                fabricTagCutSection.classList.toggle('hidden', !tagCutMode);
            }
            if(fabricHelpBtn) {
                fabricHelpBtn.classList.toggle('hidden', tagCutMode);
            }
            if(fabricHelpPanel && tagCutMode) {
                fabricHelpPanel.classList.add('hidden');
            }
            
            // Material tag cut section
            const materialTagCutSection = document.getElementById('material-tag-cut-section');
            const materialHelpBtn = document.getElementById('material-help-btn');
            const materialHelpPanel = document.getElementById('material-help-panel');
            
            if(materialTagCutSection) {
                materialTagCutSection.classList.toggle('hidden', !tagCutMode);
            }
            if(materialHelpBtn) {
                materialHelpBtn.classList.toggle('hidden', tagCutMode);
            }
            if(materialHelpPanel && tagCutMode) {
                materialHelpPanel.classList.add('hidden');
            }
            
            // Re-render cards (they'll be disabled in tagCutMode)
            renderFabricCards();
            renderMaterialCards();
            updateValidation(); 
        }
        function setSize(size, btn) { data.tagSize = size; document.querySelectorAll('.size-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); document.getElementById('tag-size-input').value=''; }
        function clearSizeBtns() { document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); }
        function onSizeInput(el) { data.tagSize = el.value.trim(); document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected')); }
        function setOrigin(origin, btn) { data.origin = origin; document.querySelectorAll('.origin-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); document.getElementById('country-section').classList.toggle('hidden', origin !== 'import'); if(origin==='usa')data.country='USA'; }
        function setCountry(country, btn) { 
            document.querySelectorAll('.country-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); 
            if(country === 'Other') {
                document.getElementById('country-other-input').classList.remove('hidden');
                document.getElementById('country-other-input').focus();
            } else {
                document.getElementById('country-other-input').classList.add('hidden');
                document.getElementById('country-other-input').value = '';
                data.country = country;
            }
        }
        function onCountryOtherInput() { data.country = document.getElementById('country-other-input').value.trim(); }
        function setGender(gender, btn) { data.gender = gender; document.querySelectorAll('.gender-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function toggleColor(color, btn) { const idx = data.colors.indexOf(color); if(idx>-1){data.colors.splice(idx,1);btn.classList.remove('selected');} else{data.colors.push(color);btn.classList.add('selected');} updateValidation(); }
        function setFade(fade, btn) { data.fade = fade; document.querySelectorAll('.fade-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); updateValidation(); }
        function setPattern(pattern, btn) { 
            data.pattern = pattern; 
            document.querySelectorAll('.pattern-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            // Show/hide print type and graphic category sections for Graphic
            const showGraphicOptions = (pattern === 'Graphic');
            document.getElementById('print-type-section').classList.toggle('hidden', !showGraphicOptions);
            document.getElementById('graphic-category-section').classList.toggle('hidden', !showGraphicOptions);
            // Clear print type and graphic category if not Graphic
            if(!showGraphicOptions) { 
                data.printType = ''; data.graphicCategory = ''; 
                document.querySelectorAll('.print-btn, .graphic-cat-btn').forEach(b => b.classList.remove('selected','btn-hero')); 
            }
            updateValidation(); 
        }
        function toggleOtherPatterns() { 
            const el = document.getElementById('pattern-others'); 
            el.classList.toggle('hidden'); 
            document.getElementById('other-patterns-toggle').textContent = el.classList.contains('hidden') ? '+ More patterns' : '‚àí Hide patterns'; 
        }
        function setPrintType(type, btn) { data.printType = type; document.querySelectorAll('.print-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function setGraphicCategory(cat, btn) { data.graphicCategory = cat; document.querySelectorAll('.graphic-cat-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function setSleeve(length, btn) { 
            data.sleeveLength = length; 
            document.querySelectorAll('.sleeve-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            // Hide sleeve style when None
            document.getElementById('sleeve-style-section').classList.toggle('hidden', length==='None'); 
            // Show cutoff section for T-Shirts when sleeveless
            const isTShirt = ['T-Shirt','Sweatshirt','Hoodie'].includes(data.category);
            document.getElementById('cutoff-section').classList.toggle('hidden', !(length==='None' && isTShirt));
            // Clear cutoff if not sleeveless
            if(length !== 'None') { data.cutoffType = ''; document.querySelectorAll('.cutoff-btn').forEach(b => b.classList.remove('selected','btn-hero')); }
            updateValidation(); 
        }
        function setCutoff(type, btn) { data.cutoffType = type; document.querySelectorAll('.cutoff-btn').forEach(b => { b.classList.remove('selected','btn-hero'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary'); }
        function setSleeveStyle(style, btn) { 
            data.sleeveStyle = style; 
            document.querySelectorAll('.style-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); 
            btn.classList.add('selected','btn-hero'); 
            btn.classList.remove('btn-secondary','btn-default'); 
            // Show/hide measurement notice for Raglan/Dolman
            const notice = document.getElementById('sleeve-measurement-notice');
            if(notice) notice.classList.toggle('hidden', style === 'Standard');
        }
        function setStitch(stitch, btn) { data.stitch = stitch; document.querySelectorAll('.stitch-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); }
        function setThickness(thickness, btn) { data.thickness = thickness; document.querySelectorAll('.thickness-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); updateValidation(); }
        function setLayers(layers, btn) { data.layers = layers; document.querySelectorAll('.layers-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); updateValidation(); }
        function setWash(wash, btn) { data.wash = wash; document.querySelectorAll('.wash-btn').forEach(b => { b.classList.remove('selected','btn-hero','btn-default'); b.classList.add('btn-secondary'); }); btn.classList.add('selected','btn-hero'); btn.classList.remove('btn-secondary','btn-default'); }
        function setClean(btn) { data.hasDefects = false; data.defectTypes = []; document.getElementById('btn-clean').classList.remove('btn-default','btn-secondary'); document.getElementById('btn-clean').classList.add('selected','btn-hero'); document.querySelectorAll('.defect-type-btn').forEach(b => b.classList.remove('selected')); updateValidation(); }
        function toggleDefect(type, btn) { document.getElementById('btn-clean').classList.remove('selected','btn-hero','btn-default'); document.getElementById('btn-clean').classList.add('btn-secondary'); data.hasDefects = true; const idx = data.defectTypes.indexOf(type); if(idx>-1){data.defectTypes.splice(idx,1);btn.classList.remove('selected');} else{data.defectTypes.push(type);btn.classList.add('selected');} if(data.defectTypes.length===0){data.hasDefects=null; document.getElementById('btn-clean').classList.remove('btn-secondary'); document.getElementById('btn-clean').classList.add('btn-default');} updateValidation(); }
        
        // FLAG AS UNUSUAL
        function toggleFlagUnusual() { 
            data.flagged = !data.flagged; 
            const btn = document.getElementById('flag-btn');
            const flagStatus = document.getElementById('flag-status');
            if(data.flagged) {
                btn.classList.add('flagged');
                btn.querySelector('span:first-child').textContent = 'üö©';
                btn.querySelector('span:last-of-type').textContent = 'FLAGGED FOR REVIEW';
                if(flagStatus) flagStatus.classList.remove('hidden');
            } else {
                btn.classList.remove('flagged');
                btn.querySelector('span:first-child').textContent = 'ü§î';
                btn.querySelector('span:last-of-type').textContent = 'FLAG AS UNUSUAL';
                if(flagStatus) flagStatus.classList.add('hidden');
            }
        }
        
        // ELASTIC CHECK (for sweatpants)
        function setElastic(elastic, btn) {
            data.elasticCheck = elastic;
            document.querySelectorAll('.elastic-btn').forEach(b => {
                b.classList.remove('selected','btn-hero');
                b.classList.add('btn-secondary');
            });
            btn.classList.add('selected','btn-hero');
            btn.classList.remove('btn-secondary');
        }
        function updateWeight() { data.weightLb = parseInt(document.getElementById('weight-lb').value); data.weightOz = parseInt(document.getElementById('weight-oz').value); updateValidation(); }
        
        async function activateSkuScan() {
            console.log('üì∑ SKU Scan button clicked');
            console.log(`   secondaryCameraId: ${secondaryCameraId?.slice(0,8) || 'null'}`);
            
            // Show status
            const statusEl = document.getElementById('sku-camera-status');
            statusEl.style.display = 'block';
            statusEl.textContent = 'üì∑ Switching to C922X...';
            statusEl.style.color = '#f59e0b';
            
            // Switch to SKU photo mode (this will switch camera)
            setPhotoMode('sku');
            
            // Wait for camera to switch and provide feedback
            await new Promise(r => setTimeout(r, 500));
            
            if(activeCameraId === secondaryCameraId) {
                statusEl.textContent = 'üîç Scanning for barcode...';
                statusEl.style.color = '#3b82f6';
                // Start barcode scanning
                setTimeout(() => startBarcodeScanning(), 300);
            } else if(!secondaryCameraId) {
                statusEl.textContent = '‚ö†Ô∏è No secondary camera detected - type SKU manually';
                statusEl.style.color = '#ef4444';
            } else {
                statusEl.textContent = '‚ö†Ô∏è Camera switch may have failed - try again';
                statusEl.style.color = '#ef4444';
            }
            
            // Focus input for barcode scanner
            const skuInput = document.getElementById('sku-input');
            skuInput.value = '';
            skuInput.focus();
        }
        
        function onSkuInput() {
            const skuInput = document.getElementById('sku-input');
            data.sku = skuInput.value.trim();
            
            // Update SKU badge in progress bar
            const skuBadge = document.getElementById('sku-badge');
            if(data.sku) {
                skuBadge.textContent = 'SKU: ' + data.sku;
                skuBadge.classList.add('visible');
            } else {
                skuBadge.classList.remove('visible');
            }
            
            updateValidation();
        }
        
        function handleSkuKeydown(event) {
            // Barcode scanners typically send Enter after scanning
            if(event.key === 'Enter') {
                event.preventDefault();
                const skuInput = document.getElementById('sku-input');
                data.sku = skuInput.value.trim();
                
                if(data.sku) {
                    // Show success feedback
                    document.getElementById('sku-status').innerHTML = '‚úÖ SKU scanned: <strong>' + data.sku + '</strong>';
                    document.getElementById('sku-status').style.color = '#16a34a';
                    console.log('üì∑ SKU scanned:', data.sku);
                    
                    // Update badge
                    const skuBadge = document.getElementById('sku-badge');
                    skuBadge.textContent = 'SKU: ' + data.sku;
                    skuBadge.classList.add('visible');
                    
                    // Switch back to main photo mode after successful scan
                    setTimeout(() => {
                        setPhotoMode('main');
                    }, 500);
                }
                
                skuInput.blur();
                updateValidation();
            }
        }
        
        // V99.15: Camera-based Barcode Scanning using BarcodeDetector API
        async function initBarcodeDetector() {
            if('BarcodeDetector' in window) {
                try {
                    barcodeDetector = new BarcodeDetector({
                        formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code', 'codabar', 'itf']
                    });
                    console.log('‚úÖ BarcodeDetector initialized');
                    return true;
                } catch(e) {
                    console.log('‚ùå BarcodeDetector init failed:', e);
                    return false;
                }
            } else {
                console.log('‚ö†Ô∏è BarcodeDetector not supported in this browser');
                return false;
            }
        }
        
        async function startBarcodeScanning() {
            if(!barcodeDetector) {
                const initialized = await initBarcodeDetector();
                if(!initialized) {
                    document.getElementById('sku-camera-status').textContent = '‚ö†Ô∏è Camera scanning not supported - type SKU or use USB scanner';
                    document.getElementById('sku-camera-status').style.color = '#f59e0b';
                    return;
                }
            }
            
            stopBarcodeScanning(); // Clear any existing interval
            
            const video = document.getElementById('camera-video');
            const statusEl = document.getElementById('sku-camera-status');
            
            console.log('üîç Starting barcode scanning...');
            statusEl.textContent = 'üîç Scanning for barcode...';
            statusEl.style.color = '#3b82f6';
            
            let scanCount = 0;
            
            barcodeScanInterval = setInterval(async () => {
                if(!video.videoWidth || video.paused || video.ended) return;
                if(photoMode !== 'sku') {
                    stopBarcodeScanning();
                    return;
                }
                
                try {
                    const barcodes = await barcodeDetector.detect(video);
                    scanCount++;
                    
                    // Update status periodically
                    if(scanCount % 10 === 0) {
                        statusEl.textContent = 'üîç Scanning... (point camera at barcode)';
                    }
                    
                    if(barcodes.length > 0) {
                        const barcode = barcodes[0];
                        console.log('‚úÖ Barcode detected:', barcode.rawValue, barcode.format);
                        
                        // Fill in the SKU
                        const skuInput = document.getElementById('sku-input');
                        skuInput.value = barcode.rawValue;
                        data.sku = barcode.rawValue;
                        
                        // Show success
                        statusEl.textContent = '‚úÖ Scanned: ' + barcode.rawValue;
                        statusEl.style.color = '#16a34a';
                        
                        document.getElementById('sku-status').innerHTML = '‚úÖ SKU scanned: <strong>' + barcode.rawValue + '</strong>';
                        document.getElementById('sku-status').style.color = '#16a34a';
                        
                        // Update badge
                        const skuBadge = document.getElementById('sku-badge');
                        skuBadge.textContent = 'SKU: ' + barcode.rawValue;
                        skuBadge.classList.add('visible');
                        
                        // Play success sound (optional beep)
                        try {
                            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                            const oscillator = audioCtx.createOscillator();
                            const gainNode = audioCtx.createGain();
                            oscillator.connect(gainNode);
                            gainNode.connect(audioCtx.destination);
                            oscillator.frequency.value = 1200;
                            oscillator.type = 'sine';
                            gainNode.gain.value = 0.1;
                            oscillator.start();
                            setTimeout(() => oscillator.stop(), 100);
                        } catch(e) {}
                        
                        // Stop scanning
                        stopBarcodeScanning();
                        
                        // Switch back to main after delay
                        setTimeout(() => {
                            setPhotoMode('main');
                        }, 1000);
                        
                        updateValidation();
                    }
                } catch(e) {
                    // Silently continue on detection errors
                }
            }, 200); // Scan 5 times per second
        }
        
        function stopBarcodeScanning() {
            if(barcodeScanInterval) {
                clearInterval(barcodeScanInterval);
                barcodeScanInterval = null;
                console.log('üõë Barcode scanning stopped');
            }
        }
        
        // Audio Recording
        async function toggleRecording() {
            if(mediaRecorder && mediaRecorder.state === 'recording') { stopRecording(); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, {type:'audio/webm'});
                    data.audioMeasure = blob;
                    stream.getTracks().forEach(t => t.stop());
                    updateValidation();
                };
                mediaRecorder.start();
                recordingStart = Date.now();
                document.getElementById('record-btn').innerHTML = '<span style="font-size:24px;">‚èπÔ∏è</span><span>RECORDING...</span>';
                document.getElementById('record-btn').style.background = '#dc2626';
                document.getElementById('record-btn').classList.add('recording');
                recordingInterval = setInterval(updateRecordingTime, 1000);
            } catch(e) { alert('Microphone access denied'); }
        }
        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                const duration = Math.floor((Date.now() - recordingStart) / 1000);
                data.audioDuration = duration;
                document.getElementById('recording-duration').textContent = formatTime(duration);
                document.getElementById('record-section').classList.add('hidden');
                document.getElementById('post-record-section').classList.remove('hidden');
            }
        }
        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStart) / 1000);
            document.getElementById('record-btn').querySelector('span:last-child').textContent = `RECORDING ${formatTime(elapsed)}`;
        }
        function reRecord() {
            data.audioMeasure = null; data.audioDuration = 0;
            document.getElementById('record-section').classList.remove('hidden');
            document.getElementById('post-record-section').classList.add('hidden');
            document.getElementById('record-btn').innerHTML = '<span style="font-size:24px;">üé§</span><span>TAP TO RECORD</span>';
            document.getElementById('record-btn').style.background = '#ef4444';
            document.getElementById('record-btn').classList.remove('recording');
            updateValidation();
        }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        
        function renderFabricCards() { 
            const grid = document.getElementById('fabric-cards-grid'); 
            const fabrics = fabricDB[data.category] || fabricDB['default']; 
            grid.innerHTML = ''; 
            fabrics.forEach(fab=>{ 
                let dimmed = false; 
                if(fabricFilters.stretch && fab.traits.stretch !== fabricFilters.stretch) dimmed = true; 
                if(fabricFilters.surface && fab.traits.surface !== fabricFilters.surface) dimmed = true; 
                if(fabricFilters.interior && fab.traits.interior !== fabricFilters.interior) dimmed = true; 
                const card = document.createElement('div'); 
                // In tagCutMode, all cards are visually dimmed and not clickable
                const disabled = tagCutMode;
                card.className = `card ${fab.default?'priority-1':''} ${data.fabricType===fab.name?'selected':''} ${dimmed||disabled?'dimmed':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showFabricHelp('${fab.name}', '${fab.desc.replace(/'/g, "\\'")}');">?</button><div class="card-name">${fab.name}</div><div class="card-desc">${fab.desc}</div>`; 
                if(!dimmed && !disabled) card.onclick = ()=>{ 
                    data.fabricType = fab.name; 
                    document.getElementById('wash-section').classList.toggle('hidden', fab.name!=='Denim'); 
                    renderFabricCards(); 
                    updateValidation(); 
                }; 
                grid.appendChild(card); 
            }); 
        }
        function showFabricHelp(name, desc) {
            openRefModal(name, desc, 'fabric');
        }
        function openRefModal(name, desc, type) {
            document.getElementById('ref-modal-title').textContent = name;
            document.getElementById('ref-modal-desc').textContent = desc;
            
            // Build Google image search URL
            let query = `${name} fabric texture close up`;
            if (name === 'Knit') query = 'knit t-shirt fabric texture close up';
            if (name === 'Jersey') query = 'jersey knit fabric texture athletic';
            if (name === 'Fleece') query = 'fleece fabric fuzzy inside sweatshirt';
            if (name === 'French Terry') query = 'french terry fabric loops inside';
            if (name === 'Selvage') query = 'selvage denim red line cuff';
            if (name === 'Pique') query = 'pique polo shirt fabric texture';
            if (name === 'Flannel') query = 'flannel shirt fabric brushed soft';
            if (name === 'Denim') query = 'denim fabric diagonal weave';
            if (name === 'Corduroy') query = 'corduroy fabric ridges texture';
            if (name === 'Mesh') query = 'mesh athletic fabric see through';
            if (name === '50/50 Blend') query = '50 50 cotton polyester blend t-shirt';
            if (name === 'Tri-Blend') query = 'tri-blend t-shirt fabric soft';
            if (name === 'Cotton') query = 'cotton fabric texture matte';
            if (name === 'Polyester') query = 'polyester fabric sheen synthetic';
            if (name === 'Wool') query = 'wool fabric texture sweater';
            if (name === 'Cashmere') query = 'cashmere fabric soft luxury';
            if (name === 'Rayon') query = 'rayon fabric silky drapey';
            if (name === 'Nylon') query = 'nylon windbreaker fabric shiny';
            if (name === 'Leather') query = 'leather jacket texture patina';
            
            // Pattern queries
            if (name === 'Solid') query = 'solid color t-shirt plain blank';
            if (name === 'Graphic') query = 'graphic tee print band shirt logo';
            if (name === 'Striped') query = 'striped shirt pattern sailor stripe';
            if (name === 'Color Block') query = 'color block shirt 90s panel';
            if (name === 'Plaid') query = 'plaid flannel pattern tartan buffalo check';
            if (name === 'Tie Dye') query = 'tie dye shirt spiral pattern';
            if (name === 'Camo') query = 'camo camouflage pattern military';
            if (name === 'Embroidered') query = 'embroidered shirt logo stitched';
            if (name === 'Polka Dot') query = 'polka dot pattern shirt dress';
            if (name === 'Paisley') query = 'paisley pattern bandana western shirt';
            if (name === 'Floral') query = 'floral pattern hawaiian shirt roses';
            if (name === 'Animal') query = 'animal print leopard zebra tiger';
            if (name === 'Geometric') query = 'geometric pattern 80s aztec chevron';
            if (name === 'Checkered') query = 'checkered pattern checkerboard vans';
            if (name === 'Houndstooth') query = 'houndstooth pattern coat jacket';
            if (name === 'Herringbone') query = 'herringbone pattern tweed suit';
            if (name === 'Abstract') query = 'abstract pattern 80s splatter';
            
            document.getElementById('ref-modal-link').href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
            document.getElementById('ref-modal-overlay').classList.add('visible');
        }
        function closeRefModal() {
            document.getElementById('ref-modal-overlay').classList.remove('visible');
        }
        function toggleFabricHelp() { document.getElementById('fabric-help-panel').classList.toggle('hidden'); }
        function toggleFabricFilter(type, value, btn) { 
            if(fabricFilters[type]===value){
                fabricFilters[type]=null;
                data.fabricTraits[type]='';
                btn.classList.remove('active');
            } 
            else{
                fabricFilters[type]=value;
                data.fabricTraits[type]=value;
                // Only deselect same-type buttons
                btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            } 
            renderFabricCards(); 
            updateFabricAdvice();
        }
        
        function updateFabricAdvice() {
            const helper = document.getElementById('fabric-helper');
            const helperTagcut = document.getElementById('fabric-helper-tagcut');
            const advice = getFabricAdvice();
            
            if(helper) {
                if(advice){helper.innerHTML=advice;helper.classList.remove('hidden');} 
                else helper.classList.add('hidden');
            }
            if(helperTagcut && tagCutMode) {
                helperTagcut.innerHTML = advice || '<span style="color:#6b7280;">Select traits above to see fabric matches</span>';
            }
        }
        
        // V99.15: TRULY DYNAMIC fabric advice based on actual fabricDB filtering
        function getFabricAdvice() {
            const cat = data.category || 'T-Shirt';
            const f = fabricFilters;
            const activeFilters = Object.values(f).filter(Boolean).length;
            
            if(activeFilters === 0) return '';
            
            // Get fabrics for this category
            const fabrics = fabricDB[cat] || fabricDB['default'];
            
            // TRULY DYNAMIC: Filter fabrics based on ALL selected traits
            const matches = fabrics.filter(fab => {
                if(f.stretch && fab.traits.stretch !== f.stretch) return false;
                if(f.surface && fab.traits.surface !== f.surface) return false;
                if(f.interior && fab.traits.interior !== f.interior) return false;
                return true;
            });
            
            // Build trait description for display
            const traitDesc = [];
            if(f.stretch) traitDesc.push(f.stretch === 'high' ? 'Stretchy' : 'Rigid');
            if(f.surface) traitDesc.push(f.surface === 'smooth' ? 'Smooth surface' : f.surface === 'diagonal' ? 'Diagonal weave' : f.surface === 'ridged' ? 'Ridged' : 'Textured');
            if(f.interior) traitDesc.push(f.interior === 'smooth' ? 'Smooth inside' : f.interior === 'fuzzy' ? 'Fuzzy inside' : 'Loops inside');
            
            // Build dynamic advice based on actual matches
            if(matches.length === 0) {
                // No matches - this combination is unusual for this category
                return `<div style="color:#b91c1c;"><strong>‚ö†Ô∏è Unusual combination for ${cat}!</strong></div>` +
                       `<div style="margin:4px 0;">${traitDesc.join(' + ')}</div>` +
                       `<div style="font-style:italic;font-size:10px;">This doesn't match any typical ${cat} fabrics. Double-check: Is this really a ${cat}?</div>`;
            } 
            else if(matches.length === 1) {
                // Perfect! One exact match
                const m = matches[0];
                return `<div style="color:#16a34a;"><strong>‚úÖ That's ${m.name}!</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">${m.desc}</div>`;
            } 
            else if(matches.length === 2) {
                // Two possibilities
                return `<div style="color:#2563eb;"><strong>üí° Could be one of these:</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">` +
                       `<strong>${matches[0].name}</strong> ‚Äì ${matches[0].desc}<br>` +
                       `<strong>${matches[1].name}</strong> ‚Äì ${matches[1].desc}</div>` +
                       `<div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
            } 
            else {
                // Multiple matches - show them all
                let html = `<div style="color:#2563eb;"><strong>üí° ${matches.length} possible fabrics:</strong></div><div style="margin:4px 0;font-size:11px;">`;
                matches.forEach(m => {
                    html += `<strong>${m.name}</strong> ‚Äì ${m.desc}<br>`;
                });
                html += `</div><div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
                return html;
            }
        }
        
        function renderMaterialCards() { 
            const grid = document.getElementById('material-cards-grid'); 
            const materials = materialDB[data.category] || materialDB['default']; 
            grid.innerHTML = ''; 
            materials.forEach(mat=>{ 
                let dimmed = false; 
                if(materialFilters.temp && mat.traits.temp !== materialFilters.temp) dimmed = true; 
                if(materialFilters.shine && mat.traits.shine !== materialFilters.shine) dimmed = true; 
                const card = document.createElement('div'); 
                // In tagCutMode, all cards are visually dimmed and not clickable
                const disabled = tagCutMode;
                card.className = `card ${mat.default?'priority-1':''} ${data.material===mat.name?'selected':''} ${dimmed||disabled?'dimmed':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showMaterialHelp('${mat.name}', '${mat.desc.replace(/'/g, "\\'")}');">?</button><div class="card-name">${mat.name}</div><div class="card-desc">${mat.desc}</div>`; 
                if(!dimmed && !disabled) card.onclick = ()=>{ 
                    data.material = mat.name; 
                    document.getElementById('material-other-select').value=''; 
                    document.getElementById('material-custom-input').classList.add('hidden'); 
                    renderMaterialCards(); 
                    updateValidation(); 
                }; 
                grid.appendChild(card); 
            }); 
        }
        function showMaterialHelp(name, desc) {
            openRefModal(name, desc, 'material');
        }
        function onMaterialOtherChange() {
            const val = document.getElementById('material-other-select').value;
            if(!val) return;
            if(val === 'Custom') {
                document.getElementById('material-custom-input').classList.remove('hidden');
                document.getElementById('material-custom-input').focus();
            } else {
                document.getElementById('material-custom-input').classList.add('hidden');
                data.material = val;
                // Deselect cards
                document.querySelectorAll('#material-cards-grid .card').forEach(c => c.classList.remove('selected'));
                updateValidation();
            }
        }
        function onMaterialCustomInput() {
            const val = document.getElementById('material-custom-input').value.trim();
            if(val) {
                data.material = val;
                document.querySelectorAll('#material-cards-grid .card').forEach(c => c.classList.remove('selected'));
                updateValidation();
            }
        }
        
        // V99.15: Pattern Cards with ? help buttons
        function renderPatternCards() {
            const mainGrid = document.getElementById('pattern-cards-grid');
            const othersGrid = document.getElementById('pattern-cards-others');
            
            // Main patterns (priority 1-2)
            const mainPatterns = patternDB.filter(p => p.priority <= 2);
            // Other patterns (priority 3+)
            const otherPatterns = patternDB.filter(p => p.priority > 2);
            
            mainGrid.innerHTML = '';
            mainPatterns.forEach(pat => {
                const card = document.createElement('div');
                card.className = `card ${pat.default?'priority-1':''} ${data.pattern===pat.name?'selected':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showPatternHelp('${pat.name}', '${pat.desc.replace(/'/g, "\\'")}', '${pat.examples.replace(/'/g, "\\'")}');">?</button><div class="card-name">${pat.name}</div><div class="card-desc">${pat.desc}</div>`;
                card.onclick = () => selectPattern(pat.name);
                mainGrid.appendChild(card);
            });
            
            othersGrid.innerHTML = '';
            otherPatterns.forEach(pat => {
                const card = document.createElement('div');
                card.className = `card ${data.pattern===pat.name?'selected':''}`;
                card.innerHTML = `<button class="card-help" onclick="event.stopPropagation(); showPatternHelp('${pat.name}', '${pat.desc.replace(/'/g, "\\'")}', '${pat.examples.replace(/'/g, "\\'")}');">?</button><div class="card-name">${pat.name}</div><div class="card-desc">${pat.desc}</div>`;
                card.onclick = () => selectPattern(pat.name);
                othersGrid.appendChild(card);
            });
        }
        
        function selectPattern(name) {
            data.pattern = name;
            renderPatternCards();
            
            // Show/hide print type and graphic category sections for Graphic
            const showGraphicOptions = (name === 'Graphic');
            document.getElementById('print-type-section').classList.toggle('hidden', !showGraphicOptions);
            document.getElementById('graphic-category-section').classList.toggle('hidden', !showGraphicOptions);
            // Clear print type and graphic category if not Graphic
            if(!showGraphicOptions) { 
                data.printType = ''; 
                data.graphicCategory = ''; 
                document.querySelectorAll('.print-btn, .graphic-cat-btn').forEach(b => b.classList.remove('selected','btn-hero')); 
            }
            
            updateValidation();
        }
        
        function showPatternHelp(name, desc, examples) {
            document.getElementById('ref-modal-title').textContent = name;
            document.getElementById('ref-modal-desc').textContent = desc + '\n\nExamples: ' + examples;
            
            // Build Google image search URL
            let query = name + ' pattern clothing';
            if (name === 'Solid') query = 'solid color t-shirt plain blank';
            if (name === 'Graphic') query = 'graphic tee print band shirt logo';
            if (name === 'Striped') query = 'striped shirt pattern sailor stripe';
            if (name === 'Color Block') query = 'color block shirt 90s panel';
            if (name === 'Plaid') query = 'plaid flannel pattern tartan buffalo check';
            if (name === 'Tie Dye') query = 'tie dye shirt spiral pattern';
            if (name === 'Camo') query = 'camo camouflage pattern military';
            if (name === 'Embroidered') query = 'embroidered shirt logo stitched';
            if (name === 'Polka Dot') query = 'polka dot pattern shirt dress';
            if (name === 'Paisley') query = 'paisley pattern bandana western shirt';
            if (name === 'Floral') query = 'floral pattern hawaiian shirt roses';
            if (name === 'Animal') query = 'animal print leopard zebra tiger';
            if (name === 'Geometric') query = 'geometric pattern 80s aztec chevron';
            if (name === 'Checkered') query = 'checkered pattern checkerboard vans';
            if (name === 'Houndstooth') query = 'houndstooth pattern coat jacket';
            if (name === 'Herringbone') query = 'herringbone pattern tweed suit';
            if (name === 'Abstract') query = 'abstract pattern 80s splatter';
            
            document.getElementById('ref-modal-link').href = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
            document.getElementById('ref-modal-overlay').classList.add('visible');
        }
        
        function onFabricOtherChange() {
            const val = document.getElementById('fabric-other-select').value;
            if(!val) return;
            if(val === 'Custom') {
                document.getElementById('fabric-custom-input').classList.remove('hidden');
                document.getElementById('fabric-custom-input').focus();
            } else {
                document.getElementById('fabric-custom-input').classList.add('hidden');
                data.fabricType = val;
                // Deselect cards
                document.querySelectorAll('#fabric-cards-grid .card').forEach(c => c.classList.remove('selected'));
                document.getElementById('wash-section').classList.add('hidden');
                updateValidation();
            }
        }
        function onFabricCustomInput() {
            const val = document.getElementById('fabric-custom-input').value.trim();
            if(val) {
                data.fabricType = val;
                document.querySelectorAll('#fabric-cards-grid .card').forEach(c => c.classList.remove('selected'));
                document.getElementById('wash-section').classList.add('hidden');
                updateValidation();
            }
        }
        function toggleMaterialHelp() { document.getElementById('material-help-panel').classList.toggle('hidden'); }
        function toggleMaterialFilter(type, value, btn) { 
            if(materialFilters[type]===value){
                materialFilters[type]=null;
                data.materialTraits[type]='';
                btn.classList.remove('active');
            } 
            else{
                materialFilters[type]=value;
                data.materialTraits[type]=value;
                btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            } 
            renderMaterialCards(); 
            updateMaterialAdvice();
        }
        
        function updateMaterialAdvice() {
            const helper = document.getElementById('material-helper');
            const helperTagcut = document.getElementById('material-helper-tagcut');
            const advice = getMaterialAdvice();
            
            if(helper) {
                if(advice){helper.innerHTML=advice;helper.classList.remove('hidden');} 
                else helper.classList.add('hidden');
            }
            if(helperTagcut && tagCutMode) {
                helperTagcut.innerHTML = advice || '<span style="color:#6b7280;">Select traits above to see material matches</span>';
            }
        }
        // V99.15: TRULY DYNAMIC material advice based on actual materialDB filtering
        function getMaterialAdvice() {
            const cat = data.category || 'T-Shirt';
            const m = materialFilters;
            const activeFilters = Object.values(m).filter(Boolean).length;
            
            if(activeFilters === 0) return '';
            
            // Get materials for this category
            const materials = materialDB[cat] || materialDB['default'];
            
            // TRULY DYNAMIC: Filter materials based on ALL selected traits
            const matches = materials.filter(mat => {
                if(m.temp && mat.traits.temp !== m.temp) return false;
                if(m.shine && mat.traits.shine !== m.shine) return false;
                return true;
            });
            
            // Build trait description for display
            const traitDesc = [];
            if(m.temp) traitDesc.push(m.temp === 'cool' ? 'Cool to touch' : 'Warm to touch');
            if(m.shine) traitDesc.push(m.shine === 'matte' ? 'Matte (no shine)' : 'Has sheen/shine');
            
            // Build dynamic advice based on actual matches
            if(matches.length === 0) {
                // No matches - this combination is unusual for this category
                return `<div style="color:#b91c1c;"><strong>‚ö†Ô∏è Unusual combination for ${cat}!</strong></div>` +
                       `<div style="margin:4px 0;">${traitDesc.join(' + ')}</div>` +
                       `<div style="font-style:italic;font-size:10px;">This doesn't match typical ${cat} materials. Check the "Other materials" dropdown.</div>`;
            } 
            else if(matches.length === 1) {
                // Perfect! One exact match
                const mat = matches[0];
                return `<div style="color:#16a34a;"><strong>‚úÖ That's ${mat.name}!</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">${mat.desc}</div>`;
            } 
            else if(matches.length === 2) {
                // Two possibilities
                return `<div style="color:#2563eb;"><strong>üí° Could be one of these:</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">` +
                       `<strong>${matches[0].name}</strong> ‚Äì ${matches[0].desc}<br>` +
                       `<strong>${matches[1].name}</strong> ‚Äì ${matches[1].desc}</div>`;
            } 
            else {
                // Multiple matches - show them all
                let html = `<div style="color:#2563eb;"><strong>üí° ${matches.length} possible materials:</strong></div><div style="margin:4px 0;font-size:11px;">`;
                matches.forEach(mat => {
                    html += `<strong>${mat.name}</strong> ‚Äì ${mat.desc}<br>`;
                });
                html += `</div>`;
                return html;
            }
        }
        
        // V99.15: Tag Location Helper Functions
        function toggleTagLocationHelp() { 
            const panel = document.getElementById('tag-location-panel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                updateTagLocationHelp();
            }
        }
        
        function updateTagLocationHelp() {
            const cat = data.category || 'T-Shirt';
            const locations = tagLocationDB[cat] || tagLocationDB['default'];
            const content = document.getElementById('tag-location-content');
            
            let html = `<div style="font-weight:700;color:#92400e;margin-bottom:8px;font-size:13px;">üîç Where to find tags on: ${cat}</div>`;
            
            // Primary location
            html += `<div style="background:white;border-radius:8px;padding:10px;margin-bottom:8px;border-left:4px solid #16a34a;">`;
            html += `<div style="font-weight:700;color:#16a34a;font-size:12px;">‚úÖ CHECK FIRST: ${locations.primary.location}</div>`;
            html += `<div style="font-size:11px;color:#374151;">${locations.primary.desc}</div>`;
            html += `</div>`;
            
            // Secondary locations
            if(locations.secondary && locations.secondary.length > 0) {
                html += `<div style="font-weight:600;color:#92400e;font-size:11px;margin-bottom:6px;">Also check these spots:</div>`;
                locations.secondary.forEach(loc => {
                    const isImportant = loc.icon === '‚≠ê';
                    html += `<div style="background:${isImportant?'#fef3c7':'white'};border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid ${isImportant?'#f59e0b':'#d1d5db'};">`;
                    html += `<div style="font-weight:600;color:${isImportant?'#b45309':'#374151'};font-size:11px;">${loc.icon} ${loc.location}</div>`;
                    html += `<div style="font-size:10px;color:#6b7280;">${loc.desc}</div>`;
                    html += `</div>`;
                });
            }
            
            // Tips
            if(locations.tips) {
                html += `<div style="background:#dbeafe;border-radius:8px;padding:10px;margin-top:8px;">`;
                html += `<div style="font-weight:600;color:#1e40af;font-size:11px;">üí° Pro Tip:</div>`;
                html += `<div style="font-size:10px;color:#1e40af;">${locations.tips}</div>`;
                html += `</div>`;
            }
            
            content.innerHTML = html;
        }
        
        // V99.15: Pattern Helper Functions
        function togglePatternHelp() { 
            document.getElementById('pattern-help-panel').classList.toggle('hidden'); 
        }
        
        function togglePatternFilter(type, value, btn) { 
            if(patternFilters[type]===value){
                patternFilters[type]=null;
                data.patternTraits[type]='';
                btn.classList.remove('active');
            } 
            else{
                patternFilters[type]=value;
                data.patternTraits[type]=value;
                btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            } 
            updatePatternAdvice();
        }
        
        function updatePatternAdvice() {
            const helper = document.getElementById('pattern-helper');
            const advice = getPatternAdvice();
            
            if(helper) {
                if(advice){helper.innerHTML=advice;helper.classList.remove('hidden');} 
                else helper.classList.add('hidden');
            }
        }
        
        // V99.15: TRULY DYNAMIC pattern advice based on patternDB filtering
        function getPatternAdvice() {
            const p = patternFilters;
            const activeFilters = Object.values(p).filter(Boolean).length;
            
            if(activeFilters === 0) return '';
            
            // Filter patterns based on ALL selected traits
            const matches = patternDB.filter(pat => {
                // Handle "any" trait (matches everything)
                if(p.lines && pat.traits.lines !== 'any' && pat.traits.lines !== p.lines) return false;
                if(p.shapes && pat.traits.shapes !== 'any' && pat.traits.shapes !== p.shapes) return false;
                if(p.method && pat.traits.method !== 'any' && pat.traits.method !== p.method) return false;
                return true;
            }).filter(pat => pat.name !== 'Other'); // Exclude "Other" from suggestions
            
            // Build trait description for display
            const traitDesc = [];
            if(p.lines) traitDesc.push(p.lines === 'none' ? 'No lines' : p.lines === 'stripes' ? 'Parallel lines' : 'Crossing lines');
            if(p.shapes) traitDesc.push(p.shapes === 'none' ? 'No shapes' : p.shapes === 'dots' ? 'Dots/circles' : p.shapes === 'curved' ? 'Curved shapes' : p.shapes === 'geometric' ? 'Geometric shapes' : 'Irregular blobs');
            if(p.method) traitDesc.push(p.method === 'woven' ? 'Woven into fabric' : p.method === 'printed' ? 'Printed on surface' : 'Stitched on');
            
            // Build dynamic advice based on actual matches
            if(matches.length === 0) {
                return `<div style="color:#b91c1c;"><strong>‚ö†Ô∏è No common pattern matches!</strong></div>` +
                       `<div style="margin:4px 0;">${traitDesc.join(' + ')}</div>` +
                       `<div style="font-style:italic;font-size:10px;">Try selecting "Other" or adjust your selections.</div>`;
            } 
            else if(matches.length === 1) {
                const pat = matches[0];
                return `<div style="color:#16a34a;"><strong>‚úÖ That's ${pat.name}!</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">${pat.desc}</div>` +
                       `<div style="font-size:10px;color:#6b7280;"><em>Examples: ${pat.examples}</em></div>`;
            } 
            else if(matches.length === 2) {
                return `<div style="color:#2563eb;"><strong>üí° Could be one of these:</strong></div>` +
                       `<div style="margin:4px 0;font-size:11px;">` +
                       `<strong>${matches[0].name}</strong> ‚Äì ${matches[0].desc}<br>` +
                       `<strong>${matches[1].name}</strong> ‚Äì ${matches[1].desc}</div>` +
                       `<div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
            } 
            else {
                // Multiple matches - show them all
                let html = `<div style="color:#2563eb;"><strong>üí° ${matches.length} possible patterns:</strong></div><div style="margin:4px 0;font-size:11px;">`;
                matches.slice(0, 5).forEach(pat => {
                    html += `<strong>${pat.name}</strong> ‚Äì ${pat.desc}<br>`;
                });
                if(matches.length > 5) html += `<em>...and ${matches.length - 5} more</em><br>`;
                html += `</div><div style="font-style:italic;font-size:10px;">Add more traits to narrow down!</div>`;
                return html;
            }
        }
        
        function updateValidation() { 
            const checks = { category:!!data.category, tag:!!data.tagStatus, color:data.colors.length>0, fade:!!data.fade, pattern:!!data.pattern, 'fabric-type':!!data.fabricType, material:!!data.material, construction:!!data.sleeveLength, feel:!!data.thickness&&!!data.layers, condition:data.hasDefects!==null, weight:data.weightLb>0||data.weightOz>0, audio:!!data.audioMeasure, sku:!!data.sku }; 
            Object.entries(checks).forEach(([key,ok])=>{ const el = document.getElementById(`check-${key}`); if(el){el.innerHTML=ok?'‚úì':'‚óã';el.classList.toggle('complete',ok);} }); 
            const allRequired = checks.category&&checks.tag&&checks.color&&checks.fade&&checks.pattern&&checks['fabric-type']&&checks.material&&checks.construction&&checks.feel&&checks.condition&&checks.weight&&checks.audio&&checks.sku; 
            const hasPhotos = data.mainPhotos.length>0; 
            document.getElementById('submit-btn').disabled = !(allRequired&&hasPhotos);
            if(currentStep===4) updateReviewCards();
        }
        
        function submitItem() { 
            if(!data.sku) { alert('Enter SKU'); return; }
            if(data.mainPhotos.length===0) { alert('Add at least one photo'); return; }
            if(data.weightLb===0 && data.weightOz===0) { alert('Enter weight'); return; }
            if(!data.audioMeasure) { alert('Record measurements'); return; }
            
            // Send to n8n webhook
            const formData = new FormData();
            formData.append('sku', data.sku);
            formData.append('category', data.category);
            formData.append('superCategory', data.superCategory);
            formData.append('tagStatus', data.tagStatus);
            formData.append('tagSize', data.tagSize);
            formData.append('origin', data.origin);
            formData.append('country', data.country);
            formData.append('gender', data.gender);
            formData.append('colors', JSON.stringify(data.colors));
            formData.append('fade', data.fade);
            formData.append('pattern', data.pattern);
            formData.append('patternTraits', JSON.stringify(data.patternTraits));
            formData.append('printType', data.printType);
            formData.append('graphicCategory', data.graphicCategory);
            formData.append('fabricType', data.fabricType);
            formData.append('fabricTraits', JSON.stringify(data.fabricTraits));
            formData.append('wash', data.wash);
            formData.append('material', data.material);
            formData.append('materialTraits', JSON.stringify(data.materialTraits));
            formData.append('sleeveLength', data.sleeveLength);
            formData.append('sleeveStyle', data.sleeveStyle);
            formData.append('cutoffType', data.cutoffType);
            formData.append('stitch', data.stitch);
            formData.append('thickness', data.thickness);
            formData.append('layers', data.layers);
            formData.append('hasDefects', data.hasDefects);
            formData.append('defectTypes', JSON.stringify(data.defectTypes));
            formData.append('flagged', data.flagged);
            formData.append('elasticCheck', data.elasticCheck);
            formData.append('weightLb', data.weightLb);
            formData.append('weightOz', data.weightOz);
            formData.append('photographer', data.photographer);
            formData.append('audioDuration', data.audioDuration);
            if(data.audioMeasure) formData.append('audio', data.audioMeasure, 'measurements.webm');
            data.mainPhotos.forEach((p,i) => formData.append(`mainPhoto${i}`, p.blob, `main${i}.jpg`));
            data.tagPhotos.forEach((p,i) => formData.append(`tagPhoto${i}`, p.blob, `tag${i}.jpg`));
            data.defectPhotos.forEach((p,i) => formData.append(`defectPhoto${i}`, p.blob, `defect${i}.jpg`));
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', N8N_WEBHOOK_URL, true);
            xhr.onload = () => { if(xhr.status===200) { console.log('Submitted to n8n'); } };
            xhr.onerror = () => { console.error('Webhook error'); };
            xhr.send(formData);
            
            recordItemTime(); stats.today++; stats.week++; stats.total++; saveStats(); updateStatsDisplay(); console.log('Submitted:',data); resetForm(); 
        }
        function resetForm() { data.mainPhotos.forEach(p=>URL.revokeObjectURL(p.url)); data.tagPhotos.forEach(p=>URL.revokeObjectURL(p.url)); data.defectPhotos.forEach(p=>URL.revokeObjectURL(p.url)); data = {superCategory:'tops',category:'',tagStatus:'',tagSize:'',origin:'',country:'',gender:'',colors:[],fade:'',pattern:'',patternTraits:{lines:'',shapes:'',method:''},printType:'',graphicCategory:'',fabricType:'',fabricTraits:{stretch:'',surface:'',interior:''},wash:'',material:'',materialTraits:{temp:'',shine:''},sleeveLength:'',sleeveStyle:'',cutoffType:'',stitch:'',thickness:'',layers:'',hasDefects:null,defectTypes:[],weightLb:0,weightOz:0,sku:'',photographer:data.photographer,audioMeasure:null,audioDuration:0,mainPhotos:[],tagPhotos:[],defectPhotos:[],flagged:false,elasticCheck:''}; tagCutMode=false; document.querySelectorAll('.selected').forEach(b=>b.classList.remove('selected')); document.querySelectorAll('.btn-hero').forEach(b=>{if(!b.classList.contains('super-btn'))b.classList.remove('btn-hero');}); document.querySelectorAll('.size-btn,.country-btn,.gender-btn').forEach(b=>{b.classList.remove('btn-hero');b.classList.add('btn-secondary');}); document.querySelectorAll('.super-btn').forEach((b,i)=>{if(i===0){b.classList.add('selected','btn-hero');b.classList.remove('btn-secondary');}else{b.classList.remove('selected','btn-hero');b.classList.add('btn-secondary');}}); document.getElementById('sku-input').value=''; document.getElementById('weight-lb').value='0'; document.getElementById('weight-oz').value='0'; document.getElementById('tag-details').classList.add('hidden'); document.getElementById('country-section').classList.add('hidden'); document.getElementById('country-other-input').classList.add('hidden'); document.getElementById('country-other-input').value=''; document.getElementById('wash-section').classList.add('hidden'); document.getElementById('print-type-section').classList.add('hidden'); document.getElementById('graphic-category-section').classList.add('hidden'); document.getElementById('pattern-others').classList.add('hidden'); document.getElementById('cutoff-section').classList.add('hidden'); document.getElementById('elastic-section').classList.add('hidden'); document.getElementById('sleeve-measurement-notice').classList.add('hidden'); document.getElementById('other-patterns-toggle').textContent='+ More patterns'; document.getElementById('tag-size-input').value=''; document.getElementById('material-other-select').value=''; document.getElementById('material-custom-input').value=''; document.getElementById('material-custom-input').classList.add('hidden'); document.getElementById('fabric-other-select').value=''; document.getElementById('fabric-custom-input').value=''; document.getElementById('fabric-custom-input').classList.add('hidden'); document.getElementById('record-section').classList.remove('hidden'); document.getElementById('post-record-section').classList.add('hidden'); document.getElementById('record-btn').innerHTML='<span style="font-size:24px;">üé§</span><span>TAP TO RECORD</span>'; document.getElementById('record-btn').style.background='#ef4444'; document.getElementById('category-label').textContent=''; document.getElementById('sku-badge').classList.remove('visible'); document.getElementById('sku-badge').textContent=''; document.getElementById('sku-status').textContent=''; document.getElementById('sku-camera-status').style.display='none'; document.getElementById('flag-btn').classList.remove('flagged'); document.getElementById('flag-btn').querySelector('span:first-child').textContent='ü§î'; document.getElementById('flag-btn').querySelector('span:last-of-type').textContent='FLAG AS UNUSUAL'; document.getElementById('flag-status').classList.add('hidden'); document.querySelectorAll('.elastic-btn').forEach(b=>{b.classList.remove('selected','btn-hero');b.classList.add('btn-secondary');}); document.getElementById('measure-hint-tops').classList.remove('hidden'); document.getElementById('measure-hint-button-shirt').classList.add('hidden'); document.getElementById('measure-hint-bottoms').classList.add('hidden'); document.getElementById('measure-hint-outer').classList.add('hidden'); fabricFilters={stretch:null,surface:null,interior:null}; materialFilters={temp:null,shine:null}; patternFilters={lines:null,shapes:null,method:null}; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); document.getElementById('fabric-helper').classList.add('hidden'); document.getElementById('material-helper').classList.add('hidden'); document.getElementById('pattern-helper').classList.add('hidden'); document.getElementById('pattern-help-panel').classList.add('hidden'); document.getElementById('tag-location-panel').classList.add('hidden'); document.getElementById('fabric-tag-cut-section').classList.add('hidden'); document.getElementById('fabric-help-btn').classList.remove('hidden'); document.getElementById('material-tag-cut-section').classList.add('hidden'); document.getElementById('material-help-btn').classList.remove('hidden'); renderSubCategories('tops'); renderFabricCards(); renderMaterialCards(); renderPatternCards(); updatePhotoGrids(); updateValidation(); goToStep(1); setPhotoMode('main'); }
        
        function loadStats() { try{ const saved = JSON.parse(localStorage.getItem('vl_stats_v99.15')||'{}'); if(saved.date!==new Date().toDateString()){saved.today=0;} stats = {today:saved.today||0,week:saved.week||0,total:saved.total||0}; itemTimes = saved.itemTimes||[]; updateStatsDisplay(); if(itemTimes.length>0){ const avg = Math.floor(itemTimes.reduce((a,b)=>a+b,0)/itemTimes.length); document.getElementById('timer-avg').textContent = `${Math.floor(avg/60)}:${(avg%60).toString().padStart(2,'0')}`; } }catch(e){} }
        function saveStats() { try{localStorage.setItem('vl_stats_v99.15',JSON.stringify({...stats,date:new Date().toDateString(),itemTimes:itemTimes.slice(-50)}));}catch(e){} }
        function updateStatsDisplay() { document.getElementById('stat-today').textContent = stats.today; document.getElementById('stat-week').textContent = stats.week; document.getElementById('stat-total').textContent = stats.total; }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VintageLister Browser v2.8.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root {
            --color-primary: #3b82f6;
            --color-primary-dark: #2563eb;
            --color-primary-light: #dbeafe;
            --color-success: #22c55e;
            --color-success-dark: #16a34a;
            --color-warning: #f59e0b;
            --color-warning-dark: #d97706;
            --color-error: #ef4444;
            --color-error-dark: #dc2626;
            --color-surface: #ffffff;
            --color-background: #f1f5f9;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-border: #e2e8f0;
            --color-dark: #1e293b;
            --color-purple: #7c3aed;
            --radius-md: 8px;
            --radius-lg: 12px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            height: 100vh;
            overflow: hidden;
        }
        
        .hidden { display: none !important; }
        
        .desktop-layout {
            display: grid;
            grid-template-columns: 320px minmax(400px, 1fr) 280px;
            height: 100vh;
            overflow: hidden;
        }
        
        @media (max-width: 1200px) {
            .desktop-layout { grid-template-columns: 280px minmax(300px, 1fr) 240px; }
        }
        
        @media (max-width: 900px) {
            .desktop-layout { grid-template-columns: 280px 1fr; }
            .photos-panel {
                position: fixed; right: 0; top: 0; bottom: 0; width: 280px;
                transform: translateX(100%); transition: transform 0.3s ease;
                z-index: 500; box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            }
            .photos-panel.visible { transform: translateX(0); }
            .photos-toggle { display: flex !important; }
        }
        
        .form-panel {
            background: var(--color-surface);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .floating-timer {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timer-main { font-size: 26px; font-weight: 800; font-family: monospace; }
        .timer-label { font-size: 9px; opacity: 0.7; }
        .timer-stats { text-align: right; font-size: 11px; }
        
        .header-buttons { display: flex; gap: 8px; align-items: center; }
        
        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none; color: white;
            width: 36px; height: 36px;
            border-radius: 8px; font-size: 18px;
            cursor: pointer; transition: all 0.15s;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.3); }
        .settings-btn.needs-setup { background: var(--color-error); animation: pulse-attention 2s infinite; }
        
        @keyframes pulse-attention { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .version-badge { background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        
        .form-content { flex: 1; overflow-y: auto; padding: 12px; }
        
        .section-card {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .section-label {
            font-size: 12px; font-weight: 700; color: var(--color-text);
            margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
        }
        
        .check-circle {
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--color-border); color: #999;
            display: flex; align-items: center; justify-content: center; font-size: 11px;
        }
        .check-circle.complete { background: var(--color-success); color: white; }
        
        .sku-input-row { display: flex; gap: 6px; align-items: stretch; }
        .sku-input {
            flex: 1; min-width: 0; padding: 10px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px; font-weight: 600;
        }
        .sku-input:focus { outline: none; border-color: var(--color-primary); }
        
        .sku-btn {
            padding: 10px 12px; border-radius: var(--radius-md);
            font-size: 13px; font-weight: 600; cursor: pointer;
            border: none; white-space: nowrap; flex-shrink: 0;
        }
        .sku-btn-scan { background: var(--color-primary); color: white; }
        .sku-btn-scan:hover { background: var(--color-primary-dark); }
        .sku-btn-start { background: var(--color-success); color: white; }
        .sku-btn-start:hover { background: var(--color-success-dark); }
        
        .sku-display {
            padding: 12px; background: var(--color-success); color: white;
            border-radius: var(--radius-md); font-size: 16px; font-weight: 700;
            text-align: center; display: none; cursor: pointer;
            position: relative; transition: all 0.15s;
        }
        .sku-display.visible { display: block; }
        .sku-display:hover { background: var(--color-success-dark); }
        .sku-display::after {
            content: '‚úï Cancel'; position: absolute; right: 12px;
            font-size: 11px; opacity: 0; transition: opacity 0.15s;
        }
        .sku-display:hover::after { opacity: 0.8; }
        
        .btn {
            padding: 10px 16px; border-radius: var(--radius-md);
            font-size: 13px; font-weight: 600; cursor: pointer;
            border: 2px solid transparent; transition: all 0.15s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-success:hover { background: var(--color-success-dark); }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: var(--color-primary-dark); }
        .btn-error { background: var(--color-error); color: white; }
        .btn-error:hover { background: var(--color-error-dark); }
        
        .mode-buttons { display: flex; flex-direction: column; gap: 8px; }
        
        .mode-btn {
            padding: 14px; border: 3px solid var(--color-border);
            border-radius: var(--radius-lg); background: white;
            cursor: pointer; display: flex; align-items: center;
            gap: 12px; transition: all 0.15s;
        }
        .mode-btn:hover { border-color: var(--color-primary); }
        .mode-btn.active { border-color: var(--color-primary); background: var(--color-primary); color: white; }
        .mode-btn.active[data-mode="main"] { background: var(--color-primary); border-color: var(--color-primary-dark); }
        .mode-btn.active[data-mode="closeup"] { background: var(--color-purple); border-color: #6d28d9; }
        .mode-btn.active[data-mode="handheld"] { background: var(--color-warning); border-color: var(--color-warning-dark); }
        
        .mode-icon { font-size: 24px; }
        .mode-info { flex: 1; }
        .mode-name { font-size: 14px; font-weight: 700; }
        .mode-desc { font-size: 10px; opacity: 0.7; }
        .mode-count { font-size: 18px; font-weight: 700; }
        .mode-camera-status { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: var(--color-success); color: white; }
        .mode-camera-status.not-set { background: var(--color-error); }
        
        /* Photo Type Selector */
        .photo-type-row {
            display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px;
        }
        .photo-type-btn {
            padding: 4px 8px; border-radius: 4px;
            font-size: 10px; font-weight: 600;
            border: 1px solid var(--color-border);
            background: white; cursor: pointer;
            transition: all 0.1s;
        }
        .photo-type-btn:hover { border-color: var(--color-primary); }
        .photo-type-btn.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        
        .ai-status {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border-radius: 10px; padding: 12px; color: white;
        }
        .ai-status-title { font-size: 10px; font-weight: 700; opacity: 0.7; margin-bottom: 6px; }
        .ai-status-chain { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
        .ai-badge { padding: 3px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; }
        .ai-badge.gemini { background: #7c3aed; }
        .ai-badge.claude { background: #d97706; }
        .ai-badge.s3 { background: #059669; }
        .ai-badge.n8n { background: #e11d48; }
        .ai-badge.active { box-shadow: 0 0 0 2px white; }
        .ai-arrow { color: #64748b; font-size: 8px; }
        
        /* Save Location */
        .save-location {
            background: #f0fdf4; border: 1px solid #86efac;
            border-radius: var(--radius-md); padding: 8px;
            margin-top: 8px; font-size: 11px;
        }
        .save-location.not-set { background: #fef2f2; border-color: #fca5a5; }
        .save-location-label { font-weight: 700; margin-bottom: 4px; }
        .save-location-path { 
            font-family: monospace; font-size: 10px;
            color: var(--color-text-muted); word-break: break-all;
        }
        .save-location-btn {
            margin-top: 6px; padding: 4px 8px;
            background: var(--color-primary); color: white;
            border: none; border-radius: 4px;
            font-size: 10px; cursor: pointer;
        }
        .save-location-btn:hover { background: var(--color-primary-dark); }
        
        .complete-section { padding: 16px; border-top: 1px solid var(--color-border); }
        
        .complete-btn {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, var(--color-success), var(--color-success-dark));
            color: white; border: none; border-radius: var(--radius-lg);
            font-size: 15px; font-weight: 700; cursor: pointer;
        }
        .complete-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34,197,94,0.4); }
        .complete-btn:disabled { background: var(--color-border); cursor: not-allowed; }
        
        .camera-panel {
            background: #000; display: flex; flex-direction: column;
            position: relative; min-width: 0; overflow: hidden;
        }
        
        .camera-header {
            background: rgba(0,0,0,0.8); padding: 10px 16px;
            display: flex; align-items: center; gap: 12px;
            z-index: 10; flex-shrink: 0;
        }
        
        .camera-mode-badge { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; color: white; }
        .camera-mode-badge.main { background: var(--color-primary); }
        .camera-mode-badge.closeup { background: var(--color-purple); }
        .camera-mode-badge.handheld { background: var(--color-warning); }
        
        .camera-resolution { color: var(--color-success); font-size: 12px; font-family: monospace; }
        .camera-name { color: #888; font-size: 11px; flex: 1; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .photos-toggle {
            display: none; background: var(--color-primary); border: none;
            color: white; padding: 6px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 600; cursor: pointer;
            gap: 4px; align-items: center;
        }
        .photos-toggle:hover { background: var(--color-primary-dark); }
        
        .camera-view {
            flex: 1; display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden; background: #000; min-height: 0;
        }
        .camera-view-container {
            position: relative; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #camera-video { max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.15s ease; }
        .camera-placeholder { color: #666; text-align: center; padding: 40px; position: absolute; z-index: 1; }
        .camera-placeholder-icon { font-size: 64px; margin-bottom: 16px; }
        
        .camera-footer {
            background: var(--color-dark); padding: 16px;
            display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; border-top: 1px solid #333;
        }
        .shutter-btn {
            width: 72px; height: 72px; border-radius: 50%;
            background: white; border: 4px solid #666;
            cursor: pointer; transition: all 0.1s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .shutter-btn:hover { transform: scale(1.05); }
        .shutter-btn:active { transform: scale(0.95); background: #ddd; }
        .shutter-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .shutter-hint { font-size: 11px; color: #888; text-align: center; margin-top: 8px; }
        .shutter-hint kbd { background: #444; color: white; padding: 2px 6px; border-radius: 4px; }
        
        .flash-overlay {
            position: absolute; inset: 0; background: white;
            opacity: 0; pointer-events: none; z-index: 100;
        }
        .flash-overlay.flash { opacity: 1; transition: opacity 0.05s; }
        
        .photos-panel {
            background: var(--color-background); overflow-y: auto;
            padding: 16px; border-left: 1px solid var(--color-border);
        }
        
        .photos-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        
        .photos-close {
            display: none; background: var(--color-border); border: none;
            width: 28px; height: 28px; border-radius: 6px; font-size: 16px; cursor: pointer;
        }
        .photos-close:hover { background: var(--color-text-muted); color: white; }
        
        @media (max-width: 900px) {
            .photos-close { display: flex; align-items: center; justify-content: center; }
        }
        
        .photos-section { margin-bottom: 16px; }
        .photos-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .photos-section-title { font-size: 12px; font-weight: 700; }
        .photos-section-count { font-size: 11px; background: var(--color-border); padding: 2px 8px; border-radius: 10px; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .photo-thumb {
            aspect-ratio: 1; background: white; border-radius: 6px;
            overflow: hidden; position: relative;
            border: 2px solid var(--color-border); cursor: pointer;
        }
        .photo-thumb:hover { border-color: var(--color-primary); }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb .photo-label {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.7); color: white;
            font-size: 8px; padding: 2px; text-align: center; font-weight: 600;
        }
        .photo-thumb .photo-folder {
            position: absolute; top: 2px; left: 2px;
            background: var(--color-primary); color: white;
            font-size: 7px; padding: 1px 4px; border-radius: 3px; font-weight: 600;
        }
        .photo-thumb .delete-btn {
            position: absolute; top: 2px; right: 2px;
            width: 16px; height: 16px; background: var(--color-error);
            border: none; border-radius: 50%; color: white;
            font-size: 10px; cursor: pointer; opacity: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .photo-thumb:hover .delete-btn { opacity: 1; }
        .photo-thumb.clickable { cursor: pointer; }
        .photo-thumb.clickable:hover { transform: scale(1.05); }
        
        /* Photo Lightbox */
        .lightbox-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .lightbox-modal.active { display: flex; }
        
        .lightbox-container {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: 80vh;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .lightbox-image {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        
        .lightbox-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .lightbox-controls {
            background: rgba(0,0,0,0.8);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .lightbox-nav {
            display: flex;
            gap: 10px;
        }
        
        .lightbox-nav button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.15s;
        }
        
        .lightbox-nav button:hover:not(:disabled) { background: rgba(255,255,255,0.4); }
        .lightbox-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .lightbox-info {
            flex: 1;
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            text-align: center;
        }
        
        .lightbox-info div { margin: 2px 0; }
        .lightbox-info strong { color: white; }
        
        .lightbox-actions {
            display: flex;
            gap: 8px;
        }
        
        .lightbox-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }
        
        .lightbox-actions button:hover { background: rgba(255,255,255,0.4); }
        .lightbox-actions button.delete { background: rgba(239,68,68,0.3); }
        .lightbox-actions button.delete:hover { background: rgba(239,68,68,0.5); }
        
        .lightbox-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.15s;
        }
        
        .lightbox-close:hover { background: rgba(0,0,0,0.8); }
        
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: white; border-radius: 16px; width: 90%;
            max-width: 900px; max-height: 90vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        
        .modal-header {
            background: var(--color-primary); color: white;
            padding: 16px 20px; display: flex;
            justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close {
            background: rgba(255,255,255,0.2); border: none;
            color: white; width: 32px; height: 32px;
            border-radius: 8px; font-size: 18px; cursor: pointer;
        }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .modal-footer {
            padding: 16px 20px; border-top: 1px solid var(--color-border);
            display: flex; justify-content: center; gap: 12px;
            background: var(--color-background);
        }
        
        .camera-setup-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        
        @media (max-width: 800px) {
            .camera-setup-grid { grid-template-columns: 1fr; }
        }
        
        .camera-setup-card {
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg); padding: 12px; text-align: center;
        }
        .camera-setup-card.main { border-color: var(--color-primary); }
        .camera-setup-card.closeup { border-color: var(--color-purple); }
        .camera-setup-card.handheld { border-color: var(--color-warning); }
        
        .camera-setup-icon { font-size: 32px; margin-bottom: 8px; }
        .camera-setup-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .camera-setup-desc { font-size: 10px; color: var(--color-text-muted); margin-bottom: 12px; }
        
        .camera-setup-select {
            width: 100%; padding: 8px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md); font-size: 12px; margin-bottom: 12px;
        }
        .camera-setup-select:focus { outline: none; border-color: var(--color-primary); }
        
        .camera-preview-container {
            background: #000; border-radius: var(--radius-md);
            aspect-ratio: 4/3; overflow: hidden; position: relative;
        }
        .camera-preview-video { width: 100%; height: 100%; object-fit: cover; }
        .camera-preview-placeholder {
            width: 100%; height: 100%; display: flex;
            align-items: center; justify-content: center;
            color: #666; font-size: 12px;
        }
        .camera-preview-status {
            position: absolute; bottom: 8px; left: 8px; right: 8px;
            background: rgba(0,0,0,0.7); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 10px; text-align: center;
        }
        .camera-preview-status.connected { background: var(--color-success); }
        
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: var(--color-dark); color: white;
            padding: 12px 16px; border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
            animation: slideIn 0.3s ease; max-width: 320px;
        }
        .toast.success { background: linear-gradient(135deg, #059669, #047857); }
        .toast.error { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .toast.warning { background: linear-gradient(135deg, #d97706, #b45309); }
        .toast.info { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .toast-icon { font-size: 16px; }
        .toast-message { font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
        
        .processing-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center;
            z-index: 2000; flex-direction: column; gap: 20px;
        }
        .processing-overlay.active { display: flex; }
        .processing-spinner {
            width: 60px; height: 60px; border: 4px solid #333;
            border-top-color: var(--color-primary);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-text { color: white; font-size: 18px; font-weight: 600; }
        .processing-subtext { color: #888; font-size: 13px; }
        .processing-progress { width: 300px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .processing-progress-bar { height: 100%; background: var(--color-primary); transition: width 0.3s; }
        
        .barcode-scanner-container { position: relative; background: #000; aspect-ratio: 4/3; }
        #barcode-video { width: 100%; height: 100%; object-fit: cover; }
        .barcode-overlay {
            position: absolute; inset: 0; display: flex;
            align-items: center; justify-content: center; pointer-events: none;
        }
        .barcode-target {
            width: 70%; height: 40%; border: 3px solid var(--color-warning);
            border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .barcode-status {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600;
        }
        .barcode-status.success { background: var(--color-success); }
        
        .measure-category {
            display: flex; align-items: center; gap: 8px;
            padding: 8px; background: var(--color-background);
            border-radius: var(--radius-md); margin-bottom: 8px; font-size: 11px;
        }
        .measure-category-icon { font-size: 16px; }
        .measure-category.detected { background: #dbeafe; }
        .measure-category.detected .measure-category-icon { color: var(--color-primary); }
        
        .measure-hints {
            background: #eff6ff; border: 1px solid #bfdbfe;
            border-radius: var(--radius-md); padding: 8px; margin-bottom: 8px;
        }
        .measure-hints-title { font-size: 10px; font-weight: 700; color: var(--color-primary); margin-bottom: 4px; }
        .measure-hints-list { font-size: 9px; color: var(--color-primary); line-height: 1.5; }
        .measure-hints-list .hint-item { display: flex; gap: 4px; }
        .measure-hints-list .hint-num { font-weight: 700; min-width: 14px; }
        
        #record-section { margin-top: 8px; }
        
        .record-btn {
            width: 100%; padding: 14px 12px;
            background: #ef4444; color: white; border: none;
            border-radius: var(--radius-md); font-size: 14px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; gap: 8px; transition: all 0.15s;
        }
        .record-btn:hover { background: #dc2626; }
        .record-btn.recording { background: #dc2626; animation: pulse-red 1s infinite; }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .record-icon { font-size: 18px; }
        
        #post-record-section { margin-top: 8px; }
        
        .recorded-badge {
            background: #f0fdf4; border: 1px solid #86efac;
            border-radius: var(--radius-md); padding: 10px; text-align: center;
        }
        .recorded-check { color: #16a34a; font-weight: 700; font-size: 13px; }
        .recorded-duration { color: #22c55e; font-family: monospace; font-size: 18px; margin-top: 2px; }
        
        .transcript-status { font-size: 11px; color: var(--color-text-muted); text-align: center; padding: 6px 0; }
        .transcript-status.processing { color: var(--color-primary); }
        .transcript-status.success { color: var(--color-success); }
        .transcript-status.error { color: var(--color-error); }
        
        .measurements-parsed {
            background: white; border: 1px solid var(--color-border);
            border-radius: var(--radius-md); padding: 8px 10px; font-size: 11px;
        }
        .measurement-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 4px 0; border-bottom: 1px solid var(--color-border);
        }
        .measurement-item:last-child { border-bottom: none; }
        .measurement-item.filled { color: var(--color-success); }
        .measurement-item.filled .measurement-value { color: var(--color-success); }
        .measurement-item.empty { color: var(--color-text-muted); }
        .measurement-name { flex: 1; }
        .measurement-value { font-weight: 700; font-family: monospace; min-width: 40px; text-align: right; }
        
        .re-record-btn {
            width: 100%; padding: 8px; margin-top: 6px;
            background: none; border: none; color: var(--color-text-muted);
            font-size: 11px; text-decoration: underline; cursor: pointer;
        }
        .re-record-btn:hover { color: var(--color-text); }
    </style>
</head>
<body>
    <div class="desktop-layout">
        <!-- LEFT PANEL -->
        <div class="form-panel">
            <div class="floating-timer">
                <div>
                    <div class="timer-main" id="timer-display">0:00</div>
                    <div class="timer-label">ITEM TIME</div>
                </div>
                <div class="header-buttons">
                    <button class="settings-btn needs-setup" id="settings-btn" onclick="openSettings()" title="Camera Settings">‚öôÔ∏è</button>
                </div>
                <div class="timer-stats">
                    <div><strong id="stat-today">0</strong> today</div>
                    <div class="version-badge">v2.8.2</div>
                </div>
            </div>
            
            <div class="form-content">
                <!-- SKU -->
                <div class="section-card">
                    <div class="section-label">
                        <span class="check-circle" id="check-sku">‚óã</span>
                        üè∑Ô∏è Item SKU
                    </div>
                    <div class="sku-input-row" id="sku-input-row">
                        <input type="text" class="sku-input" id="sku-input" placeholder="Scan or type SKU...">
                        <button class="sku-btn sku-btn-scan" onclick="openBarcodeScanner()" title="Scan Barcode">üì∑</button>
                        <button class="sku-btn sku-btn-start" onclick="startNewItem()">START</button>
                    </div>
                    <div class="sku-display" id="sku-display" onclick="confirmCancelItem()" title="Click to cancel item"></div>
                </div>
                
                <!-- Photo Mode -->
                <div class="section-card">
                    <div class="section-label">üì∏ Photo Mode & Type</div>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="main" onclick="setMode('main')">
                            <span class="mode-icon">üì¶</span>
                            <div class="mode-info">
                                <div class="mode-name">MAIN</div>
                                <div class="mode-desc">Tripod overhead ‚Ä¢ Flat-lay & T-pose</div>
                            </div>
                            <span class="mode-camera-status not-set" id="status-main">No camera</span>
                            <span class="mode-count" id="count-main">0</span>
                        </button>
                        <button class="mode-btn" data-mode="closeup" onclick="setMode('closeup')">
                            <span class="mode-icon">üîç</span>
                            <div class="mode-info">
                                <div class="mode-name">CLOSE-UP</div>
                                <div class="mode-desc">Tags, defects, features</div>
                            </div>
                            <span class="mode-camera-status not-set" id="status-closeup">No camera</span>
                            <span class="mode-count" id="count-closeup">0</span>
                        </button>
                        <button class="mode-btn" data-mode="handheld" onclick="setMode('handheld')">
                            <span class="mode-icon">‚úã</span>
                            <div class="mode-info">
                                <div class="mode-name">HANDHELD</div>
                                <div class="mode-desc">Scale, angles, details</div>
                            </div>
                            <span class="mode-camera-status not-set" id="status-handheld">No camera</span>
                            <span class="mode-count" id="count-handheld">0</span>
                        </button>
                    </div>
                    
                    <!-- Photo Type Quick Select -->
                    <div id="photo-type-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--color-border);">
                        <div style="font-size: 10px; font-weight: 600; margin-bottom: 6px; color: var(--color-text-muted);">
                            üìÇ Save to folder: <span id="current-folder" style="color: var(--color-primary);">main</span>
                        </div>
                        <div class="photo-type-row" id="photo-type-buttons">
                            <!-- Populated dynamically based on mode -->
                        </div>
                    </div>
                </div>
                
                <!-- AI & Save Status -->
                <div class="section-card">
                    <div class="ai-status">
                        <div class="ai-status-title">ü§ñ AI + STORAGE + AUTOMATION</div>
                        <div class="ai-status-chain">
                            <span class="ai-badge gemini">GEMINI</span>
                            <span class="ai-arrow">‚Üí</span>
                            <span class="ai-badge claude">CLAUDE</span>
                            <span class="ai-arrow">+</span>
                            <span class="ai-badge s3">S3</span>
                            <span class="ai-arrow">+</span>
                            <span class="ai-badge n8n">n8n</span>
                        </div>
                    </div>
                    
                    <!-- Save Location -->
                    <div id="save-location" class="save-location not-set">
                        <div class="save-location-label">üíæ Save Location</div>
                        <div class="save-location-path" id="save-path">Not set - click to choose folder</div>
                        <button class="save-location-btn" onclick="chooseSaveFolder()">üìÅ Choose Folder</button>
                    </div>
                </div>
                
                <!-- MEASUREMENTS -->
                <div class="section-card">
                    <div class="section-label">
                        <span class="check-circle" id="check-measure">‚óã</span>
                        üé§ Measurements
                    </div>
                    
                    <div id="measure-category" class="measure-category">
                        <span class="measure-category-icon">‚ùì</span>
                        <span class="measure-category-text">Take a MAIN photo to detect category</span>
                    </div>
                    
                    <div id="measure-hints" class="measure-hints hidden">
                        <div class="measure-hints-title">üìè Measurement Order:</div>
                        <div id="measure-hints-list" class="measure-hints-list"></div>
                    </div>
                    
                    <div id="record-section">
                        <button id="record-btn" class="record-btn" onclick="toggleRecording()">
                            <span class="record-icon">üé§</span>
                            <span class="record-text">TAP TO RECORD</span>
                        </button>
                    </div>
                    
                    <div id="post-record-section" class="hidden">
                        <div class="recorded-badge">
                            <div class="recorded-check">‚úì RECORDED</div>
                            <div class="recorded-duration" id="recording-duration">0:00</div>
                        </div>
                        <div id="transcript-status" class="transcript-status"></div>
                        <div id="measurements-parsed" class="measurements-parsed hidden"></div>
                        <button class="re-record-btn" onclick="reRecord()">Re-record</button>
                    </div>
                </div>
            </div>
            
            <!-- Complete -->
            <div class="complete-section">
                <button class="complete-btn" id="complete-btn" onclick="completeItem()" disabled>
                    ‚úÖ COMPLETE & SAVE
                </button>
                <div style="text-align:center; margin-top:8px; font-size:10px; color:var(--color-text-muted);">
                    Saves to folder + uploads to S3
                </div>
            </div>
        </div>
        
        <!-- CENTER - Camera -->
        <div class="camera-panel">
            <div class="camera-header">
                <span class="camera-mode-badge main" id="camera-mode-badge">MAIN</span>
                <span class="camera-resolution" id="camera-resolution">--</span>
                <span class="camera-name" id="camera-name">No camera selected</span>
                <button class="photos-toggle" id="photos-toggle" onclick="togglePhotosPanel()">
                    üì∑ <span id="photos-toggle-count">0</span>
                </button>
            </div>
            
            <div class="camera-view" id="camera-view">
                <div class="camera-view-container">
                    <div class="camera-placeholder" id="camera-placeholder">
                        <div class="camera-placeholder-icon">‚öôÔ∏è</div>
                        <div>Click the gear icon to set up cameras</div>
                        <button class="btn btn-primary" style="margin-top:16px;" onclick="openSettings()">‚öôÔ∏è Open Settings</button>
                    </div>
                    <video id="camera-video" autoplay playsinline style="display:none;"></video>
                </div>
                <div class="flash-overlay" id="flash-overlay"></div>
            </div>
            
            <div class="camera-footer">
                <div>
                    <button class="shutter-btn" id="shutter-btn" onclick="capturePhoto()" disabled></button>
                    <div class="shutter-hint">Press <kbd>SPACE</kbd> to capture</div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT PANEL -->
        <div class="photos-panel" id="photos-panel">
            <div class="photos-panel-header">
                <span class="photos-section-title">üì∑ All Photos</span>
                <button class="photos-close" onclick="togglePhotosPanel()">‚úï</button>
            </div>
            <div class="photos-section">
                <div class="photos-section-header">
                    <span class="photos-section-count" id="total-count">0</span>
                </div>
                <div style="font-size:10px; color:var(--color-text-muted); margin-bottom:10px;">
                    Photos saved to folders on complete
                </div>
                <div class="photo-grid" id="photos-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è Camera Settings</span>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="camera-setup-grid">
                    <div class="camera-setup-card main">
                        <div class="camera-setup-icon">üì¶</div>
                        <div class="camera-setup-title">MAIN Camera</div>
                        <div class="camera-setup-desc">Tripod overhead for flat-lay</div>
                        <select class="camera-setup-select" id="select-main" onchange="previewCamera('main', this.value)">
                            <option value="">Select camera...</option>
                        </select>
                        <div class="camera-preview-container">
                            <video class="camera-preview-video" id="preview-main" autoplay playsinline style="display:none;"></video>
                            <div class="camera-preview-placeholder" id="placeholder-main">Select a camera</div>
                            <div class="camera-preview-status" id="status-preview-main"></div>
                        </div>
                    </div>
                    
                    <div class="camera-setup-card closeup">
                        <div class="camera-setup-icon">üîç</div>
                        <div class="camera-setup-title">CLOSE-UP Camera</div>
                        <div class="camera-setup-desc">Macro for tags, details</div>
                        <select class="camera-setup-select" id="select-closeup" onchange="previewCamera('closeup', this.value)">
                            <option value="">Select camera...</option>
                        </select>
                        <div class="camera-preview-container">
                            <video class="camera-preview-video" id="preview-closeup" autoplay playsinline style="display:none;"></video>
                            <div class="camera-preview-placeholder" id="placeholder-closeup">Select a camera</div>
                            <div class="camera-preview-status" id="status-preview-closeup"></div>
                        </div>
                    </div>
                    
                    <div class="camera-setup-card handheld">
                        <div class="camera-setup-icon">‚úã</div>
                        <div class="camera-setup-title">HANDHELD Camera</div>
                        <div class="camera-setup-desc">Freestanding for scale</div>
                        <select class="camera-setup-select" id="select-handheld" onchange="previewCamera('handheld', this.value)">
                            <option value="">Select camera...</option>
                        </select>
                        <div class="camera-preview-container">
                            <video class="camera-preview-video" id="preview-handheld" autoplay playsinline style="display:none;"></video>
                            <div class="camera-preview-placeholder" id="placeholder-handheld">Select a camera</div>
                            <div class="camera-preview-status" id="status-preview-handheld"></div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--color-border);">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">üì∑ Barcode Scanner Camera</div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <select class="camera-setup-select" id="select-barcode" style="flex: 1; margin-bottom: 0;">
                            <option value="">Select camera...</option>
                        </select>
                        <button class="btn btn-primary" onclick="testBarcodeScanner()">Test</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#f1f5f9;" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-success" onclick="saveSettings()">‚úì Save & Close</button>
            </div>
        </div>
    </div>
    
    <!-- BARCODE SCANNER MODAL -->
    <div class="modal-overlay" id="barcode-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header" style="background: var(--color-warning);">
                <span class="modal-title">üì∑ Scan Barcode</span>
                <button class="modal-close" onclick="closeBarcodeScanner()">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="barcode-scanner-container">
                    <video id="barcode-video" autoplay playsinline></video>
                    <div class="barcode-overlay"><div class="barcode-target"></div></div>
                    <div class="barcode-status" id="barcode-status">Point camera at barcode...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#f1f5f9;" onclick="closeBarcodeScanner()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- CONFIRM CANCEL MODAL -->
    <div class="modal-overlay" id="confirm-cancel-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: var(--color-error);">
                <span class="modal-title">‚ö†Ô∏è Cancel Item?</span>
                <button class="modal-close" onclick="closeConfirmCancel()">‚úï</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 12px;">Are you sure you want to cancel?</p>
                <p style="font-size: 13px; color: var(--color-text-muted);">
                    SKU: <strong id="cancel-sku-display"></strong><br>
                    Photos: <strong id="cancel-photo-count"></strong>
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:#f1f5f9;" onclick="closeConfirmCancel()">Keep Working</button>
                <button class="btn btn-error" onclick="cancelItem()">Yes, Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Photo Lightbox -->
    <div class="lightbox-modal" id="photo-lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <div class="lightbox-container">
            <div class="lightbox-image" id="lightbox-image"></div>
            <div class="lightbox-controls">
                <div class="lightbox-nav">
                    <button id="lightbox-prev" onclick="lightboxPrev()">‚óÄ</button>
                    <button id="lightbox-next" onclick="lightboxNext()">‚ñ∂</button>
                </div>
                <div class="lightbox-info">
                    <div><strong id="lightbox-index">1/1</strong></div>
                    <div><span id="lightbox-type"></span> ‚Ä¢ <span id="lightbox-folder"></span></div>
                </div>
                <div class="lightbox-actions">
                    <button id="lightbox-delete" onclick="lightboxDelete()" class="delete">üóë Delete</button>
                    <button onclick="closeLightbox()">Done</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toast-container"></div>

    
    <div class="processing-overlay" id="processing-overlay">
        <div class="processing-spinner"></div>
        <div class="processing-text" id="processing-text">Processing...</div>
        <div class="processing-subtext" id="processing-subtext"></div>
        <div class="processing-progress">
            <div class="processing-progress-bar" id="processing-progress" style="width:0%"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONSTANTS
        // ============================================
        const VERSION = '2.8.2';
        const LAMBDA_URL = 'https://6t5wk2ae23foojyfwmddauorey0pjqji.lambda-url.us-east-2.on.aws/';
        
        // Folder structure matching your setup
        const FOLDERS = ['main', 'tag', 'defects', 'features', 'weight', 'data'];
        
        // Photo type options per mode
        const PHOTO_TYPES = {
            main: [
                { id: 'main', label: 'Main', folder: 'main' },
                { id: 'front', label: 'Front', folder: 'main' },
                { id: 'back', label: 'Back', folder: 'main' },
                { id: 'inside', label: 'Inside', folder: 'main' },
                { id: 'tpose', label: 'T-Pose', folder: 'main' }
            ],
            closeup: [
                { id: 'tag_brand', label: 'Brand Tag', folder: 'tag' },
                { id: 'tag_size', label: 'Size Tag', folder: 'tag' },
                { id: 'tag_care', label: 'Care Tag', folder: 'tag' },
                { id: 'tag_origin', label: 'Made In', folder: 'tag' },
                { id: 'defect', label: 'Defect', folder: 'defects' },
                { id: 'stain', label: 'Stain', folder: 'defects' },
                { id: 'hole', label: 'Hole', folder: 'defects' },
                { id: 'wear', label: 'Wear', folder: 'defects' },
                { id: 'feature', label: 'Feature', folder: 'features' },
                { id: 'detail', label: 'Detail', folder: 'features' },
                { id: 'zipper', label: 'Zipper', folder: 'features' },
                { id: 'button', label: 'Button', folder: 'features' },
                { id: 'print', label: 'Print', folder: 'features' }
            ],
            handheld: [
                { id: 'scale', label: 'Scale/Weight', folder: 'weight' },
                { id: 'angle', label: 'Angle', folder: 'features' },
                { id: 'detail', label: 'Detail', folder: 'features' },
                { id: 'defect', label: 'Defect', folder: 'defects' }
            ]
        };
        
        const RESOLUTION_PRESETS = [
            { w: 4096, h: 2160 }, { w: 3840, h: 2160 },
            { w: 2560, h: 1440 }, { w: 1920, h: 1080 }
        ];
        
        const MEASUREMENT_TEMPLATES = {
            'tops-standard': ['Pit-to-Pit', 'Length', 'Shoulder', 'Sleeve'],
            'bottoms-pants': ['Waist', 'Rise', 'Inseam', 'Thigh', 'Leg Opening'],
            'bottoms-shorts': ['Waist', 'Rise', 'Inseam', 'Leg Opening'],
            'outer-standard': ['Pit-to-Pit', 'Length', 'Shoulder', 'Sleeve']
        };
        
        const CATEGORY_MAP = {
            'T-Shirt': 'tops-standard', 'Polo': 'tops-standard', 'Sweater': 'tops-standard',
            'Sweatshirt': 'tops-standard', 'Hoodie': 'tops-standard', 'Jersey': 'tops-standard',
            'Button Shirt': 'tops-standard', 'Jacket': 'outer-standard', 'Coat': 'outer-standard',
            'Jeans': 'bottoms-pants', 'Pants': 'bottoms-pants', 'Shorts': 'bottoms-shorts'
        };
        
        // ============================================
        // STATE
        // ============================================
        let currentMode = 'main';
        let currentPhotoType = PHOTO_TYPES.main[0];
        let currentSKU = '';
        let currentStream = null;
        let availableCameras = [];
        let photos = [];
        let saveDirectoryHandle = null; // File System Access API
        
        let cameraConfig = {
            main: { deviceId: null, label: '' },
            closeup: { deviceId: null, label: '' },
            handheld: { deviceId: null, label: '' },
            barcode: { deviceId: null, label: '' }
        };
        
        let previewStreams = { main: null, closeup: null, handheld: null };
        let barcodeStream = null, barcodeScanning = false;
        let itemStartTime = null, timerInterval = null;
        let detectedCategory = null, currentTemplate = null;
        let mediaRecorder = null, audioChunks = [], audioBlob = null;
        let recordingStart = null, recordingInterval = null;
        let parsedMeasurements = {};
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log(`%c VintageLister v${VERSION} `, 'background: #3b82f6; color: white; font-size: 14px; font-weight: bold;');
            
            initDailyCounter();
            loadCameraConfig();
            loadSaveLocation();
            await enumerateCameras();
            
            if (hasCameraConfigured()) await autoConnectCameras();
            
            updatePhotoTypeButtons();
            initKeyboard();
            updateUI();
        });
        
        function initDailyCounter() {
            const savedDate = localStorage.getItem('vl_items_date');
            const today = new Date().toDateString();
            if (savedDate !== today) {
                localStorage.setItem('vl_items_date', today);
                localStorage.setItem('vl_items_today', '0');
            }
            document.getElementById('stat-today').textContent = localStorage.getItem('vl_items_today') || '0';
        }
        
        function incrementDailyCounter() {
            let count = parseInt(localStorage.getItem('vl_items_today') || '0') + 1;
            localStorage.setItem('vl_items_today', count.toString());
            document.getElementById('stat-today').textContent = count;
        }
        
        function hasCameraConfigured() {
            return cameraConfig.main?.deviceId || cameraConfig.closeup?.deviceId || cameraConfig.handheld?.deviceId;
        }
        
        // ============================================
        // FILE SYSTEM ACCESS API - Save Location
        // ============================================
        async function chooseSaveFolder() {
            if (!('showDirectoryPicker' in window)) {
                showToast('warning', 'Folder picker not supported. Use Chrome/Edge.');
                return;
            }
            
            try {
                saveDirectoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                
                // Save permission
                localStorage.setItem('vl_save_folder_name', saveDirectoryHandle.name);
                
                updateSaveLocationUI();
                showToast('success', `Save folder: ${saveDirectoryHandle.name}`);
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Folder picker error:', err);
                    showToast('error', 'Could not access folder');
                }
            }
        }
        
        function loadSaveLocation() {
            const savedName = localStorage.getItem('vl_save_folder_name');
            if (savedName) {
                document.getElementById('save-path').textContent = `Last used: ${savedName} (click to reselect)`;
            }
        }
        
        function updateSaveLocationUI() {
            const el = document.getElementById('save-location');
            const pathEl = document.getElementById('save-path');
            
            if (saveDirectoryHandle) {
                el.classList.remove('not-set');
                pathEl.textContent = saveDirectoryHandle.name;
            } else {
                el.classList.add('not-set');
                pathEl.textContent = 'Not set - click to choose folder';
            }
        }
        
        async function createFolderStructure(skuFolder) {
            // Create SKU folder and subfolders
            for (const folder of FOLDERS) {
                try {
                    await skuFolder.getDirectoryHandle(folder, { create: true });
                } catch (e) {
                    console.warn(`Could not create folder ${folder}:`, e);
                }
            }
        }
        
        async function savePhotoToFolder(skuFolder, photo, index) {
            const folderName = photo.folder || 'main';
            const subFolder = await skuFolder.getDirectoryHandle(folderName, { create: true });
            
            // Generate filename: SKU_type_##.jpg
            const filename = `${currentSKU}_${photo.type}_${String(index + 1).padStart(2, '0')}.jpg`;
            
            const fileHandle = await subFolder.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(photo.blob);
            await writable.close();
            
            return filename;
        }
        
        async function saveMeasurementsToFolder(skuFolder) {
            if (!parsedMeasurements || Object.keys(parsedMeasurements).length === 0) return;
            
            const dataFolder = await skuFolder.getDirectoryHandle('data', { create: true });
            const filename = `${currentSKU}_measurements.json`;
            
            const data = {
                sku: currentSKU,
                category: detectedCategory,
                measurements: parsedMeasurements,
                timestamp: new Date().toISOString()
            };
            
            const fileHandle = await dataFolder.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
        }
        
        // ============================================
        // S3 UPLOAD
        // ============================================
        async function uploadToS3() {
            if (photos.length === 0) return;
            
            try {
                // Get presigned URLs from Lambda
                const files = photos.map((p, i) => ({
                    name: `${p.folder}/${currentSKU}_${p.type}_${String(i + 1).padStart(2, '0')}.jpg`,
                    contentType: 'image/jpeg'
                }));
                
                console.log('üì§ Requesting presigned URLs for S3...');
                
                const presignResponse = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'presign',
                        sku: currentSKU,
                        files: files
                    })
                });
                
                if (!presignResponse.ok) {
                    throw new Error(`Presign failed: ${presignResponse.status}`);
                }
                
                const presignData = await presignResponse.json();
                
                if (!presignData.success || !presignData.urls) {
                    console.warn('S3 presign not available:', presignData.error);
                    return false;
                }
                
                // Upload each photo
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    const filename = files[i].name;
                    const uploadUrl = presignData.urls[filename];
                    
                    if (uploadUrl) {
                        setProcessing(`Uploading to S3...`, `${i + 1}/${photos.length}`, ((i + 1) / photos.length) * 50 + 50);
                        
                        await fetch(uploadUrl, {
                            method: 'PUT',
                            body: photo.blob,
                            headers: { 'Content-Type': 'image/jpeg' }
                        });
                    }
                }
                
                console.log('‚úÖ S3 upload complete');
                return true;
                
            } catch (err) {
                console.error('S3 upload error:', err);
                return false;
            }
        }
        
        // ============================================
        // CAMERA FUNCTIONS
        // ============================================
        async function enumerateCameras() {
            try {
                const permStream = await navigator.mediaDevices.getUserMedia({ video: true });
                permStream.getTracks().forEach(t => t.stop());
                await sleep(300);
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                // DEBUG: Log all video devices found
                console.group('üìπ Camera Enumeration Debug');
                console.log(`Total video devices detected: ${videoDevices.length}`);
                videoDevices.forEach((cam, i) => {
                    console.log(`[${i}] "${cam.label}" (ID: ${cam.deviceId.substring(0, 12)}...)`);
                });
                
                // Filter out virtual cameras
                const virtualKeywords = ['droidcam', 'obs', 'manycam', 'virtual', 'snap'];
                availableCameras = videoDevices.filter(d => {
                    if (!d.deviceId) return false;
                    const isVirtual = virtualKeywords.some(v => (d.label || '').toLowerCase().includes(v));
                    if (isVirtual) {
                        console.log(`  ‚ùå Filtered: "${d.label}" (contains virtual keyword)`);
                    }
                    return !isVirtual;
                });
                
                console.log(`\nCameras after filtering: ${availableCameras.length}`);
                availableCameras.forEach((cam, i) => {
                    console.log(`[${i}] "${cam.label}"`);
                });
                console.log('Virtual keywords:', virtualKeywords.join(', '));
                console.groupEnd();
                
                populateCameraSelects();
            } catch (err) {
                console.error('‚ùå Camera enumeration error:', err);
                showToast('error', `Camera: ${err.message}`);
            }
        }
        
        function populateCameraSelects() {
            ['main', 'closeup', 'handheld', 'barcode'].forEach(mode => {
                const select = document.getElementById(`select-${mode}`);
                if (!select) return;
                
                select.innerHTML = '<option value="">Select camera...</option>';
                availableCameras.forEach((cam, i) => {
                    const opt = document.createElement('option');
                    opt.value = cam.deviceId;
                    opt.textContent = cam.label || `Camera ${i + 1}`;
                    select.appendChild(opt);
                });
                
                if (cameraConfig[mode]?.deviceId) select.value = cameraConfig[mode].deviceId;
            });
        }
        
        function loadCameraConfig() {
            const saved = localStorage.getItem('vl_camera_config');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    cameraConfig = { ...cameraConfig, ...loaded };
                } catch (e) {}
            }
        }
        
        function saveCameraConfig() {
            localStorage.setItem('vl_camera_config', JSON.stringify(cameraConfig));
        }
        
        async function autoConnectCameras() {
            ['main', 'closeup', 'handheld'].forEach(mode => {
                const statusEl = document.getElementById(`status-${mode}`);
                if (statusEl) {
                    if (cameraConfig[mode]?.deviceId) {
                        statusEl.textContent = '‚úì Ready';
                        statusEl.classList.remove('not-set');
                    } else {
                        statusEl.textContent = 'No camera';
                        statusEl.classList.add('not-set');
                    }
                }
            });
            
            if (hasCameraConfigured()) {
                document.getElementById('settings-btn').classList.remove('needs-setup');
                document.getElementById('shutter-btn').disabled = false;
                await startCameraForMode(currentMode);
            }
        }
        
        function stopCurrentStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
        }
        
        async function startCameraForMode(mode) {
            const config = cameraConfig[mode];
            const video = document.getElementById('camera-video');
            
            if (!config?.deviceId) {
                video.style.display = 'none';
                document.getElementById('camera-placeholder').style.display = 'flex';
                document.getElementById('camera-name').textContent = 'No camera';
                document.getElementById('camera-resolution').textContent = '--';
                return;
            }
            
            stopCurrentStream();
            
            for (const res of RESOLUTION_PRESETS) {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: config.deviceId }, width: { exact: res.w }, height: { exact: res.h } }
                    });
                    break;
                } catch (e) {}
            }
            
            if (!currentStream) {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: config.deviceId } }
                    });
                } catch (err) {
                    showToast('error', `Camera error: ${err.message}`);
                    return;
                }
            }
            
            video.srcObject = currentStream;
            video.style.display = 'block';
            document.getElementById('camera-placeholder').style.display = 'none';
            document.getElementById('camera-name').textContent = config.label;
            
            video.onloadedmetadata = () => {
                const w = video.videoWidth, h = video.videoHeight;
                document.getElementById('camera-resolution').textContent = `${w}√ó${h}`;
            };
        }
        
        // ============================================
        // SETTINGS MODAL
        // ============================================
        async function openSettings() {
            stopCurrentStream();
            document.getElementById('settings-modal').classList.add('active');
            await enumerateCameras();
        }
        
        function closeSettings() {
            Object.values(previewStreams).forEach(s => s?.getTracks().forEach(t => t.stop()));
            previewStreams = { main: null, closeup: null, handheld: null };
            document.getElementById('settings-modal').classList.remove('active');
        }
        
        async function previewCamera(mode, deviceId) {
            const video = document.getElementById(`preview-${mode}`);
            const placeholder = document.getElementById(`placeholder-${mode}`);
            const status = document.getElementById(`status-preview-${mode}`);
            
            if (previewStreams[mode]) {
                previewStreams[mode].getTracks().forEach(t => t.stop());
                previewStreams[mode] = null;
            }
            
            if (!deviceId) {
                video.style.display = 'none';
                placeholder.style.display = 'flex';
                status.textContent = '';
                return;
            }
            
            try {
                status.textContent = 'Connecting...';
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: deviceId }, width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                
                previewStreams[mode] = stream;
                video.srcObject = stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                video.onloadedmetadata = () => {
                    status.textContent = `‚úì ${video.videoWidth}√ó${video.videoHeight}`;
                    status.classList.add('connected');
                };
            } catch (err) {
                status.textContent = `Error`;
                video.style.display = 'none';
                placeholder.style.display = 'flex';
            }
        }
        
        function saveSettings() {
            ['main', 'closeup', 'handheld', 'barcode'].forEach(mode => {
                const select = document.getElementById(`select-${mode}`);
                if (select) {
                    cameraConfig[mode] = {
                        deviceId: select.value || null,
                        label: select.options[select.selectedIndex]?.textContent || ''
                    };
                }
            });
            
            saveCameraConfig();
            closeSettings();
            autoConnectCameras();
            showToast('success', 'Settings saved!');
        }
        
        function testBarcodeScanner() {
            closeSettings();
            setTimeout(() => openBarcodeScanner(), 300);
        }
        
        // ============================================
        // MODE & PHOTO TYPE
        // ============================================
        function setMode(mode) {
            currentMode = mode;
            currentPhotoType = PHOTO_TYPES[mode][0];
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            const badge = document.getElementById('camera-mode-badge');
            badge.className = `camera-mode-badge ${mode}`;
            badge.textContent = mode.toUpperCase();
            
            updatePhotoTypeButtons();
            startCameraForMode(mode);
        }
        
        function updatePhotoTypeButtons() {
            const container = document.getElementById('photo-type-buttons');
            const types = PHOTO_TYPES[currentMode];
            
            container.innerHTML = types.map((t, i) => 
                `<button class="photo-type-btn ${i === 0 ? 'active' : ''}" data-type="${t.id}" onclick="setPhotoType('${t.id}')">${t.label}</button>`
            ).join('');
            
            document.getElementById('current-folder').textContent = currentPhotoType.folder;
        }
        
        function setPhotoType(typeId) {
            const types = PHOTO_TYPES[currentMode];
            currentPhotoType = types.find(t => t.id === typeId) || types[0];
            
            document.querySelectorAll('.photo-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === typeId);
            });
            
            document.getElementById('current-folder').textContent = currentPhotoType.folder;
        }
        
        // ============================================
        // PHOTO CAPTURE
        // ============================================
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            if (!video.srcObject) return showToast('warning', 'No camera');
            if (!currentSKU) return showToast('warning', 'Start an item first');
            
            // Flash
            const flash = document.getElementById('flash-overlay');
            flash.classList.add('flash');
            setTimeout(() => flash.classList.remove('flash'), 100);
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const isFirstMain = currentMode === 'main' && !photos.some(p => p.mode === 'main');
                
                photos.push({
                    id: Date.now(),
                    blob,
                    url: URL.createObjectURL(blob),
                    mode: currentMode,
                    type: currentPhotoType.id,
                    folder: currentPhotoType.folder
                });
                
                updateUI();
                showToast('success', `üì∑ ${currentPhotoType.label} ‚Üí ${currentPhotoType.folder}/`);
                
                if (isFirstMain && !detectedCategory) {
                    detectCategoryFromPhoto(blob);
                }
            }, 'image/jpeg', 0.95);
        }
        
        function deletePhoto(index) {
            URL.revokeObjectURL(photos[index].url);
            photos.splice(index, 1);
            updateUI();
        }
        
        // ============================================
        // KEYBOARD
        // ============================================
        function initKeyboard() {
            document.addEventListener('keydown', (e) => {
                if (document.querySelector('.modal-overlay.active') || e.target.matches('input')) return;
                
                switch(e.code) {
                    case 'Space': e.preventDefault(); capturePhoto(); break;
                    case 'Digit1': setMode('main'); break;
                    case 'Digit2': setMode('closeup'); break;
                    case 'Digit3': setMode('handheld'); break;
                    case 'KeyR': toggleRecording(); break;
                    case 'Escape': if (mediaRecorder?.state === 'recording') stopRecording(); break;
                }
            });
        }
        
        // ============================================
        // ITEM MANAGEMENT
        // ============================================
        function startNewItem() {
            const sku = document.getElementById('sku-input').value.trim().toUpperCase();
            if (!sku) return showToast('warning', 'Enter a SKU');
            
            photos.forEach(p => URL.revokeObjectURL(p.url));
            photos = [];
            
            currentSKU = sku;
            itemStartTime = Date.now();
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            
            document.getElementById('sku-input-row').style.display = 'none';
            document.getElementById('sku-display').textContent = sku;
            document.getElementById('sku-display').classList.add('visible');
            document.getElementById('check-sku').textContent = '‚úì';
            document.getElementById('check-sku').classList.add('complete');
            
            updateUI();
            showToast('success', `Started: ${sku}`);
        }
        
        function confirmCancelItem() {
            if (!currentSKU) return;
            document.getElementById('cancel-sku-display').textContent = currentSKU;
            document.getElementById('cancel-photo-count').textContent = photos.length;
            document.getElementById('confirm-cancel-modal').classList.add('active');
        }
        
        function closeConfirmCancel() {
            document.getElementById('confirm-cancel-modal').classList.remove('active');
        }
        
        function cancelItem() {
            closeConfirmCancel();
            resetItem();
            showToast('info', 'Item cancelled');
        }
        
        function resetItem() {
            photos.forEach(p => URL.revokeObjectURL(p.url));
            photos = [];
            currentSKU = '';
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            itemStartTime = null;
            
            detectedCategory = null;
            currentTemplate = null;
            audioBlob = null;
            parsedMeasurements = {};
            
            document.getElementById('sku-input').value = '';
            document.getElementById('sku-input-row').style.display = 'flex';
            document.getElementById('sku-display').classList.remove('visible');
            document.getElementById('check-sku').textContent = '‚óã';
            document.getElementById('check-sku').classList.remove('complete');
            document.getElementById('timer-display').textContent = '0:00';
            
            document.getElementById('measure-category').classList.remove('detected');
            document.getElementById('measure-category').innerHTML = `
                <span class="measure-category-icon">‚ùì</span>
                <span class="measure-category-text">Take a MAIN photo to detect category</span>
            `;
            document.getElementById('measure-hints').classList.add('hidden');
            document.getElementById('record-section').classList.remove('hidden');
            document.getElementById('post-record-section').classList.add('hidden');
            document.getElementById('measurements-parsed').classList.add('hidden');
            document.getElementById('record-btn').innerHTML = '<span class="record-icon">üé§</span><span class="record-text">TAP TO RECORD</span>';
            document.getElementById('record-btn').classList.remove('recording');
            document.getElementById('check-measure').textContent = '‚óã';
            document.getElementById('check-measure').classList.remove('complete');
            
            updateUI();
        }
        
        // ============================================
        // N8N WEBHOOK INTEGRATION
        // ============================================
        async function sendToN8N() {
            try {
                const n8nData = {
                    sku: currentSKU,
                    category: detectedCategory || 'Unknown',
                    measurements: parsedMeasurements,
                    measurementCount: Object.keys(parsedMeasurements).length,
                    photoCount: photos.length,
                    timestamp: new Date().toISOString(),
                    itemDuration: itemStartTime ? Math.floor((Date.now() - itemStartTime) / 1000) : 0
                };
                
                console.log('üìß Sending to n8n:', n8nData.sku);
                
                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'n8n',
                        formData: n8nData
                    })
                });
                
                if (!response.ok) {
                    console.warn('n8n response not OK:', response.status);
                    return false;
                }
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ n8n notification sent');
                    return true;
                } else {
                    console.warn('n8n error:', result.error);
                    return false;
                }
                
            } catch (err) {
                console.error('n8n send error:', err);
                // Non-blocking error - don't interrupt workflow
                showToast('warning', 'Could not notify n8n (continuing anyway)');
                return false;
            }
        }
        
        // ============================================
        // COMPLETE ITEM
        // ============================================
        async function completeItem() {
            if (!currentSKU || photos.length === 0) return;
            
            showProcessing('Saving photos...', '', 0);
            
            try {
                let savedToFolder = false;
                let uploadedToS3 = false;
                
                // Save to local folder if handle exists
                if (saveDirectoryHandle) {
                    try {
                        // Verify permission
                        const permission = await saveDirectoryHandle.queryPermission({ mode: 'readwrite' });
                        if (permission !== 'granted') {
                            const request = await saveDirectoryHandle.requestPermission({ mode: 'readwrite' });
                            if (request !== 'granted') throw new Error('Permission denied');
                        }
                        
                        // Create SKU folder
                        const skuFolder = await saveDirectoryHandle.getDirectoryHandle(currentSKU, { create: true });
                        await createFolderStructure(skuFolder);
                        
                        // Save photos by folder
                        const photosByFolder = {};
                        photos.forEach(p => {
                            if (!photosByFolder[p.folder]) photosByFolder[p.folder] = [];
                            photosByFolder[p.folder].push(p);
                        });
                        
                        let savedCount = 0;
                        for (const [folder, folderPhotos] of Object.entries(photosByFolder)) {
                            for (let i = 0; i < folderPhotos.length; i++) {
                                setProcessing(`Saving to ${folder}/`, `${savedCount + 1}/${photos.length}`, (savedCount / photos.length) * 50);
                                await savePhotoToFolder(skuFolder, folderPhotos[i], i);
                                savedCount++;
                            }
                        }
                        
                        // Save measurements
                        await saveMeasurementsToFolder(skuFolder);
                        
                        savedToFolder = true;
                        console.log(`‚úÖ Saved ${photos.length} photos to ${saveDirectoryHandle.name}/${currentSKU}/`);
                        
                    } catch (err) {
                        console.error('Local save error:', err);
                        showToast('warning', 'Could not save locally - check folder permissions');
                    }
                }
                
                // Upload to S3
                setProcessing('Uploading to S3...', '', 50);
                uploadedToS3 = await uploadToS3();
                
                // Send to n8n (non-blocking)
                if (uploadedToS3 || savedToFolder) {
                    setProcessing('Notifying n8n...', '', 75);
                    await sendToN8N();
                }
                
                hideProcessing();
                
                // Show result
                if (savedToFolder && uploadedToS3) {
                    showToast('success', `‚úÖ Saved locally + uploaded to S3 + notified n8n`);
                } else if (savedToFolder) {
                    showToast('success', `‚úÖ Saved to ${saveDirectoryHandle.name}/${currentSKU}/`);
                } else if (uploadedToS3) {
                    showToast('success', `‚úÖ Uploaded to S3 + notified n8n`);
                } else {
                    // Fallback to browser downloads
                    showToast('warning', 'No save location - downloading files');
                    await fallbackDownload();
                }
                
                incrementDailyCounter();
                resetItem();
                
            } catch (err) {
                hideProcessing();
                showToast('error', err.message);
            }
        }
        
        async function fallbackDownload() {
            for (let i = 0; i < photos.length; i++) {
                const p = photos[i];
                const a = document.createElement('a');
                a.href = p.url;
                a.download = `${currentSKU}_${p.folder}_${p.type}_${String(i + 1).padStart(2, '0')}.jpg`;
                a.click();
                await sleep(200);
            }
        }
        
        // ============================================
        // CATEGORY DETECTION
        // ============================================
        async function detectCategoryFromPhoto(photoBlob) {
            try {
                const base64 = await blobToBase64(photoBlob);
                
                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'vision', type: 'main', image: base64 })
                });
                
                if (!response.ok) return;
                
                const result = await response.json();
                if (result.success && result.data?.category) {
                    setDetectedCategory(result.data.category);
                }
            } catch (err) {
                console.error('Category detection error:', err);
            }
        }
        
        function setDetectedCategory(category) {
            const templateKey = CATEGORY_MAP[category] || 'tops-standard';
            detectedCategory = templateKey;
            currentTemplate = MEASUREMENT_TEMPLATES[templateKey];
            
            document.getElementById('measure-category').classList.add('detected');
            document.getElementById('measure-category').innerHTML = `
                <span class="measure-category-icon">‚úì</span>
                <span class="measure-category-text"><strong>${category}</strong> - ${currentTemplate?.length || 0} measurements</span>
            `;
            
            if (currentTemplate) {
                document.getElementById('measure-hints').classList.remove('hidden');
                document.getElementById('measure-hints-list').innerHTML = currentTemplate.map((m, i) => 
                    `<div class="hint-item"><span class="hint-num">${i+1}.</span> ${m}</div>`
                ).join('');
            }
        }
        
        // ============================================
        // VOICE RECORDING
        // ============================================
        async function toggleRecording() {
            if (mediaRecorder?.state === 'recording') {
                stopRecording();
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(t => t.stop());
                    await transcribeAudio(audioBlob);
                };
                
                mediaRecorder.start();
                recordingStart = Date.now();
                
                document.getElementById('record-btn').innerHTML = '<span class="record-icon">‚èπÔ∏è</span><span class="record-text">RECORDING...</span>';
                document.getElementById('record-btn').classList.add('recording');
                
                recordingInterval = setInterval(() => {
                    const s = Math.floor((Date.now() - recordingStart) / 1000);
                    document.querySelector('.record-text').textContent = `RECORDING ${formatTime(s)}`;
                }, 1000);
                
            } catch (err) {
                showToast('error', 'Microphone access denied');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                
                const duration = Math.floor((Date.now() - recordingStart) / 1000);
                document.getElementById('recording-duration').textContent = formatTime(duration);
                
                document.getElementById('record-section').classList.add('hidden');
                document.getElementById('post-record-section').classList.remove('hidden');
                document.getElementById('transcript-status').textContent = 'üîÑ Transcribing...';
                document.getElementById('transcript-status').className = 'transcript-status processing';
                
                document.getElementById('check-measure').textContent = '‚úì';
                document.getElementById('check-measure').classList.add('complete');
            }
        }
        
        async function transcribeAudio(blob) {
            try {
                const base64 = await blobToBase64(blob);
                
                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'whisper', audio: base64, filename: 'audio.webm', language: 'en' })
                });
                
                const result = await response.json();
                
                if (result.success && result.text) {
                    document.getElementById('transcript-status').textContent = '‚úì Transcribed';
                    document.getElementById('transcript-status').className = 'transcript-status success';
                    parseMeasurements(result.text);
                } else {
                    throw new Error(result.error || 'No transcript');
                }
            } catch (err) {
                document.getElementById('transcript-status').textContent = '‚ùå Failed';
                document.getElementById('transcript-status').className = 'transcript-status error';
            }
        }
        
        function parseMeasurements(transcript) {
            if (!currentTemplate) return;
            
            parsedMeasurements = {};
            const numbers = transcript.match(/\d+\.?\d*/g) || [];
            
            let i = 0;
            for (const field of currentTemplate) {
                if (i < numbers.length) {
                    parsedMeasurements[field] = parseFloat(numbers[i++]);
                }
            }
            
            displayParsedMeasurements();
        }
        
        function displayParsedMeasurements() {
            if (!currentTemplate) return;
            
            const container = document.getElementById('measurements-parsed');
            container.classList.remove('hidden');
            
            container.innerHTML = currentTemplate.map((field, i) => {
                const value = parsedMeasurements[field];
                const filled = value !== undefined;
                return `<div class="measurement-item ${filled ? 'filled' : 'empty'}">
                    <span class="measurement-name">${i + 1}. ${field}</span>
                    <span class="measurement-value">${filled ? value + '"' : '--'}</span>
                </div>`;
            }).join('');
        }
        
        function reRecord() {
            audioBlob = null;
            parsedMeasurements = {};
            
            document.getElementById('record-section').classList.remove('hidden');
            document.getElementById('post-record-section').classList.add('hidden');
            document.getElementById('measurements-parsed').classList.add('hidden');
            document.getElementById('record-btn').innerHTML = '<span class="record-icon">üé§</span><span class="record-text">TAP TO RECORD</span>';
            document.getElementById('record-btn').classList.remove('recording');
            document.getElementById('check-measure').textContent = '‚óã';
            document.getElementById('check-measure').classList.remove('complete');
        }
        
        // ============================================
        // BARCODE SCANNER
        // ============================================
        async function openBarcodeScanner() {
            // Validate barcode camera is configured
            if (!cameraConfig.barcode?.deviceId) {
                showToast('warning', 'Set barcode camera in Settings');
                return openSettings();
            }
            
            // Validate that the configured camera actually exists
            const barcodeCamera = availableCameras.find(c => c.deviceId === cameraConfig.barcode.deviceId);
            if (!barcodeCamera) {
                showToast('error', '‚ùå Barcode camera not found - reconfigure in Settings');
                console.warn('Barcode camera ID not found in available cameras:', cameraConfig.barcode.deviceId);
                return openSettings();
            }
            
            // Stop all other streams
            stopCurrentStream();
            await sleep(200);
            
            document.getElementById('barcode-modal').classList.add('active');
            document.getElementById('barcode-status').textContent = 'Initializing scanner...';
            document.getElementById('barcode-status').style.color = '#f59e0b';
            
            // Guard: Check if Quagga is available
            if (typeof Quagga === 'undefined') {
                document.getElementById('barcode-status').textContent = '‚ùå Scanner library not loaded';
                document.getElementById('barcode-status').style.color = '#ef4444';
                showToast('error', 'Barcode library unavailable');
                return;
            }
            
            try {
                const container = document.getElementById('barcode-video').parentElement;
                document.getElementById('barcode-video').style.display = 'none';
                
                // Set init timeout
                let initTimeout = setTimeout(() => {
                    if (barcodeScanning === false) {
                        document.getElementById('barcode-status').textContent = '‚è±Ô∏è Scanner taking too long - retry';
                        document.getElementById('barcode-status').style.color = '#f59e0b';
                    }
                }, 5000);
                
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: container,
                        constraints: {
                            deviceId: cameraConfig.barcode.deviceId,
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "upc_reader", "code_39_reader"],
                        debug: false
                    }
                }, (err) => {
                    clearTimeout(initTimeout);
                    
                    if (err) {
                        console.error('Quagga init error:', err);
                        document.getElementById('barcode-status').textContent = `‚ùå Camera error: ${err.message || 'Unknown'}`;
                        document.getElementById('barcode-status').style.color = '#ef4444';
                        showToast('error', 'Barcode camera failed: ' + (err.message || 'Permission denied?'));
                        return;
                    }
                    
                    document.getElementById('barcode-status').textContent = 'üîç Point camera at barcode...';
                    document.getElementById('barcode-status').style.color = '#22c55e';
                    barcodeScanning = true;
                    
                    try {
                        Quagga.start();
                    } catch (startErr) {
                        console.error('Quagga start error:', startErr);
                        document.getElementById('barcode-status').textContent = '‚ùå Failed to start scanner';
                        document.getElementById('barcode-status').style.color = '#ef4444';
                    }
                });
                
                Quagga.onProcessed(() => {
                    // Use this hook for debugging if needed
                });
                
                Quagga.onDetected((result) => {
                    if (!barcodeScanning) return;
                    barcodeScanning = false;
                    Quagga.stop();
                    
                    const code = result.codeResult.code;
                    document.getElementById('barcode-status').textContent = `‚úì ${code}`;
                    document.getElementById('barcode-status').style.color = '#22c55e';
                    document.getElementById('sku-input').value = code;
                    
                    setTimeout(() => {
                        closeBarcodeScanner();
                        showToast('success', `‚úì SKU: ${code}`);
                    }, 600);
                });
                
            } catch (err) {
                console.error('Barcode scanner error:', err);
                document.getElementById('barcode-status').textContent = `‚ùå ${err.message || 'Scanner error'}`;
                document.getElementById('barcode-status').style.color = '#ef4444';
                showToast('error', 'Barcode scanner failed: ' + err.message);
            }
        }
        
        function closeBarcodeScanner() {
            barcodeScanning = false;
            if (typeof Quagga !== 'undefined') try { Quagga.stop(); } catch(e) {}
            if (barcodeStream) { barcodeStream.getTracks().forEach(t => t.stop()); barcodeStream = null; }
            document.getElementById('barcode-video').style.display = 'block';
            document.getElementById('barcode-modal').classList.remove('active');
            if (cameraConfig[currentMode]?.deviceId) startCameraForMode(currentMode);
        }
        
        // ============================================
        // UI
        // ============================================
        function togglePhotosPanel() {
            document.getElementById('photos-panel').classList.toggle('visible');
        }
        
        function updateUI() {
            const counts = { main: 0, closeup: 0, handheld: 0 };
            photos.forEach(p => counts[p.mode]++);
            
            document.getElementById('count-main').textContent = counts.main;
            document.getElementById('count-closeup').textContent = counts.closeup;
            document.getElementById('count-handheld').textContent = counts.handheld;
            document.getElementById('total-count').textContent = photos.length;
            document.getElementById('photos-toggle-count').textContent = photos.length;
            
            const grid = document.getElementById('photos-grid');
            grid.innerHTML = photos.map((p, i) => `
                <div class="photo-thumb clickable" ondblclick="openLightbox(${i})">
                    <img src="${p.url}" alt="">
                    <div class="photo-folder">${p.folder}</div>
                    <div class="photo-label">${p.type}</div>
                    <button class="delete-btn" onclick="deletePhoto(${i}); event.stopPropagation();">√ó</button>
                </div>
            `).join('');
            
            document.getElementById('complete-btn').disabled = !currentSKU || photos.length === 0;
        }
        
        function updateTimer() {
            if (!itemStartTime) return;
            const s = Math.floor((Date.now() - itemStartTime) / 1000);
            document.getElementById('timer-display').textContent = formatTime(s);
        }
        
        function showToast(type, msg) {
            const icons = { success: '‚úì', error: '‚úó', warning: '‚ö†', info: '‚Ñπ' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span class="toast-message">${msg}</span>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showProcessing(text, sub, pct) {
            document.getElementById('processing-text').textContent = text;
            document.getElementById('processing-subtext').textContent = sub || '';
            document.getElementById('processing-progress').style.width = `${pct||0}%`;
            document.getElementById('processing-overlay').classList.add('active');
        }
        
        function setProcessing(text, sub, pct) {
            document.getElementById('processing-text').textContent = text;
            document.getElementById('processing-subtext').textContent = sub || '';
            document.getElementById('processing-progress').style.width = `${pct||0}%`;
        }
        
        function hideProcessing() {
            document.getElementById('processing-overlay').classList.remove('active');
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        function formatTime(s) {
            return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
        }
        
        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
        
        // ============================================
        // PHOTO LIGHTBOX
        // ============================================
        let currentLightboxIndex = 0;
        
        function openLightbox(index) {
            if (!photos || photos.length === 0) return;
            currentLightboxIndex = index;
            displayLightboxImage();
            document.getElementById('photo-lightbox').classList.add('active');
            document.addEventListener('keydown', handleLightboxKeys);
        }
        
        function closeLightbox() {
            document.getElementById('photo-lightbox').classList.remove('active');
            document.removeEventListener('keydown', handleLightboxKeys);
        }
        
        function displayLightboxImage() {
            if (!photos || currentLightboxIndex >= photos.length) return;
            
            const photo = photos[currentLightboxIndex];
            document.getElementById('lightbox-image').innerHTML = `<img src="${photo.url}" alt="">`;
            document.getElementById('lightbox-index').textContent = `${currentLightboxIndex + 1}/${photos.length}`;
            document.getElementById('lightbox-type').textContent = photo.type || 'unknown';
            document.getElementById('lightbox-folder').textContent = photo.folder || 'none';
            
            // Update nav buttons
            document.getElementById('lightbox-prev').disabled = currentLightboxIndex === 0;
            document.getElementById('lightbox-next').disabled = currentLightboxIndex === photos.length - 1;
        }
        
        function lightboxPrev() {
            if (currentLightboxIndex > 0) {
                currentLightboxIndex--;
                displayLightboxImage();
            }
        }
        
        function lightboxNext() {
            if (currentLightboxIndex < photos.length - 1) {
                currentLightboxIndex++;
                displayLightboxImage();
            }
        }
        
        function lightboxDelete() {
            deletePhoto(currentLightboxIndex);
            if (photos.length === 0) {
                closeLightbox();
            } else {
                currentLightboxIndex = Math.min(currentLightboxIndex, photos.length - 1);
                displayLightboxImage();
            }
        }
        
        function handleLightboxKeys(e) {
            if (!document.getElementById('photo-lightbox').classList.contains('active')) return;
            
            if (e.key === 'ArrowLeft') lightboxPrev();
            else if (e.key === 'ArrowRight') lightboxNext();
            else if (e.key === 'Escape') closeLightbox();
            else if (e.key === 'Delete') lightboxDelete();
        }
    </script>
</body>
</html>

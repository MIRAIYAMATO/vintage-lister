<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vintage Lister v23.2 (Right-Hand Optimization)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* BASE STYLES */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; user-select: none; background: #f9fafb; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        
        /* ANIMATIONS */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .recording { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; border-color: #ef4444 !important; color: white !important; }
        
        .flash { position: absolute; inset: 0; pointer-events: none; z-index: 60; opacity: 0; background: white; }
        .trigger-flash { animation: flash-anim 0.15s ease-out; }
        @keyframes flash-anim { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        /* FORM ELEMENTS */
        select, option, optgroup { font-size: 13px !important; }
        select { -webkit-appearance: none; appearance: none; background-color: white; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        #reader video { object-fit: cover; border-radius: 0.75rem; }
        
        /* DEFECT MAPPING - SVG ZONE-BASED SYSTEM */
        .map-wrapper { position: relative; width: 100%; height: 100%; touch-action: manipulation; }

        .zone-hit {
            cursor: pointer;
            transition: fill 0.05s;
            fill: rgba(220, 38, 38, 0.25); /* Visible red guide */
            stroke: rgba(220, 38, 38, 0.6);
            stroke-width: 2px;
        }
        
        .zone-hit:active { fill: rgba(220, 38, 38, 0.7) !important; }

        .defect-dot {
            position: absolute; width: 24px; height: 24px;
            background: #ef4444; border: 2px solid white; border-radius: 50%;
            color: white; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 30;
        }

        /* BUTTON STYLES - HIGH CONTRAST */
        .defect-btn-stain { background: #fef9c3; color: #854d0e; border: 2px solid #facc15; }
        .defect-btn-hole  { background: #fee2e2; color: #991b1b; border: 2px solid #f87171; }
        .defect-btn-repair{ background: #dbeafe; color: #1e40af; border: 2px solid #60a5fa; }
        .defect-btn-fade  { background: #f3f4f6; color: #374151; border: 2px solid #d1d5db; }
        
        .btn-selected { 
            background-color: #1d4ed8 !important; /* Blue-700 */
            color: white !important; 
            border: 2px solid #1e3a8a !important; /* Blue-900 */
            font-weight: 800 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); 
            transform: scale(1.02);
            z-index: 10;
        }
        
        .btn-default { 
            background-color: white; 
            color: #4b5563; 
            border: 1px solid #e5e7eb; 
            transition: all 0.1s;
        }

    </style>
</head>
<body class="pb-40">

    <!-- CONFIG -->
    <script>
        const N8N_WEBHOOK_URL = "https://jeffkoga.app.n8n.cloud/webhook/0845a6d3-be69-4b68-aba7-28f55112678c"; 
        const APP_PIN = "1234";
    </script>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-gray-900 flex flex-col items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Locked</h2>
            <p class="text-gray-500 text-sm mb-4">Enter Warehouse PIN</p>
            <input type="tel" id="pin-input" maxlength="4" class="w-full p-4 text-center text-3xl font-mono border-2 border-gray-300 rounded-xl mb-4 outline-none focus:border-blue-500 tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button onclick="checkPin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl active:bg-blue-700">UNLOCK</button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="fixed top-0 inset-x-0 bg-white shadow-sm z-40 px-4 py-3 flex justify-between items-center border-b border-gray-200" style="padding-top: max(0.75rem, env(safe-area-inset-top));">
        <div class="font-bold text-gray-800 text-lg tracking-tight">Vintage<span class="text-blue-600">Lister</span> v23.2</div>
        <div class="flex bg-gray-100 rounded-lg p-1">
            <button onclick="setMode('tops')" id="mode-tops" class="px-4 py-2 rounded shadow bg-blue-600 text-white font-bold text-sm transition-all">TOPS</button>
            <button onclick="setMode('bottoms')" id="mode-bottoms" class="px-4 py-2 rounded text-gray-500 font-bold text-sm transition-all">BOTTOMS</button>
        </div>
    </div>

    <!-- MAIN FLOW -->
    <div class="mt-20 px-4 space-y-6 max-w-lg mx-auto pt-4">

        <!-- 1. SKU -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">1. SKU Identification</label>
            <div class="flex gap-2 mt-2">
                <input type="number" id="sku-input" class="w-full text-3xl font-mono p-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-300" placeholder="Scan SKU">
                <button onclick="toggleScanner()" class="bg-gray-900 text-white p-3 rounded-xl flex-shrink-0 active:scale-95 transition-transform shadow-lg">
                    <i data-lucide="scan-barcode" class="w-8 h-8"></i>
                </button>
            </div>
            <div id="scanner-view" class="hidden mt-3 rounded-xl overflow-hidden border-4 border-gray-900 relative bg-black h-56">
                <div id="reader" class="w-full h-full"></div>
                <button onclick="toggleScanner()" class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded shadow">CLOSE</button>
            </div>
        </div>

        <!-- 2. MAIN PHOTOS -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-3">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">2. Main Photos (Visuals)</label>
                <span id="count-main" class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">0</span>
            </div>
            <button onclick="openCamera('main')" class="w-full h-20 border-2 border-dashed border-blue-400 bg-blue-50 rounded-xl flex items-center justify-center gap-2 text-blue-600 font-bold active:bg-blue-100 transition-all shadow-sm">
                <i data-lucide="camera" class="w-6 h-6"></i>
                LAUNCH MAIN CAMERA
            </button>
            <div id="thumbs-main" class="flex gap-2 mt-4 overflow-x-auto pb-2 h-24 empty:hidden snap-x"></div>
        </div>

        <!-- 3. TAG INFO -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">3. Tag Info</label>
            <div class="grid grid-cols-3 gap-2 mt-3 mb-4">
                <button onclick="setTagState('has')" id="btn-tag-has" class="py-4 border border-gray-200 rounded-xl font-bold text-gray-500 text-xs transition-all">Has Tag</button>
                <button onclick="setTagState('unreadable')" id="btn-tag-unreadable" class="py-4 border border-gray-200 rounded-xl font-bold text-gray-500 text-xs transition-all">Unreadable</button>
                <button onclick="setTagState('none')" id="btn-tag-none" class="py-4 border border-gray-200 rounded-xl font-bold text-gray-500 text-xs transition-all">No Tag</button>
            </div>
            <div class="mb-6 grid grid-cols-2 gap-2">
                <button onclick="openCamera('tag')" class="w-full py-4 rounded-xl border-2 border-dashed border-gray-300 text-gray-600 font-bold flex flex-col items-center justify-center gap-1 active:bg-gray-50"><span class="text-[10px]">Snap Neck Tag</span></button>
                <button onclick="openCamera('tag')" class="w-full py-4 rounded-xl border-2 border-dashed border-blue-200 text-blue-500 font-bold flex flex-col items-center justify-center gap-1 active:bg-blue-50"><span class="text-[10px]">Snap Care/Hip Tag</span></button>
            </div>
            <div id="thumbs-tag" class="flex gap-2 overflow-x-auto h-20 empty:hidden snap-x mb-4"></div>
            <div class="space-y-4 bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Fabric Type</label>
                    <select id="fabric-select" class="w-full p-2 border border-gray-300 rounded-xl text-gray-800 font-normal outline-none focus:border-blue-500 text-[11px] tracking-tight">
                        <option value="" disabled selected>Select Material...</option>
                        <optgroup label="Common"><option>100% Cotton</option><option>50/50 (Cotton/Poly)</option><option>Tri-Blend</option><option>100% Polyester</option></optgroup>
                        <optgroup label="Vintage"><option>Dacron / Poly</option><option>Acrylic</option><option>Acrylic/Poly Blend</option><option>Nylon</option><option>Rayon</option><option>Wool</option><option>Silk</option><option>Linen</option><option>Velour</option><option>Terry Cloth</option></optgroup>
                        <optgroup label="Other"><option>Denim</option><option>Leather</option><option>Cannot Determine</option></optgroup>
                    </select>
                </div>
                <div id="section-tag-size" class="hidden">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2 block">Tag Reads</label>
                    <div class="grid grid-cols-6 gap-1 mb-2">
                        <button onclick="setTagSize('XS', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">XS</button>
                        <button onclick="setTagSize('S', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">S</button>
                        <button onclick="setTagSize('M', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">M</button>
                        <button onclick="setTagSize('L', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">L</button>
                        <button onclick="setTagSize('XL', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">XL</button>
                        <button onclick="setTagSize('XXL', this)" class="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs">XXL</button>
                    </div>
                    <input type="text" id="tag-size-input" placeholder="Or Type (e.g. 42R)" onfocus="clearTagSizeBtns()" class="w-full p-2 border border-gray-200 rounded-lg text-sm text-center outline-none focus:border-blue-500">
                </div>
                <div>
                    <label id="label-fits-like" class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-1 block">Fits Like / Estimate</label>
                    <select id="size-select" class="w-full p-2 border border-blue-200 rounded-xl text-gray-800 font-normal outline-none focus:border-blue-500 text-[11px] tracking-tight">
                        <option value="" disabled selected>Select Fit...</option>
                        <option>XXS</option><option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option><option>3XL+</option><option>One Size</option><option>Cannot Determine</option>
                    </select>
                </div>
            </div>
            
            <div id="tag-area-audio" class="hidden">
                <button id="rec-tag" onclick="recordAudio('tag')" class="w-full py-5 rounded-xl border-2 border-red-100 bg-red-50 text-red-500 font-bold flex flex-col items-center justify-center gap-2 transition-all active:scale-[0.98]">
                    <div class="flex items-center gap-2">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                        <span>Record Brand & Origin</span>
                    </div>
                    <div class="text-[10px] text-red-800 font-mono mt-1 opacity-70 text-center">BRAND ‚Ä¢ STYLE (Check Side!) ‚Ä¢ MADE IN ‚Ä¢ RN</div>
                </button>
            </div>
        </div>

        <!-- 4. SPECS & FIT -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 space-y-5">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">4. Category</label>
                <select id="cat-select" onchange="autoSelectSleeve()" class="w-full mt-2 p-2 border border-gray-200 rounded-xl text-xs font-medium outline-none focus:border-blue-500"></select>
            </div>
            
            <!-- SLEEVE SELECTOR (Right-Hand Optimized) -->
            <div id="sleeve-selector">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">5. Sleeve Length</label>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <!-- Left Column -->
                    <div class="space-y-2">
                        <button onclick="setSleeve('None', this)" id="btn-sleeve-none" class="sleeve-btn w-full py-3 rounded-md font-bold text-xs btn-default">Sleeveless</button>
                        <button onclick="setSleeve('3/4', this)" id="btn-sleeve-34" class="sleeve-btn w-full py-3 rounded-md font-bold text-xs btn-default">3/4 Sleeve</button>
                    </div>
                    <!-- Right Column (Primary Thumb Zone) -->
                    <div class="space-y-2">
                        <button onclick="setSleeve('Short', this)" id="btn-sleeve-short" class="sleeve-btn w-full py-3 rounded-md font-bold text-xs btn-selected">Short Sleeve</button>
                        <button onclick="setSleeve('Long', this)" id="btn-sleeve-long" class="sleeve-btn w-full py-3 rounded-md font-bold text-xs btn-default">Long Sleeve</button>
                    </div>
                </div>
            </div>

            <!-- NEW FIT / SILHOUETTE SELECTOR -->
            <div id="fit-selector">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">6. Fit / Cut / Style</label>
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <button onclick="toggleFit('Regular', this)" class="fit-btn py-2 rounded-lg font-medium text-[11px] btn-default">Regular</button>
                    <button onclick="toggleFit('Boxy', this)" class="fit-btn py-2 rounded-lg font-medium text-[11px] btn-default">Boxy</button>
                    <button onclick="toggleFit('Crop', this)" class="fit-btn py-2 rounded-lg font-medium text-[11px] btn-default">Crop</button>
                    <button onclick="toggleFit('Slim', this)" class="fit-btn py-2 rounded-lg font-medium text-[11px] btn-default">Slim Fit</button>
                    <button onclick="toggleFit('Oversized', this)" class="fit-btn py-2 rounded-lg font-medium text-[11px] btn-default">Oversized</button>
                    <button onclick="toggleFit('Tapered', this)" class="fit-btn py-2 rounded-lg font-medium text-[11px] btn-default">Tapered</button>
                </div>
            </div>

            <!-- UPDATED GENDER SECTION (Right-Hand Optimized) -->
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">7. Gender / Department</label>
                <div class="grid grid-cols-3 gap-2 mt-2">
                    <!-- Left: Unisex (Least Frequent?) -->
                    <div class="space-y-2">
                        <button onclick="setGender('Adult Unisex', this)" class="g-btn w-full py-3 rounded-xl font-bold text-xs btn-default">Adult Unisex</button>
                        <button onclick="setGender('Kids Unisex', this)" class="g-btn w-full py-3 rounded-xl font-bold text-xs btn-default">Kids Unisex</button>
                    </div>
                    <!-- Center: Kids -->
                    <div class="space-y-2">
                        <button onclick="setGender('Boys', this)" class="g-btn w-full py-3 rounded-xl font-bold text-xs btn-default">Boys</button>
                        <button onclick="setGender('Girls', this)" class="g-btn w-full py-3 rounded-xl font-bold text-xs btn-default">Girls</button>
                    </div>
                    <!-- Right: Men/Women (Primary Thumb Zone) -->
                    <div class="space-y-2">
                        <button onclick="setGender('Men', this)" class="g-btn w-full py-3 rounded-xl font-bold text-xs btn-default">Men</button>
                        <button onclick="setGender('Women', this)" class="g-btn w-full py-3 rounded-xl font-bold text-xs btn-default">Women</button>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">8. Condition</label>
                <select id="cond-select" class="w-full mt-2 p-2 border border-gray-200 rounded-xl text-xs font-medium outline-none focus:border-blue-500">
                    <option>Pre-owned excellent</option><option>Pre-owned good</option><option>Pre-owned fair</option><option>Poor ‚Äì major flaws</option><option>New with tag</option><option>New without tag</option>
                </select>
            </div>
        </div>

        <!-- 9. VISUAL DEFECT MAP (Dynamic) -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
            <label class="text-xs font-bold text-red-500 uppercase tracking-wide mb-3 block">9. Defects & Issues</label>
            <div class="flex gap-3 mb-4">
                <button onclick="setDefectState(false)" id="btn-no-defects" class="flex-1 py-4 border border-green-200 bg-green-50 text-green-700 rounded-xl font-bold transition-all shadow-inner">No Defects</button>
                <button onclick="setDefectState(true)" id="btn-has-defects" class="flex-1 py-4 border border-gray-200 bg-white text-gray-400 rounded-xl font-bold transition-all">Has Defects</button>
            </div>
            <div id="defect-content" class="hidden">
                <div class="text-center mb-3 text-xs text-gray-500 font-medium">Tap EXACT location on Map</div>
                <div class="space-y-3 mb-4">
                    <!-- Front Map -->
                    <div class="relative w-full bg-white rounded-xl border border-gray-200 overflow-hidden h-64">
                         <div class="absolute top-2 left-3 text-[10px] font-bold text-gray-400 tracking-widest z-30">FRONT</div>
                         <div id="map-front" class="map-wrapper"></div>
                         <div id="dots-front" class="absolute inset-0 w-full h-full pointer-events-none z-30"></div>
                    </div>
                    <!-- Back Map -->
                    <div class="relative w-full bg-white rounded-xl border border-gray-200 overflow-hidden h-64">
                         <div class="absolute top-2 left-3 text-[10px] font-bold text-gray-400 tracking-widest z-30">BACK</div>
                         <div id="map-back" class="map-wrapper"></div>
                         <div id="dots-back" class="absolute inset-0 w-full h-full pointer-events-none z-30"></div>
                    </div>
                </div>
                <div id="thumbs-defect" class="flex gap-2 overflow-x-auto h-24 empty:hidden snap-x"></div>
            </div>
        </div>

        <!-- 10. MEASUREMENTS -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
            <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">10. Measurements</label>
            <div id="measure-hint" class="text-xs font-mono text-gray-600 mb-3 bg-gray-50 p-3 rounded-lg border border-gray-200 leading-relaxed"></div>
            <button id="rec-measure" onclick="recordAudio('measure')" class="w-full py-8 rounded-xl border-2 border-dashed border-gray-300 text-gray-400 font-bold flex flex-col items-center justify-center gap-1 active:bg-gray-50 transition-colors">
                <i data-lucide="ruler" class="w-8 h-8 text-gray-300"></i>
                <span id="lbl-measure">Tap to Record Measurements</span>
            </button>
        </div>

        <!-- SUBMIT -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-200 z-30" style="padding-bottom: max(1rem, env(safe-area-inset-bottom));">
            <button onclick="submitData()" id="btn-submit" class="w-full bg-green-600 active:bg-green-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transition-all">PROCESS LISTING</button>
        </div>

    </div>

    <!-- OVERLAYS (CAM, MODAL, UPLOAD) -->
    <div id="cam-overlay" class="fixed inset-0 z-50 bg-black hidden flex flex-col justify-center">
        <div class="flex-1 bg-black"></div>
        <div class="relative w-full aspect-square bg-gray-900 overflow-hidden shadow-2xl border-y-2 border-gray-800">
            <video id="cam-feed" class="w-full h-full object-cover" autoplay playsinline muted></video>
            <div id="flash" class="flash"></div>
        </div>
        <div class="flex-1 bg-black flex flex-col items-center justify-start pt-8 pb-8">
            <p class="text-gray-400 text-sm font-mono tracking-widest mb-6"><span id="cam-mode-label" class="text-blue-400 font-bold uppercase">MAIN</span> PHOTOS: <span id="cam-count" class="text-white font-bold text-lg">0</span></p>
            <div class="flex items-center justify-evenly w-full px-4 max-w-sm">
                <button onclick="closeCamera()" class="flex flex-col items-center justify-center w-16 h-16 rounded-full bg-gray-800 text-gray-300 font-bold text-[10px] active:bg-gray-700 border border-gray-700">CANCEL</button>
                <button onclick="takeSnap()" class="w-24 h-24 rounded-full bg-white border-[6px] border-gray-300 shadow-2xl active:scale-90 active:border-blue-500 flex items-center justify-center relative"><div class="w-20 h-20 rounded-full border-2 border-gray-100"></div></button>
                <button onclick="closeCamera()" class="flex flex-col items-center justify-center w-16 h-16 rounded-full bg-green-600 text-white font-bold text-[10px] active:bg-green-700 shadow-lg border border-green-500">DONE</button>
            </div>
        </div>
    </div>

    <div id="defect-type-modal" class="fixed inset-0 z-[70] bg-black/80 hidden flex items-end justify-center sm:items-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 pb-8 animate-slide-up">
            <div class="text-center mb-4">
                <p class="text-[10px] text-gray-400 font-bold tracking-widest uppercase mb-1">CONFIRM HAND SIGNAL</p>
                <h3 id="zone-label" class="text-xl font-black text-gray-800">R4-C5</h3>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectDefectType('Stain')" class="defect-btn-stain py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center justify-center gap-1"><span class="text-lg">STAIN</span><span class="text-[10px] opacity-70">‚òùÔ∏è 1 Finger</span></button>
                <button onclick="selectDefectType('Hole')" class="defect-btn-hole py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center justify-center gap-1"><span class="text-lg">HOLE</span><span class="text-[10px] opacity-70">‚úåÔ∏è 2 Fingers</span></button>
                <button onclick="selectDefectType('Repair')" class="defect-btn-repair py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center justify-center gap-1"><span class="text-lg">REPAIR</span><span class="text-[10px] opacity-70">ü§ü 3 Fingers</span></button>
                <button onclick="selectDefectType('Fade/Wear')" class="defect-btn-fade py-4 rounded-xl font-bold active:scale-95 flex flex-col items-center justify-center gap-1"><span class="text-lg">WEAR</span><span class="text-[10px] opacity-70">üëã Open Hand</span></button>
            </div>
            <button onclick="document.getElementById('defect-type-modal').classList.add('hidden')" class="w-full mt-4 text-gray-400 font-bold text-sm py-2">Cancel</button>
        </div>
    </div>

    <div id="upload-modal" class="fixed inset-0 z-[80] bg-black/80 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Uploading...</h2>
            <div class="w-full bg-gray-100 rounded-full h-4 mb-3 overflow-hidden"><div id="progress-bar" class="bg-blue-600 h-full transition-all" style="width: 0%"></div></div>
            <p id="upload-detail" class="text-sm text-gray-500">Processing...</p>
        </div>
    </div>

    <script>
        // --- ASSETS: SHORT SLEEVE MAPS ---
        // Zone names match exactly what's labeled in the user's SVG files (v1.2)
        
        const SVG_SHORT_FRONT = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                <rect x="69" y="139" width="140" height="141" fill="#1a1a1a"/>
                <rect x="559" y="139" width="140" height="140" fill="#1a1a1a"/>
                <!-- ZONES -->
                <rect class="zone-hit" data-zone="RIGHT SLEEVE" x="70" y="140" width="140" height="138" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="209" y="140" width="140" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="420" y="140" width="139" height="70" />
                <rect class="zone-hit" data-zone="LEFT SLEEVE" x="559" y="139" width="139" height="140" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="209" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="RIGHT CHEST" x="279" y="210" width="105" height="139" />
                <rect class="zone-hit" data-zone="LEFT CHEST" x="385" y="210" width="105" height="140" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="489" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="MID SECTION" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="489" y="349" width="70" height="208" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="489" y="559" width="70" height="70" />
            </svg>
        `;

        const SVG_SHORT_BACK = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                <rect x="69" y="139" width="140" height="141" fill="#1a1a1a"/>
                <rect x="559" y="139" width="140" height="140" fill="#1a1a1a"/>
                <!-- ZONES (Mirrored - LEFT on visual left) -->
                <rect class="zone-hit" data-zone="LEFT SLEEVE" x="70" y="140" width="140" height="138" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="209" y="140" width="140" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="420" y="140" width="139" height="70" />
                <rect class="zone-hit" data-zone="RIGHT SLEEVE" x="559" y="139" width="139" height="140" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="209" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="UPPER BACK" x="279" y="210" width="210" height="140" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="489" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="LOWER BACK" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="489" y="349" width="70" height="208" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="489" y="559" width="70" height="70" />
            </svg>
        `;

        // --- ASSETS: LONG SLEEVE MAPS ---
        // Based on user's LONG_SLEEVE_TOP_ICON_VER1_0 files
        // L-shaped PIT zones (2 rects with same data-zone)
        
        const SVG_LONG_FRONT = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette - Main body -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                <!-- Silhouette - Right sleeve area (upper + lower + L-transition) -->
                <rect x="69" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="69" y="279" width="71" height="350" fill="#1a1a1a"/>
                <rect x="140" y="210" width="70" height="70" fill="#1a1a1a"/>
                <!-- Silhouette - Left sleeve area (upper + lower + L-transition) -->
                <rect x="558" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="628" y="279" width="71" height="350" fill="#1a1a1a"/>
                <rect x="558" y="210" width="71" height="70" fill="#1a1a1a"/>
                
                <!-- ZONES -->
                <rect class="zone-hit" data-zone="RIGHT UPPER SLEEVE" x="70" y="140" width="71" height="138" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="141" y="140" width="209" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="420" y="140" width="208" height="70" />
                <rect class="zone-hit" data-zone="LEFT UPPER SLEEVE" x="628" y="139" width="70" height="141" />
                
                <!-- L-shaped RIGHT PIT (2 rects) -->
                <rect class="zone-hit" data-zone="RIGHT PIT" x="141" y="210" width="71" height="70" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="209" y="210" width="70" height="138" />
                <rect class="zone-hit" data-zone="RIGHT CHEST" x="279" y="210" width="105" height="139" />
                <rect class="zone-hit" data-zone="LEFT CHEST" x="385" y="210" width="105" height="140" />
                <!-- L-shaped LEFT PIT (2 rects) -->
                <rect class="zone-hit" data-zone="LEFT PIT" x="489" y="210" width="71" height="139" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="558" y="210" width="71" height="70" />
                
                <rect class="zone-hit" data-zone="RIGHT MID SLEEVE" x="70" y="280" width="70" height="278" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="MID SECTION" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="489" y="349" width="70" height="208" />
                <rect class="zone-hit" data-zone="LEFT MID SLEEVE" x="628" y="280" width="70" height="278" />
                
                <rect class="zone-hit" data-zone="RIGHT CUFF" x="69" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="489" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT CUFF" x="628" y="558" width="70" height="70" />
            </svg>
        `;

        const SVG_LONG_BACK = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette - Main body -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                <!-- Silhouette - Left sleeve area (upper + lower + L-transition) -->
                <rect x="69" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="69" y="279" width="71" height="350" fill="#1a1a1a"/>
                <rect x="140" y="210" width="70" height="70" fill="#1a1a1a"/>
                <!-- Silhouette - Right sleeve area (upper + lower + L-transition) -->
                <rect x="558" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="628" y="279" width="71" height="350" fill="#1a1a1a"/>
                <rect x="558" y="210" width="71" height="70" fill="#1a1a1a"/>
                
                <!-- ZONES (Mirrored - LEFT on visual left) -->
                <rect class="zone-hit" data-zone="LEFT UPPER SLEEVE" x="70" y="140" width="70" height="138" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="141" y="140" width="209" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="420" y="140" width="209" height="70" />
                <rect class="zone-hit" data-zone="RIGHT UPPER SLEEVE" x="628" y="139" width="70" height="140" />
                
                <!-- L-shaped LEFT PIT (2 rects) - on visual left for BACK -->
                <rect class="zone-hit" data-zone="LEFT PIT" x="141" y="210" width="68" height="69" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="209" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="UPPER BACK" x="279" y="210" width="210" height="140" />
                <!-- L-shaped RIGHT PIT (2 rects) - on visual right for BACK -->
                <rect class="zone-hit" data-zone="RIGHT PIT" x="489" y="210" width="71" height="139" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="560" y="210" width="68" height="69" />
                
                <rect class="zone-hit" data-zone="LEFT MID SLEEVE" x="70" y="279" width="70" height="280" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="LOWER BACK" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="489" y="349" width="70" height="208" />
                <rect class="zone-hit" data-zone="RIGHT MID SLEEVE" x="629" y="280" width="70" height="278" />
                
                <rect class="zone-hit" data-zone="LEFT CUFF" x="70" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="489" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT CUFF" x="628" y="559" width="70" height="70" />
            </svg>
        `;

        // --- ASSETS: 3/4 SLEEVE MAPS ---
        // Same as long sleeve but with shorter sleeves (cuff at Y=421 instead of Y=559)
        
        const SVG_34_FRONT = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette - Main body -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                <!-- Silhouette - Right sleeve area (upper + mid + L-transition) -->
                <rect x="69" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="69" y="279" width="71" height="212" fill="#1a1a1a"/>
                <rect x="140" y="210" width="70" height="70" fill="#1a1a1a"/>
                <!-- Silhouette - Left sleeve area (upper + mid + L-transition) -->
                <rect x="558" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="628" y="279" width="71" height="212" fill="#1a1a1a"/>
                <rect x="558" y="210" width="71" height="70" fill="#1a1a1a"/>
                
                <!-- ZONES -->
                <rect class="zone-hit" data-zone="RIGHT UPPER SLEEVE" x="70" y="140" width="71" height="138" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="141" y="140" width="209" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="420" y="140" width="208" height="70" />
                <rect class="zone-hit" data-zone="LEFT UPPER SLEEVE" x="628" y="139" width="70" height="141" />
                
                <!-- L-shaped RIGHT PIT (2 rects) -->
                <rect class="zone-hit" data-zone="RIGHT PIT" x="141" y="210" width="71" height="70" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="209" y="210" width="70" height="138" />
                <rect class="zone-hit" data-zone="RIGHT CHEST" x="279" y="210" width="105" height="139" />
                <rect class="zone-hit" data-zone="LEFT CHEST" x="385" y="210" width="105" height="140" />
                <!-- L-shaped LEFT PIT (2 rects) -->
                <rect class="zone-hit" data-zone="LEFT PIT" x="489" y="210" width="71" height="139" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="558" y="210" width="71" height="70" />
                
                <rect class="zone-hit" data-zone="RIGHT MID SLEEVE" x="70" y="280" width="70" height="139" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="MID SECTION" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="489" y="349" width="70" height="208" />
                <rect class="zone-hit" data-zone="LEFT MID SLEEVE" x="628" y="280" width="70" height="139" />
                
                <rect class="zone-hit" data-zone="RIGHT CUFF" x="70" y="421" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="489" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT CUFF" x="628" y="421" width="70" height="70" />
            </svg>
        `;

        const SVG_34_BACK = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette - Main body -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                <!-- Silhouette - Left sleeve area (upper + mid + L-transition) -->
                <rect x="69" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="69" y="279" width="71" height="212" fill="#1a1a1a"/>
                <rect x="140" y="210" width="70" height="70" fill="#1a1a1a"/>
                <!-- Silhouette - Right sleeve area (upper + mid + L-transition) -->
                <rect x="558" y="139" width="141" height="141" fill="#1a1a1a"/>
                <rect x="628" y="279" width="71" height="212" fill="#1a1a1a"/>
                <rect x="558" y="210" width="71" height="70" fill="#1a1a1a"/>
                
                <!-- ZONES (Mirrored - LEFT on visual left) -->
                <rect class="zone-hit" data-zone="LEFT UPPER SLEEVE" x="70" y="140" width="70" height="138" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="141" y="140" width="209" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="420" y="140" width="209" height="70" />
                <rect class="zone-hit" data-zone="RIGHT UPPER SLEEVE" x="628" y="139" width="70" height="140" />
                
                <!-- L-shaped LEFT PIT (2 rects) - on visual left for BACK -->
                <rect class="zone-hit" data-zone="LEFT PIT" x="141" y="210" width="68" height="69" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="209" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="UPPER BACK" x="279" y="210" width="210" height="140" />
                <!-- L-shaped RIGHT PIT (2 rects) - on visual right for BACK -->
                <rect class="zone-hit" data-zone="RIGHT PIT" x="489" y="210" width="71" height="139" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="560" y="210" width="68" height="69" />
                
                <rect class="zone-hit" data-zone="LEFT MID SLEEVE" x="70" y="279" width="70" height="140" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="LOWER BACK" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="489" y="349" width="70" height="208" />
                <rect class="zone-hit" data-zone="RIGHT MID SLEEVE" x="629" y="280" width="70" height="139" />
                
                <rect class="zone-hit" data-zone="LEFT CUFF" x="70" y="421" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="489" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT CUFF" x="628" y="421" width="70" height="70" />
            </svg>
        `;

        // --- ASSETS: SLEEVELESS MAPS ---
        // No sleeves - body only (tank tops, vests, etc.)
        
        const SVG_SLEEVELESS_FRONT = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette - Body only, no sleeves -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                
                <!-- ZONES (10 zones) -->
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="209" y="140" width="140" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="420" y="140" width="139" height="70" />
                
                <rect class="zone-hit" data-zone="RIGHT PIT" x="209" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="RIGHT CHEST" x="279" y="210" width="105" height="139" />
                <rect class="zone-hit" data-zone="LEFT CHEST" x="385" y="210" width="105" height="140" />
                <rect class="zone-hit" data-zone="LEFT PIT" x="489" y="210" width="70" height="139" />
                
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="MID SECTION" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="489" y="349" width="70" height="208" />
                
                <rect class="zone-hit" data-zone="RIGHT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="LEFT HEM" x="489" y="559" width="70" height="70" />
            </svg>
        `;

        const SVG_SLEEVELESS_BACK = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <!-- Silhouette - Body only, no sleeves -->
                <rect x="209" y="139" width="350" height="489" fill="#1a1a1a"/>
                
                <!-- ZONES (Mirrored - LEFT on visual left) -->
                <rect class="zone-hit" data-zone="LEFT SHOULDER" x="209" y="140" width="140" height="70" />
                <rect class="zone-hit" data-zone="NECK" x="349" y="140" width="70" height="70" />
                <rect class="zone-hit" data-zone="RIGHT SHOULDER" x="420" y="140" width="139" height="70" />
                
                <rect class="zone-hit" data-zone="LEFT PIT" x="209" y="210" width="70" height="139" />
                <rect class="zone-hit" data-zone="UPPER BACK" x="279" y="210" width="210" height="140" />
                <rect class="zone-hit" data-zone="RIGHT PIT" x="489" y="210" width="70" height="139" />
                
                <rect class="zone-hit" data-zone="LEFT MID SECTION" x="209" y="350" width="70" height="207" />
                <rect class="zone-hit" data-zone="LOWER BACK" x="279" y="349" width="210" height="208" />
                <rect class="zone-hit" data-zone="RIGHT MID SECTION" x="489" y="349" width="70" height="208" />
                
                <rect class="zone-hit" data-zone="LEFT HEM" x="209" y="559" width="70" height="70" />
                <rect class="zone-hit" data-zone="CENTER HEM" x="279" y="557" width="210" height="70" />
                <rect class="zone-hit" data-zone="RIGHT HEM" x="489" y="559" width="70" height="70" />
            </svg>
        `;

        // --- SECURITY ---
        document.addEventListener("DOMContentLoaded", () => {
            const savedPin = localStorage.getItem('vintage_lister_auth');
            if (savedPin === APP_PIN) document.getElementById('login-screen').classList.add('hidden');
            lucide.createIcons();
            setMode('tops'); 
            setTagState('has'); 
            setDefectState(false);
        });
        function checkPin() { if(document.getElementById('pin-input').value === APP_PIN) { localStorage.setItem('vintage_lister_auth', APP_PIN); document.getElementById('login-screen').classList.add('hidden'); } else alert("Bad PIN"); }

        let data = { mode: 'tops', mainPhotos: [], tagPhotos: [], defectPhotos: [], cameraMode: 'main', gender: '', tagStatus: 'has', tagSize: '', sleeveType: 'Short', fitType: '', hasDefects: false, audioTag: null, audioMeasure: null, scanTime: null, tempDefect: null };
        
        const config = { 
            tops: { 
                cats: ["Blouse", "Button Shirt", "Cardigan", "Hoodie", "Jacket", "Jersey", "Polo Shirt", "Sweater", "Sweatshirt", "T-Shirt", "Tank Top", "Tunic", "Other Top"], 
                measures: ["Shoulder to Shoulder", "Pit to Pit (Chest)", "Waist", "Bottom Hem", "Length", "Neck to Shoulder", "Sleeve Length", "Arm Opening"] 
            }, 
            bottoms: { 
                cats: ["Jeans", "Joggers", "Pants", "Shorts", "Sweatpants", "Other Bottom"], 
                measures: ["Waist", "Inseam", "Front Rise", "Hips", "Leg Opening"] 
            } 
        };

        window.onload = () => { setMode('tops'); document.getElementById('sku-input').addEventListener('focus', () => { if(!data.scanTime) data.scanTime = new Date(); }); };

        function setMode(m) {
            data.mode = m;
            document.getElementById('mode-tops').className = m === 'tops' ? "px-4 py-2 rounded shadow bg-blue-600 text-white font-bold text-sm" : "px-4 py-2 rounded text-gray-500 font-bold text-sm";
            document.getElementById('mode-bottoms').className = m === 'bottoms' ? "px-4 py-2 rounded shadow bg-blue-600 text-white font-bold text-sm" : "px-4 py-2 rounded text-gray-500 font-bold text-sm";
            const s = document.getElementById('cat-select'); s.innerHTML = '<option disabled selected>Select...</option>';
            config[m].cats.forEach(c => s.add(new Option(c, c)));
            updateCatLogic(); 
        }
        
        function autoSelectSleeve() {
            const cat = document.getElementById('cat-select').value;
            // Simple Logic for auto-selecting to save clicks
            if(cat.includes("Hoodie") || cat.includes("Sweat") || cat.includes("Jacket") || cat.includes("Cardigan") || cat.includes("Button Shirt")) {
                setSleeve('Long', document.getElementById('btn-sleeve-long'));
            } else if (cat.includes("Tank")) {
                setSleeve('None', document.getElementById('btn-sleeve-none'));
            } else {
                setSleeve('Short', document.getElementById('btn-sleeve-short'));
            }
            updateMeasureHint();
        }

        function setSleeve(type, el) {
            data.sleeveType = type;
            document.querySelectorAll('.sleeve-btn').forEach(b => b.className = "sleeve-btn w-full py-3 rounded-md font-bold text-xs btn-default");
            if(el) el.className = "sleeve-btn w-full py-3 rounded-md font-bold text-xs btn-selected";
            renderDefectMaps();
        }

        function toggleFit(fit, el) {
            data.fitType = fit; // Single select for now
            document.querySelectorAll('.fit-btn').forEach(b => b.className = "fit-btn py-2 rounded-lg font-medium text-[11px] btn-default");
            el.className = "fit-btn py-2 rounded-lg font-medium text-[11px] btn-selected";
        }

        function setGender(g, el) { 
            data.gender = g; 
            document.querySelectorAll('.g-btn').forEach(b => b.className = "g-btn w-full py-3 rounded-xl font-bold text-xs btn-default"); 
            el.className = "g-btn w-full py-3 rounded-xl font-bold text-xs btn-selected"; 
        }

        function updateCatLogic() {
            updateMeasureHint();
            renderDefectMaps();
        }

        function renderDefectMaps() {
            // Logic to choose SVG based on Sleeve Type
            let svgFront = SVG_SHORT_FRONT;
            let svgBack = SVG_SHORT_BACK;

            if (data.sleeveType === 'Long') {
                svgFront = SVG_LONG_FRONT;
                svgBack = SVG_LONG_BACK;
            } else if (data.sleeveType === '3/4') {
                svgFront = SVG_34_FRONT;
                svgBack = SVG_34_BACK;
            } else if (data.sleeveType === 'None') {
                svgFront = SVG_SLEEVELESS_FRONT;
                svgBack = SVG_SLEEVELESS_BACK;
            }

            // Front Map
            const mapFront = document.getElementById('map-front');
            mapFront.innerHTML = svgFront;
            attachZoneListeners(mapFront, 'Front');

            // Back Map
            const mapBack = document.getElementById('map-back');
            mapBack.innerHTML = svgBack;
            attachZoneListeners(mapBack, 'Back');
        }

        function attachZoneListeners(container, side) {
            const zones = container.querySelectorAll('.zone-hit');
            zones.forEach(zone => {
                zone.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const zoneName = zone.getAttribute('data-zone');
                    const rect = zone.getBBox();
                    const centerX = ((rect.x + rect.width/2) / 768) * 100;
                    const centerY = ((rect.y + rect.height/2) / 768) * 100;
                    handleZoneClick(e, side, zoneName, centerX, centerY);
                });
            });
        }

        function handleZoneClick(e, side, zoneName, x, y) {
            e.stopPropagation();
            data.tempDefect = { x, y, side, zone: zoneName };
            document.getElementById('zone-label').innerText = `${side.toUpperCase()} ‚Ä¢ ${zoneName}`;
            document.getElementById('defect-type-modal').classList.remove('hidden');
        }

        function selectDefectType(type) {
            data.tempDefect.type = type;
            document.getElementById('defect-type-modal').classList.add('hidden');
            openCamera('defect');
        }

        function addDefectMarker(defect) {
            const dot = document.createElement('div');
            dot.className = "defect-dot";
            dot.style.left = `${defect.x}%`;
            dot.style.top = `${defect.y}%`;
            dot.innerText = data.defectPhotos.length;
            const container = defect.side === 'Front' ? document.getElementById('dots-front') : document.getElementById('dots-back');
            container.appendChild(dot);
        }

        // --- CAMERA ---
        let stream;
        async function openCamera(mode) {
            data.cameraMode = mode;
            document.getElementById('cam-mode-label').innerText = mode;
            document.getElementById('cam-count').innerText = mode==='main'?data.mainPhotos.length:(mode==='tag'?data.tagPhotos.length:data.defectPhotos.length);
            try { stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1920 } } }); document.getElementById('cam-feed').srcObject = stream; document.getElementById('cam-overlay').classList.remove('hidden'); } catch(e) { alert("Cam Error"); }
        }

        function takeSnap() {
            const v = document.getElementById('cam-feed'); const c = document.createElement('canvas');
            const size = Math.min(v.videoWidth, v.videoHeight); c.width = size; c.height = size;
            c.getContext('2d').drawImage(v, (v.videoWidth-size)/2, (v.videoHeight-size)/2, size, size, 0, 0, size, size);
            const f = document.getElementById('flash'); f.classList.add('trigger-flash'); setTimeout(()=>f.classList.remove('trigger-flash'),150);
            c.toBlob(blob => {
                const photo = { blob, ts: new Date() };
                if(data.cameraMode === 'main') data.mainPhotos.push(photo);
                else if(data.cameraMode === 'tag') data.tagPhotos.push(photo);
                else if(data.cameraMode === 'defect') {
                    photo.defectMeta = { ...data.tempDefect };
                    data.defectPhotos.push(photo);
                    addDefectMarker(photo.defectMeta);
                    closeCamera();
                }
                if(data.cameraMode !== 'defect') document.getElementById('cam-count').innerText = data.cameraMode === 'main' ? data.mainPhotos.length : data.tagPhotos.length;
                updateThumbs(data.cameraMode);
            }, 'image/jpeg', 0.7);
        }

        function updateThumbs(mode) {
            const div = document.getElementById(`thumbs-${mode}`); div.innerHTML='';
            const list = mode==='main'?data.mainPhotos:(mode==='tag'?data.tagPhotos:data.defectPhotos);
            list.forEach((p,i) => {
                const img = document.createElement('img'); img.src = URL.createObjectURL(p.blob);
                img.className = "h-20 w-20 object-cover rounded border-2 border-gray-200 flex-shrink-0";
                if(mode==='defect') {
                     const badge = document.createElement('div'); badge.className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold"; badge.innerText = i+1;
                     const wrap = document.createElement('div'); wrap.className="relative"; wrap.appendChild(img); wrap.appendChild(badge); div.appendChild(wrap);
                } else div.appendChild(img);
            });
        }
        
        function closeCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById('cam-overlay').classList.add('hidden'); }

        // --- COMMON ---
        function updateMeasureHint() {
            const cat = document.getElementById('cat-select').value;
            let list = [...config[data.mode].measures];
            if(cat==="Button Shirt") list.push("NECK MEASUREMENT");
            let html = '<div class="grid grid-cols-1 gap-1">';
            list.forEach((m,i) => html += `<div class="${m.includes('NECK')?'text-red-600 font-bold bg-red-50 p-1':''}">${i+1}. ${m}</div>`);
            document.getElementById('measure-hint').innerHTML = html + '</div>';
        }

        function setTagState(state) {
            data.tagStatus = state;
            ['has', 'unreadable', 'none'].forEach(k => document.getElementById(`btn-tag-${k}`).className = "py-4 border border-gray-200 rounded-xl font-bold text-gray-500 text-xs bg-white");
            const active = document.getElementById(`btn-tag-${state}`);
            if(state === 'has') {
                active.className = "py-4 border border-blue-600 bg-blue-50 text-blue-600 rounded-xl font-bold text-xs shadow-inner";
                document.getElementById('section-tag-size').classList.remove('hidden');
                document.getElementById('tag-area-audio').classList.remove('hidden');
                document.getElementById('label-fits-like').innerText = "FITS LIKE (Expert Guess)";
            } else {
                active.className = "py-4 border border-gray-800 bg-gray-800 text-white rounded-xl font-bold text-xs shadow-inner";
                document.getElementById('section-tag-size').classList.add('hidden');
                document.getElementById('tag-area-audio').classList.add('hidden');
                document.getElementById('label-fits-like').innerText = "ESTIMATED SIZE";
            }
        }

        function setTagSize(size, el) { data.tagSize = size; document.getElementById('tag-size-input').value=""; document.querySelectorAll('.size-btn').forEach(b=>b.className="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs"); if(el) el.className="size-btn py-3 border border-blue-600 bg-blue-600 text-white rounded-md font-bold shadow text-xs"; }
        function clearTagSizeBtns() { document.querySelectorAll('.size-btn').forEach(b=>b.className="size-btn py-3 border border-gray-200 rounded-md font-bold text-gray-600 bg-white text-xs"); data.tagSize=""; }
        
        function setDefectState(h) { data.hasDefects=h; if(h) { document.getElementById('btn-has-defects').className="flex-1 py-4 border border-red-500 bg-red-50 text-red-600 rounded-xl font-bold shadow-inner"; document.getElementById('btn-no-defects').className="flex-1 py-4 border border-gray-200 bg-white text-gray-400 font-bold"; document.getElementById('defect-content').classList.remove('hidden'); } else { document.getElementById('btn-no-defects').className="flex-1 py-4 border border-green-500 bg-green-50 text-green-700 rounded-xl font-bold shadow-inner"; document.getElementById('btn-has-defects').className="flex-1 py-4 border border-gray-200 bg-white text-gray-400 font-bold"; document.getElementById('defect-content').classList.add('hidden'); }}

        async function recordAudio(key) {
            const btn = document.getElementById(`rec-${key}`);
            if(recorders[key] && recorders[key].state==='recording') { recorders[key].stop(); btn.classList.remove('recording'); if(key==='tag') btn.innerHTML=`<i data-lucide="check" class="w-6 h-6"></i><span>Audio Saved</span>`; else document.getElementById('lbl-measure').innerText="Saved"; lucide.createIcons(); return; }
            try { const s = await navigator.mediaDevices.getUserMedia({audio:true}); const r = new MediaRecorder(s); let chunks=[]; r.ondataavailable=e=>chunks.push(e.data); r.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); if(key==='tag') data.audioTag=blob; else data.audioMeasure=blob; s.getTracks().forEach(t=>t.stop()); }; r.start(); recorders[key]=r; btn.classList.add('recording'); if(key==='tag') btn.innerHTML=`<span>RECORDING...</span>`; else document.getElementById('lbl-measure').innerText="RECORDING..."; } catch(e) { alert("Mic Denied"); }
        }

        function submitData() {
            const sku = document.getElementById('sku-input').value;
            if(!sku) return alert("Missing SKU");
            if(data.mainPhotos.length === 0) return alert("Take Main Photos");
            if(!document.getElementById('fabric-select').value) return alert("Select Fabric");
            
            const modal = document.getElementById('upload-modal'); modal.classList.remove('hidden');
            const fd = new FormData();
            fd.append('sku', sku); fd.append('auth_pin', APP_PIN);
            fd.append('mode', data.mode); fd.append('tag_status', data.tagStatus); fd.append('has_defects', data.hasDefects);
            fd.append('category', document.getElementById('cat-select').value); fd.append('gender', data.gender); fd.append('condition', document.getElementById('cond-select').value);
            fd.append('fabric', document.getElementById('fabric-select').value); fd.append('fits_like_size', document.getElementById('size-select').value);
            if(data.tagStatus === 'has') fd.append('tag_size', data.tagSize);
            fd.append('sleeve_type', data.sleeveType); 
            fd.append('fit_type', data.fitType); // New Fit Field

            const defectsMetadata = data.defectPhotos.map((p, i) => ({ index: i+1, type: p.defectMeta.type, zone: p.defectMeta.zone, side: p.defectMeta.side }));
            fd.append('defect_map_json', JSON.stringify(defectsMetadata));

            const kpiEnd = new Date(); fd.append('kpi_duration_sec', Math.round((kpiEnd - data.scanTime)/1000));

            data.mainPhotos.forEach((p, i) => fd.append(`main_photo_${i+1}`, p.blob, `${sku}_main_${i+1}.jpg`));
            data.tagPhotos.forEach((p, i) => fd.append(`tag_photo_${i+1}`, p.blob, `${sku}_tag_${i+1}.jpg`));
            data.defectPhotos.forEach((p, i) => fd.append(`defect_photo_${i+1}`, p.blob, `${sku}_defect_${i+1}.jpg`));
            
            if(data.audioTag) fd.append('audio_tag', data.audioTag, `${sku}_tag.webm`);
            if(data.audioMeasure) fd.append('audio_measure', data.audioMeasure, `${sku}_measure.webm`);

            const xhr = new XMLHttpRequest(); xhr.open("POST", N8N_WEBHOOK_URL, true);
            xhr.upload.onprogress = e => { if(e.lengthComputable) document.getElementById('progress-bar').style.width = `${Math.round((e.loaded/e.total)*100)}%`; };
            xhr.onload = () => { if(xhr.status >= 200 && xhr.status < 300) { document.getElementById('progress-bar').style.backgroundColor="#22c55e"; setTimeout(() => location.reload(), 500); } else { alert("Error"); modal.classList.add('hidden'); } };
            xhr.onerror = () => { alert("Network Error"); modal.classList.add('hidden'); };
            xhr.send(fd);
        }
        
        function toggleScanner() { 
            if(!data.scanTime) data.scanTime=new Date(); 
            const v=document.getElementById('scanner-view'); 
            if(!v.classList.contains('hidden')) return; 
            v.classList.remove('hidden'); 
            new Html5Qrcode("reader").start({facingMode:"environment"}, {fps:10, qrbox:250}, txt=>{ document.getElementById('sku-input').value=txt; v.classList.add('hidden'); });
        }
    </script>
</body>
</html>
